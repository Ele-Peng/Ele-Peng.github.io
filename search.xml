<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CSS基本语法+基础机制</title>
    <url>/2020/05/24/CSS%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95-%E5%9F%BA%E7%A1%80%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>整理一下平时所学+所用到的 CSS 基本语法</li>
</ul>
<a id="more"></a>


<h2 id="CSS-基本语法"><a href="#CSS-基本语法" class="headerlink" title="CSS 基本语法"></a>CSS 基本语法</h2><h3 id="CSS2-1-语法"><a href="#CSS2-1-语法" class="headerlink" title="CSS2.1 语法"></a>CSS2.1 语法</h3><ul>
<li><a href="https://www.w3.org/TR/CSS21/grammar.html#q25.0" target="_blank" rel="noopener">Appendix G. Grammar of CSS 2.1</a></li>
<li><a href="https://www.w3.org/TR/css-syntax-3/" target="_blank" rel="noopener">CSS Syntax Module Level 3</a></li>
</ul>
<h3 id="CSS2-1-总体结构"><a href="#CSS2-1-总体结构" class="headerlink" title="CSS2.1 总体结构"></a>CSS2.1 总体结构</h3><p><img src="http://p0.meituan.net/myvideodistribute/b9beefeab08a031d689d4e989de4c2f1197837.png" alt="productions_1"><br><img src="http://p0.meituan.net/myvideodistribute/7340e333e43e235776839a2c00bfb982147104.png" alt="productions_2"></p>
<ul>
<li>简化为：<ul>
<li>@charset</li>
<li>@import</li>
<li>rules<ul>
<li>@media</li>
<li>@page</li>
<li>rule</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="CSS-Rules"><a href="#CSS-Rules" class="headerlink" title="CSS @ Rules"></a>CSS @ Rules</h2><ul>
<li><a href="https://www.w3.org/TR/css-syntax-3/" target="_blank" rel="noopener">@charset</a></li>
<li><a href="https://www.w3.org/TR/css-cascade-4/" target="_blank" rel="noopener">@import</a></li>
<li><a href="https://www.w3.org/TR/css3-conditional/" target="_blank" rel="noopener">@media</a></li>
<li><a href="https://www.w3.org/TR/css-page-3/" target="_blank" rel="noopener">@page</a></li>
<li><a href="https://www.w3.org/TR/css-counter-styles-3/" target="_blank" rel="noopener">@counter-style</a></li>
<li><a href="https://www.w3.org/TR/css-animations-1/" target="_blank" rel="noopener">@keyframes</a></li>
<li><a href="https://www.w3.org/TR/css-fonts-3/" target="_blank" rel="noopener">@fontface</a></li>
<li><a href="https://www.w3.org/TR/css3-conditional/" target="_blank" rel="noopener">@supports</a></li>
<li><a href="https://www.w3.org/TR/css-namespaces-3/" target="_blank" rel="noopener">@namespace</a></li>
</ul>
<h2 id="CSS-Qualified-Rule-的结构"><a href="#CSS-Qualified-Rule-的结构" class="headerlink" title="CSS Qualified Rule 的结构"></a>CSS Qualified Rule 的结构</h2><ul>
<li>Selector<ul>
<li><a href="https://www.w3.org/TR/selectors-3/" target="_blank" rel="noopener">selectors-3</a></li>
<li><a href="https://www.w3.org/TR/selectors-4/" target="_blank" rel="noopener">selectors-4</a></li>
</ul>
</li>
<li>Key<ul>
<li>Properties</li>
<li>Variables<ul>
<li><a href="https://www.w3.org/TR/css-variables/" target="_blank" rel="noopener">css-variables</a></li>
</ul>
</li>
</ul>
</li>
<li>Value<ul>
<li><a href="https://www.w3.org/TR/css-values-4/" target="_blank" rel="noopener">css-values-4</a></li>
</ul>
</li>
</ul>
<h2 id="初建-CSS-知识体系"><a href="#初建-CSS-知识体系" class="headerlink" title="初建 CSS 知识体系"></a>初建 CSS 知识体系</h2><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/236b6afc66be8e7c1ea00a43b76d43a7259289.png" alt="CSS 知识体系"></li>
</ul>
<h2 id="收集标准"><a href="#收集标准" class="headerlink" title="收集标准"></a>收集标准</h2><p><img src="http://p0.meituan.net/myvideodistribute/77c702cce890b37809d44d258837f1bd733569.png" alt="CSS standards"></p>
<ul>
<li>all standards and drafts are in the id named container of the html document.</li>
<li>so we can write a script to collect the standards.</li>
</ul>
<h3 id="第一步：获取所有-li-dom-节点"><a href="#第一步：获取所有-li-dom-节点" class="headerlink" title="第一步：获取所有 li dom 节点"></a>第一步：获取所有 li dom 节点</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = <span class="built_in">document</span>.getElementById(<span class="string">"container"</span>).children</span><br><span class="line">  </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'list'</span>, list)</span><br></pre></td></tr></table></figure>
<p><img src="http://p0.meituan.net/myvideodistribute/6cb3b64a2be23ea9ffce86db74757615120112.png" alt="获取的所有 li 节点"></p>
<h3 id="第二步：匹配出-data-tag-中为-css-的-standard"><a href="#第二步：匹配出-data-tag-中为-css-的-standard" class="headerlink" title="第二步：匹配出 data-tag 中为 css 的 standard"></a>第二步：匹配出 data-tag 中为 css 的 standard</h3><ul>
<li><p><img src="http://p1.meituan.net/myvideodistribute/3d1fb8e8198d5d5774cd861235d5682a314365.png" alt="css standard"></p>
</li>
<li><p>观察得到，我们只需要将 data-tag nodeValue 中有 “css” 抓出来即可</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> list = <span class="built_in">document</span>.getElementById(<span class="string">"container"</span>).children</span><br><span class="line"><span class="keyword">const</span> result = []</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> list) &#123;</span><br><span class="line">  <span class="keyword">if</span> (i.getAttribute(<span class="string">'data-tag'</span>).match(<span class="regexp">/css/</span>)) &#123;</span><br><span class="line">    result.push(&#123;</span><br><span class="line">      name: i.children[<span class="number">1</span>].innerText,</span><br><span class="line">      url: i.children[<span class="number">1</span>].children[<span class="number">0</span>].href</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(result, <span class="literal">null</span>, <span class="string">'    '</span>))</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="收集-CSS-属性相关标准"><a href="#收集-CSS-属性相关标准" class="headerlink" title="收集 CSS 属性相关标准"></a>收集 CSS 属性相关标准</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">"iframe"</span>);</span><br><span class="line"><span class="built_in">document</span>.body.innerHTML = <span class="string">""</span>;</span><br><span class="line"><span class="built_in">document</span>.body.appendChild(iframe);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">happen</span>(<span class="params">element, event</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> handler = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            resolve();</span><br><span class="line">            element.removeEventListener(event, handler);</span><br><span class="line">        &#125;</span><br><span class="line">        element.addEventListener(event, handler);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> standard <span class="keyword">of</span> standards) &#123;</span><br><span class="line">        iframe.src = standard.url;</span><br><span class="line">        <span class="built_in">console</span>.log(standard.name);</span><br><span class="line">        <span class="keyword">await</span> happen(iframe, <span class="string">"load"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;();</span><br></pre></td></tr></table></figure>


<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>CSS</category>
      </categories>
      <tags>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript-Statement</title>
    <url>/2020/04/26/Javascript-Statement/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h1 id="Atom"><a href="#Atom" class="headerlink" title="Atom"></a>Atom</h1><h1 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h1><h1 id="Statement"><a href="#Statement" class="headerlink" title="Statement"></a>Statement</h1><h2 id="Grammar"><a href="#Grammar" class="headerlink" title="Grammar"></a>Grammar</h2><h3 id="简单语句"><a href="#简单语句" class="headerlink" title="简单语句"></a>简单语句</h3><ul>
<li>ExpressionStatement<ul>
<li>a = 1 + 2;</li>
</ul>
</li>
<li>EmptyStatement<ul>
<li>;</li>
</ul>
</li>
<li>DebuggerStatement<ul>
<li>debugger</li>
</ul>
</li>
<li>ThrowStatement<ul>
<li>throw a;</li>
</ul>
</li>
<li>ContinueStatement<ul>
<li>continue ;</li>
<li>continue label;</li>
</ul>
</li>
<li>BreakStatement<ul>
<li>break ;</li>
<li>break label;</li>
</ul>
</li>
<li>ReturnStatement<ul>
<li>return ;</li>
<li>return expression;</li>
</ul>
</li>
</ul>
<a id="more"></a>

<h3 id="组合语句"><a href="#组合语句" class="headerlink" title="组合语句"></a>组合语句</h3><ul>
<li><p>BlockStatement</p>
<ul>
<li><p>把多条语句从语法上括起来，让它像一条语句一样</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  Statement...</span><br><span class="line">  Statement...</span><br><span class="line">  Statement...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  a: <span class="number">1</span> <span class="comment">// a 被理解为 label</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>BlockStatement 中有非 normal ，就会中断</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">throw</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">let</span> b = <span class="number">2</span>;</span><br><span class="line">  b = foo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>为 const / let 提供作用域</p>
</li>
<li><p>Completion Record</p>
<ul>
<li>[[type]]: normal</li>
<li>[[value]]: –</li>
<li>[[target]]: –</li>
</ul>
</li>
</ul>
</li>
<li><p>IfStatement</p>
</li>
<li><p>SwitchStatement</p>
</li>
<li><p>IterationStatement</p>
<ul>
<li><p><s>for await(… of …)</s></p>
</li>
<li><p>while(Expression…) Statement…</p>
</li>
<li><p>do Statement… while(Expression…);</p>
</li>
<li><p>for(Definition…; Expression…; Expression…) Statement…</p>
<ul>
<li><p>Definition</p>
<ul>
<li>var</li>
<li>const / let</li>
</ul>
</li>
<li><p>for 会独立产生一个作用域，在 blockStatement 之外</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(i)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>for(Definition… in Expression…) Statement….</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">in</span> &#123;<span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span>&#125;) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>for(Definition…of Expression…) Statement…</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> i <span class="keyword">of</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> *<span class="title">g</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">yield</span> <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> p  <span class="keyword">of</span> g())&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>for of –&gt; Iterator –&gt; Generator/Array</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>WithStatement</p>
</li>
<li><p>LabelledStatement</p>
</li>
<li><p>TryStatement</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  Statement...</span><br><span class="line">&#125; <span class="keyword">catch</span>(definition...) &#123;</span><br><span class="line">  Statement...</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  Statement...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="number">2</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">  <span class="keyword">let</span> e;</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> e = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="number">2</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>catch 中的声明，只在 {} 这一个作用域中，与 for 不一样。</p>
</li>
<li><p>运行时产生错误的时候，都有可能产生 throw</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> = a;</span><br><span class="line"><span class="literal">null</span>.a;</span><br></pre></td></tr></table></figure></li>
<li><p>Completion Record</p>
<ul>
<li>[[type]]: return</li>
<li>[[value]]: –</li>
<li>[[target]]: label</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="标签、循环、break、continue"><a href="#标签、循环、break、continue" class="headerlink" title="标签、循环、break、continue"></a>标签、循环、break、continue</h3><ul>
<li>LabelledStatement</li>
<li>IterationStatement</li>
<li>ContinueStatement</li>
<li>BreakStatement</li>
<li>SwitchStatement</li>
<li>Completion Record<ul>
<li>[[type]]: break continue</li>
<li>[[value]]: –</li>
<li>[[target]]: label</li>
</ul>
</li>
</ul>
<h3 id="声明机制"><a href="#声明机制" class="headerlink" title="声明机制"></a>声明机制</h3><ul>
<li><p>FunctionDeclaration</p>
</li>
<li><p>GeneratorDeclaration</p>
</li>
<li><p>AsyncFunctionDeclaration</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, d))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i ++);</span><br><span class="line">    <span class="keyword">await</span> sleep(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure></li>
<li><p>AsyncGeneratorDeclaration</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sleep</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> setTimeout(resolve, d))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span>* <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">yield</span> i ++;</span><br><span class="line">    <span class="keyword">await</span> sleep(<span class="number">1000</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> g = foo();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">await</span> g.next());</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">await</span> g.next());</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">await</span> g.next());</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">await</span> g.next());</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="keyword">await</span> g.next());</span><br><span class="line">&#125;()</span><br><span class="line"><span class="comment">// 想无限循环输出</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> g = foo();</span><br><span class="line">  <span class="keyword">for</span> <span class="keyword">await</span>(<span class="keyword">let</span> e <span class="keyword">of</span> g) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure></li>
<li><p>VariableStatement</p>
</li>
<li><p>ClassDeclaration</p>
</li>
<li><p>LexicalDeclaration</p>
</li>
<li><p>声明</p>
<ul>
<li><p>function</p>
</li>
<li><p>function *</p>
</li>
<li><p>async function</p>
</li>
<li><p>async function*</p>
</li>
<li><p>var</p>
<ul>
<li><p>有 var 不建议写在任何语句子结构里，建议写在 function 的范围内</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> o = &#123;<span class="attr">x</span>: <span class="number">1</span>&#125;;</span><br><span class="line">  x = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">with</span>(o) &#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(x); <span class="comment">// --&gt; 2</span></span><br><span class="line">  <span class="built_in">console</span>.log(o.x); <span class="comment">// --&gt; 3</span></span><br><span class="line">&#125;</span><br><span class="line">foo()</span><br><span class="line"><span class="built_in">console</span>.log(x); <span class="comment">// --&gt; 0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> o = &#123;<span class="attr">x</span>: <span class="number">1</span>&#125;;</span><br><span class="line">  x = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">with</span>(o) &#123;</span><br><span class="line">    x = <span class="number">3</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(x); <span class="comment">// --&gt; 2</span></span><br><span class="line">  <span class="built_in">console</span>.log(o.x); <span class="comment">// --&gt; 3</span></span><br><span class="line">&#125;</span><br><span class="line">foo()</span><br><span class="line"><span class="built_in">console</span>.log(x); <span class="comment">// --&gt; 2</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>class</p>
</li>
<li><p>const</p>
</li>
<li><p>let</p>
</li>
</ul>
</li>
</ul>
<h2 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h2><h3 id="Completion-Record"><a href="#Completion-Record" class="headerlink" title="Completion Record"></a>Completion Record</h3><ul>
<li>[[type]]: normal, break, continue, return, throw</li>
<li>[[value]]: Types</li>
<li>[[target]]: label</li>
</ul>
<h3 id="Lexical-Environment"><a href="#Lexical-Environment" class="headerlink" title="Lexical Environment"></a>Lexical Environment</h3><h2 id="预处理（pre-process）BoundNames"><a href="#预处理（pre-process）BoundNames" class="headerlink" title="预处理（pre-process）BoundNames"></a>预处理（pre-process）BoundNames</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">void</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  a = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">console</span>.log(a) </span><br><span class="line">  <span class="keyword">return</span> ;</span><br><span class="line">  <span class="keyword">var</span> a;</span><br><span class="line">&#125;()</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'a'</span>, a);</span><br></pre></td></tr></table></figure>
<p><img src="http://p0.meituan.net/myvideodistribute/f2ca7ffe01a1005a939392f8609685d733665.png" alt="var 预处理"></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">void</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  a = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> ;</span><br><span class="line">  <span class="keyword">const</span> a;</span><br><span class="line">&#125;();</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br></pre></td></tr></table></figure>
<p><img src="http://p1.meituan.net/myvideodistribute/172ab6a2ba78132f1dd33f2f5b64e11044523.png" alt="const 无预处理"></p>
<h2 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">void</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  a = <span class="number">1</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">var</span> a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;();</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">void</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">  a = <span class="number">1</span>;</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">const</span> a;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;();</span><br><span class="line"><span class="built_in">console</span>.log(a);</span><br></pre></td></tr></table></figure>

<p><img src="http://p0.meituan.net/myvideodistribute/8b9ac53e3ae6dfca675786084237d0d971523.png" alt="作用域"></p>
<ul>
<li>作用域与上下文的区别<ul>
<li>作用域可以简单理解为源代码文本的作用区域</li>
<li>执行上下文可以理解为，在用户的电脑上，内存里的，存变量的地方，JavaScript 引擎在执行过程中需要的变量，引擎里的那块内存。</li>
</ul>
</li>
</ul>
<h1 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h1><h1 id="Program-Module"><a href="#Program-Module" class="headerlink" title="Program/Module"></a>Program/Module</h1>]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript Types</title>
    <url>/2020/04/20/Javascript-Atom+Types/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h1 id="Javascript-–-Atom-Types"><a href="#Javascript-–-Atom-Types" class="headerlink" title="Javascript – Atom - Types"></a>Javascript – Atom - Types</h1><h2 id="Atom"><a href="#Atom" class="headerlink" title="Atom"></a>Atom</h2><h3 id="Unicode-（字符集）"><a href="#Unicode-（字符集）" class="headerlink" title="Unicode （字符集）"></a>Unicode （字符集）</h3><ul>
<li><p>Unicode Blocks</p>
<ul>
<li>JS使用的不是ASCII字符集，但是都要兼容ASCII字符集<ul>
<li>a 码点 –&gt; 97, A 码点 –&gt; 65</li>
</ul>
</li>
<li>U+000A LINE FEED 换行<ul>
<li>Form Feed 翻页</li>
<li>CJK 中文字符 Chinese Japan Korean</li>
</ul>
</li>
<li>U+0020 SPACE 空格</li>
<li>BMP (Basic Multilingual Plane)基本字符平面 四位能表示的范围</li>
<li>超出BMP范围<ul>
<li>fromCodePoint</li>
<li>codePointAt</li>
</ul>
</li>
<li>隐性需求需要可以使用\u转义<ul>
<li>“厉害”.codePointAt(0).toString(16)</li>
<li>\u5389\u5bb3<a id="more"></a>
</li>
</ul>
</li>
</ul>
</li>
<li><p>InputElement</p>
<ul>
<li>WhiteSpace 空格<ul>
<li>&lt;TAB&gt; Character Tabulation</li>
<li>&lt;VT&gt; Vertical Line</li>
<li>&lt;FF&gt; Form Feed </li>
<li>&lt;SP&gt; </li>
<li>&lt;NBSP&gt; html根据空格分词，不想让词分根据空格分开，可以使用&nbsp;</li>
<li>&lt;ZWNBSP&gt; U+FEFF Zero WIDTH NO-BREAK SPACE，BOM –&gt; Bit Order Mask</li>
<li>&lt;USP&gt;</li>
</ul>
</li>
<li>LineTerminator 换行符<ul>
<li>&lt;LF&gt; /n</li>
<li>&lt;CR&gt; Carriage Return 回车 /r</li>
<li>&lt;LS&gt; LINE SEPARATOR</li>
<li>&lt;PS&gt; PARAGRAPH SEPARATOR</li>
</ul>
</li>
<li>Comment 注释</li>
<li><strong>Token</strong> 与word不同，记号标记，JS中有效的东西<ul>
<li>自己写的，代码包含的有效信息<ul>
<li><strong>Identifier</strong> 标识符，以英文字母开头<ul>
<li>用作变量名，不能与关键字重复<ul>
<li>undefined 全局变量名，修改不了</li>
<li>离开全局作用域，便可以使用</li>
</ul>
</li>
<li>用作属性的部分，可以与关键字重复</li>
<li>Future reserved Keywords : enum</li>
</ul>
</li>
<li><strong>Literal</strong> 直接量<ul>
<li>Number    </li>
<li>String</li>
<li>Boolean</li>
<li>Object</li>
<li>Null</li>
<li>Undefined</li>
<li>Symbol</li>
</ul>
</li>
</ul>
</li>
<li>帮助程序形成结构<ul>
<li><strong>Punctuator</strong> 符号</li>
<li><strong>Keywords</strong> </li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Types"><a href="#Types" class="headerlink" title="Types"></a>Types</h3><h4 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h4><ul>
<li><p>IEEE 754 Double Float</p>
<ul>
<li>Sign(1)</li>
<li>Exponent(11) 指数，科学计数法</li>
<li>Fraction(52)</li>
</ul>
</li>
<li><p>Grammar</p>
<ul>
<li>DecimaLiteral<ul>
<li>0</li>
<li>0.</li>
<li>.2</li>
<li>1e3</li>
</ul>
</li>
<li>BinaryIntegerLiteral<ul>
<li>0b111</li>
</ul>
</li>
<li>OctalIntegerLiteral<ul>
<li>0o10</li>
</ul>
</li>
<li>HexIntegerLiteral<ul>
<li>0xFF</li>
</ul>
</li>
</ul>
</li>
<li><p>最佳实践</p>
<ul>
<li><p>浮点数比较时，需要加精度</p>
<blockquote>
<p>Number.MAX_SAFE_INTEGER</p>
</blockquote>
<blockquote>
<p>Math.abs(0.1 + 0.2 - 0.3) &lt;= Number.EPSILON</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><ul>
<li><p>Character</p>
</li>
<li><p>Code Point</p>
</li>
<li><p>Encoding</p>
<blockquote>
<p>97 .toString(2)</p>
</blockquote>
<blockquote>
<p>“97.” 是一个合法的Number 01100001</p>
</blockquote>
<ul>
<li>ASCII</li>
<li>Unicode</li>
<li>UCS U+0000 - U+FFFF</li>
<li>GB<ul>
<li>GB2312</li>
<li>GBK(GB13000)</li>
<li>GB18030</li>
</ul>
</li>
<li>ISO-8859</li>
<li>BIG5</li>
</ul>
</li>
<li><p>Grammar</p>
<ul>
<li><p>“abc”</p>
<ul>
<li>“\x10” –&gt; 8</li>
<li>“\u000a”</li>
</ul>
</li>
<li><p>‘abc’</p>
</li>
<li><p>`abc`</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a;</span><br><span class="line">/a/g 正则表达式直接量</span><br><span class="line">(a)</span><br><span class="line">/a/g --&gt; 则表示除法</span><br><span class="line">(a)/a/g</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
<h4 id="Boolean"><a href="#Boolean" class="headerlink" title="Boolean"></a>Boolean</h4><ul>
<li>true</li>
<li>false</li>
</ul>
<h4 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h4><h4 id="Null"><a href="#Null" class="headerlink" title="Null"></a>Null</h4><ul>
<li>typeof 下为 Object</li>
</ul>
<h4 id="Undefined"><a href="#Undefined" class="headerlink" title="Undefined"></a>Undefined</h4><h4 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h4><h2 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h2><h2 id="Statemment"><a href="#Statemment" class="headerlink" title="Statemment"></a>Statemment</h2><h2 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h2><h2 id="Module"><a href="#Module" class="headerlink" title="Module"></a>Module</h2>]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Elle-训练算法计划</title>
    <url>/2020/04/06/Elle-%E8%AE%AD%E7%BB%83%E7%AE%97%E6%B3%95%E8%AE%A1%E5%88%92/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>简单记录一下自己整个算法训练的基础步骤+学习方法</li>
<li>主要的数据结构和算法会单开文档来写</li>
</ul>
<a id="more"></a>
<h2 id="Chunk-it-up-切碎知识点"><a href="#Chunk-it-up-切碎知识点" class="headerlink" title="Chunk it up 切碎知识点"></a>Chunk it up 切碎知识点</h2><ul>
<li>数据结构<ul>
<li>一维数据结构<ul>
<li>基础：数组 array(string), 链表 linked list</li>
<li>高级：栈 stack, 队列 queue, 双端队列 deque, 集合 set, 映射 map (hash or map), etc</li>
</ul>
</li>
<li>二维数据结构<ul>
<li>一维泛化</li>
<li>基础：树 tree，图 graph</li>
<li>高级：二叉搜索树 binary search tree (red-black tree, AVL)，堆 heap, 并查集 disjoint set, 字典树 trie, etc</li>
</ul>
</li>
<li>特殊数据结构<ul>
<li>位运算 bitwise, 布隆过滤器 bloom filter</li>
<li>LRU Cache</li>
</ul>
</li>
</ul>
</li>
<li>算法<ul>
<li>if-else, switch –&gt; branch</li>
<li>for, while loop –&gt; iteration</li>
<li>递归 recursion (divide &amp; conquer 分治, backtrace 回溯)</li>
<li>搜索 search: 深度优先搜索 depth first search, 广度优先搜索 breadth first search, A* (启发式搜索), etc</li>
<li>动态规划 dynamic programing</li>
<li>二分查找 binary search</li>
<li>贪心 greedy</li>
<li>数学 math, 集合 geometry</li>
</ul>
</li>
</ul>
<h2 id="Deliberate-Practicing-刻意练习"><a href="#Deliberate-Practicing-刻意练习" class="headerlink" title="Deliberate Practicing 刻意练习"></a>Deliberate Practicing 刻意练习</h2><ul>
<li>刻意练习-过遍数 (五遍刷题法)<ul>
<li>刷题第一遍<ul>
<li>5分钟（5~15 mins）：读题+思考</li>
<li>直接看解法：注意！多解法，比较解乏优劣</li>
<li>有思路，直接写</li>
<li>背诵+默写好的解法</li>
</ul>
</li>
<li>刷题第二遍<ul>
<li>马上自己写 –&gt; LeetCode提交</li>
<li>多种解法比较、体会 –&gt; 优化</li>
<li>多种解法自己写一遍，直到通过</li>
</ul>
</li>
<li>刷题第三遍<ul>
<li>24h后，再重复做题</li>
<li>不同解法的熟练程度 –&gt; 专项练习</li>
</ul>
</li>
<li>刷题第四遍<ul>
<li>过了一周后：反复回来练习相同的题目</li>
<li>不熟练的题目 –&gt; 专项练习</li>
</ul>
</li>
<li>刷题第五遍<ul>
<li>面试前二周恢复性训练</li>
</ul>
</li>
</ul>
</li>
<li>练习缺陷、弱点地方<ul>
<li>中文站 leetcode-cn.com 刷题</li>
<li>国际站 leetcode.com 看discuss-most votes</li>
</ul>
</li>
<li>切题<ul>
<li><strong>Clarification 审题</strong></li>
<li><strong>Possible Solutions</strong><ul>
<li>compare (time/space)</li>
<li>optimal (加强)</li>
</ul>
</li>
<li><strong>Coding</strong></li>
<li><strong>Test cases</strong></li>
</ul>
</li>
</ul>
<h2 id="Feedback-反馈"><a href="#Feedback-反馈" class="headerlink" title="Feedback 反馈"></a>Feedback 反馈</h2><ul>
<li>即时反馈</li>
<li>主动型反馈</li>
<li>被动型反馈<ul>
<li>code review</li>
</ul>
</li>
</ul>
<h2 id="指法"><a href="#指法" class="headerlink" title="指法"></a>指法</h2><ul>
<li>top tips for vscode</li>
</ul>
<h2 id="自顶向下的编程方式"><a href="#自顶向下的编程方式" class="headerlink" title="自顶向下的编程方式"></a>自顶向下的编程方式</h2><ul>
<li><a href="http://markhneedham.com/blog/2008/09/15/clean-code-book-review/" target="_blank" rel="noopener">自顶向下的编程方式</a></li>
</ul>
<h2 id="Big-O-Notation"><a href="#Big-O-Notation" class="headerlink" title="Big O Notation"></a>Big O Notation</h2><ul>
<li>O(1): constant Complexity 常数复杂度</li>
<li>O(log n): Logarithmic Complexity 对数复杂度</li>
<li>O(n): Linear Complexity 线性时间复杂度</li>
<li>O(n^2): N square Complexity 平方</li>
<li>O(n^3): N cube Complexity 立方</li>
<li>O(2^n): Exponential Growth 指数</li>
<li>O(n!): Factorial 阶乘</li>
<li><img src="http://p0.meituan.net/myvideodistribute/c88294c6a8b88448ae14e2914c7bbfd2337181.png" alt="时间复杂度"></li>
</ul>
<h2 id="master-theorem"><a href="#master-theorem" class="headerlink" title="master theorem"></a>master theorem</h2><ul>
<li>二分查找</li>
<li>二叉树的遍历（每个节点都访问一次，且仅访问一次）</li>
<li>二维有序矩阵</li>
<li>归并排序 O(nlogn)</li>
<li><img src="http://p1.meituan.net/myvideodistribute/5b978d58635ea2e9233ea5e502ab706f246540.png" alt="主定理"></li>
</ul>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript-Expressions</title>
    <url>/2020/04/23/Javascript-Expressions/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h1 id="Javascript-–-Expressions"><a href="#Javascript-–-Expressions" class="headerlink" title="Javascript – Expressions"></a>Javascript – Expressions</h1><a id="more"></a>

<h1 id="Atom"><a href="#Atom" class="headerlink" title="Atom"></a>Atom</h1><h1 id="Expressions-表达式"><a href="#Expressions-表达式" class="headerlink" title="Expressions 表达式"></a>Expressions 表达式</h1><h2 id="Grammar"><a href="#Grammar" class="headerlink" title="Grammar"></a>Grammar</h2><h3 id="引导：Grammar-Tree-vs-Priority"><a href="#引导：Grammar-Tree-vs-Priority" class="headerlink" title="引导：Grammar Tree vs Priority"></a>引导：Grammar Tree vs Priority</h3><ul>
<li>+ -</li>
<li>* /</li>
<li>()</li>
</ul>
<h2 id="Left-Handside-amp-Right-Handside"><a href="#Left-Handside-amp-Right-Handside" class="headerlink" title="Left Handside &amp; Right Handside"></a>Left Handside &amp; Right Handside</h2><h2 id="Left-Handside"><a href="#Left-Handside" class="headerlink" title="Left Handside"></a>Left Handside</h2><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/4fa36955e4edcb6c2ae15f638759b365164257.png" alt="Left Handside"></li>
<li>极限是 call</li>
</ul>
<h3 id="Member"><a href="#Member" class="headerlink" title="Member"></a>Member</h3><ul>
<li><p>a.b</p>
</li>
<li><p>a[b]</p>
</li>
<li><p>foo`string`</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">"Elle"</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">arguments</span>)</span><br><span class="line">&#125;</span><br><span class="line">foo<span class="string">`Hello <span class="subst">$&#123;name&#125;</span>!`</span></span><br></pre></td></tr></table></figure></li>
<li><p>super.b</p>
<ul>
<li>只能在 constructor 里使用</li>
</ul>
</li>
<li><p>super[‘b’]</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>() &#123;</span><br><span class="line">		<span class="keyword">this</span>.a = <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span> <span class="keyword">extends</span> <span class="title">Parent</span> </span>&#123;</span><br><span class="line">	<span class="keyword">constructor</span>() &#123;</span><br><span class="line">		<span class="keyword">super</span>()</span><br><span class="line">		<span class="built_in">console</span>.log(<span class="keyword">this</span>.a)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">Parent.a = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">new</span> Child</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/6dbc29d1a132b5099186f0f9ec8e6bd458489.png" alt="super 截图"></li>
</ul>
</li>
<li><p>new.target</p>
<ul>
<li><p>函数外面不能使用，只能在函数里使用</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">this</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 存在一个伪造对象的可能，无法知道对象是否是被 new 调起</span></span><br><span class="line"><span class="keyword">var</span> fakeObj = &#123;&#125;</span><br><span class="line"><span class="built_in">Object</span>.setPrototypeOf(fakeObj, foo.prototype)</span><br><span class="line">fakeObj.constructor = foo</span><br><span class="line">foo.apply(fakeObj)</span><br><span class="line">fakeObj <span class="keyword">instanceof</span> foo</span><br></pre></td></tr></table></figure>

  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="keyword">new</span>.target)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> foo()</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>new Foo()</p>
<ul>
<li><p>high priority</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cls1</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cls2</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"2"</span>, s)</span><br><span class="line">    <span class="keyword">return</span> cls1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="keyword">new</span> cls2(<span class="string">"goog"</span>)</span><br></pre></td></tr></table></figure></li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/b94c06479581e9f07cea46eed00d5c6053648.png" alt="new Foo()"></p>
</li>
</ul>
</li>
<li><p>Member Expressions 返回的是一个 Reference 类型</p>
<ul>
<li><p>Reference</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123; <span class="attr">x</span>: <span class="number">1</span> &#125;</span><br><span class="line">o.x + <span class="number">2</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span></span><br><span class="line"><span class="keyword">delete</span> o.x</span><br><span class="line"><span class="keyword">delete</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
<h3 id="New"><a href="#New" class="headerlink" title="New"></a>New</h3><ul>
<li><p>new Foo </p>
</li>
<li><p>new Foo() 优先级高</p>
</li>
<li><p><strong>Example</strong></p>
<ul>
<li><p>new a()()</p>
</li>
<li><p>new new a()</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cls1</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(s)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cls2</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"2"</span>, s)</span><br><span class="line">    <span class="keyword">return</span> cls1</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'-=-=-=-new cls2-=-=-=-='</span>)</span><br><span class="line"><span class="keyword">new</span> cls2</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'-=-=-=-cls2("good")-=-=-=-='</span>)</span><br><span class="line">cls2(<span class="string">"good"</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'-=-=-=-new cls2("good")-=-=-=-='</span>)</span><br><span class="line"><span class="keyword">new</span> cls2(<span class="string">"good"</span>) <span class="comment">// 返回回来 cls2 实例，cls1对象</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'-=-=-=-new (cls2("good"))-=-=-=-='</span>)</span><br><span class="line"><span class="keyword">new</span> (cls2(<span class="string">"good"</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'-=-=-=-new (new cls2)-=-=-=-='</span>)</span><br><span class="line"><span class="keyword">new</span> (<span class="keyword">new</span> cls2)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'-=-=-=-new new cls2("good")-=-=-=-='</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="keyword">new</span> cls2(<span class="string">"good"</span>)</span><br></pre></td></tr></table></figure></li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/0ea9dc132069ffab80fc3260feef10d8228161.png" alt="new Foo  优先级"></p>
</li>
</ul>
</li>
</ul>
<h3 id="Call"><a href="#Call" class="headerlink" title="Call"></a>Call</h3><ul>
<li>foo()</li>
<li>super()</li>
<li>foo()[‘b’]</li>
<li>foo().b</li>
<li>foo()`abc`</li>
</ul>
<h2 id="Right-Handside"><a href="#Right-Handside" class="headerlink" title="Right Handside"></a>Right Handside</h2><h3 id="Update"><a href="#Update" class="headerlink" title="Update"></a>Update</h3><ul>
<li><p>UpdateExpression</p>
<ul>
<li><p>no LineTerminator here</p>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/c0869aae45e6bd6e9e6cc8261ed8888664190.png" alt="no LineTerminator here"></p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>, b = <span class="number">1</span>, c = <span class="number">1</span>;</span><br><span class="line">a</span><br><span class="line">++</span><br><span class="line">b</span><br><span class="line">++</span><br><span class="line">c</span><br><span class="line"><span class="built_in">console</span>.log([a, b, c])</span><br><span class="line">a<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span>++</span><br><span class="line">b<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span>++</span><br><span class="line">c</span><br><span class="line"><span class="built_in">console</span>.log([a, b, c])</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>a ++</p>
</li>
<li><p>a –</p>
</li>
<li><p>– a</p>
</li>
<li><p>++ a</p>
</li>
</ul>
<h3 id="Unary-单目运算符"><a href="#Unary-单目运算符" class="headerlink" title="Unary 单目运算符"></a>Unary 单目运算符</h3><ul>
<li><p>delete a.b</p>
</li>
<li><p>void foo() </p>
<ul>
<li><p>void 不是返回值，是运算符在 JS 中</p>
</li>
<li><p>不管后面是什么，都返回 undefined</p>
</li>
<li><p>IIFE 立即执行函数</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</span><br><span class="line">	<span class="keyword">var</span> button  = <span class="built_in">document</span>.createElement(<span class="string">'button'</span>);</span><br><span class="line">	documents.body.append(button);</span><br><span class="line">	button.innerHTML = <span class="number">1</span>;</span><br><span class="line">	button.onClick = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="built_in">console</span>.log(i)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 点那个按钮，都是10，为解决这个问题，我们可以使用IIFE</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</span><br><span class="line">	<span class="keyword">var</span> button  = <span class="built_in">document</span>.createElement(<span class="string">'button'</span>);</span><br><span class="line">	documents.body.append(button);</span><br><span class="line">	button.innerHTML = <span class="number">1</span>;</span><br><span class="line">	(<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">		button.onClick = <span class="function"><span class="keyword">function</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(i)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;)()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 如果前面不加分号，在一些写法中，会发生粘起来错误</span></span><br><span class="line">   (<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">     button.onClick = <span class="function"><span class="keyword">function</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(i)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)()</span><br><span class="line">   </span><br><span class="line">   (<span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">     button.onClick = <span class="function"><span class="keyword">function</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">       <span class="built_in">console</span>.log(i)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)()</span><br><span class="line"><span class="comment">// 最稳妥的就是，在前面加上void</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i ++) &#123;</span><br><span class="line">	<span class="keyword">var</span> button  = <span class="built_in">document</span>.createElement(<span class="string">'button'</span>);</span><br><span class="line">	documents.body.append(button);</span><br><span class="line">	button.innerHTML = <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">void</span> <span class="function"><span class="keyword">function</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">		button.onClick = <span class="function"><span class="keyword">function</span> (<span class="params">i</span>) </span>&#123;</span><br><span class="line">			<span class="built_in">console</span>.log(i)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 并且语义正确，我们并不需要IIFE的返回值</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>typeof a</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/c45593f796e09721d1b10701e366669620756.png" alt="typeof"></li>
</ul>
</li>
<li><p>+ a</p>
</li>
<li><p>- a</p>
</li>
<li><p>~ a 按位取反</p>
</li>
<li><p>! a 取非</p>
<ul>
<li>!!1</li>
</ul>
</li>
<li><p>await a</p>
</li>
</ul>
<h3 id="Exponental"><a href="#Exponental" class="headerlink" title="Exponental"></a>Exponental</h3><ul>
<li>**<ul>
<li>3 ** 2 ** 3</li>
<li>3 ** (2 ** 3)</li>
<li><img src="http://p1.meituan.net/myvideodistribute/18947a64bdd8ad6c249ea3e214f5b11d17541.png" alt="Exponental"></li>
</ul>
</li>
</ul>
<h3 id="Multiplicative"><a href="#Multiplicative" class="headerlink" title="Multiplicative"></a>Multiplicative</h3><ul>
<li>* / %<ul>
<li>JS 中有1种乘法运算符<ul>
<li>运行时<ul>
<li>number</li>
<li>string</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Additive"><a href="#Additive" class="headerlink" title="Additive"></a>Additive</h3><ul>
<li>+ -<ul>
<li>JS 中有2种加法运算符<ul>
<li>运行时<ul>
<li>number</li>
<li>string</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Shift-左右移位"><a href="#Shift-左右移位" class="headerlink" title="Shift 左右移位"></a>Shift 左右移位</h3><ul>
<li>&lt;&lt; &gt;&gt; &gt;&gt;&gt;</li>
</ul>
<h3 id="Relationship-比较"><a href="#Relationship-比较" class="headerlink" title="Relationship 比较"></a>Relationship 比较</h3><ul>
<li>&lt; &gt; &lt;= &gt;= instanceof in</li>
</ul>
<h3 id="Equality"><a href="#Equality" class="headerlink" title="Equality"></a>Equality</h3><ul>
<li>==</li>
<li>!=</li>
<li>===</li>
<li>!==</li>
</ul>
<h3 id="Bitwise"><a href="#Bitwise" class="headerlink" title="Bitwise"></a>Bitwise</h3><ul>
<li>&amp; ^ |</li>
</ul>
<h3 id="Logical"><a href="#Logical" class="headerlink" title="Logical"></a>Logical</h3><ul>
<li><p>没有任何 boolean 转换</p>
</li>
<li><p>&amp;&amp;</p>
<ul>
<li><p>有短路逻辑</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="number">1</span>)</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="number">2</span>)</span><br><span class="line">&#125;</span><br><span class="line">foo1() &amp;&amp; foo2()</span><br><span class="line"></span><br><span class="line">foo1() || foo2()</span><br></pre></td></tr></table></figure>
</li>
<li><p><img src="http://p1.meituan.net/myvideodistribute/76bacd40d3b17ddaca8fa40b7df168cc49722.png" alt="&amp;&amp; 短路逻辑运行截图"></p>
</li>
</ul>
</li>
<li><p>||</p>
</li>
</ul>
<h3 id="Conditional"><a href="#Conditional" class="headerlink" title="Conditional"></a>Conditional</h3><ul>
<li><p>? :</p>
<ul>
<li><p>同样有短路逻辑</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="literal">false</span> ? foo1() : foo2()</span><br></pre></td></tr></table></figure></li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/bcb065e3ae7986b5c15333ea32404e5360600.png" alt="三目运算符短路逻辑"></p>
</li>
</ul>
</li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=","></a>,</h3><h2 id="Runtime"><a href="#Runtime" class="headerlink" title="Runtime"></a>Runtime</h2><h3 id="Type-Convertion"><a href="#Type-Convertion" class="headerlink" title="Type Convertion"></a>Type Convertion</h3><ul>
<li><img src="http://p1.meituan.net/myvideodistribute/92ac57b25bd03ca675ef9b0d694e4415353216.png" alt="Type Convertion"></li>
<li>undefined –&gt; number NAN</li>
</ul>
<h4 id="Boxing-amp-Unboxing"><a href="#Boxing-amp-Unboxing" class="headerlink" title="Boxing &amp; Unboxing"></a>Boxing &amp; Unboxing</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Number String Boolean Symbol</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">'hello'</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">'hello'</span>).length</span><br><span class="line"><span class="string">"hello"</span>.length</span><br><span class="line"><span class="keyword">typeof</span> <span class="string">"hello"</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">'hello'</span>)</span><br><span class="line">!<span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">''</span>)</span><br><span class="line">!<span class="string">""</span></span><br><span class="line"><span class="comment">// Number String Boolean 不作为 new 调用，就是转换成普通类型</span></span><br><span class="line"><span class="built_in">String</span>(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">String</span>(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/3f64818a6b39695d9dbc489cb8bc3f6281607.png" alt="Boxing &amp; Unboxing"></p>
</li>
<li><p>toPremitive()</p>
</li>
<li><p>toString vs valueOf</p>
<ul>
<li><p>toString vs valueOf</p>
<pre><code><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> + &#123;&#125;</span><br><span class="line"><span class="number">1</span> + &#123;valueOf()&#123;<span class="keyword">return</span> <span class="number">2</span>&#125;&#125;</span><br><span class="line"><span class="number">1</span> + &#123;toString()&#123;<span class="keyword">return</span> <span class="number">2</span>&#125;&#125;</span><br><span class="line"><span class="number">1</span> + &#123;toString()&#123;<span class="keyword">return</span> <span class="number">4</span>&#125;&#125;</span><br><span class="line"><span class="number">1</span> + &#123;toString()&#123;<span class="keyword">return</span> <span class="string">"4"</span>&#125;&#125;</span><br><span class="line"><span class="number">1</span> + &#123;valueOf()&#123;<span class="keyword">return</span> <span class="number">1</span>&#125;, toString()&#123;<span class="keyword">return</span> <span class="string">"2"</span>&#125;&#125;</span><br><span class="line"><span class="string">"1"</span> + &#123;valueOf()&#123;<span class="keyword">return</span> <span class="number">1</span>&#125;, toString()&#123;<span class="keyword">return</span> <span class="string">"2"</span>&#125;&#125;</span><br></pre></td></tr></table></figure></code></pre><ul>
<li><img src="http://p1.meituan.net/myvideodistribute/78cc58a640f02d8de18f21eec0c80e2f71205.png" alt="toString vs valueOf"></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><h3 id="Object"><a href="#Object" class="headerlink" title="Object"></a>Object</h3><h3 id="Key"><a href="#Key" class="headerlink" title="Key"></a>Key</h3><h3 id="支持写"><a href="#支持写" class="headerlink" title="支持写"></a>支持写</h3><ul>
<li>delete</li>
<li>assign</li>
</ul>
<h1 id="Statement"><a href="#Statement" class="headerlink" title="Statement"></a>Statement</h1><h1 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h1><h1 id="Program-Module"><a href="#Program-Module" class="headerlink" title="Program/Module"></a>Program/Module</h1><h4 id="ps-checkSign"><a href="#ps-checkSign" class="headerlink" title="ps. checkSign"></a>ps. checkSign</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">check</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">1</span> / number === <span class="literal">Infinity</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (<span class="number">1</span> / number === -<span class="literal">Infinity</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> number / <span class="built_in">Math</span>.abs(number)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>【未完】Infinity 判断</p>
</li>
<li><p>【未完】直接用流取出符号位</p>
</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Reg-Number</title>
    <url>/2020/04/20/Reg-Number/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>利用正则表达式，匹配所有 Number 字面量<a id="more"></a>

</li>
</ul>
<h2 id="实践过程"><a href="#实践过程" class="headerlink" title="实践过程"></a>实践过程</h2><ul>
<li><p><img src="http://p1.meituan.net/myvideodistribute/fcc73488cd245a6c48cf067a6dc7641e16278.png" alt="NumbericLiteral 大纲"></p>
</li>
<li><p>NumericLiteral :: </p>
<ul>
<li><p>DecimalLiteral</p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/94398bab367ca56c0aa2435de753041520532.png" alt="DecimalLiteral 大纲"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/40d13f93242ff1f9321411cc7886586f52608.png" alt="DecimalLiteral 详情"></p>
</li>
<li><p>DecimalIntegerLiteral . DecimalDigits(opt) ExponentPart(opt)</p>
<ul>
<li><p>DecimalIntegerLiteral</p>
<blockquote>
<p>(0)</p>
</blockquote>
<blockquote>
<p>([1-9][0-9]*)</p>
</blockquote>
</li>
<li><p>.</p>
<blockquote>
<p>.</p>
</blockquote>
</li>
<li><p>DecimalDigits</p>
<blockquote>
<p>[0-9]*</p>
</blockquote>
</li>
<li><p>ExponentPart</p>
<blockquote>
<p>(e|E)(\+|\-)?([0-9])*</p>
</blockquote>
</li>
<li><p>可以推导出</p>
<blockquote>
<p>/^((0)|([1-9][0-9]*))?.?([0-9]*)((e|E)?(\+|\-)?([0-9]*))?$/</p>
</blockquote>
</li>
</ul>
</li>
<li><p>. DecimalDigits ExponentPart(opt)</p>
<ul>
<li><p>可以推导出</p>
<blockquote>
<p>/^<strong>((0)|([1-9][0-9]*))?</strong>.?([0-9]*)(((e|E)?(\+|\-)?([0-9])*)*)$/</p>
</blockquote>
</li>
</ul>
</li>
<li><p>DecimalIntegerLiteral ExponentPart(opt)</p>
<blockquote>
<p>/^((0)|([1-9][0-9]*))?<strong>.?</strong>([0-9]<em>)((e|E)?(\+|\-)?([0-9]\</em>))?$/</p>
</blockquote>
</li>
<li><p>最终</p>
<blockquote>
<p>/^((0)|([1-9][0-9]*))?.?([0-9]*)((e|E)?(\+|\-)?([0-9]*))?$/</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><p>BinaryIntegerLiteral </p>
<ul>
<li><p><img src="http://p1.meituan.net/myvideodistribute/5a2e4c4c84c80cf794281290420928d78942.png" alt="BinaryIntegerLiteral 大纲"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/22c6b076cfe8b42d71003893bed4059512350.png" alt="BinaryIntegerLiteral 详情"></p>
<blockquote>
<p>/^0(b|B)(0|1)+$/</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><p>OctalIntegerLiteral </p>
<ul>
<li><p><img src="http://p1.meituan.net/myvideodistribute/40145f430e5560e16f117863419eceea12195.png" alt="OctalIntegerLiteral 大纲"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/3049a1ac2a5071c0bcebae1e31db9a5512369.png" alt="OctalIntegerLiteral 详情"></p>
<blockquote>
<p>/^0(O|o)[0-7]+$/</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><p>HexIntegerLiteral</p>
<ul>
<li><p><img src="http://p1.meituan.net/myvideodistribute/cfe61ed151be1f9e1ab58a860cc6c8638397.png" alt="HexIntegerLiteral 大纲"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/75544696fc619ce55f6555d0fddd5a0617749.png" alt="HexIntegerLiteral 详情"></p>
<blockquote>
<p>/^0(x|X)([0-9a-fA-F])+$/</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>简单总结</p>
<blockquote>
<p>/^(((0)|([1-9][0-9]*))?.?([0-9]*)((e|E)?(\+|\-)?([0-9]*))?)|(0(b|B)(0|1)+)|(0(O|o)[0-7]+)|(0(x|X)([0-9a-fA-F])+)$/</p>
</blockquote>
</li>
<li><p>简化</p>
<blockquote>
<p> /^((((0)|([1-9]\d*))?.?(\d*)((e|E)?(\+|\-)?(\d*))?)|(0(b|B)(0|1)+)|(0(O|o)[0-7]+)|(0(x|X)([0-9a-fA-F])+))$/</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">/^((((<span class="number">0</span>)|([<span class="number">1</span><span class="number">-9</span>]\d*))?.?(\d*)((e|E)?(\+|\-)?(\d*))?)|(<span class="number">0</span>(b|B)(<span class="number">0</span>|<span class="number">1</span>)+)|(<span class="number">0</span>(O|o)[<span class="number">0</span><span class="number">-7</span>]+)|(<span class="number">0</span>(x|X)([<span class="number">0</span><span class="number">-9</span>a-fA-F])+))$/</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="结果测试"><a href="#结果测试" class="headerlink" title="结果测试"></a>结果测试</h2><ul>
<li>十六进制数： 0x0233acdfACDF<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/6b7064f71909191efad66a7a6899e17551930.png" alt="十六进制数"></li>
</ul>
</li>
<li>八进制数：0o023657<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/a65a14040f2a483733b92a78ca7cb76956176.png" alt="八进制数"></li>
</ul>
</li>
<li>二进制数： 0b01010111<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/33e2f75a6f02ec627a4aa16f56c9d59251733.png" alt="二进制数"></li>
</ul>
</li>
<li>浮点数：.2373736<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/facf9ed43fe79a6e05525c9597f1014054052.png" alt="浮点数"></li>
</ul>
</li>
<li>IEEE 754：1.2e+32<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/28058fac862347153c3d605fbb37272952996.png" alt="IEEE 754"></li>
</ul>
</li>
<li>特殊情况 .0<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/5d38329b0247e224ac893957ae24e9a150951.png" alt="特殊情况"></li>
</ul>
</li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>Reg -- String</title>
    <url>/2020/04/21/Reg-String/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>正则表达式，匹配所有 字符串 字面量<a id="more"></a>


</li>
</ul>
<h2 id="实践过程"><a href="#实践过程" class="headerlink" title="实践过程"></a>实践过程</h2><ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/42c12116bea0d20ad46f3eaaec710ee419568.png" alt="StringLiteral 大纲"></p>
</li>
<li><p>StringLiteral ::</p>
<ul>
<li><p>DoubleStringCharacters</p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/03c05dd8a9fd5b8b621593fe039e4e6c16908.png" alt="DoubleStringCharacters 大纲"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/ef23a0f824e9fc948b61da6c4a8d2a4729602.png" alt="DoubleStringCharacter 详情"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/9004c303c8ebdbb8e38c00e7597b2c5b10649.png" alt="SourceCharacter 详情"></p>
<blockquote>
<p>\\u[0-9a-fA-F]{4}</p>
</blockquote>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/25a7c00f444aaead5b3a187d09ab280a16997.png" alt="EscapeSequence 详情"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/ef30597fe4124e22ae7fcf243d9712a310845.png" alt="CharacterEscapeSequence 详情"></p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/b495509fe89ca78a7d2f5f06831d45c79074.png" alt="SingleEscapeCharacter 详情"></p>
<blockquote>
<p>‘“\\bfnrtv</p>
</blockquote>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/7ce330d5a54c7c8ac927771ee7a0540814453.png" alt="NonEscapeCharacter 详情"></p>
<ul>
<li><p><img src="http://p1.meituan.net/myvideodistribute/f3d3a1b2fba86ebd4b8b6ab2959302e610550.png" alt="EscapeCharacter 详情"></p>
<blockquote>
<p>‘“\\bfnrtv0-9xu </p>
</blockquote>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/8c027b4dfef1876ad432fd62b6ecc4a59724.png" alt="LineTerminator 详情"></p>
<blockquote>
<p>\n\r\u2028\u2029</p>
</blockquote>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/02a7f707581cb217ab5025d7a48e67e829247.png" alt="LineTerminator 码点"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>CharacterEscapeSequence</strong>总结为：</p>
<blockquote>
<p>‘“\\bfnrtv0-9xu\n\r\u2028\u2029</p>
</blockquote>
</li>
<li><p><img src="http://p1.meituan.net/myvideodistribute/9207083723607a9faa4f0a560599dde17694.png" alt="HexEscapeSequence 详情"></p>
</li>
<li><p><strong>HexEscapeSequence</strong>总结为：</p>
<blockquote>
<p>\\x[0-9a-fA-F]{2}</p>
</blockquote>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/545f52e053421a0e9c5e3b231a96276d10075.png" alt="UnicodeEscapeSequence 详情"></p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/8bb8c713ee753fd2844aea95e3ecde417620.png" alt="Hex4Digits 详情"></li>
</ul>
</li>
<li><p><strong>UnicodeEscapeSequence</strong>总结为：</p>
<blockquote>
<p> \\u[0-9a-fA-F]{4}</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>EscapeSequence</strong>总结为：</p>
<blockquote>
<p>(‘“\\bfnrtv0-9xu\n\r\u2028\u2029])|(\\x[0-9a-fA-F]{2})|(\\u[0-9a-fA-F]{4})</p>
</blockquote>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/bd86a4d39c1ae8d719eca6afbd9dcb147948.png" alt="LineContinuation 详情"></p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/e8b4e35d4653ecb6a0f89d848085f69b14054.png" alt="LineTerminatorSequence 详情"></li>
</ul>
</li>
<li><p><strong>LineContinuation</strong>总结为：</p>
<blockquote>
<p>\\\n\r\u\2028]2029</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>DoubleStringCharacters</strong>总结为：</p>
<blockquote>
<p>“(?:(\\(‘“\\bfnrtv0-9xu\n\r\u2028\u2029])|(\\x[0-9a-fA-F]{2})|(\\u[0-9a-fA-F]{4}))|(\\\n\r\u\2028]2029))*”</p>
</blockquote>
</li>
<li><p>SingleStringCharacters</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/6d2e2b31ed15050de59907d5537b9e9219247.png" alt="SingleStringCharacters 大纲"></li>
</ul>
</li>
<li><p><strong>SingleStringCharacters</strong>总结为：</p>
<blockquote>
<p>‘(?:(\\(‘“\\bfnrtv0-9xu\n\r\u2028\u2029])|(\\x[0-9a-fA-F]{2})|(\\u[0-9a-fA-F]{4}))|(\\\n\r\u\2028]2029))*’</p>
</blockquote>
</li>
</ul>
</li>
<li><p><strong>StringLiteral</strong>总结为：</p>
<blockquote>
<p>(^”(?:(\\(‘“\\bfnrtv0-9xu\n\r\u2028\u2029])|(\\x[0-9a-fA-F]{2})|(\\u[0-9a-fA-F]{4}))|(\\\n\r\u\2028]2029))*”$)|(^’(?:(\\(‘“\\bfnrtv0-9xu\n\r\u2028\u2029])|(\\x[0-9a-fA-F]{2})|(\\u[0-9a-fA-F]{4}))|(\\\n\r\u\2028]2029))*’$)</p>
</blockquote>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">(^<span class="string">"(?:(\\('"</span>\\bfnrtv0<span class="number">-9</span>xu\n\\r\u2028\u2029])|(\x[<span class="number">0</span><span class="number">-9</span>a-fA-F]&#123;<span class="number">2</span>&#125;)|(\u[<span class="number">0</span><span class="number">-9</span>a-fA-F]&#123;<span class="number">4</span>&#125;))|(\\\n\r\u\<span class="number">2028</span>]<span class="number">2029</span>))*<span class="string">"$)|(^'(?:(\\('"</span>\\bfnrtv0<span class="number">-9</span>xu\n\\r\u2028\u2029])|(\x[<span class="number">0</span><span class="number">-9</span>a-fA-F]&#123;<span class="number">2</span>&#125;)|(\u[<span class="number">0</span><span class="number">-9</span>a-fA-F]&#123;<span class="number">4</span>&#125;))|(\\\n\r\u\<span class="number">2028</span>]<span class="number">2029</span>))*<span class="string">'$)</span></span><br></pre></td></tr></table></figure>


</li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>Toy-Browser-DAY5</title>
    <url>/2020/05/24/Toy-Browser-DAY5/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>implementation of a toy-browser 🙆</li>
<li>最末篇：浏览器的绘制，完结 toy-browser ✊</li>
<li><img src="http://p0.meituan.net/myvideodistribute/5c3903a71266e72d2e3f21a276c0efad94997.png" alt="DOM with Position"></li>
</ul>
<a id="more"></a>

<h2 id="第一步：绘制单个元素"><a href="#第一步：绘制单个元素" class="headerlink" title="第一步：绘制单个元素"></a>第一步：绘制单个元素</h2><ul>
<li><p>绘制需要依赖一个图形环境</p>
</li>
<li><p>这里采用 npm package – images</p>
</li>
<li><p>绘制先在一个 viewport 上进行</p>
</li>
<li><p>暂时只处理绘制属性：background-color</p>
</li>
<li><p>render1.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> images = <span class="built_in">require</span>(<span class="string">'images'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">viewport, element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (element.style) &#123;</span><br><span class="line">    <span class="keyword">const</span> img = images(element.style.width, element.style.height)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (element.style[<span class="string">"background-color"</span>]) &#123;</span><br><span class="line">      <span class="keyword">let</span> color = element.style[<span class="string">"background-color"</span>] || <span class="string">"rgb(0,0,0)"</span></span><br><span class="line">      color.match(<span class="regexp">/rgb\((\d+),(\d+),(\d+)\)/</span>)</span><br><span class="line">      <span class="comment">// .fill(red, green, blue[, alpha])</span></span><br><span class="line">      img.fill(<span class="built_in">Number</span>(<span class="built_in">RegExp</span>.$<span class="number">1</span>), <span class="built_in">Number</span>(<span class="built_in">RegExp</span>.$<span class="number">2</span>), <span class="built_in">Number</span>(<span class="built_in">RegExp</span>.$<span class="number">3</span>), <span class="number">1</span>)</span><br><span class="line">      viewport.draw(img, element.style.left || <span class="number">0</span>, element.style.top || <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = render</span><br></pre></td></tr></table></figure>
</li>
<li><p>client.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ... some code</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ... some code</span></span><br><span class="line">	</span><br><span class="line">  <span class="keyword">let</span> dom = parser.parseHTML(response.body)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> viewport = images(<span class="number">800</span>, <span class="number">600</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 绘制 cls1 元素点，rgb(0, 255, 0)</span></span><br><span class="line">  render(viewport, dom.children[<span class="number">0</span>].children[<span class="number">3</span>].children[<span class="number">1</span>].children[<span class="number">3</span>])</span><br><span class="line"></span><br><span class="line">  viewport.save(<span class="string">"viewport.jpg"</span>)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/c8641c2200150079f9f29c91b1102ac83945.png" alt="运行结果"></li>
</ul>
</li>
<li><p><a href="https://github.com/Ele-Peng/toy-browser/blob/master/render1.js" target="_blank" rel="noopener">render1.js 完整代码-点击一下</a></p>
</li>
</ul>
<h2 id="第二步：绘制-DOM"><a href="#第二步：绘制-DOM" class="headerlink" title="第二步：绘制 DOM"></a>第二步：绘制 DOM</h2><ul>
<li><p>递归调用子元素的绘制方法完成 DOM 树的构建</p>
</li>
<li><p>render2.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> images = <span class="built_in">require</span>(<span class="string">'images'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">viewport, element</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (element.style) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// some code</span></span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (element.children) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> child <span class="keyword">of</span> element.children) &#123;</span><br><span class="line">      render(viewport, child)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = render</span><br></pre></td></tr></table></figure></li>
<li><p>忽略一些不需要绘制的节点</p>
</li>
<li><p>实际浏览器中，文字绘制是难点，需要依赖字体库，这里忽略</p>
</li>
<li><p>实际浏览器中，还会对一些图层做 compositing，这里忽略</p>
</li>
<li><p>server.js 将response Content-Type 设置为 text/html</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// some code</span></span><br><span class="line"></span><br><span class="line">res.writeHead(<span class="number">200</span>, &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// some code</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/b04d62bb5f32ee07cb640e0b97014fb147655.png" alt="运行结果"></li>
</ul>
</li>
</ul>
<ul>
<li><a href="https://github.com/Ele-Peng/toy-browser/blob/master/render2.js" target="_blank" rel="noopener">render2.js 完整代码 点击一下</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li><a href="https://github.com/Ele-Peng/toy-browser" target="_blank" rel="noopener">toy-browser 完整代码 点击一下</a></li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>浏览器</category>
      </categories>
      <tags>
        <tag>浏览器</tag>
      </tags>
  </entry>
  <entry>
    <title>【未完】react-hooks</title>
    <url>/2020/04/13/react-hooks/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>记录学习 react-hooks 过程中的思考🤔<a id="more"></a>

</li>
</ul>
<h2 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h2><ul>
<li><p>react 16.8 推出</p>
</li>
<li><p>能够在函数组件内部使用 state 和组件生命周期方法</p>
</li>
<li><p>定义组件</p>
<ul>
<li>class</li>
<li>F(x) + react-hooks(灵活、可测试、代码复用)</li>
</ul>
</li>
<li><p>什么是 hooks ?</p>
<ul>
<li>允许你hook一些业务逻辑到组件内部 state 和 render 函数上</li>
<li>hooks 允许我们去操作这个内部state了</li>
<li>更好的去关注分离和代码复用(传统 HOC，函数作为子组件)，将相关代码</li>
</ul>
</li>
<li><p>Why Hooks?</p>
<ul>
<li>Mixins<ul>
<li>命名空间耦合</li>
<li>静态检查</li>
<li>组件参数不清晰</li>
</ul>
</li>
<li>HOC<ul>
<li>解决命名空间解耦</li>
<li>对 Class 进行静态检查</li>
<li>组件参数不清晰</li>
<li>组件实例增加</li>
</ul>
</li>
<li>Hooks<ul>
<li>命名空间解耦</li>
<li>静态检查</li>
<li>组件参数清晰</li>
<li>单组件实例</li>
</ul>
</li>
</ul>
</li>
<li><p>三个基础 hooks</p>
<ul>
<li>useState<ul>
<li>允许操作组件的内部状态</li>
<li>如果要根据之前的状态决定下一个状态<ul>
<li>参数可以写成一个函数，函数接受的参数就是之前的状态，prevState =&gt; nowState</li>
</ul>
</li>
</ul>
</li>
<li>useEffect<ul>
<li>使用副作用</li>
<li>指定一个函数在每次render完，去执行什么样的逻辑</li>
<li>第二个参数，传入一个数组，这个数组是当前闭包中的任何变量<ul>
<li>只有当数组中的发生变化，才会调用回调函数</li>
<li>函数组件内部，很容易监听props变化</li>
</ul>
</li>
<li>可以在 useEffect 回调函数中，返回一个函数，作为组建销毁时的一个回调，允许执行一些资源回收的逻辑</li>
<li><strong>useCallback</strong><ul>
<li>将回调函数进行一个缓存，只有在需要时才会返回一个新的事件处理函数</li>
<li>useEffect 和 useCallback，现在都有一个约定，回调函数内如果使用了外部闭包中的变量，那么都应该在第二个参数中进行声明<ul>
<li>eslint-plugin-react-hooks<ul>
<li>“react-hooks/rules-of-hooks”: “error”<ul>
<li>确保对hooks的调用，都发生在顶层作用域</li>
</ul>
</li>
<li>“react-hooks/exhaustive-deps”: “warn”<ul>
<li>必须提供 useEffect 和 useCallback 等hooks 的第二个参数，声明回调函数依赖的变量</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>useContext</li>
</ul>
</li>
<li><p>自定义 hooks</p>
</li>
<li><p>额外 hooks</p>
<ul>
<li><p>useReducer</p>
<ul>
<li><p><a href="https://fed.taobao.org/blog/taofed/do71ct/use-the-react-hooks-instead-of-the-redux/?spm=taofed.bloginfo.blog.3.707f5ac8tD5Gxz" target="_blank" rel="noopener">简单项目：使用 Hooks：useReducer 代替 Redux</a></p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> providers <span class="keyword">from</span> <span class="string">'./providers'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 数据 Provider 组合器</span></span><br><span class="line"><span class="keyword">const</span> ProvidersComposer = <span class="function">(<span class="params">props</span>) =&gt;</span> (</span><br><span class="line">  props.providers.reduceRight(<span class="function">(<span class="params">children, Parent</span>) =&gt;</span> (</span><br><span class="line">    &lt;Parent&gt;&#123;children&#125;&lt;<span class="regexp">/Parent&gt;</span></span><br><span class="line"><span class="regexp">  ), props.children)</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const Provider = (props) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;ProvidersComposer providers=&#123;providers&#125;&gt;</span></span><br><span class="line"><span class="regexp">      &#123;props.children&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>ProvidersComposer&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> Provider;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>useCallback</p>
</li>
<li><p>useMemo</p>
</li>
<li><p>useRef</p>
</li>
<li><p>useImperativeHandle</p>
</li>
<li><p>useLayoutEffect</p>
</li>
<li><p>useDebugValue</p>
</li>
</ul>
</li>
</ul>
<h2 id="react-hooks-改写-TO-DO-Lists"><a href="#react-hooks-改写-TO-DO-Lists" class="headerlink" title="react-hooks 改写 TO DO Lists"></a>react-hooks 改写 TO DO Lists</h2><h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>react</category>
      </categories>
      <tags>
        <tag>react</tag>
      </tags>
  </entry>
  <entry>
    <title>convertNumberToString</title>
    <url>/2020/04/25/convertNumberToString/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>是的我要折腾一下 Javascript convertNumberToString 了🙆</li>
<li><a href="https://ele-peng.github.io/2020/04/24/convertStringToNumber/" target="_blank" rel="noopener">convertStringToNumber 实现</a></li>
</ul>
<a id="more"></a>
<h2 id="实践准备"><a href="#实践准备" class="headerlink" title="实践准备"></a>实践准备</h2><ul>
<li><p>首先我们依旧需要简单梳理一下我们的实践过程，再根据 <a href="https://www.ecma-international.org/publications/standards/Ecma-262.htm" target="_blank" rel="noopener">ECMAScript-262</a> 标准P61完善实践</p>
</li>
<li><p>input: @params: { num } 输入需要转换的number, { radix } 转换的指定基数</p>
</li>
<li><p>对 input-num 的特殊处理</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/e0405830e24314df04f89a21078cc64198443.png" alt="input-num 的特殊处理"></li>
</ul>
</li>
<li><p>简单算法处理</p>
<ul>
<li>获取符号位<ul>
<li>- 负 显示</li>
<li>+ 正 不显示</li>
</ul>
</li>
<li>十进制</li>
<li>二进制</li>
<li>八进制</li>
<li>十六进制</li>
</ul>
</li>
<li><p>output: return resStr</p>
</li>
</ul>
<h2 id="实践过程"><a href="#实践过程" class="headerlink" title="实践过程"></a>实践过程</h2><ul>
<li><p>经过上面的分析，我们代码可以先写成</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convertNumberToString</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> formatNum = <span class="built_in">Number</span>(num) <span class="comment">// 处理Number为十进制</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">isNaN</span>(formatNum)) <span class="keyword">return</span> <span class="string">'NaN'</span></span><br><span class="line">    <span class="keyword">if</span> (isZero(formatNum)) <span class="keyword">return</span> <span class="string">'0'</span></span><br><span class="line">    <span class="keyword">const</span> sign = getSign(formatNum)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isFinite</span>(formatNum)) <span class="keyword">return</span> sign + <span class="string">'Infinity'</span></span><br><span class="line">    <span class="keyword">return</span> convertDecimalNumberToString(formatNum)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(err)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>input number 的特殊处理</p>
<ul>
<li><p>If m is NaN, return the String “NaN”.</p>
<blockquote>
<p>if (isNaN(formatNum)) return ‘NaN’</p>
</blockquote>
</li>
<li><p>If m is +0 or -0, return the String “0”.</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (isZero(formatNum)) <span class="keyword">return</span> <span class="string">'0'</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isZero</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">1</span> / num === <span class="literal">Infinity</span> || <span class="number">1</span> / num === -<span class="literal">Infinity</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>If m is less than zero, return the string-concatenation of “-“ and ! NumberToString(-m).</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> sign = getSign(formatNum)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSign</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (num === -<span class="literal">Infinity</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"-"</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num === <span class="literal">Infinity</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span></span><br><span class="line">  &#125; <span class="comment">// 特殊情况 0 前面已经处理</span></span><br><span class="line">  <span class="keyword">return</span> num / <span class="built_in">Math</span>.abs(num) === <span class="number">1</span> ? <span class="string">""</span> : <span class="string">"-"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>If m is +∞, return the String “Infinity”.</p>
<blockquote>
<p>if (!isFinite(formatNum)) return sign + ‘Infinity’</p>
</blockquote>
</li>
</ul>
</li>
<li><p>常规 Decimal Number 处理</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convertDecimalNumberToString</span>(<span class="params">num</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> radix = <span class="number">10</span></span><br><span class="line">  <span class="keyword">let</span> int = <span class="built_in">Math</span>.floor(num)</span><br><span class="line">  <span class="keyword">let</span> float = (num - int) * <span class="number">100</span> / <span class="number">100</span></span><br><span class="line">  <span class="keyword">let</span> resInt = <span class="string">''</span></span><br><span class="line">  <span class="keyword">let</span> resFloat = <span class="string">''</span></span><br><span class="line">  <span class="comment">// 整数部分 取余，除以基数</span></span><br><span class="line">  <span class="keyword">while</span> (int &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    resInt = <span class="built_in">String</span>(int % radix) + resInt</span><br><span class="line">    int = <span class="built_in">Math</span>.floor(int / radix)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (float) &#123;</span><br><span class="line">    resFloat = <span class="string">'.'</span></span><br><span class="line">    <span class="comment">// 小数部分，乘以基数，取整</span></span><br><span class="line">    <span class="keyword">while</span> (float &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      resFloat = resFloat + <span class="built_in">Math</span>.floor(float * radix)</span><br><span class="line">      float -= <span class="built_in">Math</span>.floor(float * radix)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> resInt + resFloat</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(convertNumberToString(-<span class="literal">Infinity</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'toString'</span>, -<span class="literal">Infinity</span>.toString())</span><br><span class="line"><span class="built_in">console</span>.log(convertNumberToString(+<span class="literal">Infinity</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'toString'</span>, +<span class="literal">Infinity</span>.toString())</span><br><span class="line"><span class="built_in">console</span>.log(convertNumberToString(<span class="number">120.11112</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'toString'</span>, <span class="number">120.11112</span>.toString())</span><br><span class="line"><span class="built_in">console</span>.log(convertNumberToString(<span class="number">120</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'toString'</span>, (<span class="number">120</span>).toString())</span><br></pre></td></tr></table></figure>
<ul>
<li>测试截图<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/b741d6a87bab9c52f01871781745689124911.png" alt="测试截图"></li>
</ul>
</li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>可以看出，我们写的 converNumbertoString 遇到浮点数，就失灵了，有想到说 用 toString，然后正则匹配出小数点后面的浮点数，舍入相应位数，但是这样，就用到了 toString 方法，似乎与我的最初想法实现 convertNumbertToString 死锁了 🙃</li>
<li>大家有其他的不用 toString 实践，欢迎评论告诉我呀~</li>
<li><a href="https://github.com/Ele-Peng/Frontend-01-Template/blob/master/week03/convertNumberToString.html" target="_blank" rel="noopener">代码地址</a></li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>【未完】前端性能监控</title>
    <url>/2020/04/16/%E5%89%8D%E7%AB%AF%E6%80%A7%E8%83%BD%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>记录 性能监控 方面的学习过程🤔</li>
</ul>
<a id="more"></a>

<h2 id="学习过程"><a href="#学习过程" class="headerlink" title="学习过程"></a>学习过程</h2><h3 id="大前端时代前端变化"><a href="#大前端时代前端变化" class="headerlink" title="大前端时代前端变化"></a>大前端时代前端变化</h3><ul>
<li>Gmail SPA</li>
<li>Angular/React/Vue MVVM/工程化</li>
<li>weex/react native 跨端</li>
<li>Node 全栈</li>
</ul>
<h3 id="前端变化给监控带来了什么样的改变"><a href="#前端变化给监控带来了什么样的改变" class="headerlink" title="前端变化给监控带来了什么样的改变"></a>前端变化给监控带来了什么样的改变</h3><ul>
<li>传统监控模式能否使用于新的技术？比如 PV 统计<ul>
<li>导致 PV 下降的原因和解法</li>
<li>原因<ul>
<li>业内路由替代了请求新的页面</li>
</ul>
</li>
<li>解法<ul>
<li>哈希路由：监听 hash change 变化上报 PV</li>
<li>非哈希路由(Angular): 轻量 hack pushState 和 replaceState</li>
</ul>
</li>
<li>案例<ul>
<li>下拉刷新</li>
<li>滚屏分页</li>
<li>阿里云邮后台一直开着，每周上百次查看</li>
<li>未关闭的浏览器 Ta b几小时后再次浏览</li>
<li>查找信息时，浏览器 Tab 之间快速切换</li>
</ul>
</li>
</ul>
</li>
<li>SPA模式下首屏如何计算？<ul>
<li>第一阶段：自定义打点时期<ul>
<li>页头和首屏dom处分别通过 new Date() 打点</li>
</ul>
</li>
<li>第二阶段：W3C标准时期<ul>
<li>Navigaion Timing API</li>
</ul>
</li>
<li>第三阶段：SPA盛行导致w3c标准失去原来的意义</li>
<li>现阶段：用户感官指标FMP<ul>
<li>FMP：主要内容可见时间</li>
<li>猜想：主要内容 = 元素增量最大的点 （猜想不成立）<ul>
<li>什么原因导致猜想不成立？<ul>
<li>元素是否可见</li>
<li>每个元素对页面的影响是否等效？ –&gt; 权重</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>下一阶段：W3C/paint-timing 首屏加载时间计算已经在提案中</li>
</ul>
</li>
<li>跨端开发给监控带来什么挑战？</li>
<li>前端监控的上报模式在 Node.js 端是否合理？</li>
</ul>
<h3 id="前端监控的最佳实践"><a href="#前端监控的最佳实践" class="headerlink" title="前端监控的最佳实践"></a>前端监控的最佳实践</h3><ul>
<li>主动监控</li>
<li>性能样本分布 &amp; 慢会话<ul>
<li>慢会话追踪</li>
</ul>
</li>
<li>搜索报错明细</li>
<li>出错行为还原</li>
</ul>
<h3 id="阿里云ARMS前端监控系统架构"><a href="#阿里云ARMS前端监控系统架构" class="headerlink" title="阿里云ARMS前端监控系统架构"></a>阿里云ARMS前端监控系统架构</h3><h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>性能监控</category>
      </categories>
      <tags>
        <tag>性能监控</tag>
      </tags>
  </entry>
  <entry>
    <title>OOP-面向对象</title>
    <url>/2020/04/09/OOP-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>昨天 Mentor 说以后要开始用 React Hooks（我还没有涉足 ）写点东西，进而谈论到 React 生态一直想推展开来的的函数式编程思想，我不由得想到一个问题：都说 Javascript 不是典型的面向对象编程语言，它并不具备完整的 OOP 该有的特性，它虽引进了 class 语法糖，但只是让对象原型写法更加像面向对象编程语言的写法，那面向对象到底可以理解为什么 ? 🤔 以及函数式编程思想在推什么？Javascript 定位究竟是什么？</li>
<li>简单记录一下自己关于这个问题的思考<a id="more"></a>

</li>
</ul>
<h2 id="OOP-Wikipedia"><a href="#OOP-Wikipedia" class="headerlink" title="OOP Wikipedia"></a>OOP Wikipedia</h2><ul>
<li><p>探讨的是面向对象</p>
</li>
<li><p>我们首先可以想想，我们为什么需要封装成对象？</p>
<ul>
<li>我的理解是：我们需要减少我们的操作粒度，每个操作都去落实到 bit 数据是非常庞大的，减少问题求解复杂度</li>
<li>wiki 上关于 object 特性也给到了支持</li>
</ul>
</li>
<li><p>A feature of objects is an object’s procedures that can <strong>access</strong> and <strong>often modify the data fields</strong> of the object with which they are associated (objects have a notion of “this” or “self”).</p>
<ul>
<li><p>可以和面向过程 (Procedure Oriented) 放在一起说。</p>
</li>
<li><p>首先 OOP 是一个很自然的思想，在C语言中也能写出<strong>符合</strong>面向对象思想的代码</p>
  <figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// C语言例子</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span>&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *name;  <span class="comment">//姓名</span></span><br><span class="line">    <span class="keyword">int</span> num;  <span class="comment">//学号</span></span><br><span class="line">    <span class="keyword">int</span> age;  <span class="comment">//年龄</span></span><br><span class="line">    <span class="keyword">char</span> group;  <span class="comment">//所在学习小组</span></span><br><span class="line">    <span class="keyword">float</span> score;  <span class="comment">//成绩</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">char</span>* <span class="title">GetStudentName</span><span class="params">(struct Student* stu)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetStudentName</span><span class="params">(struct Student* stu, <span class="keyword">char</span>* newName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 略</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Student</span> <span class="title">s1</span>, <span class="title">s2</span>, <span class="title">s3</span>, <span class="title">s4</span>;</span> <span class="comment">// 创建了多个学生</span></span><br><span class="line">    SetStudentName(&amp;s1, <span class="string">"小明"</span>);</span><br><span class="line">    SetStudentName(&amp;s2, <span class="string">"小红"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>其次 OOP 面向对象编程，在做一件什么事情？</p>
<ul>
<li><p>在面对复杂性业务需求中，面向对象思想可以将业务先进行分析，如果业务需求全新无关联，那我们可以新建一个对象，在里面封装对应的方法；如果业务需求只是一条延展线（比如特定节假日打折），那我们可以继承现有对象，并对现有对象的某些方法（discount），进行特定操作，即多态：用统一的方法对不同的对象进行同样的操作。</p>
  <figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">override</span> fun <span class="title">discount</span><span class="params">(price: Double)</span>: Double </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (!isCouple()) <span class="keyword">return</span> price</span><br><span class="line">       <span class="keyword">if</span> (price &gt; <span class="number">99</span>) &#123;</span><br><span class="line">           val lucky = Random().nextInt(gifts.<span class="built_in">size</span>)</span><br><span class="line">           <span class="built_in">println</span>(<span class="string">"Congratulations on getting $&#123;gifts[lucky]&#125;!"</span>)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> price * <span class="number">0.77</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>而面对这种频繁操作数据单元的使用面向过程编程思想，可能会在现有对象加上判断，万一节假日还要做其他的业务，判断只会越来越多。这就与我们 Nicklaus Wirth 提出的：<strong>程序 = 数据结构 + 算法</strong>，越来越割裂。</li>
</ul>
</li>
<li><p>在我现在的浅薄思考看来：面向对象编程思想比较广泛的 Object-based 实现是想先让不同对象以尽可能的统一特性进行归组，形成“大对象”，然后各个对象变成了这个大对象中衍生出来的基类，并在父类派生出来的对象中，去实现各自解决问题的具体方法。这样当我们在拿到一个问题，我们可以不用去管它的内部实现，我们根据类型就可以知道它能做什么事，这比我们手动去一步一步执行要先进点。<strong>让对象有多态性，把不同对象以同一特性来归组，统一处理。至于所谓继承等概念，是实现的细节</strong>。</p>
</li>
</ul>
</li>
</ul>
<h2 id="prototype-based-programming"><a href="#prototype-based-programming" class="headerlink" title="prototype-based programming"></a>prototype-based programming</h2><ul>
<li><p>Languages with abstract data type support which may be used to <strong>resemble OO programming</strong>, but <strong>without all features of object-orientation</strong>. This includes object-based and <strong>prototype-based languages</strong>. Examples: JavaScript, Lua, Modula-2, CLU.</p>
</li>
<li><p>The Document Object Model of HTML, XHTML, and XML documents on the Internet has bindings to the popular JavaScript/ECMAScript language. <strong>JavaScript is perhaps the best known prototype-based programming language, which employs cloning from prototypes rather than inheriting from a class (contrast to class-based programming)</strong>. </p>
</li>
<li><p>我们在大概了解了 OOP 思想后，我们可以继续看看 OOP编程思想的另一种实现“类OOP”–基于原型编程 Javascript 实现</p>
</li>
<li><p>我们可以先从 ECMA-262 规范中找到关于 Object 的定义</p>
<ul>
<li>“Objects are created by using constructors in <strong>new expressions</strong>.”</li>
<li>“Each constructor is a function that has a property named <strong>‘prototype’ that is used to implement prototype-based inheritance and shared properties</strong>.”</li>
<li>“Every object created by a constructor has an implicit reference (called the object’s prototype) to the value of its constructor’s ‘prototype’ property. Furthermore, a prototype may have a non-null implicit reference to its prototype, and so on; this is called the prototype chain. When a reference is made to a property in an object, that reference is to the property of that name in the first object in the prototype chain that contains a property of that name. In other words, first the object mentioned directly is examined for such a property; if that object contains the named property, that is the property to which the reference refers; if that object does not contain the named property, the prototype for that object is examined next; and so on.”</li>
<li><img src="http://p0.meituan.net/myvideodistribute/54f432d1395e59da48e0e7935ffd7665110363.png" alt="ECMA原型链"></li>
</ul>
</li>
<li><p>同时 Douglas Crockford 关于 <a href="https://crockford.com/javascript/prototypal.html" target="_blank" rel="noopener">prototypal inheritance</a></p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">object</span>(<span class="params">o</span>) </span>&#123;</span><br><span class="line">       <span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">       F.prototype = o;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> F();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>“The object function untangles JavaScript’s constructor pattern, achieving true prototypal inheritance. It takes an old object as a parameter and returns an empty new object that inherits from the old one. If we attempt to obtain a member from the new object, and it lacks that key, then the old object will supply the member. Objects inherit from objects.”</li>
<li>“What could be more object oriented than that?” 😝</li>
</ul>
</li>
<li><p>也有新的对 Object 的思考</p>
<ul>
<li>“In JavaScript, <strong>an object is an associative array</strong>, augmented with a prototype (see below); each string key provides the name for an object property, and there are two syntactical ways to specify such a name: dot notation (obj.x = 10) and bracket notation (obj[‘x’] = 10). A property may be added, rebound, or deleted at run-time. Most properties of an object (and any property that belongs to an object’s prototype inheritance chain) can be enumerated using a for…in loop.”</li>
</ul>
</li>
</ul>
<h2 id="Functional-programming"><a href="#Functional-programming" class="headerlink" title="Functional programming"></a>Functional programming</h2><ul>
<li>Functional programming has its origins in lambda calculus.It is a programming paradigm —- a style of building the structure and elements of computer programs – that treats computation as the evaluation of mathematical functions and avoids changing-state and mutable data.</li>
<li>One of the key motivations for the development of functional programming is making a program easier to understand by eliminating changes in state that <strong>do not depend on function inputs</strong> which are called side effects.</li>
<li>side effects include modifying a non-local variable, modifying a static local variable, modifying a mutable argument passed by reference, performing I/O or calling other side-effect functions.</li>
<li>referential transparency<ul>
<li>the same language expression can result in different values at different times depending on the state of the executing program.</li>
<li>Consider C assignment statement x = x * 10, this changes the value assigned to the variable x. Let us say that the initial value of x was 1, then two consecutive evaluations of the variable x yields 10 and 100 respectively. Clearly, replacing x = x * 10 with either 10 or 100 gives a program with different meaning, and so the expression is not referentially transparent. In fact, assignment statements are never referentially transparent.</li>
<li>Absence of side effects is a necessary, but not sufficient, condition for referential transparency. <strong>Referential transparency means that an expression (such as a function call) can be replaced with its value</strong>. This requires that the expression is pure, that is to say the expression must be deterministic (always give the same value for the same input) and side-effect free.</li>
</ul>
</li>
</ul>
<h2 id="个人总结"><a href="#个人总结" class="headerlink" title="个人总结"></a>个人总结</h2><ul>
<li>Javasript 说它是基于面向对象的编程语言是不严谨的，准确的说他是面向对象的编程语言，的基于原型实现的编程语言。</li>
</ul>
<h2 id="All-Objects-in-Javascript"><a href="#All-Objects-in-Javascript" class="headerlink" title="All Objects in Javascript"></a>All Objects in Javascript</h2><ul>
<li><p>可参考<a href="https://www.ecma-international.org/publications/standards/Ecma-262.htm" target="_blank" rel="noopener">ECMA-Script 262 Chapter18.3 Constructor Properties of the Global Object P399</a> </p>
<table>
<thead>
<tr>
<th>基本类型</th>
<th>Error</th>
<th>数据结构 &amp; 内置对象</th>
<th>TypedArray</th>
</tr>
</thead>
<tbody><tr>
<td>Boolean</td>
<td>Error</td>
<td>Array</td>
<td>Float32Array</td>
</tr>
<tr>
<td>Number</td>
<td>EvalError</td>
<td>ArrayBuffer</td>
<td>Float64Array</td>
</tr>
<tr>
<td>Object</td>
<td>RangeError</td>
<td>DataView</td>
<td>Int8Array</td>
</tr>
<tr>
<td>String</td>
<td>ReferenceError</td>
<td>Date</td>
<td>Int16Array</td>
</tr>
<tr>
<td>Symbol</td>
<td>SyntaxError</td>
<td>Function</td>
<td>Int32Array</td>
</tr>
<tr>
<td></td>
<td>TypeError</td>
<td>Map</td>
<td>Uint8Array</td>
</tr>
<tr>
<td></td>
<td>URIError</td>
<td>Promise</td>
<td>Uint8ClampedArray</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Proxy</td>
<td>Uint16Array</td>
</tr>
<tr>
<td></td>
<td></td>
<td>RegExp</td>
<td>Uint32Array</td>
</tr>
<tr>
<td></td>
<td></td>
<td>Set</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>SharedArrayBuffer</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>WeakMap</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>WeakSet</td>
<td></td>
</tr>
</tbody></table>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects" target="_blank" rel="noopener">引入 Javascript 对象</a></li>
<li><a href="https://software.intel.com/en-us/blogs/2008/08/22/flaws-of-object-oriented-modeling/" target="_blank" rel="noopener">Flaws of Object Oriented Modeling</a></li>
<li><a href="https://books.google.com/books?id=xb-sAQAAQBAJ&printsec=frontcover&dq=isbn:9788090466180&hl=zh-CN&sa=X&ved=0ahUKEwiG-8y8qdroAhWmUt8KHey5Dl0Q6AEIKDAA#v=onepage&q&f=false" target="_blank" rel="noopener">learn object oriented thinking &amp; programming</a></li>
<li><a href="https://books.google.com/books?id=WzsFCAAAQBAJ&printsec=frontcover&dq=isbn:9780735619654&hl=zh-CN&sa=X&ved=0ahUKEwiqzaPSqNroAhVvUd8KHc80CYEQ6AEIKDAA#v=onepage&q&f=false" target="_blank" rel="noopener">Obejct thinking</a></li>
<li><a href="https://en.wikipedia.org/wiki/JavaScript" target="_blank" rel="noopener">Javascript Object-orientation (prototype-based)</a></li>
<li><a href="https://www.codeproject.com/Articles/22769/Introduction-to-Object-Oriented-Programming-Concep" target="_blank" rel="noopener">Introduction to Object Oriented Programming Concepts (OOP) and More</a></li>
<li><a href="https://en.wikipedia.org/wiki/Functional_programming" target="_blank" rel="noopener">Functional_programming wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Side_effect_(computer_science)" target="_blank" rel="noopener">Side effect wikipedia</a></li>
<li><a href="https://en.wikipedia.org/wiki/Object-oriented_programming" target="_blank" rel="noopener">Object-oriented programming wikipedia</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>有对 Object 以及对 reference 产生的 side effects<br>新的认识</li>
<li>闭包 closure<ul>
<li>A nested function is a function defined within another function. It is created each time the outer function is invoked. In addition, each nested function forms a lexical closure: The lexical scope of the outer function (including any constant, local variable, or argument value) becomes part of the internal state of each inner function object, even after execution of the outer function concludes.</li>
</ul>
</li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Toy Browser DAY1</title>
    <url>/2020/05/10/Toy-Browser-DAY1/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>



<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>implementation of a toy-browser 🙆</li>
</ul>
<a id="more"></a>


<h2 id="实践过程"><a href="#实践过程" class="headerlink" title="实践过程"></a>实践过程</h2><h3 id="Server-端实现"><a href="#Server-端实现" class="headerlink" title="Server 端实现"></a>Server 端实现</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;&#x2F; Returns content-type &#x3D; text&#x2F;plain</span><br><span class="line">const server &#x3D; http.createServer((req, res) &#x3D;&gt; &#123;</span><br><span class="line">  res.setHeader(&#39;Content-Type&#39;, &#39;text&#x2F;html&#39;);</span><br><span class="line">  res.setHeader(&#39;X-Foo&#39;, &#39;bar&#39;);</span><br><span class="line">  res.writeHead(200, &#123; &#39;Content-Type&#39;: &#39;text&#x2F;plain&#39; &#125;);</span><br><span class="line">  res.end(&#39;ok&#39;);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(8088);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>When headers have been set with response.setHeader(), they will be merged with any headers passed to response.writeHead(), with the headers passed to <strong>response.writeHead() given precedence</strong>.</p>
</blockquote>
<ul>
<li>writeHead 与 setHeader 相比，具有更高的优先级</li>
<li>所以最终的请求体头 ‘Content-Type’: ‘text/plain’</li>
<li>这里我们让它监听 8088 端口，因为默认的 80端口，可能会存在占用</li>
<li>我们可以在浏览器中，对 <a href="http://127.0.0.1:8088/" target="_blank" rel="noopener">http://127.0.0.1:8088/</a> 访问，最后我们要利用 toy-browser 简单模拟<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/aa69465245fc64274c75ac4e5aab244691470.png" alt="浏览器行为"></li>
</ul>
</li>
</ul>
<h3 id="Client-端实现"><a href="#Client-端实现" class="headerlink" title="Client 端实现"></a>Client 端实现</h3><h4 id="第一版：简单实现"><a href="#第一版：简单实现" class="headerlink" title="第一版：简单实现"></a>第一版：简单实现</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">const net &#x3D; require(&#39;net&#39;);</span><br><span class="line">const client &#x3D; net.createConnection(&#123; port: 8088 &#125;, () &#x3D;&gt; &#123;</span><br><span class="line">  &#x2F;&#x2F; &#39;connect&#39; listener.</span><br><span class="line">  console.log(&#39;connected to server!&#39;);</span><br><span class="line">  client.write(&#39;POST &#x2F; HTTP&#x2F;1.1\r\n&#39;);</span><br><span class="line">  client.write(&#39;HOST: 127.0.0.1\r\n&#39;);</span><br><span class="line">  client.write(&#39;Content-Length: 9\r\n&#39;);</span><br><span class="line">  client.write(&#39;Content-Type: application&#x2F;x-www-form-urlencoded\r\n&#39;);</span><br><span class="line">  client.write(&#39;\r\n&#39;);</span><br><span class="line">  client.write(&#39;name&#x3D;elle&#39;);</span><br><span class="line">  client.write(&#39;\r\n&#39;);</span><br><span class="line">&#125;);</span><br><span class="line">client.on(&#39;data&#39;, (data) &#x3D;&gt; &#123;</span><br><span class="line">  console.log(data.toString());</span><br><span class="line">  client.end();</span><br><span class="line">&#125;);</span><br><span class="line">client.on(&#39;end&#39;, () &#x3D;&gt; &#123;</span><br><span class="line">  console.log(&#39;disconnected from server&#39;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>我们开启服务端<blockquote>
<p>node server.js</p>
</blockquote>
</li>
</ul>
<ul>
<li>再开启客户端<blockquote>
<p>node client.js</p>
</blockquote>
</li>
</ul>
<ul>
<li><p>运行截图</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/5a4f9f936d87d43335d08670a03205a448885.png" alt="client"></li>
<li><img src="http://p1.meituan.net/myvideodistribute/115d90c1e9de7f974d7749988e01c87332973.png" alt="server"></li>
</ul>
</li>
<li><p>我们可以看到请求成功的发出，并且服务端也进行了正确的反馈。</p>
<ul>
<li>请求体：name=elle，’content-length’: ‘9’</li>
</ul>
</li>
</ul>
<h4 id="第二版：对-request-进行简单封装"><a href="#第二版：对-request-进行简单封装" class="headerlink" title="第二版：对 request 进行简单封装"></a>第二版：对 request 进行简单封装</h4><ul>
<li><p>简单分析 request 构造器所需内容</p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/7663a0cff7c034fbeadce907b2e445b588991.png" alt="request"></p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// request line</span></span><br><span class="line">  <span class="comment">// method, url = host + port + path</span></span><br><span class="line"><span class="comment">// headers</span></span><br><span class="line">  <span class="comment">// Content-Type</span></span><br><span class="line">    <span class="comment">// Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line">    <span class="comment">// Content-Type: application/json</span></span><br><span class="line">    <span class="comment">// Content-Type: multipart/form-data</span></span><br><span class="line">    <span class="comment">// Content-Type: text/xml</span></span><br><span class="line">  <span class="comment">// Content-Length</span></span><br><span class="line"><span class="comment">// body: k-v</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>我们可以简单写出封装后的 reqeust</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Request</span> </span>&#123;</span><br><span class="line">    <span class="comment">// request line</span></span><br><span class="line">      <span class="comment">// method, url = host + port + path</span></span><br><span class="line">    <span class="comment">// headers</span></span><br><span class="line">      <span class="comment">// Content-Type</span></span><br><span class="line">        <span class="comment">// Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line">        <span class="comment">// Content-Type: application/json</span></span><br><span class="line">        <span class="comment">// Content-Type: multipart/form-data</span></span><br><span class="line">        <span class="comment">// Content-Type: text/xml</span></span><br><span class="line">      <span class="comment">// Content-Length</span></span><br><span class="line">    <span class="comment">// body: k-v</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(options) &#123;</span><br><span class="line">    <span class="keyword">this</span>.method = options.method || <span class="string">"GET"</span></span><br><span class="line">    <span class="keyword">this</span>.host = options.host</span><br><span class="line">    <span class="keyword">this</span>.port = options.port || <span class="number">80</span></span><br><span class="line">    <span class="keyword">this</span>.path = options.path || <span class="string">"/"</span></span><br><span class="line">    <span class="keyword">this</span>.body = options.body || &#123;&#125;</span><br><span class="line">    <span class="keyword">this</span>.headers = options.headers || &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.headers[<span class="string">"Content-Type"</span>]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.headers[<span class="string">"Content-Type"</span>] = <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.headers[<span class="string">"Content-Type"</span>] === <span class="string">"application/json"</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.bodyText = <span class="built_in">JSON</span>.stringify(<span class="keyword">this</span>.body)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.headers[<span class="string">"Content-Type"</span>] === <span class="string">"application/x-www-form-urlencoded"</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.bodyText = <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.body).map(<span class="function"><span class="params">key</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;key&#125;</span>=<span class="subst">$&#123;<span class="built_in">encodeURIComponent</span>(<span class="keyword">this</span>.body[key])&#125;</span>`</span>).join(<span class="string">'&amp;'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// calculate Content-Length</span></span><br><span class="line">    <span class="keyword">this</span>.headers[<span class="string">"Content-Length"</span>] = <span class="keyword">this</span>.bodyText.length</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.method&#125;</span> <span class="subst">$&#123;<span class="keyword">this</span>.path&#125;</span> HTTP/1.1\r\nHOST: <span class="subst">$&#123;<span class="keyword">this</span>.host&#125;</span>\r\n<span class="subst">$&#123;<span class="built_in">Object</span>.keys(<span class="keyword">this</span>.headers).map(key =&gt; <span class="string">`<span class="subst">$&#123;key&#125;</span>: <span class="subst">$&#123;<span class="keyword">this</span>.headers[key]&#125;</span>`</span>).join(<span class="string">'\r\n'</span>)&#125;</span>\r\n\r\n<span class="subst">$&#123;<span class="keyword">this</span>.bodyText&#125;</span>\r\n`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>再利用封装后的 request 进行 client 访问</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> net = <span class="built_in">require</span>(<span class="string">"net"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> client = net.createConnection(&#123;</span><br><span class="line">  host: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">  port: <span class="number">8088</span></span><br><span class="line">&#125;, () =&gt; &#123;</span><br><span class="line">  <span class="comment">// 'connect' listener.</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'connected to server!'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> options = &#123;</span><br><span class="line">    method: <span class="string">"POST"</span>,</span><br><span class="line">    path: <span class="string">"/"</span>,</span><br><span class="line">    host: <span class="string">"127.0.0.1"</span>,</span><br><span class="line">    port: <span class="number">8088</span>,</span><br><span class="line">    headers: &#123;</span><br><span class="line">      [<span class="string">"X-Foo2"</span>]: <span class="string">"customed"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    body: &#123;</span><br><span class="line">      name: <span class="string">"elle"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> request = <span class="keyword">new</span> Request(options)</span><br><span class="line">  client.write(request.toString());</span><br><span class="line">&#125;);</span><br><span class="line">client.on(<span class="string">'data'</span>, (data) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(data.toString());</span><br><span class="line">  client.end();</span><br><span class="line">&#125;);</span><br><span class="line">client.on(<span class="string">'end'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'disconnected from server'</span>);</span><br><span class="line">&#125;);</span><br><span class="line">client.on(<span class="string">'error'</span>, (err) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(err);</span><br><span class="line">  client.end();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/19807e0f02f52d93b9391645a286cfdf48815.png" alt="封装后的request"></li>
</ul>
</li>
</ul>
<h4 id="第三版：对-responseParse-进行封装"><a href="#第三版：对-responseParse-进行封装" class="headerlink" title="第三版：对 responseParse 进行封装"></a>第三版：对 responseParse 进行封装</h4><ul>
<li><p>简单分析 response 内容框架</p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/9c17bab40bf615430215e496d9bdfeb5147249.png" alt="response内容框架"></p>
</li>
<li><p>开始我们的状态机 constructor 简单编写</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">constructor</span>() &#123;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_STATUS_LINE = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_STATUS_LINE_END = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_HEADER_NAME = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_HEADER_SPACE = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_HEADER_VALUE = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_HEADER_LINE_END = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_HEADER_BLOCK_END = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_BODY = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_STATUS_LINE;</span><br><span class="line">  <span class="keyword">this</span>.statusLine = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">this</span>.headers = &#123;&#125;;</span><br><span class="line">  <span class="keyword">this</span>.headerName = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">this</span>.headerValue = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">this</span>.bodyParse = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>对 response 字符流进行处理。循环读取流中数据</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字符流处理</span></span><br><span class="line">receive(string) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; string.length; i++) &#123;</span><br><span class="line">      <span class="keyword">this</span>.receiveChar(string.charAt(i));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>对流中单个字符进行扫描</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">receiveChar(char) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_STATUS_LINE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\r'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_STATUS_LINE_END</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.statusLine += char</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_STATUS_LINE_END) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_HEADER_NAME</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_HEADER_NAME) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">':'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_HEADER_SPACE</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char === <span class="string">'\r'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_HEADER_BLOCK_END</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.headers[<span class="string">'Transfer-Encoding'</span>] === <span class="string">'chunked'</span>)</span><br><span class="line">        <span class="keyword">this</span>.bodyParse = <span class="keyword">new</span> TrunkedBodyParser();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.headerName += char</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_HEADER_SPACE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">' '</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_HEADER_VALUE</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_HEADER_VALUE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\r'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_HEADER_LINE_END</span><br><span class="line">      <span class="keyword">this</span>.headers[<span class="keyword">this</span>.headerName] = <span class="keyword">this</span>.headerValue</span><br><span class="line">      <span class="keyword">this</span>.headerName = <span class="string">""</span></span><br><span class="line">      <span class="keyword">this</span>.headerValue = <span class="string">""</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.headerValue += char</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_HEADER_LINE_END) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_HEADER_NAME</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_HEADER_BLOCK_END) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_BODY</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_BODY) &#123;</span><br><span class="line">    <span class="keyword">this</span>.bodyParse.receiveChar(char)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>简单分析 server 端的 TrunkBody </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">2</span> <span class="comment">// 下一行 trunk 长度</span></span><br><span class="line">ok <span class="comment">// trunk 内容</span></span><br><span class="line"><span class="number">0</span> <span class="comment">// trunk 终止，再没有内容</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>开始我们的 TrunkedBodyParser 状态机 constructor 简单编写</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">constructor</span>() &#123;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_LENGTH = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_LENGTH_LINE_END = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">this</span>.READING_TRUNK = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_NEW_LINE = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">this</span>.WAITING_NEW_LINE_END = <span class="number">4</span>;</span><br><span class="line">  <span class="keyword">this</span>.FINISHED_NEW_LINE = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">this</span>.FINISHED_NEW_LINE_END = <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">this</span>.isFinished = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">this</span>.length = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>.content = [];</span><br><span class="line">  <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_LENGTH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>TrunkBody 字符处理</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字符流处理</span></span><br><span class="line">receiveChar(char) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_LENGTH) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\r'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.current = <span class="keyword">this</span>.FINISHED_NEW_LINE</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_LENGTH_LINE_END</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.length *= <span class="number">10</span></span><br><span class="line">      <span class="keyword">this</span>.length += char.charCodeAt(<span class="number">0</span>) - <span class="string">'0'</span>.charCodeAt(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">				</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_LENGTH_LINE_END) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.READING_TRUNK</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">				</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.READING_TRUNK) &#123;</span><br><span class="line">    <span class="keyword">this</span>.content.push(char)</span><br><span class="line">    <span class="keyword">this</span>.length --</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_NEW_LINE</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">				</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_NEW_LINE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\r'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_NEW_LINE_END</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">				</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_NEW_LINE_END) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_LENGTH</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">				</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.FINISHED_NEW_LINE) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\r'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.current = <span class="keyword">this</span>.FINISHED_NEW_LINE_END</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">				</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.FINISHED_NEW_LINE_END) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\n'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.isFinished = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
















</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/50256a14d9171b06c374dc7e6894efcf61275.png" alt="client"></li>
<li><img src="http://p0.meituan.net/myvideodistribute/23ed78fb0b5598952897249eb5ae2fbb29575.png" alt="server"></li>
</ul>
</li>
</ul>
<h2 id="错误修改"><a href="#错误修改" class="headerlink" title="错误修改"></a>错误修改</h2><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/fd4b58c42c99e0f2754c025b6682307650941.png" alt="错误修改"></li>
<li>server 端长度计算不是十进制，是十六进制</li>
</ul>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 字符流处理</span></span><br><span class="line">receiveChar(char) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.current === <span class="keyword">this</span>.WAITING_LENGTH) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char === <span class="string">'\r'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.length === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.current = <span class="keyword">this</span>.FINISHED_NEW_LINE</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.current = <span class="keyword">this</span>.WAITING_LENGTH_LINE_END</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.length *= <span class="number">16</span></span><br><span class="line">      <span class="keyword">this</span>.length += <span class="built_in">parseInt</span>(char, <span class="number">16</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://nodejs.org/dist/latest-v12.x/docs/api/http.html" target="_blank" rel="noopener">Node.js v12.16.3 Documentation</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li><a href="https://github.com/Ele-Peng/toy-browser" target="_blank" rel="noopener">完整代码地址-点击一下</a></li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>浏览器</category>
      </categories>
      <tags>
        <tag>浏览器</tag>
      </tags>
  </entry>
  <entry>
    <title>Toy-Browser-DAY3</title>
    <url>/2020/05/17/Toy-Browser-DAY3/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>



<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>implementation of a toy-browser 🙆</li>
<li>我们开始进入到 CSS Computing 啦！！！😘</li>
<li><img src="http://p0.meituan.net/myvideodistribute/4bb352346db82d88a68035a6ddad906c81827.png" alt="CSS Computing"><a id="more"></a>


</li>
</ul>
<h2 id="实践记录"><a href="#实践记录" class="headerlink" title="实践记录"></a>实践记录</h2><h3 id="实践准备"><a href="#实践准备" class="headerlink" title="实践准备"></a>实践准备</h3><blockquote>
<p>npm install css</p>
</blockquote>
<h3 id="第一步：收集-CSS-规则"><a href="#第一步：收集-CSS-规则" class="headerlink" title="第一步：收集 CSS 规则"></a>第一步：收集 CSS 规则</h3><ul>
<li><p>遇到 style 标签时，我们把 CSS 规则保存起来</p>
</li>
<li><p>这里我们调用 CSS Parser 来分析 CSS 规则</p>
</li>
<li><p>这里我们必须要仔细研究此库分析 CSS 规则的格式</p>
</li>
<li><p>computeCss1.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> css = <span class="built_in">require</span>(<span class="string">'css'</span>)</span><br><span class="line"></span><br><span class="line">... some code</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加入一个新的函数，addCSSRules，这里我们把 CSS 规则暂存到一个数组里</span></span><br><span class="line"><span class="keyword">let</span> rules = []</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addCSSRules</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ast = css.parse(text)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="built_in">JSON</span>.stringify(ast, <span class="literal">null</span>, <span class="string">"    "</span>))</span><br><span class="line">  rules.push(...ast.stylesheet.rules)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emit</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  ... some code</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (token.type == <span class="string">"endTag"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (top.tagName != token.tagName) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Tag start end doesn't match"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// console.log('pop', stack.pop())</span></span><br><span class="line">      <span class="comment">/** 遇到 style 标签时，执行添加 CCS 规则的操作 */</span></span><br><span class="line">      <span class="keyword">if</span> (top.tagName === <span class="string">"style"</span>) &#123;</span><br><span class="line">        addCSSRules(top.children[<span class="number">0</span>].content)</span><br><span class="line">      &#125;</span><br><span class="line">      stack.pop()</span><br><span class="line">    &#125;</span><br><span class="line">    currentTextNode = <span class="literal">null</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ... some code</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>这里，我们需要将添加 CSS 规则操作至元素 pop前，元素 push 后</p>
<ul>
<li>元素 push 后，也就是 style 标签的子元素文本节点，还未挂载到 style 标签上，styles 标签子元素还是空的</li>
<li>pop 前，我们可以取到这个元素</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/01014f5e30127ef5f2b23dd6b7fa44ac153947.png" alt="第一步运行结果"></li>
</ul>
</li>
<li><p>文本结果</p>
  <figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"stylesheet"</span>,</span><br><span class="line">    <span class="attr">"stylesheet"</span>: &#123;</span><br><span class="line">        <span class="attr">"rules"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"rule"</span>,</span><br><span class="line">                <span class="attr">"selectors"</span>: [</span><br><span class="line">                    <span class="string">"body div #myid"</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">"declarations"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"declaration"</span>,</span><br><span class="line">                        <span class="attr">"property"</span>: <span class="string">"width"</span>,</span><br><span class="line">                        <span class="attr">"value"</span>: <span class="string">"100px"</span>,</span><br><span class="line">                        <span class="attr">"position"</span>: &#123;</span><br><span class="line">                            <span class="attr">"start"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">3</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">9</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"end"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">3</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">20</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"declaration"</span>,</span><br><span class="line">                        <span class="attr">"property"</span>: <span class="string">"background-color"</span>,</span><br><span class="line">                        <span class="attr">"value"</span>: <span class="string">"#ff5000"</span>,</span><br><span class="line">                        <span class="attr">"position"</span>: &#123;</span><br><span class="line">                            <span class="attr">"start"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">4</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">9</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"end"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">4</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">34</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">"position"</span>: &#123;</span><br><span class="line">                    <span class="attr">"start"</span>: &#123;</span><br><span class="line">                        <span class="attr">"line"</span>: <span class="number">2</span>,</span><br><span class="line">                        <span class="attr">"column"</span>: <span class="number">5</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"end"</span>: &#123;</span><br><span class="line">                        <span class="attr">"line"</span>: <span class="number">5</span>,</span><br><span class="line">                        <span class="attr">"column"</span>: <span class="number">6</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">"type"</span>: <span class="string">"rule"</span>,</span><br><span class="line">                <span class="attr">"selectors"</span>: [</span><br><span class="line">                    <span class="string">"body div img"</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">"declarations"</span>: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"declaration"</span>,</span><br><span class="line">                        <span class="attr">"property"</span>: <span class="string">"width"</span>,</span><br><span class="line">                        <span class="attr">"value"</span>: <span class="string">"30px"</span>,</span><br><span class="line">                        <span class="attr">"position"</span>: &#123;</span><br><span class="line">                            <span class="attr">"start"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">7</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">9</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"end"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">7</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">19</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;,</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="attr">"type"</span>: <span class="string">"declaration"</span>,</span><br><span class="line">                        <span class="attr">"property"</span>: <span class="string">"background-color"</span>,</span><br><span class="line">                        <span class="attr">"value"</span>: <span class="string">"#ff1111"</span>,</span><br><span class="line">                        <span class="attr">"position"</span>: &#123;</span><br><span class="line">                            <span class="attr">"start"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">8</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">9</span></span><br><span class="line">                            &#125;,</span><br><span class="line">                            <span class="attr">"end"</span>: &#123;</span><br><span class="line">                                <span class="attr">"line"</span>: <span class="number">8</span>,</span><br><span class="line">                                <span class="attr">"column"</span>: <span class="number">34</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">"position"</span>: &#123;</span><br><span class="line">                    <span class="attr">"start"</span>: &#123;</span><br><span class="line">                        <span class="attr">"line"</span>: <span class="number">6</span>,</span><br><span class="line">                        <span class="attr">"column"</span>: <span class="number">5</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">"end"</span>: &#123;</span><br><span class="line">                        <span class="attr">"line"</span>: <span class="number">9</span>,</span><br><span class="line">                        <span class="attr">"column"</span>: <span class="number">6</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">"parsingErrors"</span>: []</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="第二步：添加调用"><a href="#第二步：添加调用" class="headerlink" title="第二步：添加调用"></a>第二步：添加调用</h3><ul>
<li><p>当我们创建一个元素后，立即计算 CSS</p>
</li>
<li><p>理论上，当我们分析一个元素时，所有 CSS 规则已经收集完毕</p>
</li>
<li><p>在真实浏览器中，可能遇到写在 body 的 style 标签，需要重新 CSS 计算的情况，这里我们忽略</p>
</li>
<li><p>computeCSS2.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeCSS</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(rules)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"-=-=-=-=-=-=-="</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"compute CSS for Element-=-=-=-=-=-="</span>, element)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"********************************************"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emit</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  ... some code</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (token.type == <span class="string">"startTag"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> element = &#123;</span><br><span class="line">      type: <span class="string">"element"</span>,</span><br><span class="line">      children: [],</span><br><span class="line">      attributes: []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    element.tagName = token.tagName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">in</span> token) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="string">"type"</span> &amp;&amp; p != <span class="string">"tagName"</span>) &#123;</span><br><span class="line">        element.attributes.push(&#123;</span><br><span class="line">          name: p,</span><br><span class="line">          value: token[p]</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    computeCSS(element)</span><br><span class="line"></span><br><span class="line">    top.children.push(element)</span><br><span class="line">    element.parent = top</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!token.isSelfClosing)</span><br><span class="line">      stack.push(element)</span><br><span class="line">    </span><br><span class="line">    currentTextNode = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// console.log('push', element)</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  ... some code</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>这里一个元素的创建后，tagName, 属性都加好后，就应该有一个 cumputeCSS 过程</p>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/634ec08db6e9b90b38c17656be424e2d127292.png" alt="第二步：添加调用"></li>
</ul>
</li>
</ul>
<h3 id="第三步：获取父元素序列"><a href="#第三步：获取父元素序列" class="headerlink" title="第三步：获取父元素序列"></a>第三步：获取父元素序列</h3><ul>
<li><p>在 computeCss 函数中，我们必须知道元素的所有父元素才能判断元素与规则是否匹配</p>
</li>
<li><p>我们从上一步骤的 stack，可以获取本元素所有的父元素</p>
</li>
<li><p>因为我们首先获取的是”当前元素“，所以我们获得和计算父元素匹配的顺序是从内向外</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/68af300e9e207b8a190b7c3893f17ff036554.png" alt="从内向外 CSS 匹配"></li>
</ul>
</li>
<li><p>computeCSS3.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeCSS</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">     <span class="keyword">const</span> elements = stack.slice().reverse()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...some code</span><br></pre></td></tr></table></figure></li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/706c9c25bc5a46f41f8bc11ba2a6854e250838.png" alt="第三步运行结果"></li>
</ul>
</li>
<li><p>stack.slice() 拷贝原数组，不在 stack 中操作，防御式编程避免影响 stack</p>
</li>
</ul>
<h3 id="第四步：拆分选择器"><a href="#第四步：拆分选择器" class="headerlink" title="第四步：拆分选择器"></a>第四步：拆分选择器</h3><ul>
<li><p>选择器也要从当前元素从外排列</p>
</li>
<li><p>复杂选择器拆成针对单个元素的选择器，用循环匹配父元素队列</p>
</li>
<li><p>computeCSS4.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">	</span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">specificity</span>(<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">  <span class="keyword">const</span> selectorParts = selector.split(<span class="string">" "</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> part <span class="keyword">of</span> selectorParts) &#123;</span><br><span class="line">    <span class="keyword">if</span> (part.charAt(<span class="number">0</span>) == <span class="string">"#"</span>) &#123;</span><br><span class="line">      p[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (part.charAt(<span class="number">0</span>) == <span class="string">"."</span>) &#123;</span><br><span class="line">      p[<span class="number">2</span>] += <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      p[<span class="number">3</span>] += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compare</span>(<span class="params">sp1, sp2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sp1[<span class="number">0</span>] - sp2[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> sp1[<span class="number">0</span>] - sp2[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sp1[<span class="number">1</span>] - sp2[<span class="number">1</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> sp1[<span class="number">1</span>] - sp2[<span class="number">1</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sp1[<span class="number">2</span>] - sp2[<span class="number">2</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> sp1[<span class="number">2</span>] - sp2[<span class="number">2</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sp1[<span class="number">3</span>] - sp2[<span class="number">3</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">function</span> <span class="title">computeCSS</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> elements = stack.slice().reverse()</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (!element.computedStyle)</span><br><span class="line">	    element.computedStyle = &#123;&#125;</span><br><span class="line">	  </span><br><span class="line">	  <span class="keyword">for</span> (<span class="keyword">let</span> rule <span class="keyword">of</span> rules) &#123;</span><br><span class="line">	    <span class="keyword">const</span> selectorParts = rule.selectors[<span class="number">0</span>].split(<span class="string">" "</span>).reverse()</span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">if</span> (!match(element, selectorParts[<span class="number">0</span>]))</span><br><span class="line">	      <span class="keyword">continue</span></span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">let</span> matched = <span class="literal">false</span></span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">let</span> j = <span class="number">1</span></span><br><span class="line">	</span><br><span class="line">	    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; elements.length; i ++) &#123;</span><br><span class="line">	      <span class="keyword">if</span> (match(elements[i], selectorParts[j])) &#123;</span><br><span class="line">	        j ++</span><br><span class="line">	      &#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (j &gt;= selectorParts.length) &#123;</span><br><span class="line">	      matched = <span class="literal">true</span></span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="keyword">if</span> (matched) &#123; <span class="comment">// 匹配成功</span></span><br><span class="line">	      <span class="built_in">console</span>.log(<span class="string">"Element"</span>, element, <span class="string">"matched rule"</span>, rule)</span><br><span class="line">	    &#125;</span><br><span class="line">	  &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	...some code</span><br></pre></td></tr></table></figure>


</li>
</ul>
<h3 id="第五步：计算选择器与元素匹配"><a href="#第五步：计算选择器与元素匹配" class="headerlink" title="第五步：计算选择器与元素匹配"></a>第五步：计算选择器与元素匹配</h3><ul>
<li><p>根据选择器的类型和元素属性，计算是否与当前元素匹配</p>
</li>
<li><p>这里仅实现了三种基本选择器，实际的浏览器中要处理复合选择器</p>
</li>
<li><p>computeCSS5.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">element, selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!selector || !element.attributes) </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (selector.charAt(<span class="number">0</span>) == <span class="string">"#"</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> attr = element.attributes.filter(<span class="function"><span class="params">attr</span> =&gt;</span> attr.name === <span class="string">"id"</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (attr &amp;&amp; attr.value === selector.replace(<span class="string">"#"</span>, <span class="string">''</span>))</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (selector.charAt(<span class="number">0</span>) == <span class="string">"."</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> attr = element.attributes.filter(<span class="function"><span class="params">attr</span> =&gt;</span> attr.name === <span class="string">"class"</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (attr &amp;&amp; attr.value === selector.replace(<span class="string">"."</span>, <span class="string">''</span>))</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (element.tagName === selector) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...some code</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/e23fb1db77239166c990b52468b24451353540.png" alt="第五步运行结果"></li>
</ul>
</li>
</ul>
<h4 id="第五步优化：实现支持空格的-Class-选择器"><a href="#第五步优化：实现支持空格的-Class-选择器" class="headerlink" title="第五步优化：实现支持空格的 Class 选择器"></a>第五步优化：实现支持空格的 Class 选择器</h4><ul>
<li><p>假如我们的 html 改成这样：</p>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">maaa</span>=<span class="string">a</span> &gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">	<span class="selector-tag">body</span> <span class="selector-tag">div</span> <span class="selector-id">#myid</span>&#123;</span></span><br><span class="line"><span class="css">	    <span class="selector-tag">width</span><span class="selector-pseudo">:100px</span>;</span></span><br><span class="line"><span class="css">	    <span class="selector-tag">background-color</span>: <span class="selector-id">#ff5000</span>;</span></span><br><span class="line">	&#125;</span><br><span class="line">	body div img&#123;</span><br><span class="line"><span class="css">	    <span class="selector-tag">width</span><span class="selector-pseudo">:30px</span>;</span></span><br><span class="line"><span class="css">	    <span class="selector-tag">background-color</span>: <span class="selector-id">#ff1111</span>;</span></span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line"><span class="css">	<span class="selector-tag">body</span> <span class="selector-tag">div</span> <span class="selector-class">.cls1</span> &#123;</span></span><br><span class="line"><span class="css">	  <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9906</span>;</span></span><br><span class="line">	&#125;</span><br><span class="line">	    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">	    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">img</span> <span class="attr">id</span>=<span class="string">"myid"</span>/&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">"cls1 cls2"</span>/&gt;</span></span><br><span class="line">	    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>在 &lt;img&gt; 增加多个 class 选择器，那我们的选择器 match 可以改成</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">element, selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!selector || !element.attributes) </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (selector.charAt(<span class="number">0</span>) == <span class="string">"#"</span>) &#123;</span><br><span class="line">	    </span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (selector.charAt(<span class="number">0</span>) == <span class="string">"."</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> attr = element.attributes.filter(<span class="function"><span class="params">attr</span> =&gt;</span> attr.name === <span class="string">"class"</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> (attr) &#123;</span><br><span class="line">      <span class="keyword">const</span> attrClassArray = attr.value.split(<span class="string">' '</span>)</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> attrClass <span class="keyword">of</span> attrClassArray) &#123;</span><br><span class="line">        <span class="keyword">if</span> (attrClass === selector.replace(<span class="string">"."</span>, <span class="string">''</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		    </span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">  &#125;</span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...some code</span><br></pre></td></tr></table></figure></li>
<li><p>思路：</p>
<ul>
<li>我们可以看到<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/a8b9d9396713239928cd8b0af216535e40897.png" alt="多 class 选择器"></li>
</ul>
</li>
<li>我们可以将 元素 attr 根据空格分隔，再利用循环匹配</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/1d5533479cdb7d6c1a0af20acdfc4e71146017.png" alt="第五步优化运行结果"></li>
</ul>
</li>
</ul>
<h3 id="第六步：生成-computed-属性"><a href="#第六步：生成-computed-属性" class="headerlink" title="第六步：生成 computed 属性"></a>第六步：生成 computed 属性</h3><ul>
<li><p>一旦选择匹配，就应用选择器到元素上，形成 computedStyle</p>
</li>
<li><p>computeCSS6.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeCSS</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> (matched) &#123; <span class="comment">// 匹配成功</span></span><br><span class="line">      <span class="keyword">const</span> computedStyle = element.computedStyle</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> declaration <span class="keyword">of</span> rule.declarations) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!computedStyle[declaration.property]) &#123;</span><br><span class="line">          computedStyle[declaration.property] = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        computedStyle[declaration.property].value = declaration.value</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(element.computedStyle)</span><br><span class="line">    &#125;</span><br><span class="line">	</span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...some code</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/71888ca9220eb11196bc00eb407fb05980361.png" alt="第六步运行结果"></li>
</ul>
</li>
</ul>
<h3 id="第七步：确定规则覆盖关系"><a href="#第七步：确定规则覆盖关系" class="headerlink" title="第七步：确定规则覆盖关系"></a>第七步：确定规则覆盖关系</h3><ul>
<li><p>CSS 规则根据 specificity 和后来优先规则覆盖</p>
</li>
<li><p>specificity 是个四元组，越左边权重越高</p>
</li>
<li><p>一个 CSS 规则的 specificity 根据包含的简单选择器相加而成</p>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/a50f3ae53878adbacbdcb7798632605e283940.png" alt="selectors-3 specificity"></p>
</li>
<li><p>computeCSS7.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">...some code</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">specificity</span>(<span class="params">selector</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">  <span class="keyword">const</span> selectorParts = selector.split(<span class="string">" "</span>)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> part <span class="keyword">of</span> selectorParts) &#123;</span><br><span class="line">    <span class="keyword">if</span> (part.charAt(<span class="number">0</span>) == <span class="string">"#"</span>) &#123;</span><br><span class="line">      p[<span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (part.charAt(<span class="number">0</span>) == <span class="string">"."</span>) &#123;</span><br><span class="line">      p[<span class="number">2</span>] += <span class="number">1</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      p[<span class="number">3</span>] += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compare</span>(<span class="params">sp1, sp2</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (sp1[<span class="number">0</span>] - sp2[<span class="number">0</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> sp1[<span class="number">0</span>] - sp2[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sp1[<span class="number">1</span>] - sp2[<span class="number">1</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> sp1[<span class="number">1</span>] - sp2[<span class="number">1</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sp1[<span class="number">2</span>] - sp2[<span class="number">2</span>]) &#123;</span><br><span class="line">    <span class="keyword">return</span> sp1[<span class="number">2</span>] - sp2[<span class="number">2</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sp1[<span class="number">3</span>] - sp2[<span class="number">3</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeCSS</span>(<span class="params">element</span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> (matched) &#123; <span class="comment">// 匹配成功</span></span><br><span class="line">      <span class="keyword">const</span> sp = specificity(rule.selectors[<span class="number">0</span>])</span><br><span class="line">      <span class="keyword">const</span> computedStyle = element.computedStyle</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> declaration <span class="keyword">of</span> rule.declarations) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!computedStyle[declaration.property]) &#123;</span><br><span class="line">          computedStyle[declaration.property] = &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!computedStyle[declaration.property].specificity) &#123;</span><br><span class="line">          computedStyle[declaration.property].value = declaration.value</span><br><span class="line">          computedStyle[declaration.property].specificity = sp</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (compare(computedStyle[declaration.property].specificity, sp) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">          computedStyle[declaration.property].value = declaration.value</span><br><span class="line">          computedStyle[declaration.property].specificity = sp</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		</span><br><span class="line">	...some code</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...some code</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li>运行结果<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/063c59deee7d24e437fdff9920aec8ea216464.png" alt="第七步运行结果"></li>
<li><img src="http://p1.meituan.net/myvideodistribute/c3a7fb73c0d001fef48137c4a23144b6211501.png" alt="第七步运行结果"></li>
</ul>
</li>
</ul>
<h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/Specificity" target="_blank" rel="noopener">CSS 优先级是如何计算的？</a></li>
<li><a href="https://drafts.csswg.org/selectors-3/#specificity" target="_blank" rel="noopener">selectors-3 specificity</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li><a href="https://github.com/Ele-Peng/toy-browser" target="_blank" rel="noopener">完整代码地址-点击一下</a></li>
<li>学而不思则罔</li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>浏览器</category>
      </categories>
      <tags>
        <tag>浏览器</tag>
      </tags>
  </entry>
  <entry>
    <title>UTF8_Encoing</title>
    <url>/2020/04/21/UTF8-Encoing/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>周一和小姐妹 Skady 宝贝练完舞后，交流了一个小时技术，是的🙆我们没有扯皮，难得交流技术。🤣她在玩“在C语言中编写JS代码，然后再编译成wasm，可以在浏览器里跑”，我们简单地交流了一下底层实现.<span style="color: #bfbfbf">应该是基于 ArrayBuffer 的</span></li>
<li>然后不知怎么就想到了 0.1 + 0.2 ≠ 0.3，这个经典问题</li>
<li>想看看它在内存中的表现</li>
<li>并记录一下将 String 字符串，转成字节流的整个实现过程</li>
<li>往下看吧~ 🤓</li>
</ul>
<a id="more"></a>

<h2 id="实践过程"><a href="#实践过程" class="headerlink" title="实践过程"></a>实践过程</h2><h4 id="总体思路"><a href="#总体思路" class="headerlink" title="总体思路"></a>总体思路</h4><ul>
<li>统计字符串长度</li>
<li>循环遍历字符串，进行编码</li>
<li>输出编码后的字节流</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UTF8_Encoding</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">let</span> length = str.length,</span><br><span class="line">        strIndex = <span class="number">-1</span>,</span><br><span class="line">        strEnd = length - <span class="number">1</span>,</span><br><span class="line">        bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(length),</span><br><span class="line">        index = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (strIndex++ &lt; strEnd) &#123;</span><br><span class="line">        bytes[index] = str.charCodeAt(strIndex) &amp; <span class="number">0xFF</span>; <span class="comment">// 设置为低8位值</span></span><br><span class="line">        index += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="字节流文件转-String"><a href="#字节流文件转-String" class="headerlink" title="字节流文件转 String"></a>字节流文件转 String</h2><h4 id="总体思路-1"><a href="#总体思路-1" class="headerlink" title="总体思路"></a>总体思路</h4><ul>
<li>统计字节流长度</li>
<li>循环遍历字节流，进行解码</li>
<li>输出解码后的字节流</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UTF8_Decoding</span>(<span class="params">bytes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> str = <span class="string">""</span>,</span><br><span class="line">        bytesIndex = <span class="number">-1</span>,</span><br><span class="line">        bytesEnd = bytes.length - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (bytesIndex ++ &lt; bytesEnd) &#123;</span><br><span class="line">        str += <span class="built_in">String</span>.fromCharCode(bytes[bytesIndex]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="测试截图"><a href="#测试截图" class="headerlink" title="测试截图"></a>测试截图</h4><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/c1770110908275e40343791324f7dfff154914.png" alt="测试截图"></li>
</ul>
<h2 id="类型化数组"><a href="#类型化数组" class="headerlink" title="类型化数组"></a>类型化数组</h2><ul>
<li><p>类型化数组中的元素都是数字。使用构造函数在创建类型化数组的时候决定了数组中数字（有符号或者无符号整数或者浮点数）的类型和大小（以位为单位）</p>
</li>
<li><p>类型化数组有固定的长度。</p>
</li>
<li><p>在创建类型化数组的时候，数组中的元素总是默认初始化为0.</p>
</li>
<li><p><strong>类型化数组</strong></p>
<ul>
<li><p><strong>TypedArray</strong> 视图支持的数据类型一共有 9 种（ <strong>DataView</strong> 视图支持除 <strong>Uint8C</strong> 以外的其他 8 种）。</p>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>字节长度</th>
<th>含义</th>
<th>对应的 C 语言类型</th>
</tr>
</thead>
<tbody><tr>
<td>Int8</td>
<td>1</td>
<td>8 位带符号整数</td>
<td>signed char</td>
</tr>
<tr>
<td>Uint8</td>
<td>1</td>
<td>8 位不带符号整数</td>
<td>unsigned char</td>
</tr>
<tr>
<td>Uint8C</td>
<td>1</td>
<td>8 位不带符号整数（自动过滤溢出）</td>
<td>unsigned char</td>
</tr>
<tr>
<td>Int16</td>
<td>2</td>
<td>16 位带符号整数</td>
<td>short</td>
</tr>
<tr>
<td>Uint16</td>
<td>2</td>
<td>16 位不带符号整数</td>
<td>unsigned short</td>
</tr>
<tr>
<td>Int32</td>
<td>4</td>
<td>32 位带符号整数</td>
<td>int</td>
</tr>
<tr>
<td>Uint32</td>
<td>4</td>
<td>32 位不带符号的整数</td>
<td>unsigned int</td>
</tr>
<tr>
<td>Float32</td>
<td>4</td>
<td>32 位浮点数</td>
<td>float</td>
</tr>
<tr>
<td>Float64</td>
<td>8</td>
<td>64 位浮点数</td>
<td>double</td>
</tr>
</tbody></table>
</li>
</ul>
</li>
<li><p>在创建一个类型化数组的时候，可以传递数组大小给构造函数，或者传递一个数组或者类型化数组来用于初始化数组元素。一旦创建了类型化数组，就可以像操作其他类数组对象那样，通过常规的中括号表示法来对数组元素进行读/写操作。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">1024</span>); <span class="comment">// 1kb字节 </span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i ++) <span class="comment">// 循环数组的每个元素</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i ++) <span class="comment">// 循环数组的每个元素</span></span><br><span class="line">	bytes[i] = i &amp; <span class="number">0xFF</span>; <span class="comment">// 设置为索引的低8位值</span></span><br><span class="line"><span class="keyword">var</span> copy = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(bytes); <span class="comment">// 创建数组的副本</span></span><br><span class="line"><span class="keyword">var</span> ints = <span class="keyword">new</span> <span class="built_in">Int32Array</span>([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]); <span class="comment">// 包含这4个int值的类型化数组</span></span><br></pre></td></tr></table></figure></li>
<li><p>类型化数组：他们都是<strong>基本字节块的视图</strong>，称为一个 ArrayBuffer 。ArrayBuffer 只是不透明的字节块。可以通过类型化数组获取这些字节，但是 ArrayBuffer 自己并不是一个类型化数组。可以像对任意 Javascript 对象那样，使用数字数组索引来操作 ArrayBuffer。但是，这样做并<strong>不能赋予访问缓冲区中字节的权限</strong></p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> bytes = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="number">8</span>); <span class="comment">// 分配8个字节</span></span><br><span class="line">bytes[<span class="number">0</span>] = <span class="number">1</span> <span class="comment">// 把第一个字节设置为1</span></span><br><span class="line">bytes.buffer[<span class="number">0</span>] = <span class="number">255</span> <span class="comment">// 错误获取，缓冲区中没有索引值0</span></span><br><span class="line">bytes.buffer[<span class="number">1</span>] = <span class="number">255</span> <span class="comment">// 错误设置缓冲区字节</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="“字节顺序”"><a href="#“字节顺序”" class="headerlink" title="“字节顺序”"></a>“字节顺序”</h3><ul>
<li><p>字节组织成更长的字的顺序</p>
</li>
<li><p>为了高效，类型化数组采用底层硬件的原生顺序。在低位优先(little-endian)系统中， ArrayBuffer 中数字的字节是按照从低位到高位的顺序排列的。在高位优先(big-endian)系统中，字节是按照从高位到低位的顺序排列的。</p>
</li>
<li><p>可以使用如下代码来检测系统的字节顺序：</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 如果整数 Ox00000001 在内存中表示成： 01 00 00 00</span></span><br><span class="line"><span class="comment">// 则说明当前系统是低位优先系统</span></span><br><span class="line"><span class="comment">// 相反，在高位优先系统中，它会表示成：00 00 00 01</span></span><br><span class="line"><span class="keyword">var</span> little_endian = <span class="keyword">new</span> <span class="built_in">Int8Array</span>(<span class="keyword">new</span> <span class="built_in">Int32Array</span>([<span class="number">1</span>]).buffer)[<span class="number">0</span>] === <span class="number">1</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h2 id="思考问题-0-1-0-2-≠-0-3"><a href="#思考问题-0-1-0-2-≠-0-3" class="headerlink" title="思考问题 0.1 + 0.2 ≠ 0.3"></a>思考问题 0.1 + 0.2 ≠ 0.3</h2><ul>
<li>我们可以先来看看 十进制小数的二进制表示：<ul>
<li>整数部分：除以2，取出余数，商继续除以2，直到得到0为止，将取出的余数逆序</li>
<li>小数部分：乘以2，然后取出整数部分，将剩下的小数部分继续乘以2，然后再取整数部分，一直取到小数部分为零为止。如果永远不为零，则按要求保留足够位数的小数，最后一位做0舍1入。将取出的整数顺序排列。</li>
<li>所以 0.1 可以表示为<ul>
<li>0.000110011001100110011…</li>
</ul>
</li>
<li>0.2 可以表示为<ul>
<li>0.00110011001100110011…</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 0.1 和 0.2 都转化成二进制后再进行运算</span></span><br><span class="line"><span class="number">0.00011001100110011001100110011001100110011001100110011010</span> +</span><br><span class="line"><span class="number">0.0011001100110011001100110011001100110011001100110011010</span> =</span><br><span class="line"><span class="number">0.0100110011001100110011001100110011001100110011001100111</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 转成十进制正好是 0.30000000000000004</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>二进制数转成 IEEE 754 标准</p>
<ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/eefbaacb81e66deb742370e27d9e3bb876872.png" alt="IEEE 754 标准"></p>
</li>
<li><p>使用 64 位固定长度来表示，也就是标准的double 双精度浮点数。</p>
</li>
<li><p>这样的存储结构优点是可以归一化处理整数和小数，节省存储空间。</p>
</li>
<li><p>这64个比特又可分为三个部分，即：</p>
<ul>
<li>第1位: 是符号的标志位(S), 0代表正数，1代表负数</li>
<li>第1-11位: 指数位(E), 存储指数（exponent），用来表示次方数</li>
<li>第12-63位: 尾数(M), 这52 位是尾数，超出的部分自动进一舍零</li>
</ul>
</li>
<li><p>实际数字就可以用以下公式来计算：</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/7b2c9fce00cfe3bf57fcede347257af276632.png" alt="IEEE 754数学公式"></li>
</ul>
</li>
<li><p>因此 0.1 的二进制表示：    </p>
<blockquote>
<p>0.00011001100110011001100110011001100110011001100110011001100…</p>
</blockquote>
<ul>
<li><p>首先 0.1 是正数，标志位 </p>
<blockquote>
<p>Sign = 0</p>
</blockquote>
</li>
<li><p>其次, 将小数转化为科学计数法</p>
<blockquote>
<p>1.100110011001100110011001100110011001100110011001100… * 2^-4</p>
</blockquote>
<ul>
<li><p>相对于，小数点移了4位，指数减4</p>
<blockquote>
<p>exponent = -4 + 1023 = 1019</p>
</blockquote>
<blockquote>
<p>01111111011</p>
</blockquote>
</li>
</ul>
</li>
<li><p>由于科学计数法, 第一个数始终是1, 所以可以忽略存储, 只要存后面的52位就可以了</p>
</li>
<li><p><strong>如果超过了52位, 就是对第53位舍0进1</strong>（精度误差）, 结果也就是</p>
<blockquote>
<p>1001100110011001100110011001100110011001100110011010</p>
</blockquote>
</li>
</ul>
</li>
<li><p>因此 0.1 的 IEEE 754 的表示：</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/1ae3cf9f7bda61d8d0849ce05f7657f997288.png" alt="0.1 的IEEE 754"></li>
</ul>
</li>
<li><p>同理 0.2 的 IEEE 754 的表示：</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/0c5d93145800b45b59a3ef23dc2abe4a97936.png" alt="0.2 的 IEEE 754"></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="查看-0-1-表示方式"><a href="#查看-0-1-表示方式" class="headerlink" title="查看 0.1 表示方式"></a>查看 0.1 表示方式</h3><pre><code class="javascript"><span class="keyword">let</span> b = <span class="keyword">new</span> <span class="built_in">Float64Array</span>([<span class="number">0.1</span>])
<span class="built_in">console</span>.log(b)
<span class="keyword">let</span> intArr = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(b.buffer)
<span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">7</span>; i &gt;= <span class="number">0</span>; i --) {
    s = intArr[i].toString(<span class="number">2</span>)
    <span class="keyword">while</span>(s.length &lt; <span class="number">8</span>) {
        s = <span class="string">'0'</span> + s
    }
    <span class="built_in">console</span>.log(s)

}</code></pre>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/d996e0a508b796f5a3d4f4866c1bf43064783.png" alt="低位优先系统"></li>
<li>首先我们的系统是低位优先系统(little_endian)</li>
<li><img src="http://p0.meituan.net/myvideodistribute/de79ee3caac77ddad9398cfeaaf3719f227171.png" alt="查看 0.1 表示方式截图"><ul>
<li>0 –&gt; 标志位</li>
<li>011111111011 –&gt; 指数位</li>
<li>1001{12}1010 –&gt; 尾数</li>
</ul>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li>《Javascript 权威指南》22.5章 类型化数组和 ArrayBuffer P678</li>
<li><a href="https://cloud.tencent.com/developer/article/1592651" target="_blank" rel="noopener">彻底搞懂Javascript 浮点数</a></li>
<li><a href="http://www.binaryconvert.com/convert_double.html" target="_blank" rel="noopener">二进制转换工具</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
        <tag>UTF-8</tag>
      </tags>
  </entry>
  <entry>
    <title>基于KMP的FSM处理未知 pattern</title>
    <url>/2020/05/16/%E5%9F%BA%E4%BA%8EKMP%E7%9A%84FSM%E5%A4%84%E7%90%86%E5%AD%97%E7%AC%A6%E4%B8%B2/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>准备整一下 “基于KMP的FSM处理 pattern” 啦，祝我成功 🙋</li>
<li>这里呢~ 准备分为三步去实现<ul>
<li>FSM 处理字符串</li>
<li>KMP 算法概述</li>
<li>基于 KMP 的 FSM 处理 pattern 的实现</li>
</ul>
</li>
</ul>
<a id="more"></a>

<h2 id="实践记录"><a href="#实践记录" class="headerlink" title="实践记录"></a>实践记录</h2><h3 id="FSM-处理字符串"><a href="#FSM-处理字符串" class="headerlink" title="FSM 处理字符串"></a>FSM 处理字符串</h3><h4 id="FSM-概念"><a href="#FSM-概念" class="headerlink" title="FSM 概念"></a>FSM 概念</h4><ul>
<li>每一个状态都是一个机器<ul>
<li>在每一个机器里，我们可以做计算、存储、输出</li>
<li>所有的这些机器接受的输入是一致的</li>
<li>状态机的每一个机器本身没有状态，如果我们用函数来表示的话，它应该是纯函数（无副作用）</li>
</ul>
</li>
<li>每一个机器知道下一个状态<ul>
<li>每个机器都有确定的下一个状态（Moore）</li>
<li>每个机器根据输入决定下一个状态（Mealy）</li>
</ul>
</li>
</ul>
<h4 id="在一个字符串中，找到字符串-abcdef"><a href="#在一个字符串中，找到字符串-abcdef" class="headerlink" title="在一个字符串中，找到字符串 abcdef"></a>在一个字符串中，找到字符串 abcdef</h4><ul>
<li><p>不使用 FSM ，在一个字符串中，找到字符串 abcdef找到字符串 abcdef</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> foundA = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> foundB = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> foundC = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> foundD = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> foundE = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> string) &#123;</span><br><span class="line">    <span class="keyword">if</span> (char == <span class="string">'a'</span>)</span><br><span class="line">      foundA = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (foundA &amp;&amp; char == <span class="string">'b'</span>)</span><br><span class="line">      foundB = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (foundB &amp;&amp; char == <span class="string">'c'</span>)</span><br><span class="line">      foundC = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (foundC &amp;&amp; char == <span class="string">'d'</span>)</span><br><span class="line">      foundD = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (foundD &amp;&amp; char == <span class="string">'e'</span>)</span><br><span class="line">      foundE = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (foundD &amp;&amp; char == <span class="string">'f'</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> foundA = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">let</span> foundB = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">let</span> foundC = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">let</span> foundD = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">let</span> foundE = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aabcdefghm grood."</span>))</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aacdefghm grood."</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/40a9e9395d783093ae5e9af1bc2d081c58822.png" alt="第一版运行结果"></li>
</ul>
</li>
<li>缺点：<ol>
<li>不可扩展代码较多</li>
<li>if else 多次判断</li>
</ol>
</li>
</ul>
</li>
<li><p>使用 FSM ，在一个字符串中，找到字符串 abcdef </p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> state = start</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> string) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> state === end</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">return</span> findA</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> end</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findA</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'b'</span>)</span><br><span class="line">    <span class="keyword">return</span> findB</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findB</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'c'</span>)</span><br><span class="line">    <span class="keyword">return</span> findC</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findC</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'d'</span>)</span><br><span class="line">    <span class="keyword">return</span> findD</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findD</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'e'</span>)</span><br><span class="line">    <span class="keyword">return</span> findE</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findE</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'f'</span>)</span><br><span class="line">    <span class="keyword">return</span> end</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aabcdefghm grood."</span>))</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aacdefghm grood."</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/74431b7630e0a9f8b3aeb65907987b9a80908.png" alt="FSM 处理字符串 abcdef"></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="JS-中的有限状态机"><a href="#JS-中的有限状态机" class="headerlink" title="JS 中的有限状态机"></a>JS 中的有限状态机</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 每个函数是一个状态</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">state</span>(<span class="params">input</span>) </span>&#123; <span class="comment">// 函数参数就是输入</span></span><br><span class="line">  <span class="comment">// 在函数中，可以自由地编写代码，处理每个状态的逻辑</span></span><br><span class="line">  <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 以下是调用 **/</span></span><br><span class="line"><span class="keyword">while</span>(input) &#123;</span><br><span class="line">  <span class="comment">// 获取输入</span></span><br><span class="line">  state = state(input) <span class="comment">// 把状态机的返回值作为下一个状态</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用-FSM-，在一个字符串中，找到字符串-abcabx"><a href="#使用-FSM-，在一个字符串中，找到字符串-abcabx" class="headerlink" title="使用 FSM ，在一个字符串中，找到字符串 abcabx"></a>使用 FSM ，在一个字符串中，找到字符串 abcabx</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> state = start</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> string) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> state === end</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">return</span> findA</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> end</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findA</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'b'</span>)</span><br><span class="line">    <span class="keyword">return</span> findB</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findB</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'c'</span>)</span><br><span class="line">    <span class="keyword">return</span> findC</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findC</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">return</span> findA2</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findA2</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'b'</span>)</span><br><span class="line">    <span class="keyword">return</span> findB2</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findB2</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'x'</span>)</span><br><span class="line">    <span class="keyword">return</span> end</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> findB(char)</span><br><span class="line">&#125;</span><br><span class="line">match(<span class="string">"I aabcabcabx grood."</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>运行结果<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/c09493a569d2d4e21d1600ebd9fcb84589625.png" alt="FSM 找到 abcabx"></li>
</ul>
</li>
</ul>
<h4 id="使用-FSM-，在一个字符串中，找到字符串-ababx"><a href="#使用-FSM-，在一个字符串中，找到字符串-ababx" class="headerlink" title="使用 FSM ，在一个字符串中，找到字符串 ababx"></a>使用 FSM ，在一个字符串中，找到字符串 ababx</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> state = start</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> string) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> state === end</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">return</span> findA1</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">end</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> end</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findA1</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'b'</span>)</span><br><span class="line">    <span class="keyword">return</span> findB1</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findB1</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">return</span> findA2</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findA2</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'b'</span>)</span><br><span class="line">    <span class="keyword">return</span> findB2</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findB2</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'a'</span>)</span><br><span class="line">    <span class="keyword">return</span> findA3</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findA3</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'b'</span>)</span><br><span class="line">    <span class="keyword">return</span> findB3</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> start(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findB3</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char === <span class="string">'x'</span>)</span><br><span class="line">    <span class="keyword">return</span> end</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> findB2(char)</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aababababx grood."</span>))</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aabababababx grood."</span>))</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aababaeababx grood."</span>))</span><br><span class="line"><span class="built_in">console</span>.log(match(<span class="string">"I aabababaabx grood."</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/6c000a617a3f594e24bf99c52d4d0848101059.png" alt="abababx"></li>
</ul>
</li>
</ul>
<p>【那我们该如何利用 FSM 处理未知 pattern 呢？🤔</p>
<p>【字符串匹配问题就是在一个文本字符串T中搜索某个模式字符串P的所有出现位置。</p>
<h3 id="KMP-算法概述"><a href="#KMP-算法概述" class="headerlink" title="KMP 算法概述"></a>KMP 算法概述</h3><h4 id="KMP-最长公共前后缀长度"><a href="#KMP-最长公共前后缀长度" class="headerlink" title="KMP 最长公共前后缀长度"></a>KMP 最长公共前后缀长度</h4><ul>
<li><p>假如 pattern 为 ABABCABAA</p>
<ul>
<li>前缀依次为 A AB ABA ABAB ABABC ABABCA ABABCAB ABABCABA</li>
<li>后缀依次为 A AA BAA ABAA CABAA BCABAA ABCABAA BABCABAA</li>
</ul>
</li>
<li><p>那么它的最长公共前后缀长度为多少呢？</p>
<ul>
<li>A –&gt; 0<ul>
<li>无前缀</li>
<li>无后缀</li>
<li>最长公共前后缀：””，len = 0</li>
</ul>
</li>
<li>AB –&gt; 0<ul>
<li>前缀 A</li>
<li>后缀 B</li>
<li>最长公共前后缀：””，len = 0</li>
</ul>
</li>
<li>ABA –&gt; 1<ul>
<li>前缀 A AB</li>
<li>后缀 A BA </li>
<li>最长公共前后缀：A，len = 1</li>
</ul>
</li>
<li>ABAB –&gt; 2<ul>
<li>前缀 A AB ABA</li>
<li>后缀 B AB BAB </li>
<li>最长公共前后缀：AB，len = 2</li>
</ul>
</li>
<li>ABABC –&gt; 0<ul>
<li>前缀 A AB ABA ABAB</li>
<li>后缀 C BC ABC BABC</li>
<li>最长公共前后缀：””，len = 0</li>
</ul>
</li>
<li>ABABCA –&gt; 1<ul>
<li>前缀 A AB ABA ABAB ABABC</li>
<li>后缀 A CA BCA ABCA BABCA</li>
<li>最长公共前后缀：A，len = 1</li>
</ul>
</li>
<li>ABABCAB –&gt; 2<ul>
<li>前缀 A AB ABA ABAB ABABC ABABCA</li>
<li>后缀 B AB CAB BCAB ABCAB BACAB</li>
<li>最长公共前后缀：AB，len = 2</li>
</ul>
</li>
<li>ABABCABA –&gt; 3<ul>
<li>前缀 A AB ABA ABAB ABABC ABABCA ABABCAB</li>
<li>后缀 A BA ABA CABA BCABA ABCABA BABCABA</li>
<li>最长公共前后缀：ABA，len = 3</li>
</ul>
</li>
<li>ABABCABAA –&gt; 1<ul>
<li>前缀 A AB ABA ABAB ABABC ABABCA ABABCAB ABABCABA</li>
<li>后缀 A AA BAA ABAA CABAA BCABAA ABCABAA BABCABAA</li>
<li>最长公共前后缀：A，len = 1</li>
</ul>
</li>
</ul>
</li>
<li><p>因此我们可以构建出，最长公共前后缀长度为</p>
<ul>
<li>[0, 0, 1, 2, 0, 1, 2, 3, 1] 对应 pattern 字符串数组</li>
<li>[A, B, A, B, C, A, B, A, A]</li>
<li>[0, 1, 2, 3, 4, 5, 6, 7, 8]</li>
</ul>
</li>
<li><p>那么根据</p>
<ul>
<li><p>A –&gt; len = 0, i = 0</p>
</li>
<li><p>AB –&gt; len = 0, i = 1</p>
</li>
<li><p><u>A</u>B<u>A</u> –&gt; len = 1, i = 2, pattern[i] = A, pattern[上一个len] = A</p>
</li>
<li><p><u>AB</u><u>AB</u> –&gt; len = 2, i = 3, pattern[i] = B, pattern[上一个len] = B</p>
</li>
<li><p>ABABC –&gt; len = 0, i = 4</p>
</li>
<li><p><u>A</u>BABC<u>A</u> –&gt; len = 1, i = 5, pattern[i] = A, pattern[上一个len] = A</p>
</li>
<li><p><u>AB</u>ABC<u>AB</u> –&gt; len = 2, i = 6, pattern[i] = B, pattern[上一个len] = B</p>
</li>
<li><p><u>ABA</u>BC<u>ABA</u> –&gt; len = 3, i = 7, pattern[i] = A, pattern[上一个len] = A</p>
</li>
<li><p>ABABCABAA –&gt; len = 1, i = 8</p>
</li>
<li><p>我们可以观察得到</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (pattern[i] === pattern[len]) &#123;</span><br><span class="line">       len ++;</span><br><span class="line">       prefix[i] = len;</span><br><span class="line">       i ++;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>除此之外的情况呢？比如最后的 ABABCABAA –&gt; len = 1, i = 8</p>
<ul>
<li>[0, 1, 2, 3, 4, 5, 6, 7, 8] 字符串数组下标索引</li>
<li>[A, B, A, B, C, A, B, A, A] 字符串数组</li>
<li>[0, 0, 1, 2, 0, 1, 2, 3, ?] prefixTable<ul>
<li>我们可以发现，前一个字符 A 对应的 prefix 为 3，对应的pattern[3]为 B（prefix[len - 1] === B），B的前一个字符 A 对应的 prefix 为 1（len = prefix[len - 1] –&gt; 0），pattern[1] 为 A，再执行上层代码 prefix[8] === len[0]</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>KMP 最长公共前后缀长度实现</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prefixTable</span>(<span class="params">pattern, prefix, n</span>) </span>&#123;</span><br><span class="line">    prefix[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">// prefix 初始</span></span><br><span class="line">    <span class="keyword">let</span> len = <span class="number">0</span>; <span class="comment">// 最长公共前后缀长度</span></span><br><span class="line">    <span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span>(i &lt; n) &#123;</span><br><span class="line">      <span class="keyword">if</span> (pattern[i] === pattern[len]) &#123;</span><br><span class="line">        len ++;</span><br><span class="line">        prefix[i] = len;</span><br><span class="line">        i ++;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          len = prefix[len - <span class="number">1</span>]</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          prefix[i] = len</span><br><span class="line">          i ++</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(prefix)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/354d6d33c10aa23f150c26a68a09f19084870.png" alt="运行结果"></li>
</ul>
</li>
<li><p>再添一层处理，因为前缀是不不会包括自己本身的，所以我们需要整体后移一位，并且，空出来的第一项置为 -1</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">movePrefixTable</span>(<span class="params">prefix, n</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i --) &#123;</span><br><span class="line">      prefix[i] = prefix[i - <span class="number">1</span>]</span><br><span class="line">    &#125;</span><br><span class="line">    prefix[<span class="number">0</span>] = <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="KMP-处理-pattern"><a href="#KMP-处理-pattern" class="headerlink" title="KMP 处理 pattern"></a>KMP 处理 pattern</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prefixTable</span>(<span class="params">pattern, prefix, n</span>) </span>&#123;</span><br><span class="line">  prefix[<span class="number">0</span>] = <span class="number">0</span>; <span class="comment">// prefix 初始</span></span><br><span class="line">  <span class="keyword">let</span> len = <span class="number">0</span>; <span class="comment">// 最长公共前后缀长度</span></span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span>(i &lt; n) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pattern[i] === pattern[len]) &#123;</span><br><span class="line">      len ++;</span><br><span class="line">      prefix[i] = len;</span><br><span class="line">      i ++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        len = prefix[len - <span class="number">1</span>]</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        prefix[i] = len</span><br><span class="line">        i ++</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(prefix)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">movePrefixTable</span>(<span class="params">prefix, n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i --) &#123;</span><br><span class="line">    prefix[i] = prefix[i - <span class="number">1</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  prefix[<span class="number">0</span>] = <span class="number">-1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">kmpSearch</span>(<span class="params">text, pattern</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> patternArray = pattern.split(<span class="string">""</span>)</span><br><span class="line">  <span class="keyword">let</span> patternLen = patternArray.length</span><br><span class="line">  <span class="keyword">const</span> textArray = text.split(<span class="string">""</span>)</span><br><span class="line">  <span class="keyword">let</span> textLen = textArray.length</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> prefixArray = <span class="keyword">new</span> <span class="built_in">Array</span>(patternLen)</span><br><span class="line">  prefixTable(patternArray, prefixArray, patternLen)</span><br><span class="line">  movePrefixTable(prefixArray, patternLen)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// console.log('prefixTemp', prefixTemp)</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'prefixArray'</span>, prefixArray)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// textArray len m</span></span><br><span class="line">  <span class="comment">// pattern len n</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> i = <span class="number">0</span>, j = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(i &lt; textLen) &#123;</span><br><span class="line">    <span class="keyword">if</span> (j === patternLen - <span class="number">1</span> &amp;&amp; textArray[i] === patternArray[j]) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Found pattern at "</span>, i - j)</span><br><span class="line">      j = prefixArray[j]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (textArray[i] === patternArray[j]) &#123;</span><br><span class="line">      i ++;</span><br><span class="line">      j ++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      j = prefixArray[j]</span><br><span class="line">      <span class="keyword">if</span> (j === <span class="number">-1</span>) &#123;</span><br><span class="line">        i ++;</span><br><span class="line">        j ++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kmpSearch(<span class="string">"ABABABABCABAAB"</span>, <span class="string">"ABABCABAA"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/f4273ce6b530673651ce3a9f513c730760549.png" alt="运行结果"></li>
<li><img src="http://p0.meituan.net/myvideodistribute/214a8fcf81cda92716e44270f816392663018.png" alt="运行结果"></li>
</ul>
</li>
</ul>
<h3 id="基于-KMP-的-FSM-处理-pattern"><a href="#基于-KMP-的-FSM-处理-pattern" class="headerlink" title="基于 KMP 的 FSM 处理 pattern"></a>基于 KMP 的 FSM 处理 pattern</h3><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> textArray = [] <span class="comment">// 未知字符串</span></span><br><span class="line"><span class="keyword">let</span> text = <span class="string">""</span></span><br><span class="line"><span class="keyword">let</span> textLen = <span class="number">0</span> <span class="comment">// 未知字符串长度</span></span><br><span class="line"><span class="keyword">let</span> patternArray = [] <span class="comment">// pattern 字符串</span></span><br><span class="line"><span class="keyword">let</span> pattern = <span class="string">""</span></span><br><span class="line"><span class="keyword">let</span> patternLen <span class="comment">// 未知 pattern 长度</span></span><br><span class="line"><span class="keyword">let</span> prefixArray = <span class="literal">null</span> <span class="comment">// KMP prefix table</span></span><br><span class="line"><span class="keyword">let</span> len = <span class="number">0</span> <span class="comment">// 最长公共前后缀长度</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  patternArray = pattern.split(<span class="string">""</span>)</span><br><span class="line">  patternLen = patternArray.length</span><br><span class="line">  textArray = text.split(<span class="string">""</span>)</span><br><span class="line">  textLen = textArray.length</span><br><span class="line">  prefixArray = <span class="keyword">new</span> <span class="built_in">Array</span>(patternLen)</span><br><span class="line">  prefixArray[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">  <span class="keyword">let</span> len = <span class="number">0</span></span><br><span class="line">  <span class="keyword">return</span> patteranStart</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">patteranStart</span>(<span class="params">i</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (patternArray[i] === patternArray[len]) &#123;</span><br><span class="line">    len++;</span><br><span class="line">    prefixArray[i] = len;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">needAdd</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      len = prefixArray[len - <span class="number">1</span>]</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">needAdd</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      prefixArray[i] = len</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">needAdd</span>: <span class="literal">true</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (i ===  patternLen) &#123;</span><br><span class="line">    <span class="keyword">return</span> movePrefixTable</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">movePrefixTable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = patternLen - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">    prefixArray[i] = prefixArray[i - <span class="number">1</span>]</span><br><span class="line">  &#125;</span><br><span class="line">  prefixArray[<span class="number">0</span>] = <span class="number">-1</span></span><br><span class="line">  <span class="keyword">return</span> KMPSearch</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">KMPSearch</span>(<span class="params">i, j</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (j === patternLen - <span class="number">1</span> &amp;&amp; textArray[i] === patternArray[j]) &#123;</span><br><span class="line">    j = prefixArray[j]</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">iNeedAdd</span>: <span class="literal">false</span>, <span class="attr">jNeedAdd</span>: <span class="literal">false</span>, <span class="attr">isMatched</span>: <span class="literal">true</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (textArray[i] === patternArray[j]) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">iNeedAdd</span>: <span class="literal">true</span>, <span class="attr">jNeedAdd</span>: <span class="literal">true</span>, <span class="attr">isMatched</span>: <span class="literal">false</span> &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    j = prefixArray[j]</span><br><span class="line">    <span class="keyword">if</span> (j === <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; <span class="attr">iNeedAdd</span>: <span class="literal">true</span>, <span class="attr">jNeedAdd</span>: <span class="literal">true</span>, <span class="attr">isMatched</span>: <span class="literal">false</span> &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">iNeedAdd</span>: <span class="literal">true</span>, <span class="attr">jNeedAdd</span>: <span class="literal">false</span>, <span class="attr">isMatched</span>: <span class="literal">false</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> STATUS_MAP = &#123;</span><br><span class="line">  <span class="string">"init"</span>: initState,</span><br><span class="line">  <span class="string">"prefixtable"</span>: patteranStart,</span><br><span class="line">  <span class="string">"movePrefixTable"</span>: movePrefixTable,</span><br><span class="line">  <span class="string">"KMPSearch"</span>: KMPSearch</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">match</span>(<span class="params">_text, _pattern</span>) </span>&#123;</span><br><span class="line">  text = _text</span><br><span class="line">  pattern = _pattern</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> patternState = initState</span><br><span class="line">  <span class="keyword">let</span> STATUS_MAP_KEYS = <span class="built_in">Object</span>.keys(STATUS_MAP)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> status = <span class="number">0</span>; status &lt; STATUS_MAP_KEYS.length; status++) &#123;</span><br><span class="line">    patternState = STATUS_MAP[STATUS_MAP_KEYS[status]]</span><br><span class="line">    <span class="keyword">if</span> (STATUS_MAP_KEYS[status] === <span class="string">"init"</span>) &#123;</span><br><span class="line"></span><br><span class="line">      patternState()</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (STATUS_MAP_KEYS[status] === <span class="string">"prefixtable"</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> res = &#123; <span class="attr">len</span>: <span class="number">0</span>, <span class="attr">needAdd</span>: <span class="literal">true</span> &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">1</span>; i &lt;= patternLen; res.needAdd &amp;&amp; i++) &#123;</span><br><span class="line">        res = patternState(i)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (STATUS_MAP_KEYS[status] === <span class="string">"movePrefixTable"</span>) &#123;</span><br><span class="line"></span><br><span class="line">      patternState()</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (STATUS_MAP_KEYS[status] === <span class="string">"KMPSearch"</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">let</span> kmpSearchRes = &#123; <span class="attr">iNeedAdd</span>: <span class="literal">false</span>, <span class="attr">jNeedAdd</span>: <span class="literal">false</span>, <span class="attr">isMatched</span>: <span class="literal">false</span> &#125;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, j = <span class="number">0</span>; i &lt; textLen;) &#123;</span><br><span class="line">        kmpSearchRes = patternState(i, j)</span><br><span class="line">        <span class="keyword">if</span> (kmpSearchRes.isMatched) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">"First Found pattern at "</span>, i - j)</span><br><span class="line">          <span class="keyword">return</span> kmpSearchRes.isMatched</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (kmpSearchRes.iNeedAdd)</span><br><span class="line">          i++</span><br><span class="line">        <span class="keyword">if</span> (kmpSearchRes.jNeedAdd)</span><br><span class="line">          j++</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> kmpSearchRes.isMatched</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">match(<span class="string">"ABABABABCABAAB"</span>, <span class="string">"ABABCABAA"</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/7079d40d337c97ae742c21e0f7a2f87320359.png" alt="基于 KMP 的 FSM 处理 pattern 运行结果"></li>
</ul>
</li>
</ul>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://www.bilibili.com/video/BV1Px411z7Yo" target="_blank" rel="noopener">KMP 算法视频讲解</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2013/05/Knuth%E2%80%93Morris%E2%80%93Pratt_algorithm.html" target="_blank" rel="noopener">KMP-最长公共前后缀长度</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>感谢在 KMP 算法折腾时，提供帮助的 田神大大【 🤫 等我有他联系方式了，我悄悄同步给你们</li>
<li>学而不思则罔</li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序-fix canvas原生组件最顶层</title>
    <url>/2020/04/05/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-fix%20canvas%E5%8E%9F%E7%94%9F%E7%BB%84%E4%BB%B6%E6%9C%80%E9%A1%B6%E5%B1%82/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>大家应该都知道过，在微信小程序中，canvas等原生组件的层级是最高的，页面中无论你设置多大的z-index都无法覆盖在其之上，这就可能会产生一些问题</li>
<li>就像这样<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2UxYmQ5OTM2M2VkYjU1NTRmYjc5MzBlZDllMTA0ZjEwMTc2MDM0LnBuZw?x-oss-process=image/format,png" alt="canvas顶层问题截图"></li>
<li>柱状图是用canvas画的，它置于了我的tooltip之上。【这看起来真是一个可怕的问题<a id="more"></a>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h2><ul>
<li>微信官方提供了<a href="https://developers.weixin.qq.com/miniprogram/dev/component/cover-view.html" target="_blank" rel="noopener">cover-view</a>原生组件，覆盖在原生组件之上的文本视图</li>
<li>微信官方提供了将canvas转化为图片的方式–<a href="https://developers.weixin.qq.com/miniprogram/dev/api/canvas/wx.canvasToTempFilePath.html" target="_blank" rel="noopener">wx.canvasToTempFilePath</a>，这样就可以”降级“</li>
</ul>
<h3 id="方法一：cover-view"><a href="#方法一：cover-view" class="headerlink" title="方法一：cover-view"></a>方法一：cover-view</h3><ul>
<li>将tooltip用cover-view改写，效果如下<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2Y0MTZjZjhlMjNiZWEwMjNjYTM1M2JhOGExMDM1MDM2MzYyOTIucG5n?x-oss-process=image/format,png" alt="cover-view version0.1 截图"></li>
<li>看上去，是解决了我们的问题，且tooltip后的灰色背景不能滑动了，【妈耶，好棒！</li>
<li>但是，这产生了一个：<strong>当文本超出tooltip宽度时，scroll-y: auto，失效了，溢出部分被直接截取</strong></li>
<li>罪魁祸首就是它<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2M5ZDljYjZiZTQ0ZGY3YmJmNmRlMjAxNDM1ZmYzOTJjNDMxNDMucG5n?x-oss-process=image/format,png" alt="cover内置样式"></li>
</ul>
</li>
<li>那我们可以：<ul>
<li>在tooltip分段内容中加上  <figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.modal-layer-content-rule</span> &#123;</span><br><span class="line">    <span class="attribute">white-space</span>: pre-wrap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在内容wrapper中加上  <figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.modal-layer-content</span> &#123;</span><br><span class="line">    <span class="attribute">overflow</span>: scroll;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>完美解决<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2FhZjRkMDAyODdjZGI4M2Y0NWRhMGVkOTg3Mzc5MGNhNDQxMjkucG5n?x-oss-process=image/format,png" alt="cover-view解决图"><h3 id="方法二：wx-canvasToTempFilePath"><a href="#方法二：wx-canvasToTempFilePath" class="headerlink" title="方法二：wx.canvasToTempFilePath"></a>方法二：wx.canvasToTempFilePath</h3></li>
</ul>
</li>
</ul>
</li>
<li>首先我们要做的就是将网络图片绘制进canvas，官方关于canvas类型有两种<br><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2E4ZjJmNjA5OGYxNmQ4MzY3NWJiN2I3OWY0ZDM1NWM1MTAwMDg3LnBuZw?x-oss-process=image/format,png" alt="两种canvas类型"></li>
<li>新canvas 2D接口尝试  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> query = wx.createSelectorQuery().in(<span class="keyword">this</span>)</span><br><span class="line">   query.select(<span class="string">'#myCanvas'</span>)</span><br><span class="line">     .fields(&#123; <span class="attr">node</span>: <span class="literal">true</span>, <span class="attr">size</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">     .exec(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">const</span> canvas = res[<span class="number">0</span>].node</span><br><span class="line">       <span class="keyword">const</span> ctx = canvas.getContext(<span class="string">'2d'</span>)</span><br><span class="line">       <span class="keyword">const</span> img = canvas.createImage()</span><br><span class="line">       img.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">         ctx.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line">       &#125;</span><br><span class="line">       img.src = <span class="string">'https://p0.meituan.net/myvideodistribute/0990cc2062e81ab6cc11fd8690f8755042005.jpg'</span></span><br><span class="line">       <span class="comment">// 这种方式获取canvas区域隐含的像素数据</span></span><br><span class="line">       <span class="built_in">console</span>.log(ctx.getImageData(<span class="number">0</span>, <span class="number">0</span>, <span class="number">150</span>, <span class="number">100</span>).data)</span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">type</span>=<span class="string">"2d"</span> <span class="attr">id</span>=<span class="string">"myCanvas"</span> <span class="attr">canvas-id</span>=<span class="string">"myCanvas"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>运行截图<img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzE5ZWE3ZGYxYjg2ODUzOWFhNzVhY2E0OTAxYzI2MzU2OTk4NDYucG5n?x-oss-process=image/format,png" alt="canvas2d 运行截图"></li>
<li>第二种旧canvas  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> ctx = wx.createCanvasContext(<span class="string">'myCanvas'</span>)</span><br><span class="line">   wx.getImageInfo(&#123;</span><br><span class="line">       src: <span class="string">'https://p0.meituan.net/myvideodistribute/0990cc2062e81ab6cc11fd8690f8755042005.jpg'</span>,</span><br><span class="line">       success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">         <span class="built_in">console</span>.log(<span class="string">'res'</span>, res)</span><br><span class="line">         <span class="keyword">const</span> poster = res.path                                  </span><br><span class="line">         ctx.drawImage(poster, <span class="number">0</span>, <span class="number">0</span>, <span class="number">150</span>, <span class="number">100</span>)</span><br><span class="line">         ctx.draw()</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     <span class="comment">// 这种方式获取canvas区域隐含的像素数据</span></span><br><span class="line">     wx.canvasGetImageData(&#123;</span><br><span class="line">       canvasId: <span class="string">'myCanvas'</span>,</span><br><span class="line">       x: <span class="number">0</span>,</span><br><span class="line">       y: <span class="number">0</span>,</span><br><span class="line">       width: <span class="number">150</span>,</span><br><span class="line">       height: <span class="number">100</span>,</span><br><span class="line">       success(res) &#123;</span><br><span class="line">         <span class="built_in">console</span>.log(res.width) <span class="comment">// 150</span></span><br><span class="line">         <span class="built_in">console</span>.log(res.height) <span class="comment">// 100</span></span><br><span class="line">         <span class="built_in">console</span>.log(res.data <span class="keyword">instanceof</span> <span class="built_in">Uint8ClampedArray</span>) <span class="comment">// true</span></span><br><span class="line">         <span class="built_in">console</span>.log(res.data) <span class="comment">// 150 * 100 * 4</span></span><br><span class="line">         <span class="built_in">console</span>.log(res.data.length) <span class="comment">// 150 * 100 * 4</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">"myCanvas"</span> <span class="attr">canvas-id</span>=<span class="string">"myCanvas"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>运行截图<img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzU4NTg5MzQ4MDc3Njk3OTA0OTRmZmIzOWRiNDdjMWRmNjk4ODQucG5n?x-oss-process=image/format,png" alt="旧canvas"></li>
<li>虽然两种方法，都能实现将网络图片绘制进canvas，但新版的进行了createImage，将其打印的话，其实就是新建了一个img标签，并将img标签的东西绘制进canvas<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzFjMjE1NzMzZTRkY2UzNGZiNzI4NDFhZWEyMDc0ZWIwMjQ1OTQucG5n?x-oss-process=image/format,png" alt="img console"></li>
<li>为什么微信官方会仅支持以下方式进行新版canvas2d 图片的绘制，考虑是什么？</li>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2JhYWQ1OWRhNDI4M2FjZmViZTY1NGQ0ZWZiNTAxZDZlMjAxMjE2LnBuZw?x-oss-process=image/format,png" alt="经典报错"></li>
</ul>
</li>
<li>现在我们要将canvas的内容导成图片，同样分成新旧两版</li>
<li>主要思路都是：在wxml中，如果canvas绘制图片没有完成，则显示canvas内容，绘制完成后，就利用canvasToTempFilePath，将图层内容生成指定大小图片，显示image<ul>
<li>canvas2d   <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> that = <span class="keyword">this</span></span><br><span class="line">   <span class="keyword">const</span> query = wx.createSelectorQuery().in(<span class="keyword">this</span>)</span><br><span class="line">   query.select(<span class="string">'#myCanvas'</span>)</span><br><span class="line">     .fields(&#123; <span class="attr">node</span>: <span class="literal">true</span>, <span class="attr">size</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">     .exec(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">       <span class="keyword">const</span> canvas = res[<span class="number">0</span>].node</span><br><span class="line">       <span class="keyword">const</span> ctx = canvas.getContext(<span class="string">'2d'</span>)</span><br><span class="line">       <span class="keyword">const</span> img = canvas.createImage()</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">'img'</span>, img)</span><br><span class="line">       img.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">         ctx.drawImage(img, <span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>)</span><br><span class="line">           wx.canvasToTempFilePath(&#123;</span><br><span class="line">             x: <span class="number">0</span>,</span><br><span class="line">             y: <span class="number">0</span>,</span><br><span class="line">             width: <span class="number">100</span>,</span><br><span class="line">             height: <span class="number">100</span>,</span><br><span class="line">             destWidth: <span class="number">100</span>,</span><br><span class="line">             destHeight: <span class="number">100</span>,</span><br><span class="line">             canvas: canvas,</span><br><span class="line">             success(res) &#123;</span><br><span class="line">               that.setData(&#123;</span><br><span class="line">                 imgPath: res.tempFilePath</span><br><span class="line">               &#125;)</span><br><span class="line">             &#125;,</span><br><span class="line">             fail(err) &#123;</span><br><span class="line">               <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">             &#125;</span><br><span class="line">           &#125;)</span><br><span class="line">       &#125;</span><br><span class="line">       img.src = <span class="string">'https://p0.meituan.net/myvideodistribute/0990cc2062e81ab6cc11fd8690f8755042005.jpg'</span></span><br><span class="line">       <span class="comment">// 这种方式获取canvas区域隐含的像素数据</span></span><br><span class="line">       <span class="built_in">console</span>.log(ctx.getImageData(<span class="number">0</span>, <span class="number">0</span>, <span class="number">100</span>, <span class="number">100</span>).data)</span><br><span class="line">     &#125;)</span><br></pre></td></tr></table></figure>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;!imgPath&#125;&#125;"</span> <span class="attr">type</span>=<span class="string">"2d"</span> <span class="attr">id</span>=<span class="string">"myCanvas"</span> <span class="attr">canvas-id</span>=<span class="string">"myCanvas"</span> <span class="attr">style</span>=<span class="string">"width: 330px;height: 340px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">wx:else</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;imgPath&#125;&#125;"</span> <span class="attr">style</span>=<span class="string">"width: 330px;height: 340px;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>canvas2d 需要踩得坑是：它的官方文档🙃<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2UwM2Q1ZDg0YzYyNmI0NzlmZjBjOTlmNzA1YmRhYjg5NDc5MjcucG5n?x-oss-process=image/format,png" alt="canvas2d 转图片误导"></li>
<li>尝试下来，会<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2UxMjRiY2Q3ZmNjYWI5ODBlNDdkMTk2YTMyZGQyODI4NDUzODcucG5n?x-oss-process=image/format,png" alt="ctx.draw报错"></li>
</ul>
</li>
<li>那我们可以继续往下看<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2YxODk5NWFiNDY4N2IwYmZlYzhjZTZkZWU2ZWQxYmZjMTA1MTY1LnBuZw?x-oss-process=image/format,png" alt="canvas2d tempath正确实力">这才是符合我们需要</li>
</ul>
</li>
</ul>
</li>
<li>运行截图<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2JmMzVlMzY4YzRjMmRhYTgxNTA0NzM0YTIxZGMxM2I2NDYwNzIucG5n?x-oss-process=image/format,png" alt="canvas2d运行截图"></li>
</ul>
</li>
</ul>
</li>
<li>旧版canvas  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> ctx = wx.createCanvasContext(<span class="string">'myCanvas'</span>)</span><br><span class="line"><span class="keyword">const</span> that = <span class="keyword">this</span></span><br><span class="line">wx.getImageInfo(&#123;</span><br><span class="line">  src: <span class="string">'https://p0.meituan.net/myvideodistribute/0990cc2062e81ab6cc11fd8690f8755042005.jpg'</span>,</span><br><span class="line">  success: <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'res'</span>, res)</span><br><span class="line">    <span class="keyword">const</span> poster = res.path</span><br><span class="line">    ctx.drawImage(poster, <span class="number">0</span>, <span class="number">0</span>, <span class="number">150</span>, <span class="number">100</span>)</span><br><span class="line">    ctx.draw(<span class="literal">false</span>, () =&gt; &#123;</span><br><span class="line">      wx.canvasToTempFilePath(&#123;</span><br><span class="line">        x: <span class="number">0</span>,</span><br><span class="line">        y: <span class="number">0</span>,</span><br><span class="line">        width: <span class="number">100</span>,</span><br><span class="line">        height: <span class="number">100</span>,</span><br><span class="line">        destWidth: <span class="number">100</span>,</span><br><span class="line">        destHeight: <span class="number">100</span>,</span><br><span class="line">        canvasId: <span class="string">"myCanvas"</span>,</span><br><span class="line">        success(res) &#123;</span><br><span class="line">          that.setData(&#123;</span><br><span class="line">            imgPath: res.tempFilePath</span><br><span class="line">          &#125;)</span><br><span class="line">          <span class="built_in">console</span>.log(res.tempFilePath)</span><br><span class="line">        &#125;,</span><br><span class="line">        fail(err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(<span class="string">'err'</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// 这种方式获取canvas区域隐含的像素数据</span></span><br><span class="line">    wx.canvasGetImageData(&#123;</span><br><span class="line">      canvasId: <span class="string">'myCanvas'</span>,</span><br><span class="line">      x: <span class="number">0</span>,</span><br><span class="line">      y: <span class="number">0</span>,</span><br><span class="line">      width: <span class="number">150</span>,</span><br><span class="line">      height: <span class="number">100</span>,</span><br><span class="line">      success(res) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(res.width) <span class="comment">// 150</span></span><br><span class="line">        <span class="built_in">console</span>.log(res.height) <span class="comment">// 100</span></span><br><span class="line">        <span class="built_in">console</span>.log(res.data <span class="keyword">instanceof</span> <span class="built_in">Uint8ClampedArray</span>) <span class="comment">// true</span></span><br><span class="line">        <span class="built_in">console</span>.log(res.data) <span class="comment">// 150 * 100 * 4</span></span><br><span class="line">        <span class="built_in">console</span>.log(res.data.length) <span class="comment">// 150 * 100 * 4</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">wx:if</span>=<span class="string">"&#123;&#123;!imgPath&#125;&#125;"</span> <span class="attr">id</span>=<span class="string">"myCanvas"</span> <span class="attr">canvas-id</span>=<span class="string">"myCanvas"</span> <span class="attr">style</span>=<span class="string">"width: 330px;height: 340px;"</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">image</span> <span class="attr">wx:else</span> <span class="attr">src</span>=<span class="string">"&#123;&#123;imgPath&#125;&#125;"</span> <span class="attr">style</span>=<span class="string">"width: 330px;height: 340px;"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>运行截图<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2EzZTRiYTBkYzc2NDgzYTM1NTYxZDcwNDUzNzZkNjZmNDU5MTgucG5n?x-oss-process=image/format,png" alt="旧版canvas运行截图"><h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>感谢<a href="https://github.com/skadieyes" target="_blank" rel="noopener">Skady宝贝</a>在探讨问题中给予的帮助，欢迎大家去github找她玩👈</li>
<li>祝大家多多发财</li>
</ul>
<hr>
]]></content>
      <categories>
        <category>微信小程序</category>
      </categories>
      <tags>
        <tag>微信小程序</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序-气泡框</title>
    <url>/2020/04/05/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E6%B0%94%E6%B3%A1%E6%A1%86%20Popover/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>记录基于<a href="https://developers.weixin.qq.com/community/develop/doc/000e4e7103c3c090e517e0cdb5b806" target="_blank" rel="noopener">微信小程序-气泡框</a>实现中产生的问题及思考</li>
</ul>
<hr>
<h2 id="问题截图"><a href="#问题截图" class="headerlink" title="问题截图"></a>问题截图</h2><p><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzlkMGY1NmUxOTVkNzFjMjAyYzVkYzI0OGMxMzg0NmUxMTQ3MTQucG5n?x-oss-process=image/format,png" alt="popover问题截图"></p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><ul>
<li>模拟器显示正常，但在真机上点击后，气泡框的箭头并没有消失，且点击同一级别区域，能利用覆盖消除箭头。【是不是一个很可爱的bug？<a id="more"></a>

</li>
</ul>
<h2 id="问题解决过程记录"><a href="#问题解决过程记录" class="headerlink" title="问题解决过程记录"></a>问题解决过程记录</h2><ul>
<li><p>定位问题发生的原因范围</p>
<ul>
<li>样式<ul>
<li>样式在判断显示条件(wx:if=”“)生效后，仍然渲染</li>
<li>否定原因<ul>
<li>查询代码发现，整个样式背景的设定是在::before伪元素选择器中</li>
<li>且显示条件生效，在调试器中已没有该元素，但仍显示</li>
</ul>
</li>
</ul>
</li>
<li>逻辑<ul>
<li>会不会是组件在渲染时，多渲染一份，我们使用判断条件进行开关时，只是对其中一个进行了操作</li>
<li>怀疑依据<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzk5ZjcwMDAwZmViM2IwYzc0MWJmNjFiYzE5YTUwMDIxMjYyMTI3LnBuZw?x-oss-process=image/format,png" alt="popover问题依据截图"></li>
<li>上图可见：在popover组件下，有2个通过&lt;slot&gt;插入的相同内容</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>开始解决问题</p>
<ul>
<li>查询官方关于<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/custom-component/wxml-wxss.html" target="_blank" rel="noopener">slot</a>方面的介绍<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2JjMTE0ZmI0YTdhOWZkY2ZlYzU3ZDE5ZWQyYWY0YzI3MzE1NTU4LnBuZw?x-oss-process=image/format,png" alt="官方slot基础例子"></li>
</ul>
</li>
<li>基于官方基础代码，复现问题<ul>
<li>产生一个child-tag组件，并在其中编写  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// components/child-tag.js.js</span></span><br><span class="line">Component(&#123;</span><br><span class="line">  options: &#123;</span><br><span class="line">    multipleSlots: <span class="literal">true</span> <span class="comment">// 在组件定义时的选项中启用多slot支持</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 组件的属性列表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  properties: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  relations: &#123;</span><br><span class="line">    <span class="string">'./component-tag-name'</span>: &#123;</span><br><span class="line">      type: <span class="string">'parent'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 组件的初始数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  data: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 组件的方法列表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  methods: &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>与component-tag-name绑定形成父子组件  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// components/component-tag-name.js</span></span><br><span class="line">Component(&#123;</span><br><span class="line">  options: &#123;</span><br><span class="line">    multipleSlots: <span class="literal">true</span> <span class="comment">// 在组件定义时的选项中启用多slot支持</span></span><br><span class="line">  &#125;,</span><br><span class="line">  relations: &#123;</span><br><span class="line">    <span class="string">'./child-tag'</span>: &#123;</span><br><span class="line">      type: <span class="string">'child'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 组件的属性列表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  properties: &#123;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 组件的初始数据</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  data: &#123;</span><br><span class="line">    visible: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 组件的方法列表</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  methods: &#123;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>并将index.html中进行调用  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 引用组件的页面模版 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"primary"</span> <span class="attr">bindtap</span>=<span class="string">"onTap"</span>&gt;</span>222<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">my-component</span> <span class="attr">id</span>=<span class="string">"component"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">view</span> <span class="attr">slot</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">			这里是插入到组件slot name="content"中的内容</span><br><span class="line">			<span class="tag">&lt;<span class="name">child-component</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">view</span> <span class="attr">slot</span>=<span class="string">"child"</span>&gt;</span>这里是插入到组件slot name="child"中的内容<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">child-component</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">my-component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>但是其结构树仍然非常正常，并没有出现那个所谓的”拷贝”组件<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzcwNTRhNjJkYmM2MGEyNmU5ZGI1ODYzNzNjOGY2OTgyMzg3NTI0LnBuZw?x-oss-process=image/format,png" alt="改写v1.1后的结构树截图"></li>
<li>仔细复现了几次，发现：多出来的那个组件会有所延迟。抓住这个问题，想到我们在onReady中，注册了该组件，于是，继续模拟</li>
</ul>
</li>
<li>修改index.js代码，并在component-tag-name组件注册onTap方法，控制显隐  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">onReady() &#123;</span><br><span class="line">  <span class="keyword">this</span>.component = <span class="keyword">this</span>.selectComponent(<span class="string">'#component'</span>)</span><br><span class="line">&#125;,</span><br><span class="line">onTap() &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'onTap'</span>)</span><br><span class="line">  wx.createSelectorQuery().select(<span class="string">'#component'</span>).boundingClientRect(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 调用自定义组件 popover 中的 onDisplay 方法</span></span><br><span class="line">      <span class="keyword">this</span>.component.onTap();</span><br><span class="line">  &#125;).exec();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>最终复现<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AxLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzhmZjQ3OTNhMjUwYTNjMzlhYjBlOGQxMGJhYTllZmI2NDc1NjIyLnBuZw?x-oss-process=image/format,png" alt="官方模拟最终运行截图"></li>
</ul>
</li>
</ul>
</li>
<li>得出问题来源：<ul>
<li>在组件中进行了一次setData</li>
</ul>
</li>
<li>思考背后问题<ul>
<li>在组件中setData为什么会”拷贝“一份相同的在页面级wxml中？</li>
<li>猜想一：从<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/view/interactive-animation.html#%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88" target="_blank" rel="noopener">WXS响应事件</a>中，我隐隐得到了答案</li>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzZlYWJjYjdjOTliMzAxNWMwOGQwZmM2YWM3ZmMxMGMzNDU5NDAxLnBuZw?x-oss-process=image/format,png" alt="wxs相应事件"></li>
<li>我们在页面级通过selectComponent实例化组件，对选中的组件进行操作，官方可以通过拷贝一份相同的组件，使我们便捷的将事件的处理从2次的逻辑层和渲染层通信以及一次渲染，减少到直接对页面上元素进行操作，即一次逻辑层和渲染层通信以及一次渲染。</li>
<li>猜想二：问题层面是在微信开发者工具中的wxml，渲染方式对于这种情况就是这样处理的。</li>
</ul>
</li>
</ul>
</li>
<li><p>官方已给出问题原因</p>
<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzJkMWVkZmYyNWIwM2YxZDU2ZGVjYjZhM2NkYjAwMGU5NTE5ODQucG5n?x-oss-process=image/format,png" alt="wxml面板"></li>
</ul>
</li>
</ul>
<h2 id="如何解决问题"><a href="#如何解决问题" class="headerlink" title="如何解决问题"></a>如何解决问题</h2><ul>
<li>在popover以及popover-item加入  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">options: &#123;</span><br><span class="line">		    multipleSlots: <span class="literal">true</span> <span class="comment">// 在组件定义时的选项中启用多slot支持</span></span><br><span class="line">		  &#125;,</span><br></pre></td></tr></table></figure></li>
<li>就可以解决了。最后建议slot中可以写上name这样代码可能会更易读。<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2></li>
<li>祝大家多多发财</li>
</ul>
<hr>
]]></content>
      <categories>
        <category>微信小程序</category>
      </categories>
      <tags>
        <tag>微信小程序</tag>
      </tags>
  </entry>
  <entry>
    <title>自己的前端知识体系</title>
    <url>/2020/04/12/%E8%87%AA%E5%B7%B1%E7%9A%84%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E4%BD%93%E7%B3%BB/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>理一下自己的技术体系吧</li>
</ul>
<a id="more"></a>

<h2 id="技术体系脑图"><a href="#技术体系脑图" class="headerlink" title="技术体系脑图"></a>技术体系脑图</h2><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/49daa01a2bbdab251434a26a618376c53934435.png" alt="技术体系脑图"></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>数组、链表、跳表</title>
    <url>/2020/04/07/%E6%95%B0%E7%BB%84%E3%80%81%E9%93%BE%E8%A1%A8%E3%80%81%E8%B7%B3%E8%A1%A8/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="跳表"><a href="#跳表" class="headerlink" title="跳表"></a>跳表</h2><ul>
<li>补足链表linked list，look up O(n) 的缺陷，升维思想，以空间换时间</li>
<li>数学归纳法</li>
<li>找最近重复问题</li>
</ul>
]]></content>
  </entry>
  <entry>
    <title>【未完】计算机图形学初探</title>
    <url>/2020/04/15/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E5%88%9D%E6%8E%A2/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li><p>记录 计算机图形学 方面的学习过程🤔</p>
<a id="more"></a>

</li>
</ul>
<h2 id="主要概念"><a href="#主要概念" class="headerlink" title="主要概念"></a>主要概念</h2><ul>
<li>前端与图形学<ul>
<li>shader</li>
</ul>
</li>
<li>图形学应用场景<ul>
<li>Image<ul>
<li>pattern（多用于背景）</li>
<li>photo</li>
<li>shape</li>
</ul>
</li>
<li>来自数学的图形–分形</li>
<li>来自物理的图形–光的衍射<ul>
<li>相变</li>
<li>绿幕<ul>
<li>PNG24 –&gt; 2张 jpg</li>
</ul>
</li>
<li>3D效果<ul>
<li>three.js</li>
<li>babylon.js</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><h2 id="图形学基础设施"><a href="#图形学基础设施" class="headerlink" title="图形学基础设施"></a>图形学基础设施</h2></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>计算机图形学</category>
      </categories>
      <tags>
        <tag>计算机图形学</tag>
      </tags>
  </entry>
  <entry>
    <title>编程语言通识</title>
    <url>/2020/04/20/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E9%80%9A%E8%AF%86/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="语言按语法分类"><a href="#语言按语法分类" class="headerlink" title="语言按语法分类"></a>语言按语法分类</h2><ul>
<li>非形式语言<ul>
<li>中文、英文</li>
</ul>
</li>
<li>形式语言（乔姆斯基谱系）<strong>追溯</strong>19世纪50年代<ul>
<li>0型 无限制文法</li>
<li>1型 上下文相关文法</li>
<li>2型 上下文无关文法<ul>
<li>大部分计算机语言主体上都是上下文无关文法</li>
<li>比如Javascript就是上下文无关文法，会在某些点，违反上下文无关文法原则（get）</li>
</ul>
</li>
<li>3型 正则文法<a id="more"></a>

</li>
</ul>
</li>
</ul>
<h2 id="理解形式语言"><a href="#理解形式语言" class="headerlink" title="理解形式语言"></a>理解形式语言</h2><h3 id="产生式（BNF-–-Backus-Naur-Form）"><a href="#产生式（BNF-–-Backus-Naur-Form）" class="headerlink" title="产生式（BNF – Backus-Naur Form）"></a>产生式（BNF – Backus-Naur Form）</h3><ul>
<li>用尖括号括起来的名称来表示语法结构名</li>
<li>语法结构分成基础结构和需要用其他语法结构定义的复合结构<ul>
<li>基础结构称终结符</li>
<li>复合结构称非终结符</li>
</ul>
</li>
<li>引号和中间的字符表示终结符</li>
<li>可以有括号</li>
<li><ul>
<li>表示重复多次</li>
</ul>
</li>
<li>| 表示或</li>
<li><ul>
<li>表示至少一次</li>
</ul>
</li>
</ul>
<h4 id="BNF-表示-四则运算"><a href="#BNF-表示-四则运算" class="headerlink" title="BNF 表示 四则运算"></a>BNF 表示 四则运算</h4><ul>
<li><p>加法，允许连加</p>
<ul>
<li>&lt;Number&gt;::= “0” | “1” | “2” | “3” | … | “9”</li>
<li>&lt;DecimalNumber&gt;::= “0” | ((“1” | “2” | “3” | … “9”) &lt;Number&gt;*)</li>
<li>&lt;AddtiveExpression&gt;::= &lt;DecimalNumber&gt; “+” &lt;DecimalNumber&gt;</li>
<li>支持多个连加，采用递归：<ul>
<li>&lt;AddtiveExpression&gt;::= &lt;AddtiveExpression&gt; “+” &lt;DecimalNumber&gt;</li>
</ul>
</li>
<li>最终：<ul>
<li>&lt;AddtiveExpression&gt;::= &lt;DecimalNumber&gt; | &lt;AddtiveExpression&gt; “+” &lt;DecimalNumber&gt;</li>
</ul>
</li>
</ul>
</li>
<li><p>乘法</p>
<ul>
<li><p>&lt;MultiplecativeExpression&gt;::= &lt;DecimalNumber&gt; | &lt; MultiplecativeExpression&gt; “*” &lt;DecimalNumber&gt;</p>
</li>
<li><p>1 + 2 * 3</p>
<ul>
<li><p>加法表达式，是由两个乘法表达式加起来的</p>
</li>
<li><p>1 * 1 + 2 * 3</p>
</li>
<li><p>因此<strong>加法表示成</strong></p>
<blockquote>
<p>&lt;AddtiveExpression&gt;::= &lt; MultiplecativeExpression&gt; | &lt; AddtiveExpression&gt; “+” &lt;DecimalNumber&gt;</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li><p>LogicExpression</p>
<blockquote>
<p>&lt;LogicExpression&gt;::= &lt;AddtiveExpression&gt; | </p>
<pre><code>&amp;lt;LogicExpression&amp;gt; &quot;||&quot; &amp;lt;AddtiveExpression&amp;gt; |
&amp;lt;LogicExpression&amp;gt; &quot;&amp;&amp;&quot; &amp;lt;AddtiveExpression&amp;gt;</code></pre></blockquote>
</li>
<li><p>除法</p>
<blockquote>
<p>&lt;MultiplecativeExpression&gt;::= &lt;DecimalNumber&gt; | &lt; MultiplecativeExpression&gt; “/“ &lt;DecimalNumber&gt;</p>
</blockquote>
</li>
<li><p>减法</p>
<blockquote>
<p>&lt;AddtiveExpression&gt;::= &lt;MultiplecativeExpression&gt; | &lt; AddtiveExpression&gt; “-“ &lt;MultiplecativeExpression&gt;</p>
</blockquote>
</li>
<li><p>带括号的四则运算</p>
<ul>
<li><p>括号</p>
<blockquote>
<p>&lt;PrimaryExpression&lt;::= &lt;DecimalNumber&lt; | “(“ | &lt;LogicExpression&lt; | “)”</p>
</blockquote>
</li>
<li><p>乘法表达式便可以变成</p>
<blockquote>
<p>&lt;MultiplecativeExpression&gt;::= &lt;PrimaryExpression&gt; | &lt; MultiplecativeExpression&gt; “*” &lt; PrimaryExpression&gt;</p>
</blockquote>
</li>
<li><p>除法，同理乘法，换符号</p>
<blockquote>
<p>&lt;MultiplecativeExpression&gt;::= &lt;PrimaryExpression&gt; | &lt; MultiplecativeExpression&gt; “/“ &lt; PrimaryExpression&gt;</p>
</blockquote>
</li>
<li><p>加减</p>
<blockquote>
<p>&lt;AddtiveExpression&gt;::= &lt;MultiplecativeExpression&gt; | &lt; AddtiveExpression&gt; “+” &lt;MultiplecativeExpression&gt; | &lt; AddtiveExpression&gt; “-“ &lt;MultiplecativeExpression&gt;</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h4 id="通过-BNF-理解形式语言（乔姆斯基谱系）"><a href="#通过-BNF-理解形式语言（乔姆斯基谱系）" class="headerlink" title="通过 BNF 理解形式语言（乔姆斯基谱系）"></a>通过 BNF 理解形式语言（乔姆斯基谱系）</h4><ul>
<li>0型 无限制文法<ul>
<li>?::=?</li>
</ul>
</li>
<li>1型 上下文相关文法<ul>
<li><span style="color: red">?</span>&lt;A&gt;<span style="color:blue">?</span>::=<span style="color: red">?</span>&lt;B&gt;<span style="color:blue">?</span></li>
</ul>
</li>
</ul>
<pre><code>    <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="keyword">get</span> a &#123; <span class="keyword">return</span> <span class="number">1</span>&#125;,</span><br><span class="line">  <span class="keyword">get</span>: 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
- 1）类似关键字， 2）get: 属性</code></pre><ul>
<li><p>2型 上下文无关文法</p>
<ul>
<li>&lt;A&gt;::=?</li>
<li>2 ** 1 ** 2</li>
</ul>
</li>
<li><p>3型 正则文法，只允许左递归（Javascript在**出现前，一直遵循着左递归）</p>
<ul>
<li><p>&lt;A&gt;::=&lt;A&gt;?</p>
</li>
<li><p>&lt;A&gt;::=?&lt;A&gt;<span style="color: red">x</span></p>
</li>
<li><p>Javascript 表达式大部分在3型</p>
</li>
<li><p>** 右结合</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="number">2</span> ** <span class="number">2</span> --&gt; <span class="number">4</span></span><br><span class="line"><span class="number">2</span> ** (<span class="number">2</span> ** <span class="number">3</span>) --&gt; <span class="number">256</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>**</p>
<blockquote>
<p>&lt;ExpExpression&gt; = &lt;MulticativeExpression&gt; | &lt;MulticativeExpression&gt; “**” &lt;ExpExpression&gt;</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="optional-正则表达式-BNF-表示四则运算"><a href="#optional-正则表达式-BNF-表示四则运算" class="headerlink" title="optional 正则表达式+ BNF 表示四则运算"></a>optional 正则表达式+ BNF 表示四则运算</h4><h3 id="其他产生式"><a href="#其他产生式" class="headerlink" title="其他产生式"></a>其他产生式</h3><ul>
<li>EBNF ABNF Customized<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/1d1c7542767173de3c87f7a9e00a445763429.png" alt="ECMA-Script EBNF"></li>
</ul>
</li>
</ul>
<h3 id="现代语言语言的特例"><a href="#现代语言语言的特例" class="headerlink" title="现代语言语言的特例"></a>现代语言语言的特例</h3><ul>
<li>C++，* 可能表示乘号或者指针，具体是哪个，取决于星号前面的标识符是否被声明为类型<ul>
<li>非形式话语言，语法与语义相关，* 可以在很早之前出现</li>
</ul>
</li>
<li>VB中， &lt; 可能是小于号，也可能是 XML 直接量的开始，取决于当前位置是否可以接受 XML 直接量<ul>
<li>1型 上下文无关文法</li>
</ul>
</li>
<li>Python，行首的 tab 符和空格会根据上一行的行首空白以一定规则被处理成虚拟终结符 indent 或者 dedent </li>
<li>Javascript，/ 可能是除号，也可能是正则表达式开头，处理方式类似于VB，字符串模板中也需要特殊处理},还有自动插入分号规则<ul>
<li>同 VB / JSX</li>
</ul>
</li>
</ul>
<h2 id="语言的分类"><a href="#语言的分类" class="headerlink" title="语言的分类"></a>语言的分类</h2><h3 id="图灵完备性"><a href="#图灵完备性" class="headerlink" title="图灵完备性"></a>图灵完备性</h3><ul>
<li>图灵机（凡是可计算的，都能计算出来）</li>
<li>图灵完备性<ul>
<li>命令式 – 图灵机<ul>
<li>goto</li>
<li>if 和 while</li>
</ul>
</li>
<li>声明式 – lambda<ul>
<li>递归</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="动态与静态"><a href="#动态与静态" class="headerlink" title="动态与静态"></a>动态与静态</h3><ul>
<li>动态：<ul>
<li>在用户的设备/在线服务器上</li>
<li>产品实际运行时</li>
<li>Runtime</li>
</ul>
</li>
<li>静态<ul>
<li>在程序员的设备上</li>
<li>产品开发时</li>
<li>Compiletime</li>
</ul>
</li>
</ul>
<h4 id="类型系统-In-静态语言"><a href="#类型系统-In-静态语言" class="headerlink" title="类型系统 In 静态语言"></a>类型系统 In 静态语言</h4><ul>
<li>动态类型系统和静态类型系统<ul>
<li>不是说 Typescript 才有类型系统，而是它才有静态类型系统</li>
</ul>
</li>
<li>强类型和弱类型<ul>
<li>String + Number<ul>
<li>产生了隐式的类型转换</li>
</ul>
</li>
<li>String == Boolean</li>
<li>C++ 有隐式转换，弱类型</li>
</ul>
</li>
<li>复合类型<ul>
<li>结构体</li>
<li><strong>函数签名</strong><ul>
<li>参数列表 + 返回值类型</li>
</ul>
</li>
</ul>
</li>
<li>子类型<ul>
<li>逆变/协变<ul>
<li>协变 –&gt; 凡是能用到Array&lt;Parent&gt;的地方，都能用Array&lt;Child&gt;</li>
<li>逆变 –&gt; 凡是能用到Array&lt;Child&gt;的地方，都能用Array&lt;Parent&gt;</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="一般命令式编程语言"><a href="#一般命令式编程语言" class="headerlink" title="一般命令式编程语言"></a>一般命令式编程语言</h2><h3 id="Atom"><a href="#Atom" class="headerlink" title="Atom"></a>Atom</h3><h3 id="Expression"><a href="#Expression" class="headerlink" title="Expression"></a>Expression</h3><h3 id="Statement-语句"><a href="#Statement-语句" class="headerlink" title="Statement 语句"></a>Statement 语句</h3><h3 id="Structure"><a href="#Structure" class="headerlink" title="Structure"></a>Structure</h3><h3 id="Program"><a href="#Program" class="headerlink" title="Program"></a>Program</h3>]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript-运行机制（二）</title>
    <url>/2020/05/02/Javascrtip-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>嗯，发现 运行机制 的面试题是真的多。。😓</li>
<li>那这就是，最末篇吧</li>
<li>加油 Elle 🤦‍♀️</li>
<li>五一倒计时 2 天</li>
</ul>
<a id="more"></a>

<h2 id="实践记录"><a href="#实践记录" class="headerlink" title="实践记录"></a>实践记录</h2><h3 id="async-await"><a href="#async-await" class="headerlink" title="async / await"></a>async / await</h3><p>5.1 题目一</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 start"</span>);</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 end"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async2"</span>);</span><br><span class="line">&#125;</span><br><span class="line">async1();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>分析<ul>
<li>代码从上至下开始执行</li>
<li>执行同步代码</li>
<li>async1();<ul>
<li>console.log(“async1 start”);</li>
<li>await async2();<ul>
<li>等待执行 async2 结果</li>
<li>console.log(“async2”);</li>
</ul>
</li>
<li>console.log(“async1 end”); 入队微任务队列</li>
</ul>
</li>
<li>console.log(‘start’)</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 </li>
<li>console.log(“async1 end”);</li>
</ul>
</li>
</ul>
<ul>
<li><p>结论</p>
<ul>
<li>在这里，可以理解为「紧跟着await后面的语句相当于放到了new Promise中，下一行及之后的语句相当于放在Promise.then中」</li>
</ul>
</li>
<li><p>等同于</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 start"</span>);</span><br><span class="line">  <span class="comment">// 原来代码</span></span><br><span class="line">  <span class="comment">// await async2();</span></span><br><span class="line">  <span class="comment">// console.log("async1 end");</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 转换后代码</span></span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"async2"</span>)</span><br><span class="line">    resolve()</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"async1 end"</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async2"</span>);</span><br><span class="line">&#125;</span><br><span class="line">async1();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li>运行结果<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/f08b1b409f667c37f2a9dae1bf0b491e36782.png" alt="题目一运行结果"></li>
</ul>
</li>
</ul>
<p>5.2 题目二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 start"</span>);</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 end"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer'</span>)</span><br><span class="line">  &#125;, <span class="number">0</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async2"</span>);</span><br><span class="line">&#125;</span><br><span class="line">async1();</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>async1();<ul>
<li>执行同步代码</li>
<li>console.log(“async1 start”);</li>
<li>await async2();<ul>
<li>setTimeout … 入队宏任务队列</li>
<li>console.log(“async2”);</li>
</ul>
</li>
<li>console.log(“async1 end”); 入队微任务队列</li>
</ul>
</li>
<li>console.log(“start”)</li>
<li>当前宏任务中的同步代码执行完成，开始执行微任务队列<ul>
<li>console.log(“async1 end”);</li>
</ul>
</li>
<li>第一个宏任务执行完成，开始执行下一个宏任务</li>
<li>console.log(‘timer’)</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/ef5bbc4448d8cf8a4e6e7eb3d481257d43632.png" alt="题目二运行结果"></li>
</ul>
</li>
</ul>
<p>5.3 题目三</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 start"</span>);</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 end"</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer1'</span>)</span><br><span class="line">  &#125;, <span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer2'</span>)</span><br><span class="line">  &#125;, <span class="number">0</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async2"</span>);</span><br><span class="line">&#125;</span><br><span class="line">async1();</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer3'</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"start"</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>async1();<ul>
<li>console.log(“async1 start”);</li>
<li>await async2();<ul>
<li>setTimeout … 入队宏任务队列</li>
<li>console.log(“async2”);</li>
</ul>
</li>
<li>console.log(“async1 end”); 入队微任务队列</li>
<li>setTimeout … 入队微任务队列</li>
</ul>
</li>
<li>setTimeout … 入队宏任务队列</li>
<li>console.log(“start”)</li>
<li>当前宏任务中的同步代码已经执行完成，开始执行微任务</li>
<li>console.log(“async1 end”);</li>
<li>setTimeout … 入队宏任务队列</li>
<li>当前宏任务执行完成，开始执行下一个宏任务</li>
<li>console.log(‘timer2’);</li>
<li>当前宏任务执行完成，开始执行下一个宏任务</li>
<li>console.log(‘timer3’)</li>
<li>当前宏任务执行完成，开始执行下一个宏任务</li>
<li>console.log(‘timer1’)</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/40ff5c3620b6ef956afd99a895080cee58816.png" alt="题目三运行结果"></li>
</ul>
</li>
</ul>
<p>5.4 题目四</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">fn</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// return await 1234</span></span><br><span class="line">  <span class="comment">// 等同于</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">123</span></span><br><span class="line">&#125;</span><br><span class="line">fn().then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>fn()<ul>
<li>return 123</li>
</ul>
</li>
<li>console.log(res) res –&gt; 123</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/01d7e322293346a15fd0c97cb6167dee21159.png" alt="题目四运行结果"></li>
</ul>
</li>
</ul>
<p>5.5 <strong>题目五</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 start'</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 success'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'async1 end'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'srcipt start'</span>)</span><br><span class="line">async1().then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'srcipt end'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>console.log(‘srcipt start’)</li>
<li>async1()<ul>
<li>console.log(‘async1 start’);</li>
<li>new Promise … 等待执行<ul>
<li>console.log(‘promise1’)</li>
<li>由于 promise 并没有 resolved、rejected，所以一直处在 pending 状态，所以 会一直 await ，await 后的内容也包括 async1 后面的 then，都不会执行</li>
</ul>
</li>
</ul>
</li>
<li>console.log(‘srcipt end’)</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/6da017ef5e2bef76433a90be0f7804c343869.png" alt="题目五运行结果"></li>
</ul>
</li>
</ul>
<p>5.6 题目六</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 start'</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>)</span><br><span class="line">    resolve(<span class="string">'promise1 resolve'</span>)</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 success'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'async1 end'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'srcipt start'</span>)</span><br><span class="line">async1().then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'srcipt end'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>分析<ul>
<li>代码从上至下开始执行</li>
<li>console.log(‘srcipt start’)</li>
<li>async1()<ul>
<li>console.log(‘async1 start’);</li>
<li>await new Promise … 等待 promise 执行<ul>
<li>console.log(‘promise1’)</li>
<li>其中 promise 状态变为 resolved，将其状态保存起来</li>
<li>new Promise then … 加入微任务队列</li>
</ul>
</li>
<li>console.log(‘async1 success’); 入队微任务队列</li>
<li>return ‘async1 end’</li>
</ul>
</li>
<li>async1().then … 入队微任务队列</li>
<li>console.log(‘srcipt end’)</li>
<li>当前宏任务中的同步代码执行完成，开始执行微任务队列</li>
<li>.then(res =&gt; console.log(res))<ul>
<li>res –&gt; promise1 resolve</li>
</ul>
</li>
<li>console.log(‘async1 success’); </li>
<li>res =&gt; console.log(res) res –&gt; ‘async1 end’</li>
</ul>
</li>
</ul>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/478ab1a6c972bd17dab664ba479c1c2859767.png" alt="题目六运行结果"></li>
</ul>
</li>
</ul>
<p>5.7 题目七</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 start'</span>);</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>)</span><br><span class="line">    resolve(<span class="string">'promise resolve'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 success'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'async1 end'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'srcipt start'</span>)</span><br><span class="line">async1().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise2'</span>)</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>console.log(‘srcipt start’)</li>
<li>async1()<ul>
<li>console.log(‘async1 start’);</li>
<li>await new Promise …<ul>
<li>console.log(‘promise1’)</li>
<li>其中 promise 状态变为 resolve，将其保存起来</li>
</ul>
</li>
<li>console.log(‘async1 success’); 入队微任务队列</li>
<li>return ‘async1 end’</li>
</ul>
</li>
<li>async1().then … 入队微任务队列</li>
<li>new Promise，执行该构造函数代码<ul>
<li>console.log(‘promise2’)</li>
<li>setTimeout … 加入宏任务队列</li>
</ul>
</li>
<li>当前宏任务中的同步代码执行完，开始执行微任务</li>
<li>console.log(‘async1 success’);</li>
<li>console.log(res) res –&gt; ‘async1 end’</li>
<li>当前宏任务执行完成，开始执行下一个宏任务</li>
<li>console.log(‘timer’)</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/59c38ec9bef1877e27b64b056fd9258663945.png" alt="题目七运行结果"></li>
</ul>
</li>
</ul>
<p>5.8 题目八</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 start"</span>);</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async1 end"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"async2"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"script start"</span>);</span><br><span class="line"></span><br><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"setTimeout"</span>);</span><br><span class="line">&#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">async1();</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"promise1"</span>);</span><br><span class="line">  resolve();</span><br><span class="line">&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"promise2"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script end'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>console.log(“script start”);</li>
<li>setTimeout … 入队宏任务队列</li>
<li>async1()<ul>
<li>console.log(“async1 start”);</li>
<li>await async2();<ul>
<li>console.log(“async2”);</li>
</ul>
</li>
<li>console.log(“async1 end”); 入队微任务队列</li>
</ul>
</li>
<li>new promise，执行该构造函数<ul>
<li>console.log(“promise1”);</li>
<li>其中 promise 状态改变为 resolve，将其保存</li>
</ul>
</li>
<li>new promise then … 入队微任务队列</li>
<li>console.log(‘script end’)</li>
<li>当前宏任务中的同步代码执行完成，开始执行微任务</li>
<li>console.log(“async1 end”);</li>
<li>new Promise then … <ul>
<li>console.log(“promise2”);</li>
</ul>
</li>
<li>当前宏任务执行完成，开始执行下一个宏任务<ul>
<li>console.log(“setTimeout”);</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/05bcc26014cb3a56f1da38df3e28141974246.png" alt="题目八运行结果"></li>
</ul>
</li>
</ul>
<p>5.9 题目九</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">testSometing</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"执行testSometing"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">"testSometing"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">testAsync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"执行testAsync"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="string">"hello async"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"test start..."</span>);</span><br><span class="line">  <span class="keyword">const</span> v1 = <span class="keyword">await</span> testSometing();</span><br><span class="line">  <span class="built_in">console</span>.log(v1);</span><br><span class="line">  <span class="keyword">const</span> v2 = <span class="keyword">await</span> testAsync();</span><br><span class="line">  <span class="built_in">console</span>.log(v2);</span><br><span class="line">  <span class="built_in">console</span>.log(v1, v2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"promise start..."</span>);</span><br><span class="line">  resolve(<span class="string">"promise"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promise.then(<span class="function"><span class="params">val</span> =&gt;</span> <span class="built_in">console</span>.log(val));</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"test end..."</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>分析<ul>
<li>代码从上至下开始执行</li>
<li>test()<ul>
<li>console.log(“test start…”);</li>
<li>await testSometing()<ul>
<li>console.log(“执行testSometing”);</li>
<li>“testSometing”;</li>
<li>const v1 = “testSometing”;</li>
</ul>
</li>
<li>console.log(“testSometing”); 入队微任务队列</li>
<li>await testAsync() 入队微任务队列</li>
<li>console.log(v2); 入队微任务队列</li>
<li>console.log(v1, v2); 入队微任务队列</li>
<li>new Promise, 执行该构造函数代码<ul>
<li>console.log(“promise start…”);</li>
<li>其 promise 状态变为 resolve,将其保存</li>
</ul>
</li>
<li>promise.then … 入队微任务队列</li>
<li>console.log(“test end…”);</li>
<li>当前宏任务中的同步代码执行完成，开始执行微任务<ul>
<li>console.log(“testSometing”); v1 –&gt; “testSometing”</li>
<li>await testAsync() <ul>
<li>console.log(“执行testAsync”);</li>
<li>return Promise.resolve(“hello async”);</li>
<li>Promise.resolve(“hello async”) … 入队微任务队列</li>
</ul>
</li>
<li>console.log(v2); … 重新入队微任务队列</li>
<li>console.log(v1, v2); 重新入队微任务队列</li>
<li>promise.then … <ul>
<li>console.log(val) val –&gt; promise</li>
</ul>
</li>
<li>Promise.resolve(“hello async”) return “hello async”</li>
<li>v2 = “hello async”</li>
<li>console.log(v2);</li>
<li>console.log(“hello async”);</li>
<li>console.log(v1, v2);<ul>
<li>console.log(“执行testAsync”, “hello async”);</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/09e8b0ae4cadad1f803049e6545d73f091754.png" alt="题目九运行结果"></li>
</ul>
</li>
</ul>
<h3 id="async-处理错误"><a href="#async-处理错误" class="headerlink" title="async 处理错误"></a>async 处理错误</h3><p>6.1 <strong>题目一</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> async2();</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'async1 success'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async2</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'async2'</span>)</span><br><span class="line">    reject(<span class="string">'error'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line">async1().then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>async1()<ul>
<li>await async2();<ul>
<li>new Promise，执行该构造函数<ul>
<li>console.log(‘async2’)</li>
<li>reject(‘error’) promise 状态变为 reject,将其保存起来，并向上抛</li>
<li>Promise {<rejected>: “error”}</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/b3955dc674cf405c9a60de9062b525c736256.png" alt="题目一运行结果"></li>
</ul>
</li>
</ul>
<p>6.2 题目二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">async1</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.reject(<span class="string">'error!!!'</span>)</span><br><span class="line">  &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1'</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(<span class="string">'async1 success'</span>)</span><br><span class="line">&#125;</span><br><span class="line">async1().then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script start'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>async1()<ul>
<li>Promise.reject(‘error!!!’)<ul>
<li>promise 状态变为 reject，将其状态保存起来，向上抛错</li>
</ul>
</li>
<li>catch 错误 入队微任务队列</li>
<li>console.log(‘async1’); 入队微任务队列</li>
<li>return Promise.resolve(‘async1 success’)</li>
</ul>
</li>
<li>async1().then … 入队微任务队列</li>
<li>console.log(‘script start’)</li>
<li>当前宏任务中的同步代码执行完成，开始执行微任务</li>
<li>console.log(e) e –&gt; ‘error!!!’</li>
<li>console.log(‘async1’);</li>
<li>console.log(res) res –&gt; ‘async1 success’</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/fc960e772e0fbca1fdf8640c8774999640316.png" alt="题目二运行结果"></li>
</ul>
</li>
</ul>
<h3 id="综合题"><a href="#综合题" class="headerlink" title="综合题"></a>综合题</h3><p>7.1 题目一</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> first = <span class="function"><span class="params">()</span> =&gt;</span> <span class="function">(<span class="params"><span class="keyword">new</span> <span class="built_in">Promise</span>((resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">let</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="number">7</span>);</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="number">5</span>);</span><br><span class="line">            resolve(<span class="number">6</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(p)</span><br><span class="line">        &#125;, <span class="number">0</span>)</span><br><span class="line">        resolve(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    resolve(<span class="number">2</span>);</span><br><span class="line">    p.then(<span class="function">(<span class="params">arg</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(arg);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;));</span><br><span class="line">first().then(<span class="function">(<span class="params">arg</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(arg);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>first()<ul>
<li>return 一个 promise 对象。先执行 new Promise，该构造函数代码</li>
<li>console.log(3);</li>
<li>resolve(2)<ul>
<li>该 promise 状态变为 resolved，保存起来</li>
</ul>
</li>
<li>p new Promise, 执行该构造函数代码<ul>
<li>console.log(7);</li>
<li>setTimeout … 入队宏任务队列</li>
<li>resolve(1);</li>
<li>该 promise 状态变为 resolve ,保存起来</li>
</ul>
</li>
<li>p.then … 入队微任务队列</li>
</ul>
</li>
<li>first().then … 入队微任务队列</li>
<li>执行同步代码<ul>
<li>console.log(4);</li>
</ul>
</li>
<li>该宏任务中的同步代码都执行完成，开始执行微任务队列</li>
<li>p.then</li>
<li>console.log(arg) arg –&gt; 1</li>
<li>p.then 入队微任务队列</li>
<li>console.log(arg) arg –&gt; 2</li>
<li>当前宏任务中的代码都执行完成，开始执行下一个宏任务</li>
<li>setTimeout …<ul>
<li>console.log(5);</li>
<li>resolve(6); promise p 的状态已经改变，无法再进行更改，所以该行代码，无效</li>
<li>console.log(p) p –&gt; 1</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/de321f1169135bf57ef98b6dd3346ada56428.png" alt="题目一运行结果"></li>
</ul>
</li>
</ul>
<p>7.2 题目二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> async1 = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1'</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer1'</span>)</span><br><span class="line">  &#125;, <span class="number">2000</span>)</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise1'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'async1 end'</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="string">'async1 success'</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script start'</span>);</span><br><span class="line">async1().then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'script end'</span>);</span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line">  .then(<span class="number">2</span>)</span><br><span class="line">  .then(<span class="built_in">Promise</span>.resolve(<span class="number">3</span>))</span><br><span class="line">  .catch(<span class="number">4</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer2'</span>)</span><br><span class="line">&#125;, <span class="number">1000</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>console.log(‘script start’);</li>
<li>async1()<ul>
<li>console.log(‘async1’);</li>
<li>setTimeout … 2000入队宏任务队列</li>
<li>await new Promise<ul>
<li>执行该构造函数代码<ul>
<li>console.log(‘promise1’)</li>
</ul>
</li>
</ul>
</li>
<li>由于该 promise 没有被 resolve、reject，一直处在 pending，因此 后面的<ul>
<li>console.log(‘async1 end’) 入队微任务队列</li>
<li>return ‘async1 success’</li>
<li>均不执行</li>
</ul>
</li>
</ul>
</li>
<li>async1().then … 入队微任务队列</li>
<li>console.log(‘script end’);</li>
<li>Promise.resolve(1)<ul>
<li>该 promie 状态变为1，保存起来</li>
</ul>
</li>
<li>Promise.resolve(1).then … 入队微任务队列</li>
<li>setTimeout … 1000入队宏任务队列</li>
<li>当前宏任务中的同步代码执行完成，开始执行微任务</li>
<li>Promise.resolve(1).then … <ul>
<li>由于 .then(2) .then(Promise.resolve(3)) .catch(4) 一个是数字，一个是对象，会发生值透传现象</li>
<li>console.log(res) res –&gt; 1</li>
</ul>
</li>
<li>当前宏任务执行完成，开始执行下一个宏任务</li>
<li>setTimeout … 1000<ul>
<li>console.log(‘timer2’)</li>
</ul>
</li>
<li>setTimeout … 2000<ul>
<li><ul>
<li>console.log(‘timer1’)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/18d87ace8b51f98e4e30f55c17d0c4ff93076.png" alt="题目二运行结果"></li>
</ul>
</li>
</ul>
<p>7.3 题目三</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> p1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">'resolve3'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer1'</span>)</span><br><span class="line">  &#125;, <span class="number">0</span>)</span><br><span class="line">  resolve(<span class="string">'resovle1'</span>);</span><br><span class="line">  resolve(<span class="string">'resolve2'</span>);</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(p1)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;).finally(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'finally'</span>, res)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>new Promise，执行该构造函数代码<ul>
<li>setTimeout … 入队宏任务队列</li>
<li>resolve(‘resovle1’);</li>
<li>promise 状态变为 resolve1，并保存起来</li>
</ul>
</li>
<li>Promise.then …<ul>
<li>console.log(res) res –&gt; ‘resovle1’</li>
<li>setTimeout … 入队宏任务队列</li>
</ul>
</li>
<li>Promise.finally …<ul>
<li>console.log(‘finally’, res) res –&gt; undefined</li>
</ul>
</li>
<li>当前宏任务中的代码全部执行完成，开始执行下一个宏任务</li>
<li>resolve(‘resolve3’); promise 状态一旦改变，无法更改</li>
<li>console.log(‘timer1’)</li>
<li>当前宏任务中的代码全部执行完成，开始执行下一个宏任务</li>
<li>console.log(p1) p1 –&gt; .finally的返回值 –&gt; undefined</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><strong>finally 不管 Promise 的状态是 resolved 还是 rejected 都会执行，且它的回调函数是接收不到 Promise 的结果的</strong>，所以 finally() 中的 res 是一个迷惑项</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/7be692142d758f1d65ad549a1b106f4146102.png" alt="题目三运行结果"></li>
</ul>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://juejin.im/post/5e58c618e51d4526ed66b5cf" target="_blank" rel="noopener">题目来源</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Realm</title>
    <url>/2020/05/08/Realm/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>Before it is evaluated, all ECMAScript code must be associated with a realm. Conceptually, a realm consists of a set of intrinsic objects, an ECMAScript global environment, all of the ECMAScript code that is loaded within the scope of that global environment, and other associated state and resources.</li>
</ul>
<a id="more"></a>

<ul>
<li><p>从逻辑上讲，堆栈中的每个上下文总是与其 realm 相关联</p>
<ul>
<li><p>让我们看看单独的realm的例子，使用vm模块：</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">'vm'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// First realm, and its global:</span></span><br><span class="line"><span class="keyword">const</span> realm1 = vm.createContext(&#123;<span class="attr">x</span>: <span class="number">10</span>, <span class="built_in">console</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Second realm, and its global:</span></span><br><span class="line"><span class="keyword">const</span> realm2 = vm.createContext(&#123;<span class="attr">x</span>: <span class="number">20</span>, <span class="built_in">console</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Code to execute:</span></span><br><span class="line"><span class="keyword">const</span> code = <span class="string">`console.log(x);`</span>;</span><br><span class="line"></span><br><span class="line">vm.runInContext(code, realm1); <span class="comment">// 10</span></span><br><span class="line">vm.runInContext(code, realm2); <span class="comment">// 20</span></span><br></pre></td></tr></table></figure></li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/5055c18e52edec4cd447d7acfd4a8278158263.png" alt="realm"></p>
</li>
</ul>
</li>
</ul>
<h2 id="实践记录"><a href="#实践记录" class="headerlink" title="实践记录"></a>实践记录</h2><ul>
<li><p>JavaScript 中所有的固有对象</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> objects = [</span><br><span class="line">  <span class="string">"eval"</span>,</span><br><span class="line">  <span class="string">"isFinite"</span>,</span><br><span class="line">  <span class="string">"isNaN"</span>,</span><br><span class="line">  <span class="string">"parseFloat"</span>,</span><br><span class="line">  <span class="string">"parseInt"</span>,</span><br><span class="line">  <span class="string">"decodeURI"</span>,</span><br><span class="line">  <span class="string">"decodeURIComponent"</span>,</span><br><span class="line">  <span class="string">"encodeURI"</span>,</span><br><span class="line">  <span class="string">"encodeURIComponent"</span>,</span><br><span class="line">  <span class="string">"Array"</span>,</span><br><span class="line">  <span class="string">"Date"</span>,</span><br><span class="line">  <span class="string">"RegExp"</span>,</span><br><span class="line">  <span class="string">"Promise"</span>,</span><br><span class="line">  <span class="string">"Proxy"</span>,</span><br><span class="line">  <span class="string">"Map"</span>,</span><br><span class="line">  <span class="string">"WeakMap"</span>,</span><br><span class="line">  <span class="string">"Set"</span>,</span><br><span class="line">  <span class="string">"WeakSet"</span>,</span><br><span class="line">  <span class="string">"Function"</span>,</span><br><span class="line">  <span class="string">"Boolean"</span>,</span><br><span class="line">  <span class="string">"String"</span>,</span><br><span class="line">  <span class="string">"Number"</span>,</span><br><span class="line">  <span class="string">"Symbol"</span>,</span><br><span class="line">  <span class="string">"Object"</span>,</span><br><span class="line">  <span class="string">"Error"</span>,</span><br><span class="line">  <span class="string">"EvalError"</span>,</span><br><span class="line">  <span class="string">"RangeError"</span>,</span><br><span class="line">  <span class="string">"ReferenceError"</span>,</span><br><span class="line">  <span class="string">"SyntaxError"</span>,</span><br><span class="line">  <span class="string">"TypeError"</span>,</span><br><span class="line">  <span class="string">"URIError"</span>,</span><br><span class="line">  <span class="string">"ArrayBuffer"</span>,</span><br><span class="line">  <span class="string">"SharedArrayBuffer"</span>,</span><br><span class="line">  <span class="string">"DataView"</span>,</span><br><span class="line">  <span class="string">"Float32Array"</span>,</span><br><span class="line">  <span class="string">"Float64Array"</span>,</span><br><span class="line">  <span class="string">"Int8Array"</span>,</span><br><span class="line">  <span class="string">"Int16Array"</span>,</span><br><span class="line">  <span class="string">"Int32Array"</span>,</span><br><span class="line">  <span class="string">"Uint8Array"</span>,</span><br><span class="line">  <span class="string">"Uint16Array"</span>,</span><br><span class="line">  <span class="string">"Uint32Array"</span>,</span><br><span class="line">  <span class="string">"Uint8ClampedArray"</span>,</span><br><span class="line">  <span class="string">"Atomics"</span>,</span><br><span class="line">  <span class="string">"JSON"</span>,</span><br><span class="line">  <span class="string">"Math"</span>,</span><br><span class="line">  <span class="string">"Reflect"</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">set</span> = new Set();</span><br><span class="line"></span><br><span class="line">const globalObject = []</span><br><span class="line"></span><br><span class="line">for (let i of objects) &#123;</span><br><span class="line">  globalObject.push(&#123;</span><br><span class="line">    object: <span class="keyword">this</span>[i],</span><br><span class="line">    path: [i]</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (globalObject.length) &#123;</span><br><span class="line">  <span class="keyword">const</span> current = globalObject.shift()</span><br><span class="line">  <span class="built_in">console</span>.log(current.path.join(<span class="string">'.'</span>))</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">set</span>.has(current.object))</span><br><span class="line">    continue;</span><br><span class="line">  <span class="keyword">set</span>.add(current.object)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  let proto = Object.getPrototypeOf(current.object)</span><br><span class="line">  if (proto) &#123;</span><br><span class="line">    globalObject.push(&#123;</span><br><span class="line">      path: current.path.concat([<span class="string">"__proto__"</span>]),</span><br><span class="line">      object: proto</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">of</span> <span class="built_in">Object</span>.getOwnPropertyNames(current.object)) &#123;</span><br><span class="line">    <span class="keyword">let</span> d = <span class="built_in">Object</span>.getOwnPropertyDescriptor(current.object, p)</span><br><span class="line">    <span class="keyword">if</span> (d.hasOwnProperty(<span class="string">"value"</span>) &amp;&amp; ((d.value !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> d.value === <span class="string">"object"</span>) || (<span class="keyword">typeof</span> d.value === <span class="string">"function"</span>)) &amp;&amp; d.value <span class="keyword">instanceof</span> <span class="built_in">Object</span>) &#123;</span><br><span class="line">      globalObject.push(&#123;</span><br><span class="line">        path: current.path.concat([p]),</span><br><span class="line">        object: d.value</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d.hasOwnProperty(<span class="string">"get"</span>) &amp;&amp; <span class="keyword">typeof</span> d.get === <span class="string">"function"</span>) &#123;</span><br><span class="line">      globalObject.push(&#123;</span><br><span class="line">        path: current.path.concat([p]),</span><br><span class="line">        object: d.get</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d.hasOwnProperty(<span class="string">"set"</span>) &amp;&amp; <span class="keyword">typeof</span> d.set === <span class="string">"function"</span>) &#123;</span><br><span class="line">      globalObject.push(&#123;</span><br><span class="line">        path: current.path.concat([p]),</span><br><span class="line">        object: d.set</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>根据上述代码，进行数据结构方面的格式化</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">	</span><br><span class="line"><span class="keyword">const</span> objects = [</span><br><span class="line">  <span class="string">"eval"</span>,</span><br><span class="line">  <span class="string">"isFinite"</span>,</span><br><span class="line">  <span class="string">"isNaN"</span>,</span><br><span class="line">  <span class="string">"parseFloat"</span>,</span><br><span class="line">  <span class="string">"parseInt"</span>,</span><br><span class="line">  <span class="string">"decodeURI"</span>,</span><br><span class="line">  <span class="string">"decodeURIComponent"</span>,</span><br><span class="line">  <span class="string">"encodeURI"</span>,</span><br><span class="line">  <span class="string">"encodeURIComponent"</span>,</span><br><span class="line">  <span class="string">"Array"</span>,</span><br><span class="line">  <span class="string">"Date"</span>,</span><br><span class="line">  <span class="string">"RegExp"</span>,</span><br><span class="line">  <span class="string">"Promise"</span>,</span><br><span class="line">  <span class="string">"Proxy"</span>,</span><br><span class="line">  <span class="string">"Map"</span>,</span><br><span class="line">  <span class="string">"WeakMap"</span>,</span><br><span class="line">  <span class="string">"Set"</span>,</span><br><span class="line">  <span class="string">"WeakSet"</span>,</span><br><span class="line">  <span class="string">"Function"</span>,</span><br><span class="line">  <span class="string">"Boolean"</span>,</span><br><span class="line">  <span class="string">"String"</span>,</span><br><span class="line">  <span class="string">"Number"</span>,</span><br><span class="line">  <span class="string">"Symbol"</span>,</span><br><span class="line">  <span class="string">"Object"</span>,</span><br><span class="line">  <span class="string">"Error"</span>,</span><br><span class="line">  <span class="string">"EvalError"</span>,</span><br><span class="line">  <span class="string">"RangeError"</span>,</span><br><span class="line">  <span class="string">"ReferenceError"</span>,</span><br><span class="line">  <span class="string">"SyntaxError"</span>,</span><br><span class="line">  <span class="string">"TypeError"</span>,</span><br><span class="line">  <span class="string">"URIError"</span>,</span><br><span class="line">  <span class="string">"ArrayBuffer"</span>,</span><br><span class="line">  <span class="string">"SharedArrayBuffer"</span>,</span><br><span class="line">  <span class="string">"DataView"</span>,</span><br><span class="line">  <span class="string">"Float32Array"</span>,</span><br><span class="line">  <span class="string">"Float64Array"</span>,</span><br><span class="line">  <span class="string">"Int8Array"</span>,</span><br><span class="line">  <span class="string">"Int16Array"</span>,</span><br><span class="line">  <span class="string">"Int32Array"</span>,</span><br><span class="line">  <span class="string">"Uint8Array"</span>,</span><br><span class="line">  <span class="string">"Uint16Array"</span>,</span><br><span class="line">  <span class="string">"Uint32Array"</span>,</span><br><span class="line">  <span class="string">"Uint8ClampedArray"</span>,</span><br><span class="line">  <span class="string">"Atomics"</span>,</span><br><span class="line">  <span class="string">"JSON"</span>,</span><br><span class="line">  <span class="string">"Math"</span>,</span><br><span class="line">  <span class="string">"Reflect"</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">set</span> = new Set();</span><br><span class="line"></span><br><span class="line">const globalObject = &#123;</span><br><span class="line">  id: <span class="string">"Global Object"</span>,</span><br><span class="line">  children: [</span><br><span class="line"></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> objects) &#123;</span><br><span class="line">  globalObject.children.push(&#123;</span><br><span class="line">    children: [],</span><br><span class="line">    id: i</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; objects.length; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> current = objects[i]</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">set</span>.has(objects[i]))</span><br><span class="line">    continue;</span><br><span class="line">  <span class="keyword">set</span>.add(objects[i])</span><br><span class="line">  for (let p of Object.getOwnPropertyNames(window[objects[i]])) &#123;</span><br><span class="line">    <span class="keyword">let</span> d = <span class="built_in">Object</span>.getOwnPropertyDescriptor(<span class="built_in">window</span>[objects[i]], p)</span><br><span class="line">    <span class="keyword">if</span> (d.hasOwnProperty(<span class="string">"value"</span>) &amp;&amp; ((d.value !== <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> d.value === <span class="string">"object"</span>) || (<span class="keyword">typeof</span> d.value === <span class="string">"function"</span>)) &amp;&amp; d.value <span class="keyword">instanceof</span> <span class="built_in">Object</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> childrenThird = []</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">of</span> <span class="built_in">Object</span>.getOwnPropertyNames(d.value)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k !== <span class="string">'name'</span> &amp;&amp; k !== <span class="string">'length'</span>) &#123;</span><br><span class="line">          childrenThird.push(&#123; <span class="attr">id</span>: k &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      globalObject[<span class="string">"children"</span>][i].children.push(&#123;</span><br><span class="line">        children: childrenThird,</span><br><span class="line">        id: p</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d.hasOwnProperty(<span class="string">"get"</span>) &amp;&amp; <span class="keyword">typeof</span> d.get === <span class="string">"function"</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> childrenThird = []</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">of</span> <span class="built_in">Object</span>.getOwnPropertyNames(d.get)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k !== <span class="string">'name'</span> &amp;&amp; k !== <span class="string">'length'</span>) &#123;</span><br><span class="line">          childrenThird.push(&#123; <span class="attr">id</span>: k &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      globalObject[<span class="string">"children"</span>][i].children.push(&#123;</span><br><span class="line">        children: childrenThird,</span><br><span class="line">        id: p</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (d.hasOwnProperty(<span class="string">"set"</span>) &amp;&amp; <span class="keyword">typeof</span> d.set === <span class="string">"function"</span>) &#123;</span><br><span class="line">      <span class="keyword">let</span> childrenThird = []</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> k <span class="keyword">of</span> <span class="built_in">Object</span>.getOwnPropertyNames(d.set)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (k !== <span class="string">'name'</span> &amp;&amp; k !== <span class="string">'length'</span>) &#123;</span><br><span class="line">          childrenThird.push(&#123; <span class="attr">id</span>: k &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      globalObject[<span class="string">"children"</span>][i].children.push(&#123;</span><br><span class="line">        children: childrenThird,</span><br><span class="line">        id: p</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>处理好的JSON数据  </p>
<pre><code><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&quot;id&quot;:&quot;Global Object&quot;,&quot;children&quot;:[&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;eval&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isFinite&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isNaN&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;parseFloat&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;parseInt&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;decodeURI&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;decodeURIComponent&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;encodeURI&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;encodeURIComponent&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;concat&quot;&#125;,&#123;&quot;id&quot;:&quot;copyWithin&quot;&#125;,&#123;&quot;id&quot;:&quot;fill&quot;&#125;,&#123;&quot;id&quot;:&quot;find&quot;&#125;,&#123;&quot;id&quot;:&quot;findIndex&quot;&#125;,&#123;&quot;id&quot;:&quot;lastIndexOf&quot;&#125;,&#123;&quot;id&quot;:&quot;pop&quot;&#125;,&#123;&quot;id&quot;:&quot;push&quot;&#125;,&#123;&quot;id&quot;:&quot;reverse&quot;&#125;,&#123;&quot;id&quot;:&quot;shift&quot;&#125;,&#123;&quot;id&quot;:&quot;unshift&quot;&#125;,&#123;&quot;id&quot;:&quot;slice&quot;&#125;,&#123;&quot;id&quot;:&quot;sort&quot;&#125;,&#123;&quot;id&quot;:&quot;splice&quot;&#125;,&#123;&quot;id&quot;:&quot;includes&quot;&#125;,&#123;&quot;id&quot;:&quot;indexOf&quot;&#125;,&#123;&quot;id&quot;:&quot;join&quot;&#125;,&#123;&quot;id&quot;:&quot;keys&quot;&#125;,&#123;&quot;id&quot;:&quot;entries&quot;&#125;,&#123;&quot;id&quot;:&quot;values&quot;&#125;,&#123;&quot;id&quot;:&quot;forEach&quot;&#125;,&#123;&quot;id&quot;:&quot;filter&quot;&#125;,&#123;&quot;id&quot;:&quot;flat&quot;&#125;,&#123;&quot;id&quot;:&quot;flatMap&quot;&#125;,&#123;&quot;id&quot;:&quot;map&quot;&#125;,&#123;&quot;id&quot;:&quot;every&quot;&#125;,&#123;&quot;id&quot;:&quot;some&quot;&#125;,&#123;&quot;id&quot;:&quot;reduce&quot;&#125;,&#123;&quot;id&quot;:&quot;reduceRight&quot;&#125;,&#123;&quot;id&quot;:&quot;toLocaleString&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isArray&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;from&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;of&quot;&#125;],&quot;id&quot;:&quot;Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;,&#123;&quot;id&quot;:&quot;toDateString&quot;&#125;,&#123;&quot;id&quot;:&quot;toTimeString&quot;&#125;,&#123;&quot;id&quot;:&quot;toISOString&quot;&#125;,&#123;&quot;id&quot;:&quot;toUTCString&quot;&#125;,&#123;&quot;id&quot;:&quot;toGMTString&quot;&#125;,&#123;&quot;id&quot;:&quot;getDate&quot;&#125;,&#123;&quot;id&quot;:&quot;setDate&quot;&#125;,&#123;&quot;id&quot;:&quot;getDay&quot;&#125;,&#123;&quot;id&quot;:&quot;getFullYear&quot;&#125;,&#123;&quot;id&quot;:&quot;setFullYear&quot;&#125;,&#123;&quot;id&quot;:&quot;getHours&quot;&#125;,&#123;&quot;id&quot;:&quot;setHours&quot;&#125;,&#123;&quot;id&quot;:&quot;getMilliseconds&quot;&#125;,&#123;&quot;id&quot;:&quot;setMilliseconds&quot;&#125;,&#123;&quot;id&quot;:&quot;getMinutes&quot;&#125;,&#123;&quot;id&quot;:&quot;setMinutes&quot;&#125;,&#123;&quot;id&quot;:&quot;getMonth&quot;&#125;,&#123;&quot;id&quot;:&quot;setMonth&quot;&#125;,&#123;&quot;id&quot;:&quot;getSeconds&quot;&#125;,&#123;&quot;id&quot;:&quot;setSeconds&quot;&#125;,&#123;&quot;id&quot;:&quot;getTime&quot;&#125;,&#123;&quot;id&quot;:&quot;setTime&quot;&#125;,&#123;&quot;id&quot;:&quot;getTimezoneOffset&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCDate&quot;&#125;,&#123;&quot;id&quot;:&quot;setUTCDate&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCDay&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCFullYear&quot;&#125;,&#123;&quot;id&quot;:&quot;setUTCFullYear&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCHours&quot;&#125;,&#123;&quot;id&quot;:&quot;setUTCHours&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCMilliseconds&quot;&#125;,&#123;&quot;id&quot;:&quot;setUTCMilliseconds&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCMinutes&quot;&#125;,&#123;&quot;id&quot;:&quot;setUTCMinutes&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCMonth&quot;&#125;,&#123;&quot;id&quot;:&quot;setUTCMonth&quot;&#125;,&#123;&quot;id&quot;:&quot;getUTCSeconds&quot;&#125;,&#123;&quot;id&quot;:&quot;setUTCSeconds&quot;&#125;,&#123;&quot;id&quot;:&quot;valueOf&quot;&#125;,&#123;&quot;id&quot;:&quot;getYear&quot;&#125;,&#123;&quot;id&quot;:&quot;setYear&quot;&#125;,&#123;&quot;id&quot;:&quot;toJSON&quot;&#125;,&#123;&quot;id&quot;:&quot;toLocaleString&quot;&#125;,&#123;&quot;id&quot;:&quot;toLocaleDateString&quot;&#125;,&#123;&quot;id&quot;:&quot;toLocaleTimeString&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;now&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;parse&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;UTC&quot;&#125;],&quot;id&quot;:&quot;Date&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;exec&quot;&#125;,&#123;&quot;id&quot;:&quot;dotAll&quot;&#125;,&#123;&quot;id&quot;:&quot;flags&quot;&#125;,&#123;&quot;id&quot;:&quot;global&quot;&#125;,&#123;&quot;id&quot;:&quot;ignoreCase&quot;&#125;,&#123;&quot;id&quot;:&quot;multiline&quot;&#125;,&#123;&quot;id&quot;:&quot;source&quot;&#125;,&#123;&quot;id&quot;:&quot;sticky&quot;&#125;,&#123;&quot;id&quot;:&quot;unicode&quot;&#125;,&#123;&quot;id&quot;:&quot;compile&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;,&#123;&quot;id&quot;:&quot;test&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;input&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;input&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$_&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$_&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;lastMatch&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;lastMatch&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$&amp;&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$&amp;&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;lastParen&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;lastParen&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$+&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$+&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;leftContext&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;leftContext&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$&#96;&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$&#96;&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;rightContext&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;rightContext&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$&#39;&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$&#39;&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$1&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$1&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$2&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$2&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$3&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$3&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$4&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$4&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$5&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$5&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$6&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$6&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$7&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$7&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$8&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$8&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$9&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;$9&quot;&#125;],&quot;id&quot;:&quot;RegExp&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;then&quot;&#125;,&#123;&quot;id&quot;:&quot;catch&quot;&#125;,&#123;&quot;id&quot;:&quot;finally&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;all&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;race&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;resolve&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;reject&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;allSettled&quot;&#125;],&quot;id&quot;:&quot;Promise&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;revocable&quot;&#125;],&quot;id&quot;:&quot;Proxy&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;get&quot;&#125;,&#123;&quot;id&quot;:&quot;set&quot;&#125;,&#123;&quot;id&quot;:&quot;has&quot;&#125;,&#123;&quot;id&quot;:&quot;delete&quot;&#125;,&#123;&quot;id&quot;:&quot;clear&quot;&#125;,&#123;&quot;id&quot;:&quot;entries&quot;&#125;,&#123;&quot;id&quot;:&quot;forEach&quot;&#125;,&#123;&quot;id&quot;:&quot;keys&quot;&#125;,&#123;&quot;id&quot;:&quot;size&quot;&#125;,&#123;&quot;id&quot;:&quot;values&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Map&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;delete&quot;&#125;,&#123;&quot;id&quot;:&quot;get&quot;&#125;,&#123;&quot;id&quot;:&quot;set&quot;&#125;,&#123;&quot;id&quot;:&quot;has&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;WeakMap&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;has&quot;&#125;,&#123;&quot;id&quot;:&quot;add&quot;&#125;,&#123;&quot;id&quot;:&quot;delete&quot;&#125;,&#123;&quot;id&quot;:&quot;clear&quot;&#125;,&#123;&quot;id&quot;:&quot;entries&quot;&#125;,&#123;&quot;id&quot;:&quot;forEach&quot;&#125;,&#123;&quot;id&quot;:&quot;size&quot;&#125;,&#123;&quot;id&quot;:&quot;values&quot;&#125;,&#123;&quot;id&quot;:&quot;keys&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Set&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;delete&quot;&#125;,&#123;&quot;id&quot;:&quot;has&quot;&#125;,&#123;&quot;id&quot;:&quot;add&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;WeakSet&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;arguments&quot;&#125;,&#123;&quot;id&quot;:&quot;caller&quot;&#125;,&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;apply&quot;&#125;,&#123;&quot;id&quot;:&quot;bind&quot;&#125;,&#123;&quot;id&quot;:&quot;call&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Function&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;,&#123;&quot;id&quot;:&quot;valueOf&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Boolean&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;anchor&quot;&#125;,&#123;&quot;id&quot;:&quot;big&quot;&#125;,&#123;&quot;id&quot;:&quot;blink&quot;&#125;,&#123;&quot;id&quot;:&quot;bold&quot;&#125;,&#123;&quot;id&quot;:&quot;charAt&quot;&#125;,&#123;&quot;id&quot;:&quot;charCodeAt&quot;&#125;,&#123;&quot;id&quot;:&quot;codePointAt&quot;&#125;,&#123;&quot;id&quot;:&quot;concat&quot;&#125;,&#123;&quot;id&quot;:&quot;endsWith&quot;&#125;,&#123;&quot;id&quot;:&quot;fontcolor&quot;&#125;,&#123;&quot;id&quot;:&quot;fontsize&quot;&#125;,&#123;&quot;id&quot;:&quot;fixed&quot;&#125;,&#123;&quot;id&quot;:&quot;includes&quot;&#125;,&#123;&quot;id&quot;:&quot;indexOf&quot;&#125;,&#123;&quot;id&quot;:&quot;italics&quot;&#125;,&#123;&quot;id&quot;:&quot;lastIndexOf&quot;&#125;,&#123;&quot;id&quot;:&quot;link&quot;&#125;,&#123;&quot;id&quot;:&quot;localeCompare&quot;&#125;,&#123;&quot;id&quot;:&quot;match&quot;&#125;,&#123;&quot;id&quot;:&quot;matchAll&quot;&#125;,&#123;&quot;id&quot;:&quot;normalize&quot;&#125;,&#123;&quot;id&quot;:&quot;padEnd&quot;&#125;,&#123;&quot;id&quot;:&quot;padStart&quot;&#125;,&#123;&quot;id&quot;:&quot;repeat&quot;&#125;,&#123;&quot;id&quot;:&quot;replace&quot;&#125;,&#123;&quot;id&quot;:&quot;search&quot;&#125;,&#123;&quot;id&quot;:&quot;slice&quot;&#125;,&#123;&quot;id&quot;:&quot;small&quot;&#125;,&#123;&quot;id&quot;:&quot;split&quot;&#125;,&#123;&quot;id&quot;:&quot;strike&quot;&#125;,&#123;&quot;id&quot;:&quot;sub&quot;&#125;,&#123;&quot;id&quot;:&quot;substr&quot;&#125;,&#123;&quot;id&quot;:&quot;substring&quot;&#125;,&#123;&quot;id&quot;:&quot;sup&quot;&#125;,&#123;&quot;id&quot;:&quot;startsWith&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;,&#123;&quot;id&quot;:&quot;trim&quot;&#125;,&#123;&quot;id&quot;:&quot;trimStart&quot;&#125;,&#123;&quot;id&quot;:&quot;trimLeft&quot;&#125;,&#123;&quot;id&quot;:&quot;trimEnd&quot;&#125;,&#123;&quot;id&quot;:&quot;trimRight&quot;&#125;,&#123;&quot;id&quot;:&quot;toLocaleLowerCase&quot;&#125;,&#123;&quot;id&quot;:&quot;toLocaleUpperCase&quot;&#125;,&#123;&quot;id&quot;:&quot;toLowerCase&quot;&#125;,&#123;&quot;id&quot;:&quot;toUpperCase&quot;&#125;,&#123;&quot;id&quot;:&quot;valueOf&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;fromCharCode&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;fromCodePoint&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;raw&quot;&#125;],&quot;id&quot;:&quot;String&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;toExponential&quot;&#125;,&#123;&quot;id&quot;:&quot;toFixed&quot;&#125;,&#123;&quot;id&quot;:&quot;toPrecision&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;,&#123;&quot;id&quot;:&quot;valueOf&quot;&#125;,&#123;&quot;id&quot;:&quot;toLocaleString&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isFinite&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isInteger&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isNaN&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isSafeInteger&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;parseFloat&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;parseInt&quot;&#125;],&quot;id&quot;:&quot;Number&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;,&#123;&quot;id&quot;:&quot;valueOf&quot;&#125;,&#123;&quot;id&quot;:&quot;description&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;for&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;keyFor&quot;&#125;],&quot;id&quot;:&quot;Symbol&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;assign&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;getOwnPropertyDescriptor&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;getOwnPropertyDescriptors&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;getOwnPropertyNames&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;getOwnPropertySymbols&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;is&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;preventExtensions&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;seal&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;create&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;defineProperties&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;defineProperty&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;freeze&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;getPrototypeOf&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;setPrototypeOf&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isExtensible&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isFrozen&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isSealed&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;keys&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;entries&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;fromEntries&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;values&quot;&#125;],&quot;id&quot;:&quot;Object&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;message&quot;&#125;,&#123;&quot;id&quot;:&quot;toString&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;captureStackTrace&quot;&#125;],&quot;id&quot;:&quot;Error&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;message&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;EvalError&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;message&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;RangeError&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;message&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;ReferenceError&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;message&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;SyntaxError&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;message&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;TypeError&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;message&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;URIError&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;byteLength&quot;&#125;,&#123;&quot;id&quot;:&quot;slice&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isView&quot;&#125;],&quot;id&quot;:&quot;ArrayBuffer&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;byteLength&quot;&#125;,&#123;&quot;id&quot;:&quot;slice&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;SharedArrayBuffer&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;buffer&quot;&#125;,&#123;&quot;id&quot;:&quot;byteLength&quot;&#125;,&#123;&quot;id&quot;:&quot;byteOffset&quot;&#125;,&#123;&quot;id&quot;:&quot;getInt8&quot;&#125;,&#123;&quot;id&quot;:&quot;setInt8&quot;&#125;,&#123;&quot;id&quot;:&quot;getUint8&quot;&#125;,&#123;&quot;id&quot;:&quot;setUint8&quot;&#125;,&#123;&quot;id&quot;:&quot;getInt16&quot;&#125;,&#123;&quot;id&quot;:&quot;setInt16&quot;&#125;,&#123;&quot;id&quot;:&quot;getUint16&quot;&#125;,&#123;&quot;id&quot;:&quot;setUint16&quot;&#125;,&#123;&quot;id&quot;:&quot;getInt32&quot;&#125;,&#123;&quot;id&quot;:&quot;setInt32&quot;&#125;,&#123;&quot;id&quot;:&quot;getUint32&quot;&#125;,&#123;&quot;id&quot;:&quot;setUint32&quot;&#125;,&#123;&quot;id&quot;:&quot;getFloat32&quot;&#125;,&#123;&quot;id&quot;:&quot;setFloat32&quot;&#125;,&#123;&quot;id&quot;:&quot;getFloat64&quot;&#125;,&#123;&quot;id&quot;:&quot;setFloat64&quot;&#125;,&#123;&quot;id&quot;:&quot;getBigInt64&quot;&#125;,&#123;&quot;id&quot;:&quot;setBigInt64&quot;&#125;,&#123;&quot;id&quot;:&quot;getBigUint64&quot;&#125;,&#123;&quot;id&quot;:&quot;setBigUint64&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;DataView&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Float32Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Float64Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Int8Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Int16Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Int32Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Uint8Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Uint16Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Uint32Array&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[&#123;&quot;id&quot;:&quot;constructor&quot;&#125;,&#123;&quot;id&quot;:&quot;BYTES_PER_ELEMENT&quot;&#125;],&quot;id&quot;:&quot;prototype&quot;&#125;],&quot;id&quot;:&quot;Uint8ClampedArray&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;load&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;store&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;add&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;sub&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;and&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;or&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;xor&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;exchange&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;compareExchange&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isLockFree&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;wait&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;wake&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;notify&quot;&#125;],&quot;id&quot;:&quot;Atomics&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;parse&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;stringify&quot;&#125;],&quot;id&quot;:&quot;JSON&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;abs&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;acos&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;acosh&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;asin&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;asinh&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;atan&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;atanh&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;atan2&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;ceil&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;cbrt&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;expm1&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;clz32&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;cos&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;cosh&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;exp&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;floor&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;fround&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;hypot&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;imul&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;log&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;log1p&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;log2&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;log10&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;max&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;min&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;pow&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;random&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;round&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;sign&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;sin&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;sinh&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;sqrt&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;tan&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;tanh&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;trunc&quot;&#125;],&quot;id&quot;:&quot;Math&quot;&#125;,&#123;&quot;children&quot;:[&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;defineProperty&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;deleteProperty&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;apply&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;construct&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;get&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;getOwnPropertyDescriptor&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;getPrototypeOf&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;has&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;isExtensible&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;ownKeys&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;preventExtensions&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;set&quot;&#125;,&#123;&quot;children&quot;:[],&quot;id&quot;:&quot;setPrototypeOf&quot;&#125;],&quot;id&quot;:&quot;Reflect&quot;&#125;]&#125;</span><br></pre></td></tr></table></figure></code></pre></li>
</ul>
</li>
<li><p>绘制 G6 Tree Graph</p>
<ul>
<li><p>需要在 HTML 中创建一个用于容纳 G6 绘制的图的容器，通常为 div  标签。G6 在绘制时会在该容器下追加 canvas 标签，然后将图绘制在其中。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;div id=<span class="string">"container"</span> /&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>引入 G6 的数据源为 JSON 格式的对象。即上面我们处理过的 globalObject</p>
</li>
<li><p>创建关系图（实例化）时，至少需要为图设置容器、宽和高。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">		</span><br><span class="line"><span class="keyword">const</span> width = <span class="built_in">window</span>.devicePixelRatio * <span class="built_in">window</span>.screen.width * <span class="number">0.5</span>; <span class="comment">// 高清显示</span></span><br><span class="line"><span class="keyword">const</span> height = <span class="built_in">window</span>.devicePixelRatio * <span class="built_in">window</span>.screen.height;</span><br><span class="line"><span class="keyword">const</span> graph = <span class="keyword">new</span> G6.TreeGraph(&#123;</span><br><span class="line">  container: <span class="string">'container'</span>,</span><br><span class="line">  width,</span><br><span class="line">  height,</span><br><span class="line">  modes: &#123;</span><br><span class="line">    <span class="keyword">default</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        type: <span class="string">'collapse-expand'</span>,</span><br><span class="line">        onChange: <span class="function"><span class="keyword">function</span> <span class="title">onChange</span>(<span class="params">item, collapsed</span>) </span>&#123;</span><br><span class="line">          <span class="keyword">const</span> data = item.get(<span class="string">'model'</span>).data;</span><br><span class="line">          data.collapsed = collapsed;</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">'drag-canvas'</span>,</span><br><span class="line">      <span class="string">'zoom-canvas'</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">  defaultNode: &#123;</span><br><span class="line">    size: <span class="number">26</span>,</span><br><span class="line">    anchorPoints: [</span><br><span class="line">      [<span class="number">0</span>, <span class="number">0.5</span>],</span><br><span class="line">      [<span class="number">1</span>, <span class="number">0.5</span>],</span><br><span class="line">    ],</span><br><span class="line">    style: &#123;</span><br><span class="line">      fill: <span class="string">'#C6E5FF'</span>,</span><br><span class="line">      stroke: <span class="string">'#5B8FF9'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  defaultEdge: &#123;</span><br><span class="line">    type: <span class="string">'cubic-horizontal'</span>,</span><br><span class="line">    style: &#123;</span><br><span class="line">      stroke: <span class="string">'#A3B1BF'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  layout: &#123;</span><br><span class="line">    type: <span class="string">'compactBox'</span>,</span><br><span class="line">    direction: <span class="string">'LR'</span>,</span><br><span class="line">    getId: <span class="function"><span class="keyword">function</span> <span class="title">getId</span>(<span class="params">d</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> d.id;</span><br><span class="line">    &#125;,</span><br><span class="line">    getHeight: <span class="function"><span class="keyword">function</span> <span class="title">getHeight</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    getWidth: <span class="function"><span class="keyword">function</span> <span class="title">getWidth</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">16</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    getVGap: <span class="function"><span class="keyword">function</span> <span class="title">getVGap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">10</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">    getHGap: <span class="function"><span class="keyword">function</span> <span class="title">getHGap</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置数据源，渲染</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">graph.data(data);</span><br><span class="line"> graph.render();</span><br><span class="line"> graph.fitView();</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>运行截图</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/348969f29ced9ddcebac4fce71a1de42543229.png" alt="g6"></li>
</ul>
</li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li><a href="https://github.com/Ele-Peng/antv-g6-realm" target="_blank" rel="noopener">完整代码地址-点击一下</a></li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
  <entry>
    <title>Toy-Browser-DAY4</title>
    <url>/2020/05/22/Toy-Browser-DAY4/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>implementation of a toy-browser 🙆</li>
<li>嘻嘻嘻，我们将要在做 toy-browser 浏览器相关排版问题啦</li>
<li><img src="http://p0.meituan.net/myvideodistribute/6d5c67d3d5d0633bf667bd680f6dfb9489753.png" alt="DOM with CSS"></li>
</ul>
<a id="more"></a>

<h3 id="第一步：初始化"><a href="#第一步：初始化" class="headerlink" title="第一步：初始化"></a>第一步：初始化</h3><ul>
<li><p>我们采用以下 html 代码段</p>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">maaa</span>=<span class="string">a</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-id">#container</span>&#123;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">width</span><span class="selector-pseudo">:500px</span>;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">height</span><span class="selector-pseudo">:300px</span>;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">display</span><span class="selector-pseudo">:flex</span>;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span><span class="selector-pseudo">:rgb(255</span>,255,255);</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-id">#container</span> <span class="selector-id">#myid</span>&#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">width</span><span class="selector-pseudo">:200px</span>;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">height</span><span class="selector-pseudo">:100px</span>;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">background-color</span><span class="selector-pseudo">:rgb(255</span>,0,0)</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="selector-id">#container</span> <span class="selector-class">.c1</span>&#123;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">flex</span><span class="selector-pseudo">:1</span>;</span></span><br><span class="line"><span class="css">      <span class="selector-tag">background-color</span><span class="selector-pseudo">:rgb(0</span>,255,0)</span></span><br><span class="line">    &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"myid"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"c1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>代码逻辑自顶向下</p>
</li>
<li><p>首先，我们在 endTag 的时候进行 layout</p>
<ul>
<li>我们只处理 flex，可以简化成在 endTag 时，进行 layout 即可</li>
</ul>
</li>
<li><p>computeCSS7.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> layout = <span class="built_in">require</span>(<span class="string">"./layout.js"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ... some code</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emit</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line">	</span><br><span class="line">  <span class="comment">// ... some code</span></span><br><span class="line">	</span><br><span class="line">  <span class="keyword">if</span> (token.type == <span class="string">"startTag"</span>) &#123;</span><br><span class="line">	    </span><br><span class="line">	 <span class="comment">// ... some code</span></span><br><span class="line">	</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.type == <span class="string">"endTag"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (top.tagName != token.tagName) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Tag start end doesn't match"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// console.log('pop', stack.pop())</span></span><br><span class="line">      <span class="comment">/** 遇到 style 标签时，执行添加 CCS 规则的操作 */</span></span><br><span class="line">      <span class="keyword">if</span> (top.tagName === <span class="string">"style"</span>) &#123;</span><br><span class="line">        addCSSRules(top.children[<span class="number">0</span>].content)</span><br><span class="line">      &#125;</span><br><span class="line">      layout(top)</span><br><span class="line">      stack.pop()</span><br><span class="line">    &#125;</span><br><span class="line">    currentTextNode = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.type == <span class="string">"text"</span>) &#123;</span><br><span class="line">	    </span><br><span class="line">	 <span class="comment">// ... some code</span></span><br><span class="line">	</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="flex-布局基础概念"><a href="#flex-布局基础概念" class="headerlink" title="flex 布局基础概念"></a>flex 布局基础概念</h4></li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/1e160d5f7cbdc299f68d432dcb19cca1137896.png" alt="flex 排版解释图"></p>
<blockquote>
<p>给 div 这类块状元素元素设置 display: flex 或者给 span 这类内联元素设置 display: inline-flex ，flex 布局即创建！其中，直接设置 display: flex 或者 display: inline-flex 的元素称为 flex 容器，里面的子元素称为 flex 子项。</p>
</blockquote>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/0f5622ba2bab24f882be6007f6761a4422506.png" alt="flex 相关方法概览"></li>
</ul>
</li>
<li><p>由上 felx 布局中的 主轴，交叉轴图示，我们可以先定义变量</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">mainSize, <span class="comment">// 主轴size width / height</span></span><br><span class="line">mainStart, <span class="comment">// 主轴起点 left / right / top / bottom</span></span><br><span class="line">mainEnd, <span class="comment">// 主轴终点 left / right / top / bottom</span></span><br><span class="line">mainSign, <span class="comment">// 主轴符号位，用于 是否 reverse +1 / -1</span></span><br><span class="line">mainBase, <span class="comment">// 主轴开始的位置 0 / style.width</span></span><br><span class="line">crossSize, <span class="comment">// 交叉轴size width / height</span></span><br><span class="line">crossStart, <span class="comment">// 交叉轴坐标起点 left / right / top / bottom</span></span><br><span class="line">crossEnd, <span class="comment">// 交叉轴坐标终点 left / right / top / bottom</span></span><br><span class="line">crossSign, <span class="comment">// 交叉轴符号位，用于 是否 reverse +1 / -1</span></span><br><span class="line">crossBase; <span class="comment">// 交叉轴开始的位置 0 / style.width</span></span><br></pre></td></tr></table></figure></li>
<li><p>处理 flex 布局中属性默认值</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!style.flexDirection || style.flexDirection === <span class="string">'auto'</span>)</span><br><span class="line">    style.flexDirection = <span class="string">'row'</span></span><br><span class="line"><span class="keyword">if</span> (!style.alignItems || style.alignItems === <span class="string">'auto'</span>)</span><br><span class="line">    style.alignItems = <span class="string">'stretch'</span></span><br><span class="line"><span class="keyword">if</span> (!style.justifyContent || style.justifyContent === <span class="string">'auto'</span>)</span><br><span class="line">    style.justifyContent = <span class="string">'flex-start'</span></span><br><span class="line"><span class="keyword">if</span> (!style.flexWrap || style.flexWrap === <span class="string">'auto'</span>)</span><br><span class="line">    style.flexWrap = <span class="string">'nowrap'</span></span><br><span class="line"><span class="keyword">if</span> (!style.alignContent || style.alignContent === <span class="string">'auto'</span>)</span><br><span class="line">    style.alignContent = <span class="string">'center'</span></span><br></pre></td></tr></table></figure>
<h4 id="flex-direction"><a href="#flex-direction" class="headerlink" title="flex-direction"></a>flex-direction</h4></li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/bec69e2fc98cf7ebfaad21b5d166030361399.png" alt="MDN flex-direction 语法解释"></p>
<ul>
<li><p>flex-direction: row</p>
<ul>
<li><p>默认值，显示为行。方向为当前文档水平流方向，默认情况下是从左往右。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.flexDirection === <span class="string">'row'</span>) &#123;</span><br><span class="line">	mainSize = <span class="string">'width'</span></span><br><span class="line">	mainStart = <span class="string">'left'</span></span><br><span class="line">	mainEnd = <span class="string">'right'</span></span><br><span class="line">	mainSign = +<span class="number">1</span></span><br><span class="line">	mainBase = <span class="number">0</span></span><br><span class="line">		</span><br><span class="line">	crossSize = <span class="string">'height'</span></span><br><span class="line">	crossStart = <span class="string">'top'</span></span><br><span class="line">	crossEnd = <span class="string">'bottom'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>flex-direction: row-reverse</p>
<ul>
<li><p>显示为行。但方向和row属性值是反的。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.flexDirection === <span class="string">'row-reverse'</span>) &#123;</span><br><span class="line">    mainSize = <span class="string">'width'</span></span><br><span class="line">    mainStart = <span class="string">'right'</span></span><br><span class="line">    mainEnd = <span class="string">'left'</span></span><br><span class="line">    mainSign = <span class="number">-1</span></span><br><span class="line">    mainBase = style.width</span><br><span class="line"></span><br><span class="line">    crossSize = <span class="string">'height'</span></span><br><span class="line">    crossStart = <span class="string">'top'</span></span><br><span class="line">    crossEnd = <span class="string">'bottom'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>flex-direction: column</p>
<ul>
<li><p>显示为列。方向为当前文档垂直流方向，默认情况下是从上至下。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.flexDirection === <span class="string">'column'</span>) &#123;</span><br><span class="line">    mainSize = <span class="string">'height'</span></span><br><span class="line">    mainStart = <span class="string">'top'</span></span><br><span class="line">    mainEnd = <span class="string">'bottom'</span></span><br><span class="line">    mainSign = +<span class="number">1</span></span><br><span class="line">    mainBase = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    crossSize = <span class="string">'width'</span></span><br><span class="line">    crossStart = <span class="string">'left'</span></span><br><span class="line">    crossEnd = <span class="string">'right'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>flex-direction: column-reverse</p>
<ul>
<li><p>显示为列。但方向和column属性值是反的。</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.flexDirection === <span class="string">'column-reverse'</span>) &#123;</span><br><span class="line">    mainSize = <span class="string">'height'</span></span><br><span class="line">    mainStart = <span class="string">'bottom'</span></span><br><span class="line">    mainEnd = <span class="string">'top'</span></span><br><span class="line">    mainSign = <span class="number">-1</span></span><br><span class="line">    mainBase = style.height</span><br><span class="line"></span><br><span class="line">    crossSize = <span class="string">'width'</span></span><br><span class="line">    crossStart = <span class="string">'left'</span></span><br><span class="line">    crossEnd = <span class="string">'right'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="flex-wrap"><a href="#flex-wrap" class="headerlink" title="flex-wrap"></a>flex-wrap</h4><ul>
<li><p><img src="http://p0.meituan.net/myvideodistribute/137acf28be957d3b145c9571e3af265462518.png" alt="MDN flex-wrap语法解释"></p>
<ul>
<li><p>flex-wrap: nowrap</p>
<ul>
<li><p>默认值，表示单行显示，不换行。于是很容易出现宽度溢出的场景，其渲染表现比较复杂，需要对CSS3宽度有一定了解。这边我们简单处理为：（以水平布局举例）</p>
<ul>
<li><p>flex 子项宽度 width 之和大于 flex 容器宽度，则内容溢出，表现和 white-space: nowrap 类似。</p>
</li>
<li><p>flex 子项宽度 width 之和大于 flex 容器宽度，则内容不溢出</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">crossBase = <span class="number">0</span></span><br><span class="line">crossSign = +<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>flex-wrap: wrap</p>
<ul>
<li><p>宽度不足换行显示</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">crossBase = <span class="number">0</span></span><br><span class="line">crossSign = +<span class="number">1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>flex-wrap: wrap-reverse</p>
<ul>
<li><p>宽度不足换行显示，但是是从下往上开始，也就是原本换行在下面的子项现在跑到上面</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.flexWrap === <span class="string">'wrap-reverse'</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> temp = crossStart</span><br><span class="line">    crossStart = crossEnd</span><br><span class="line">    crossEnd = temp</span><br><span class="line">    crossSign = <span class="number">-1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li><a href="https://github.com/Ele-Peng/toy-browser/blob/master/layout1.js" target="_blank" rel="noopener">layout1.js 完整代码-点击一下</a></li>
</ul>
<h3 id="第二步：收集元素进行"><a href="#第二步：收集元素进行" class="headerlink" title="第二步：收集元素进行"></a>第二步：收集元素进行</h3><ul>
<li><p>flex 容器没有设置 mainSize，直接撑开，count flex 子项 mainSize</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> isAutoMainSize = <span class="literal">false</span></span><br><span class="line"><span class="comment">// 没有设置 mainSize 直接撑开</span></span><br><span class="line"><span class="keyword">if</span> (!style[mainSize]) &#123; <span class="comment">// auto sizing</span></span><br><span class="line">elementStyle[mainSize] = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i ++) &#123;</span><br><span class="line">    <span class="keyword">let</span> item = items[i]</span><br><span class="line">    <span class="keyword">if</span> (itemStyle[mainSize] !== <span class="literal">null</span> || itemStyle[mainSize] !== (<span class="keyword">void</span> <span class="number">0</span>)) </span><br><span class="line">      elementStyle[mainSize] = elementStyle[mainSize] + itemStyle[mainSize]</span><br><span class="line">&#125;</span><br><span class="line">isAutoMainSize = <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>flex 容器 flex-wrap: no-wrap &amp;&amp; isAutoMainSize，mainSpace 为0，允许撑大，<strong>强行分进第一行</strong></p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.flexWrap === <span class="string">'nowrap'</span> &amp;&amp; isAutoMainSize) &#123;</span><br><span class="line">     mainSpace -= itemStyle[mainSize]</span><br><span class="line">     <span class="keyword">if</span> (itemStyle[crossSize] !== <span class="literal">null</span> &amp;&amp; itemStyle[crossSize] !== (<span class="keyword">void</span> <span class="number">0</span>)) &#123;</span><br><span class="line">       crossSpace = <span class="built_in">Math</span>.max(crossSpace, itemStyle[crossSize])</span><br><span class="line">     &#125;</span><br><span class="line">     flexLine.push(item)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>flex 子项 display 为 flex，直接塞进当前行，mainSpace 不作处理，后续自适应</p>
<ul>
<li><p>flex: none | auto | [ &lt;’flex-grow’&gt; &lt;’flex-shrink’&gt;? || &lt;’flex-basis’&gt; ]</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (itemStyle.flex) &#123;</span><br><span class="line">   flexLine.push(item)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>flex 容器是否换行</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 当前flex 子项，大于 flex mainSize,自适应</span></span><br><span class="line"><span class="keyword">if</span> (itemStyle[mainSize] &gt; style[mainSize]) &#123;</span><br><span class="line">    itemStyle[mainSize] = style[mainSize]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 当前flex 子项，大于 flex 容器剩余 mainSpace，另起新行</span></span><br><span class="line"><span class="keyword">if</span> (mainSpace &lt; itemStyle[mainSize]) &#123;</span><br><span class="line">    flexLine.mainSpace = mainSpace</span><br><span class="line">    flexLine.crossSpace = crossSpace</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建新行</span></span><br><span class="line">    flexLine = []</span><br><span class="line">    flexLines.push(flexLine)</span><br><span class="line">    flexLine.push(item)</span><br><span class="line"></span><br><span class="line">    mainSpace = style[mainSize]</span><br><span class="line">    crossSpace = <span class="number">0</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 未超过 flex 容器剩余 mainSpace，添加进行 </span></span><br><span class="line">    flexLine.push(item)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 处理交叉轴，只需要取 flex 子项最大 crossSize</span></span><br><span class="line"><span class="keyword">if</span> (itemStyle[crossSize] !== <span class="literal">null</span> &amp;&amp; itemStyle[crossSize] !== (<span class="keyword">void</span> <span class="number">0</span>)) &#123;</span><br><span class="line">    crossSpace = <span class="built_in">Math</span>.max(crossSpace, itemStyle[crossSize])</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// flex 容器剩余 mainSpace</span></span><br><span class="line">mainSpace -= itemStyle[mainSize]</span><br></pre></td></tr></table></figure></li>
<li><p><a href="https://github.com/Ele-Peng/toy-browser/blob/master/layout2.js" target="_blank" rel="noopener">layout2.js 完整代码-点击一下</a></p>
</li>
</ul>
<h3 id="第三步：计算主轴"><a href="#第三步：计算主轴" class="headerlink" title="第三步：计算主轴"></a>第三步：计算主轴</h3><ul>
<li><p>计算主轴方向</p>
<ul>
<li><p>找出所有 flex 子项也为 flex 元素</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> item = items[i]</span><br><span class="line">    <span class="keyword">const</span> itemStyle = getStyle(item)</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span> ((itemStyle.flex !== <span class="literal">null</span>) &amp;&amp; (itemStyle.flex !== (<span class="keyword">void</span> <span class="number">0</span>))) &#123;</span><br><span class="line">      flexTotal += itemStyle.flex</span><br><span class="line">      <span class="keyword">continue</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>存在 flex 子项也为 flex</p>
<ul>
<li><p>填充 flexLine 剩余 mainSpace 空间</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> currentMain = mainBase</span><br><span class="line">		</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> item = items[i]</span><br><span class="line">  <span class="keyword">const</span> itemStyle = getStyle(item)</span><br><span class="line">		</span><br><span class="line">  <span class="keyword">if</span> (itemStyle.flex) &#123;</span><br><span class="line">    itemStyle[mainSize] = (mainSpace / flexTotal) * itemStyle.flex</span><br><span class="line">  &#125;</span><br><span class="line">  itemStyle[mainStart] = currentMain</span><br><span class="line">  itemStyle[mainEnd] = itemStyle[mainStart] + mainSign * itemStyle[mainSize]</span><br><span class="line">  currentMain = itemStyle[mainEnd]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>不存在 flex 子项也为 flex，把主轴方向剩余尺寸按比例分配给这些元素</p>
</li>
<li><p>justify-content: flex-start | flex-end | center | space-between | space-around | space-evenly;</p>
<ul>
<li><p>justify-content: flex-start</p>
<ul>
<li><p>默认值</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!style.justifyContent || style.justifyContent === <span class="string">'auto'</span>)</span><br><span class="line">    style.justifyContent = <span class="string">'flex-start'</span></span><br></pre></td></tr></table></figure>

  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.justifyContent === <span class="string">'flex-start'</span>) &#123;</span><br><span class="line">  currentMain = mainBase</span><br><span class="line">  gap = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>justify-content: flex-end</p>
<ul>
<li><p>逻辑CSS属性值，与默认文档流方向相反</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.justifyContent === <span class="string">'flex-start'</span>) &#123;</span><br><span class="line">  currentMain = mainSpace * mainSign + mainBase</span><br><span class="line">  gap = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>justify-content: center</p>
<ul>
<li><p>居中对齐</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.justifyContent === <span class="string">'center'</span>) &#123;</span><br><span class="line">  currentMain = mainSpace / <span class="number">2</span> * mainSign + mainBase</span><br><span class="line">  gap = <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>justify-content: space-between</p>
<ul>
<li><p>表现为两端对齐。between 是中间的意思，意思是多余的空白间距只在元素中间区域分配</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.justifyContent === <span class="string">'space-between'</span>) &#123;</span><br><span class="line">  gap = mainSpace / (items.length - <span class="number">1</span>) * mainSign</span><br><span class="line">  currentMain = mainBase</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>justify-content: space-around</p>
<ul>
<li><p>around 是环绕的意思，意思是每个 flex 子项两侧都环绕互不干扰的等宽的空白间距，最终视觉上边缘两侧的空白只有中间空白宽度一半</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.justifyContent === <span class="string">'space-around'</span>) &#123;</span><br><span class="line">  gap = mainSpace / items.length * mainSign</span><br><span class="line">  currentMain = gap / <span class="number">2</span> + mainBase</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>justify-content: space-evenly</p>
<ul>
<li><p>evenly 是匀称、平等的意思。也就是视觉上，每个 flex 子项两侧空白间距完全相等</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (style.justifyContent === <span class="string">'space-evenly'</span>) &#123;</span><br><span class="line">  gap = mainSpace / (items.length + <span class="number">1</span>) * mainSign</span><br><span class="line">  currentMain = gap + mainBase</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p>循环计算 flex 子项位置</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i++) &#123;</span><br><span class="line">  <span class="keyword">const</span> item = items[i]</span><br><span class="line">  itemStyle[mainStart] = currentMain</span><br><span class="line">  itemStyle[mainEnd] = itemStyle[mainStart] + mainSign * itemStyle[mainSize]</span><br><span class="line">  currentMain = itemStyle[mainEnd] + gap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>若剩余空间为负数，所有 flex 元素为 0，等比压缩剩余元素</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (mainSpace &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// 对负的 mainSpace， 所有该行 flex 子项等比例缩放（未设置 flex-shrink 默认值是1，也就是默认所有的 flex 子项都会收缩）</span></span><br><span class="line">    <span class="keyword">const</span> scale = style[mainSize] / (style[mainSize] - mainSpace)</span><br><span class="line">    <span class="keyword">const</span> currentMain = mainBase</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i ++) &#123;</span><br><span class="line">      <span class="keyword">const</span> item = items[i]</span><br><span class="line">      <span class="keyword">const</span> itemStyle = getStyle(item)</span><br><span class="line">	</span><br><span class="line">      <span class="keyword">if</span> (itemStyle.flex) &#123;</span><br><span class="line">        itemStyle[mainSize] = <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">	</span><br><span class="line">      itemStyle[mainSize] = itemStyle[mainSize] * scale</span><br><span class="line">	</span><br><span class="line">      <span class="comment">// flex 容器这一行内，flex 子项排布</span></span><br><span class="line">      itemStyle[mainStart] = currentMain</span><br><span class="line">      itemStyle[mainEnd] = itemStyle[mainStart] + mainSign * itemStyle[mainSize]</span><br><span class="line">      currentMain = itemStyle[mainEnd]</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p><a href="https://github.com/Ele-Peng/toy-browser/blob/master/layout3.js" target="_blank" rel="noopener">layout3.js 完整代码-点击一下</a></p>
</li>
</ul>
<h3 id="第四步：计算交叉轴"><a href="#第四步：计算交叉轴" class="headerlink" title="第四步：计算交叉轴"></a>第四步：计算交叉轴</h3><ul>
<li><p>计算交叉轴方向</p>
<ul>
<li><p>根据每一行中最大元素尺寸计算行高</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!style[crossSize]) &#123; <span class="comment">// 交叉轴，crossSize 未设定时默认为 count flexLines 每行最大 crossSpace 之和 </span></span><br><span class="line">    crossSpace = <span class="number">0</span></span><br><span class="line">    elementStyle[crossSize] = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; flexLines.length; i ++) &#123;</span><br><span class="line">      elementStyle[crossSize] = elementStyle[crossSize] + flexLines[i].crossSpace</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123; <span class="comment">// 设定后，计算出 最终的 crossSpace，为 crossSpace 减去每行最大 crossSpace，剩余空间，用作分配</span></span><br><span class="line">    crossSpace = style[crossSize]</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; flexLines.length; i ++) &#123;</span><br><span class="line">      crossSpace -= flexLines[i].crossSpace</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>根据行高 flex-align 和 item-align，确定元素具体位置</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">flexLines.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">items</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> lineCrossSize = style.alignContent === <span class="string">'stretch'</span> ? <span class="comment">// 拉伸 flex 子项，填满交叉轴</span></span><br><span class="line">      items.crossSpace + crossSpace / flexLines.length :</span><br><span class="line">      item.crossSpace</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; items.length; i ++) &#123;</span><br><span class="line">      <span class="keyword">const</span> item = items[i]</span><br><span class="line">      <span class="keyword">const</span> itemStyle = getStyle(item)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> align = itemStyle.alignSelf || style.alignItems <span class="comment">// align-self指控制单独某一个flex子项的垂直对齐方式</span></span><br><span class="line">      <span class="comment">// align-items属性，表示子项们</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (itemStyle[crossSize] === <span class="literal">null</span>) &#123;</span><br><span class="line">        itemStyle[crossSize] = (align === <span class="string">'stretch'</span>) ?</span><br><span class="line">          lineCrossSize : <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (align === <span class="string">'flex-start'</span>) &#123;</span><br><span class="line">        itemStyle[crossStart] = crossBase</span><br><span class="line">        itemStyle[crossEnd] = itemStyle[crossStart] + crossSign * itemStyle[crossSize]</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (align === <span class="string">'flex-end'</span>) &#123;</span><br><span class="line">        itemStyle[crossEnd] = crossBase + crossSign * lineCrossSize</span><br><span class="line">        itemStyle[crossStart] = itemStyle[crossEnd] - crossSign * itemStyle[crossSize]</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (align === <span class="string">'center'</span>) &#123;</span><br><span class="line">        itemStyle[crossStart] = crossBase + crossSign * (lineCrossSize - itemStyle[crossSize]) / <span class="number">2</span></span><br><span class="line">        itemStyle[crossEnd] = itemStyle[crossStart] + crossSign * itemStyle[crossSize]</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (align === <span class="string">'stretch'</span>) &#123;</span><br><span class="line">        itemStyle[crossStart] = crossBase</span><br><span class="line">        itemStyle[crossEnd] = crossBase + crossSign * ((itemStyle[crossSize] !== <span class="literal">null</span> &amp;&amp; itemStyle[crossSize] !== (<span class="keyword">void</span> <span class="number">0</span>)) ?</span><br><span class="line">          itemStyle[crossSize] : lineCrossSize)</span><br><span class="line"></span><br><span class="line">        itemStyle[crossSize] = crossSign * (itemStyle[crossEnd] - itemStyle[crossStart])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    crossBase += crossSign * (lineCrossSize + step)</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/0e488c9e6c482d1d67f2a1872a58aa0d231450.png" alt="第四步运行结果"></li>
</ul>
</li>
<li><p><a href="https://github.com/Ele-Peng/toy-browser/blob/master/layout4.js" target="_blank" rel="noopener">layout4.js 完整代码-点击一下</a></p>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://www.zhangxinxu.com/wordpress/2018/10/display-flex-css3-css/#justify-content" target="_blank" rel="noopener">display: flex 教程</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2015/07/flex-grammar.html" target="_blank" rel="noopener">Flex 布局教程：语法篇</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Glossary/Flex" target="_blank" rel="noopener">MDN Flex</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>浏览器</category>
      </categories>
      <tags>
        <tag>浏览器</tag>
      </tags>
  </entry>
  <entry>
    <title>【未完】从URL输入到...（一）</title>
    <url>/2020/05/12/%E4%BB%8EURL%E8%BE%93%E5%85%A5%E5%88%B0/</url>
    <content><![CDATA[<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>嘿嘿嘿 😱</li>
<li>别想歪，我们这个系列要做的是从经典面试题入手<ul>
<li>从 URL 输入 <a href="https://ele-peng.github.io/" target="_blank" rel="noopener">https://ele-peng.github.io/</a> 到页面展现到底发生了什么？</li>
</ul>
</li>
<li>简单了解一下计算机网络相关知识。是的，Elle 很惨😭 计算机网络学得稀烂</li>
</ul>
<a id="more"></a>

<h2 id="简单过程"><a href="#简单过程" class="headerlink" title="简单过程"></a>简单过程</h2><ul>
<li>你先在浏览器里面输入 <a href="https://ele-peng.github.io/" target="_blank" rel="noopener">https://ele-peng.github.io/</a> ，这是一个 URL。浏览器只知道名字是“ele-peng.github.io”，但是不知道具体的地点，所以不知道应该如何访问。于是，它打开地址簿去查找。可以使用一般的地址簿协议 DNS 去查找，还可以使用另一种更加精准的地址簿查找协议 HTTPDNS 。</li>
<li>无论用哪一种方法查找，最终都会得到这个地址：52.74.223.119。这个是 IP 地址，是互联网世界的“门牌号”。</li>
<li>知道了目标地址，浏览器就开始打包它的请求。这里会使用HTTPS协议。无论是什么协议，里面都会写明“你要请求什么”。﻿</li>
<li>DNS、HTTP、HTTPS 所在的层我们称为<strong>应用层</strong>。经过应用层封装后，浏览器会将应用层的包交给下一层去完成，<strong>通过 socket 编程来实现</strong>。下一层是<strong>传输层</strong>。传输层有两种协议，一种是无连接的协议UDP，一种是面向连接的协议TCP。这里使用 TCP 协议。所谓的面向连接就是，TCP 会保证这个包能够到达目的地。如果不能到达，就会重新发送，直至到达。</li>
<li>TCP 协议里面会有两个端口，一个是浏览器监听的端口，一个是 github 的服务器监听的端口。操作系统往往通过端口来判断，它得到的包应该给哪个进程。</li>
<li>传输层封装完毕后，浏览器会将包交给操作系统的<strong>网络层</strong>。网络层的协议是 IP 协议。在 IP 协议里面会有源 IP 地址，即浏览器所在机器的 IP 地址和目标 IP 地址，也即 github 所在服务器的 IP 地址。</li>
<li>操作系统既然知道了目标 IP 地址，就开始想如何根据这个门牌号找到目标机器。操作系统往往会判断，这个目标 IP 地址是本地人，还是外地人。如果是本地人，从门牌号就能看出来，但是显然 github 网站不在本地，而在遥远的地方。</li>
<li>操作系统知道要离开本地去远方。虽然不知道远方在何处，但是可以这样类比一下：如果去国外要去海关，去外地就要去网关。而操作系统启动的时候，就会被 DHCP 协议配置 IP 地址，以及默认的网关的 IP 地址 192.168.1.1。</li>
<li>操作系统如何将 IP 地址发给网关呢？在本地通信基本靠吼，于是操作系统大吼一声，谁是 192.168.1.1 啊？网关会回答它，我就是，我的本地地址在村东头。这个本地地址就是 MAC 地址，而大吼的那一声是 ARP 协议。</li>
<li>于是操作系统将 IP 包交给了下一层，也就是 <strong>MAC 层</strong>。网卡再将包发出去。由于这个包里面是有 MAC 地址的，因而它能够到达网关。</li>
<li>网关收到包之后，会根据自己的知识，判断下一步应该怎么走。网关往往是一个路由器，到某个 IP 地址应该怎么走，这个叫作路由表。</li>
<li>路由器有点像玄奘西行路过的一个个国家的一个个城关。每个城关都连着两个国家，每个国家相当于一个局域网，在每个国家内部，都可以使用本地的地址 MAC 进行通信。</li>
<li>一旦跨越城关，就需要拿出 IP 头来问，目标 IP 地址怎么走？</li>
<li>城关往往是知道这些“知识”的，因为城关和临近的城关也会经常沟通。到哪里应该怎么走，这种沟通的协议称为路由协议，常用的有 OSP F和 BGP 。﻿</li>
<li>城关与城关之间是一个国家，当网络包知道了下一步去哪个城关，还是要使用国家内部的 MAC 地址，通过下一个城关的 MAC 地址，找到下一个城关，然后再问下一步的路怎么走，一直到走出最后一个城关。</li>
<li>最后一个城关知道这个网络包要去的地方。于是，对着这个国家吼一声，谁是目标 IP 啊？目标服务器就会回复一个 MAC 地址。网络包过关后，通过这个 MAC 地址就能找到目标服务器。</li>
<li>目标服务器发现 MAC 地址对上了，取下 MAC 头来，发送给操作系统的网络层。发现 IP 也对上了，就取下 IP 头。IP 头里会写上一层封装的是 TCP 协议，然后将其交给传输层，即TCP 层。</li>
<li>在这一层里，对于收到的每个包，都会有一个回复的包说明收到了。这个回复的包绝非这次查询请求的结果，而仅仅是 TCP 层的一个说明，即收到之后的回复。当然这个回复，会沿着刚才来的方向走回去，报个平安。</li>
<li>如果过一段时间还是没到，发送端的 TCP 层会重新发送这个包，还是上面的过程，直到有一天收到平安到达的回复。这个重试绝非你的浏览器重新请求 github 个人主页。对于浏览器来讲，就发送了一次 github 个人主页请求，TCP 层不断自己闷头重试。除非 TCP 这一层出了问题，例如连接断了，才轮到浏览器的应用层重新发送 github 个人主页请求。</li>
<li>当网络包平安到达 TCP 层之后，TCP 头中有目标端口号，通过这个端口号，可以找到 github 网站的进程正在监听这个端口号，假设一个 Tomcat，将这个包发给 github 网站。﻿</li>
<li>github 网站的进程得到 HTTP 请求的内容，知道了要响应啥。往往一个电商网站最初接待请求的这个 Tomcat 只是个接待员，负责统筹处理这个请求，而不是所有的事情都自己做。例如，这个接待员要告诉专门管理 GitHub 个人主页的进程，要响应啥等等。</li>
<li>如何告诉相关的进程呢？往往通过 RPC 调用，即远程过程调用的方式来实现。远程过程调用就是当告诉管理 GitHub 个人主页的进程的时候，接待员不用关心中间的网络互连问题，会由 RPC 框架统一处理。RPC 框架有很多种，有基于 HTTP 协议放在 HTTP 的报文里面的，有直接封装在 TCP 报文里面的。</li>
<li>当接待员发现相应的部门都处理完毕，就回复一个 HTTPS 的包，告知查询成功。这个 HTTPS 的包，会像来的时候一样，经过千难万险到达你的个人电脑，最终进入浏览器，显示个人主页。</li>
</ul>
<h2 id="网络分层模型"><a href="#网络分层模型" class="headerlink" title="网络分层模型"></a>网络分层模型</h2><h3 id="TCP-IP-协议栈"><a href="#TCP-IP-协议栈" class="headerlink" title="TCP/IP 协议栈"></a>TCP/IP 协议栈</h3><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/6fea0628affaf34d09b59d845ffeb60a75766.png" alt="TCP/IP 协议栈"></li>
<li><strong>link layer 链接层</strong>：负责在以太网、WiFi 这样的底层网络上发送原始数据包（frame 帧），工作在网卡这个层次，使用 MAC 地址来标记网络上的设备，所以有时候也叫 MAC 层。</li>
<li><strong>internet layer 网际层</strong>：IP 协议就处在这一层。因为 IP 协议定义了“IP 地址”的概念，所以就可以在“链接层”的基础上，用 IP 地址取代 MAC 地址，把许许多多的局域网、广域网连接成一个虚拟的巨大网络，在这个网络里找设备时只要把 IP 地址再“翻译”成 MAC 地址就可以了。传输单位是包（packet）</li>
<li><strong>transport layer 传输层</strong>：TCP/UDP 协议工作的层次<ul>
<li>TCP 是一个有状态的协议，需要先与对方建立连接然后才能发送数据，而且保证数据不丢失不重复。而 UDP 则比较简单，它无状态，不用事先建立连接就可以任意发送数据，但不保证数据一定会发到对方。两个协议的另一个重要区别在于数据的形式。TCP 的数据是连续的“字节流”，有先后顺序，而 UDP 则是分散的小数据包，是顺序发，乱序收。</li>
<li>TCP 层的传输单位是段（segment）</li>
</ul>
</li>
<li><strong>application layer 应用层</strong>：各种面向具体应用的协议，例如 DHCP、HTTP、HTTPS、RTMP、DNS、P2P、GTP、RPC、Telnet、SSH、FTP、SMTP 等等。<ul>
<li>HTTP 的传输单位则是消息或报文（message）</li>
</ul>
</li>
</ul>
<h3 id="OSI-Open-System-Interconnection-Reference-Model-开放式系统互联通信参考模型"><a href="#OSI-Open-System-Interconnection-Reference-Model-开放式系统互联通信参考模型" class="headerlink" title="OSI (Open System Interconnection Reference Model) 开放式系统互联通信参考模型"></a>OSI (Open System Interconnection Reference Model) 开放式系统互联通信参考模型</h3><ul>
<li><img src="http://p1.meituan.net/myvideodistribute/53145af5e2b1d0846761c3382cce24c5104243.png" alt="OSI参考模型"></li>
<li><strong>physical layer 物理层</strong>：网络的物理形式，例如电缆、光纤、网卡、集线器等等</li>
<li><strong>data link layer 数据链路层</strong>：基本相当于 TCP/IP 的链接层</li>
<li><strong>network layer 网络层</strong>：相当于 TCP/IP 里的网际层</li>
<li><strong>transport layer 传输层</strong>：相当于 TCP/IP 里的传输层</li>
<li><strong>session layer 会话层</strong>：维护网络中的连接状态，即保持会话和同步</li>
<li><strong>presentation layer 表示层</strong>：把数据转换为合适、可理解的语法和语义</li>
<li><strong>application layer 应用层</strong>：面向具体的应用传输数据</li>
</ul>
<h3 id="两个分层模型的映射关系"><a href="#两个分层模型的映射关系" class="headerlink" title="两个分层模型的映射关系"></a>两个分层模型的映射关系</h3><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/0042adbffe9810c7913862252fa27662164155.png" alt="两个分层模型的映射关系"></li>
<li>第一层：物理层，TCP/IP 里无对应</li>
<li>第二层：数据链路层，对应 TCP/IP 的链接层</li>
<li>第三层：网络层，对应 TCP/IP 的网际层</li>
<li>第四层：传输层，对应 TCP/IP 的传输层</li>
<li>第五、六、七层：统一对应到 TCP/IP 的应用层<ul>
<li>TCP/IP 实际应用时的会话管理、编码转换、压缩等和具体应用经常联系的很紧密，很难分开</li>
</ul>
</li>
</ul>
<h2 id="HTTP-HyperText-Transfer-Protocol"><a href="#HTTP-HyperText-Transfer-Protocol" class="headerlink" title="HTTP - HyperText Transfer Protocol"></a>HTTP - HyperText Transfer Protocol</h2><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/0eac1c72dc8c7c0ac87363d73f51b19b30633.png" alt="HTTP概览图"></li>
<li>Protocol<ul>
<li>协议必须要有两个或多个参与者，也就是“协”</li>
<li>协议是对参与者的一种行为约定和规范，也就是“议”，包括语法、语义、同步规则和错误处理</li>
<li>总结：<strong>HTTP 是一个用在计算机世界里的协议。它使用计算机能够理解的语言确立了一种计算机之间交流通信的规范，以及相关的各种控制和错误处理方式。</strong></li>
</ul>
</li>
<li>Transfer<ul>
<li>HTTP 协议是一个“双向协议”</li>
<li>数据虽然是在 A 和 B 之间传输，但并没有限制只有 A 和 B 这两个角色，允许中间有“中转”或者“接力”<ul>
<li>传输方式从“A&lt;===&gt;B” 可以变成了 “A&lt;=&gt;X&lt;=&gt;Y&lt;=&gt;Z&lt;=&gt;B”</li>
<li>A 到 B 的传输过程中可以存在任意多个“中间人”，而这些中间人也都遵从 HTTP 协议，只要不打扰基本的数据传输，就可以添加任意的额外功能，例如安全认证、数据压缩、编码转换等等，优化整个传输过程。</li>
</ul>
</li>
<li>总结：<strong>HTTP 是一个在计算机世界里专门用来在两点之间传输数据的约定和规范。</strong></li>
</ul>
</li>
<li>HyperText<ul>
<li>Text<ul>
<li>表示 HTTP 传输的不是 TCP/UDP 这些底层协议里被切分的杂乱无章的二进制包（datagram），而是完整的、有意义的数据，可以被浏览器、服务器这样的上层应用程序处理。</li>
</ul>
</li>
<li>超文本：文字、图片、音频和视频等的混合体，最关键的是含有“超链接”，能够从一个“超文本”跳跃到另一个“超文本”，形成复杂的非线性、网状的结构关系。</li>
</ul>
</li>
<li>总结：<strong>HTTP 是一个在计算机世界里专门在两点之间传输文字、图片、音频、视频等超文本数据的约定和规范</strong></li>
</ul>
<h3 id="HTTP不是？"><a href="#HTTP不是？" class="headerlink" title="HTTP不是？"></a>HTTP不是？</h3><ul>
<li><strong>不存在“单独的实体”</strong>，但 HTTP 又与应用程序、操作系统、Web 服务器密切相关，在它们之间的通信过程中存在，而且是一种“动态的存在”，是发生在网络连接、传输超文本数据时的一个“动态过程”。</li>
<li><strong>HTTP 不是互联网</strong><ul>
<li>互联网（Internet）是遍布于全球的许多网络互相连接而形成的一个巨大的国际网络，在它上面存放着各式各样的资源，也对应着各式各样的协议，例如超文本资源使用 HTTP，普通文件使用 FTP，电子邮件使用 SMTP 和 POP3 等。</li>
</ul>
</li>
<li><strong>HTTP 不是编程语言</strong><ul>
<li>编程语言是人与计算机沟通交流所使用的语言，而 HTTP 是计算机与计算机沟通交流的语言</li>
<li>无法使用 HTTP 来编程，但可以反过来，用编程语言去实现 HTTP，告诉计算机如何用 HTTP 来与外界通信</li>
</ul>
</li>
<li><strong>HTTP 不是用于从互联网服务器传输超文本到本地浏览器的协议</strong><ul>
<li>过于片面，HTTP 发生在两点之间，即服务端与客户端，客户端不是只包括本地浏览器，服务器也可以作为客户端，客户端也不仅仅只有浏览器，还可以有 App、小程序，浏览器只能作为客户端</li>
</ul>
</li>
<li><strong>HTTP 不是一个孤立的协议</strong><ul>
<li>HTTP 通常跑在 TCP/IP 协议栈之上，依靠 IP 协议实现寻址和路由、TCP 协议实现可靠数据传输、DNS 协议实现域名查找、SSL/TLS 协议实现安全通信</li>
<li>还有一些协议依赖于 HTTP，例如 WebSocket、HTTPDNS 等</li>
</ul>
</li>
<li>总结：<strong>HTTP 是构建互联网的重要基础技术，它没有实体，依赖许多其他的技术来实现，但同时许多技术也都依赖于它。</strong></li>
</ul>
<h2 id="Domain"><a href="#Domain" class="headerlink" title="Domain"></a>Domain</h2><h3 id="Domain-形式"><a href="#Domain-形式" class="headerlink" title="Domain 形式"></a>Domain 形式</h3><ul>
<li>域名是一个有层次的结构，是一串用“.”分隔的多个单词，最右边的被称为“顶级域名”，然后是“二级域名”，层级关系向左依次降低。</li>
<li>本质上还是个名字空间系统</li>
</ul>
<h3 id="DNS-Domain-Name-System"><a href="#DNS-Domain-Name-System" class="headerlink" title="DNS Domain Name System"></a>DNS Domain Name System</h3><ul>
<li>就像 IP 地址必须转换成 MAC 地址才能访问主机一样，域名也必须要转换成 IP 地址，这个过程就是“域名解析”。</li>
<li>DNS 使用 TCP 和 UDP 端口53</li>
<li>DNS 的核心系统是一个三层的树状、分布式服务，基本对应域名的结构：<ul>
<li>根域名服务器（Root DNS Server）：管理顶级域名服务器，返回“com”“net”“cn”等顶级域名服务器的 IP 地址<ul>
<li>全世界共有 13 组根域名服务器，又有数百台的镜像，保证一定能够被访问到</li>
</ul>
</li>
<li>级域名服务器（Top-level DNS Server）：管理各自域名下的权威域名服务器，比如 com 顶级域名服务器可以返回 apple.com 域名服务器的 IP 地址</li>
<li>权威域名服务器（Authoritative DNS Server）：管理自己域名下主机的 IP 地址，比如 apple.com 权威域名服务器可以返回 <a href="http://www.apple.com" target="_blank" rel="noopener">www.apple.com</a> 的 IP 地址</li>
<li><img src="http://p0.meituan.net/myvideodistribute/5ac55ff4d8109df28c9afb3fbfc27208625512.png" alt="DNS 三层的树状"></li>
</ul>
</li>
<li>所以我们访问 <a href="https://ele-peng.github.io/" target="_blank" rel="noopener">https://ele-peng.github.io/</a> 就需要进行下面的三次查询<ul>
<li>访问根域名服务器，它会告诉你 “io” 顶级域名服务器的地址</li>
<li>访问 “io” 顶级域名服务器，它再告诉你 “github.io” 域名服务器的地址</li>
<li>最后访问 “github.io” 域名服务器，就得到了 “ele-peng.github.io” 的地址</li>
</ul>
</li>
<li>DNS 是一个树状的分布式查询系统，为了提高查询效率，外围有多级的缓存（非权威域名服务器、操作系统缓存和 hosts 文件等手段）用来减轻域名解析的压力，并且能够更快地获取结果，基本思路都是<strong>“缓存”</strong><ul>
<li>许多大公司、网络运行商都会建立自己的 DNS 服务器，作为用户 DNS 查询的代理，代替用户访问核心 DNS 系统。这些“野生”服务器被称为“非权威域名服务器”，可以缓存之前的查询结果，如果已经有了记录，就无需再向根服务器发起查询，直接返回对应的 IP 地址<ul>
<li>这些 DNS 服务器的数量要比核心系统的服务器多很多，而且大多部署在离用户很近的地方。比较知名的 DNS 有 Google 的“8.8.8.8”，Microsoft 的“4.2.2.1”，还有 CloudFlare 的“1.1.1.1”等等。</li>
</ul>
</li>
<li>其次，操作系统里也会对 DNS 解析结果做缓存，如果你之前访问过“ele-peng.github.io”，那么下一次在浏览器里再输入这个网址的时候就不会再跑到 DNS 那里去问了，直接在操作系统里就可以拿到 IP 地址</li>
<li>另外，操作系统里还有一个特殊的“主机映射”文件</li>
</ul>
</li>
<li>假如访问 www.不存在.com <ul>
<li>www.不存在.com -&gt; Hosts 文件 -&gt; 操作系统本地缓存 -&gt; 非权威域名服务器查询其缓存 -&gt; 查询根域名、顶级域名、以及域名服务器，当后面的查询得到结果时，将会写入本地缓存</li>
</ul>
</li>
<li>现在的 DNS 架构<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/3ba7d376ea3f43fcb761deeb78932622389661.png" alt="现在的 DNS 架构"></li>
</ul>
</li>
<li><strong>使用 DNS 可以实现基于域名的负载均衡，既可以在内网，也可以在外网</strong></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>学而不思则罔 互勉</li>
<li>祝大家多多发财ee</li>
</ul>
]]></content>
      <categories>
        <category>计算机网络</category>
      </categories>
      <tags>
        <tag>计算机网络</tag>
      </tags>
  </entry>
  <entry>
    <title>Javascript-convertStringToNumber</title>
    <url>/2020/04/24/convertStringToNumber/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>简单记录一下，Javascript parseInt+parseFloat 内部实现，并实现 convertStringToNumber</li>
</ul>
<a id="more"></a>

<h2 id="实践准备"><a href="#实践准备" class="headerlink" title="实践准备"></a>实践准备</h2><ul>
<li>首先我们需要简单梳理一下我们的实现过程，再根据 <a href="https://www.ecma-international.org/publications/standards/Ecma-262.htm" target="_blank" rel="noopener">ECMAScript-262</a> 标准完善实现</li>
<li>input: @params: { str } 输入需要转换的字符串, { radix } 转换的指定基数</li>
<li>对 input 的简单处理 StringNumericLiteral<ul>
<li>规格化 str</li>
<li><img src="http://p0.meituan.net/myvideodistribute/6f4d129d30fe4d0b45743d72da9760ca14615.png" alt="StringNumericLiteral BNF"><ul>
<li>将 str 中可能出现的 StrWhiteSpace 去掉<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/3ab76a2ee0627ddeeec42e093ae8307717214.png" alt="StrWhiteSpace BNF"><ul>
<li><img src="http://p0.meituan.net/myvideodistribute/d9ba181d676994f053ba3ba067279cf48592.png" alt="LineTerminator BNF"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>判断 radix 是否合法，仅支持 Decimal / BinaryInteger / OctalInteger / HexInteger radix<ul>
<li>Decimal: 10</li>
<li>BinaryInteger: 2</li>
<li>OctalInteger: 8</li>
<li>HexInteger: 16</li>
</ul>
</li>
</ul>
</li>
<li>简单算法处理过程<ul>
<li>十进制数<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/dbb89c490f4cbe92ce1e7b1025912cde51542.png" alt="StrDecimalLiteral BNF"></li>
<li>处理 Infinity 情况</li>
<li>符号位处理</li>
<li>小数点</li>
<li>科学计数法</li>
</ul>
</li>
<li>二进制数<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/f12e98da62b6529c1d3781a6c1dc36a86760.png" alt="BinaryInteger"></li>
</ul>
</li>
<li>八进制数<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/e11bf633f8350bb17f761b719762ed038371.png" alt="OctalInteger"></li>
</ul>
</li>
<li>十六进制数<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/274e704676b7d52093ac555c4b43f61013946.png" alt="HexInteger"></li>
</ul>
</li>
</ul>
</li>
<li>output: return number</li>
</ul>
<h2 id="详细实践"><a href="#详细实践" class="headerlink" title="详细实践"></a>详细实践</h2><ul>
<li>根据上面的实践准备</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @params: &#123; str &#125; 输入需要转换的字符串, &#123; radix &#125; 转换的指定基数</span></span><br><span class="line"><span class="comment">* return: number</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convertStringToNumber</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> noWhiteSpaceStr = replaceWhiteSpaceInStr(str) <span class="comment">/** 将 str 中的 whitespace 进行匹配 */</span></span><br><span class="line">  <span class="keyword">const</span> checkedRadixStr = formatStrByRadix(str, radix) <span class="comment">/** 将 str 根据指定基数进行转换 */</span></span><br><span class="line">  <span class="keyword">let</span> resNum = <span class="number">0</span></span><br><span class="line">  <span class="keyword">switch</span> (radix) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">      resNum = converStringToDeciaml(str) <span class="comment">/** 将 str 转成十进制 */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      resNum = converStringToBinaryInteger(str) <span class="comment">/** 将 str 转成二进制*/</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">      resNum = converStringToOctalInteger(str) <span class="comment">/** 将 str 转成八进制*/</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">      resNum = converStringToHexIntegers(str) <span class="comment">/** 将 str 转成十六进制*/</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NaN</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> resNum</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>将 str 中的 whitespace 进行匹配</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @params: &#123; str &#125; 输入需要替换的字符串</span></span><br><span class="line"><span class="comment">* return: resStr 无 whitespace 字符串</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replaceWhiteSpaceInStr</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> resStr = str.replace(<span class="regexp">/\s*/g</span>, <span class="string">''</span>) <span class="comment">// 去除空格</span></span><br><span class="line">  <span class="comment">// resStr = resStr.replace(/^[\u000A|\u000D|\u2028|\u2029]/g, '') // 去除 LineTerminator unicode输入方式</span></span><br><span class="line">  resStr =  resStr.replace(<span class="regexp">/[\r|\n]/g</span>, <span class="string">''</span>) <span class="comment">// 去除换行</span></span><br><span class="line">  <span class="keyword">return</span> resStr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>单元测试<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/a70fa86dd4d8261537f8cbf5c0e5bc2c71147.png" alt="单元测试截图"></li>
</ul>
</li>
</ul>
</li>
<li><p>将 str 根据指定基数进行转换</p>
<ul>
<li><p><a href="https://ele-peng.github.io/2020/04/20/Reg-Number/" target="_blank" rel="noopener">正则表达式匹配 Number 字面量</a></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @params: &#123; str &#125; 输入需要替换的字符串, &#123; radix &#125; 转换的指定基数</span></span><br><span class="line"><span class="comment">* return: resStr 根据指定基数转换过得字符串</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStrByRadix</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> resStr = <span class="string">''</span></span><br><span class="line">  <span class="keyword">let</span> testReg = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">switch</span> (radix) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">      testReg = <span class="regexp">/^((0)|([1-9][0-9]*))?.?([0-9]*)((e|E)?(\+|\-)?([0-9]*))?/</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="comment">// 根据 ECMA-262 是 /^0(b|B)(0|1)+$/</span></span><br><span class="line">      <span class="comment">// 但是我在 Chrome 浏览器上测了，二进制没有 'b' or 'B'</span></span><br><span class="line">      testReg = <span class="regexp">/^(0|1)+/</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">      <span class="comment">// 根据 ECMA-262 是 /^0(O|o)[0-7]+$/</span></span><br><span class="line">      <span class="comment">// 但是我在 Chrome 浏览器上测了，二进制没有 'o' or 'O'</span></span><br><span class="line">      testReg = <span class="regexp">/^[0-7]+/</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">16</span>:</span><br><span class="line">      <span class="comment">// 根据 ECMA-262 是 /^0(x|X)([0-9a-fA-F])+/</span></span><br><span class="line">      <span class="comment">// 但是我在 Chrome 浏览器自测中发现，没有表示符 'x' or 'X'也可</span></span><br><span class="line">      testReg = <span class="regexp">/^0(x|X)?([0-9a-fA-F])+/</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">`radix: <span class="subst">$&#123;radix&#125;</span>, str:  <span class="subst">$&#123;str&#125;</span> illegal radix`</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  resStr = (testReg.exec(str) &amp;&amp; testReg.exec(str)[<span class="string">'0'</span>]) || <span class="string">'convert fail'</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`radix: <span class="subst">$&#123;radix&#125;</span>, <span class="subst">$&#123;str&#125;</span> --&gt; resStr: `</span>, resStr)</span><br><span class="line">&#125;</span><br><span class="line">formatStrByRadix(<span class="string">'001010101'</span>, <span class="number">3</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'001010101'</span>, <span class="number">2</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'001010101'</span>, <span class="number">8</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'0b01010101'</span>, <span class="number">2</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'012345677'</span>, <span class="number">8</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'012345677'</span>, <span class="number">2</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'0o12345677'</span>, <span class="number">8</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'1.01E+23'</span>, <span class="number">10</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'.012345677'</span>, <span class="number">10</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'.012345677'</span>, <span class="number">10</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'0123acfACF'</span>, <span class="number">16</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'0x123acfACF'</span>, <span class="number">16</span>)</span><br><span class="line">formatStrByRadix(<span class="string">'0x123acfACFG'</span>, <span class="number">16</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>单元测试</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/ff9d3e6a3cd279427f8873f91911290774369.png" alt="单元测试"></li>
</ul>
</li>
</ul>
</li>
<li><p>根据指定基数进行相应算法转换</p>
<ul>
<li><p>二进制：</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 将 str 转成二进制</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">converStringToBinaryInteger</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> strMultipleRadix(str, radix)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @params: &#123; str &#125; 输入需要替换的字符串, &#123; radix &#125; 转换的指定基数</span></span><br><span class="line"><span class="comment">* return: resStr 乘以指定基数转换过得字符串</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strMultipleRadix</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> tempStrArr = str.split(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">let</span> res = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = tempStrArr.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i --) &#123;</span><br><span class="line">    res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line">converStringToBinaryInteger(<span class="string">'001010101'</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>单元测试<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/5f3f3d1a2d0851eddaa1e258a182831864745.png" alt="单元测试截图"></li>
</ul>
</li>
</ul>
</li>
<li><p>八进制</p>
<ul>
<li><p>同上</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将 str 转成八进制</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">converStringToBinaryInteger</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> strMultipleRadix(str, radix)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @params: &#123; str &#125; 输入需要替换的字符串, &#123; radix &#125; 转换的指定基数</span></span><br><span class="line"><span class="comment">* return: resStr 乘以指定基数转换过得字符串</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strMultipleRadix</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> tempStrArr = str.split(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">let</span> res = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = tempStrArr.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i --) &#123;</span><br><span class="line">    res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line">converStringToBinaryInteger(<span class="string">'001010101'</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>单元测试</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/e9db13d824513d4e72509cd571f90dc069034.png" alt="单元测试截图"></li>
</ul>
</li>
</ul>
</li>
<li><p>十六进制</p>
<ul>
<li><p>需要对 a-f A-F 进行判断，别忘了+10</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 将 str 转成十六进制</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">converStringToBinaryInteger</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> strMultipleRadix(str, radix)</span><br><span class="line">&#125;</span><br><span class="line">			</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @params: &#123; str &#125; 输入需要替换的字符串, &#123; radix &#125; 转换的指定基数</span></span><br><span class="line"><span class="comment">* return: resStr 乘以指定基数转换过得字符串</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strMultipleRadix</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> tempStrArr = str.split(<span class="string">''</span>)</span><br><span class="line">  <span class="keyword">let</span> res = <span class="number">0</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = tempStrArr.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">    <span class="keyword">if</span> (radix === <span class="number">16</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> ((tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>) &gt;= <span class="number">0</span>) &amp;&amp; (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>) &lt; <span class="number">10</span>)) &#123;</span><br><span class="line">        res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'a'</span>.codePointAt(<span class="number">0</span>) &gt;= <span class="number">0</span>) &amp;&amp; (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'a'</span>.codePointAt(<span class="number">0</span>) &lt; <span class="number">6</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'(tempStrArr[i].codePointAt(0)a'</span>, tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'a'</span>.codePointAt(<span class="number">0</span>))</span><br><span class="line">        res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'a'</span>.codePointAt(<span class="number">0</span>) + <span class="number">10</span>) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'A'</span>.codePointAt(<span class="number">0</span>) &gt;= <span class="number">0</span>) &amp;&amp; (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'A'</span>.codePointAt(<span class="number">0</span>) &lt; <span class="number">6</span>)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'(tempStrArr[i].codePointAt(0)A'</span>, tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'A'</span>.codePointAt(<span class="number">0</span>))</span><br><span class="line">        res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'A'</span>.codePointAt(<span class="number">0</span>) + <span class="number">10</span>) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.log(converStringToBinaryInteger(<span class="string">'001010101'</span>, <span class="number">16</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToBinaryInteger(<span class="string">'00101acfAFF'</span>, <span class="number">16</span>))</span><br></pre></td></tr></table></figure></li>
<li><p>单元测试</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/e2e319f170fe2334f7b589cfc0f77b06205824.png" alt="单元测试截图"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>最终二/八/十六进制根据指定基数进行相应算法转换方法为：</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * @params: &#123; str &#125; 输入需要替换的字符串, &#123; radix &#125; 转换的指定基数</span></span><br><span class="line"><span class="comment"> * return: resStr 乘以指定基数转换过得字符串</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> <span class="function"><span class="keyword">function</span> <span class="title">strMultipleRadix</span>(<span class="params">str, radix</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">let</span> tempStrArr = str.split(<span class="string">''</span>)</span><br><span class="line">   <span class="keyword">let</span> res = <span class="number">0</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">let</span> i = tempStrArr.length - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</span><br><span class="line">     <span class="keyword">if</span> (radix === <span class="number">16</span>) &#123;</span><br><span class="line">       <span class="keyword">if</span> ((tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>) &gt;= <span class="number">0</span>) &amp;&amp; (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>) &lt; <span class="number">10</span>)) &#123;</span><br><span class="line">         res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'a'</span>.codePointAt(<span class="number">0</span>) &gt;= <span class="number">0</span>) &amp;&amp; (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'a'</span>.codePointAt(<span class="number">0</span>) &lt; <span class="number">6</span>)) &#123;</span><br><span class="line">         res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'a'</span>.codePointAt(<span class="number">0</span>) + <span class="number">10</span>) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'A'</span>.codePointAt(<span class="number">0</span>) &gt;= <span class="number">0</span>) &amp;&amp; (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'A'</span>.codePointAt(<span class="number">0</span>) &lt; <span class="number">6</span>)) &#123;</span><br><span class="line">         res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'A'</span>.codePointAt(<span class="number">0</span>) + <span class="number">10</span>) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">       res += (tempStrArr[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, tempStrArr.length - i - <span class="number">1</span>)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> res</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h3 id="转换成十进制"><a href="#转换成十进制" class="headerlink" title="转换成十进制"></a>转换成十进制</h3></li>
<li><p>实践思路</p>
<ol>
<li>判断正负符号位</li>
<li>判断是否为 Infinity</li>
<li>判断是否为 整数<ol>
<li>整数<ol>
<li>是否为科学计数法表示<ol>
<li>是，通过指数位置分成两部分：整数部分+指数部分</li>
<li>否，只需处理整数部分</li>
</ol>
</li>
</ol>
</li>
<li>小数<ol>
<li>是否为科学计数法表示<ol>
<li>是，通过分割成小数点到指数，分成三部分：整数部分+小数部分+指数部分</li>
<li>否，通过小数点位置，分成两部分：整数部分+小数部分</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</li>
<li><p>代码大致为：</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">converStringToDeciaml</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// console.log('str-=-=--=-==-=', str)</span></span><br><span class="line">  <span class="keyword">const</span> sign = getSign(str)</span><br><span class="line">  <span class="keyword">const</span> strFormatBySign = formatStrBySign(str)</span><br><span class="line">  <span class="keyword">if</span> (isInfinity(strFormatBySign)) <span class="keyword">return</span> (<span class="number">1</span> / <span class="number">0</span>) * sign <span class="comment">// 如果为 Inifity,乘以符号位输出Infinity</span></span><br><span class="line">  <span class="keyword">const</span> numberObject = splitStr(strFormatBySign)</span><br><span class="line">  <span class="keyword">const</span> &#123;int, float, exponentSign, exponent&#125; = numberObject</span><br><span class="line">  <span class="comment">// console.log('numberObject', numberObject)</span></span><br><span class="line">  <span class="keyword">const</span> resInt = calculateInt(int) <span class="comment">// 计算整数部分</span></span><br><span class="line">  <span class="comment">// console.log('resInt', resInt)</span></span><br><span class="line">  <span class="keyword">const</span> resFloat = calculateFloat(float) <span class="comment">// 计算小数部分</span></span><br><span class="line">  <span class="comment">// console.log('resFloat', resFloat)</span></span><br><span class="line">  <span class="keyword">const</span> resExponent = calculateExponent(resInt, resFloat, exponentSign, exponent) <span class="comment">// 计算（整数+小数）*  指数部分</span></span><br><span class="line">  <span class="keyword">const</span> res = sign * resExponent <span class="comment">// 最后乘以符号位</span></span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="判断正负，并根据符号位格式化字符串"><a href="#判断正负，并根据符号位格式化字符串" class="headerlink" title="判断正负，并根据符号位格式化字符串"></a>判断正负，并根据符号位格式化字符串</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 获取符号位</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSign</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果S的首字符为'-'</span></span><br><span class="line">  <span class="keyword">if</span>(str.indexOf(<span class="string">'-'</span>) == <span class="number">0</span>) &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="根据符号位格式化字符串（移除字符号位）"><a href="#根据符号位格式化字符串（移除字符号位）" class="headerlink" title="根据符号位格式化字符串（移除字符号位）"></a>根据符号位格式化字符串（移除字符号位）</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 根据符号位格式化字符串</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatStrBySign</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 如果 str 的首字符为‘+’或'-'，则移除首字符</span></span><br><span class="line">  <span class="keyword">if</span> (str.indexOf(<span class="string">'-'</span>) == <span class="number">0</span> || str.indexOf(<span class="string">'+'</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">    str = str.substring(<span class="number">1</span>, str.length)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="判断是否为Infinity"><a href="#判断是否为Infinity" class="headerlink" title="判断是否为Infinity"></a>判断是否为Infinity</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 是否为 Infinity</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isInfinity</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> testReg = <span class="regexp">/^Infinity/</span></span><br><span class="line">  <span class="keyword">let</span> resReg = testReg.exec(str)</span><br><span class="line">  <span class="keyword">return</span> resReg &amp;&amp; resReg[<span class="number">0</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="切割字符串，分成整数-小数-指数位符号-指数部分"><a href="#切割字符串，分成整数-小数-指数位符号-指数部分" class="headerlink" title="切割字符串，分成整数+小数+指数位符号+指数部分"></a>切割字符串，分成整数+小数+指数位符号+指数部分</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 切割字符串</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* @params: &#123; str &#125; 输入需要切割的字符串</span></span><br><span class="line"><span class="comment">* return: res: Object &#123;</span></span><br><span class="line"><span class="comment">*   int: 整数位,</span></span><br><span class="line"><span class="comment">*   float: 小数位,</span></span><br><span class="line"><span class="comment">*   exponentSign: 指数位符号,</span></span><br><span class="line"><span class="comment">*   exponent: 指数位</span></span><br><span class="line"><span class="comment">* &#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">splitStr</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> testReg = <span class="regexp">/^((0)|([1-9][0-9]*))?.?([0-9]*)(e|E)?((\+|\-)?([0-9]*))?/</span></span><br><span class="line">  <span class="keyword">let</span> resReg = testReg.exec(str)</span><br><span class="line">  <span class="keyword">let</span> res = &#123;</span><br><span class="line">    int: resReg[<span class="string">'1'</span>] || <span class="number">0</span>,</span><br><span class="line">    float: resReg[<span class="string">'4'</span>] || <span class="number">0</span>,</span><br><span class="line">    exponentSign: resReg[<span class="string">'7'</span>] || <span class="string">'+'</span>,</span><br><span class="line">    exponent: resReg[<span class="string">'8'</span>] || <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="整数部分运算"><a href="#整数部分运算" class="headerlink" title="整数部分运算"></a>整数部分运算</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 整数部分运算</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateInt</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> radix = <span class="number">10</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = str.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">    res += (str[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, str.length - i - <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="小数部分运算"><a href="#小数部分运算" class="headerlink" title="小数部分运算"></a>小数部分运算</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 小数部分运算</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateFloat</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> res = <span class="number">0</span></span><br><span class="line">  <span class="keyword">const</span> radix = <span class="number">10</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; str.length; i++) &#123;</span><br><span class="line">    res += (str[i].codePointAt(<span class="number">0</span>) - <span class="string">'0'</span>.codePointAt(<span class="number">0</span>)) * <span class="built_in">Math</span>.pow(radix, i * <span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h4 id="指数部分运算"><a href="#指数部分运算" class="headerlink" title="指数部分运算"></a>指数部分运算</h4><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 指数部分运算</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateExponent</span>(<span class="params">int, float, exponentSign, exponent</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// if (float)</span></span><br><span class="line">  <span class="keyword">let</span> str = int + <span class="number">0.1</span> * float</span><br><span class="line">  <span class="keyword">const</span> radix = <span class="number">10</span></span><br><span class="line">  <span class="keyword">const</span> exponentInt = calculateInt(exponent)</span><br><span class="line">  <span class="keyword">if</span> (exponentSign === <span class="string">'+'</span>) &#123;</span><br><span class="line">    str = str * <span class="built_in">Math</span>.pow(radix, exponentInt)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    str = str * <span class="built_in">Math</span>.pow(radix, exponentInt * <span class="number">-1</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// console.log('Math.abs(str)', Math.abs(str) -  Math.floor(str))</span></span><br><span class="line">  <span class="comment">// // console.log('Number.EPSILON', Number.EPSILON)</span></span><br><span class="line">  <span class="comment">// if (Math.abs(str) -  Math.floor(str)) &#123;</span></span><br><span class="line">  <span class="comment">//   return str.toFixed(1)</span></span><br><span class="line">  <span class="comment">// &#125;</span></span><br><span class="line">  <span class="keyword">return</span> str</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h4><ul>
<li>测试用例</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'1.0e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'1.0e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'-1.0e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'-1.0e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'1.012e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'1.012e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'-1.012e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'-1.012e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'.012e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'.012e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'-.012e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'-.012e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'0.12e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'0.12e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'-0.12e+10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'-0.12e+10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'1.2e-10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'1.2e-10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'-1.2e-10'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'-1.2e-10'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'-1.22'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'-1.22'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'Infinity'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'Infinity'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'Infinity2222'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'Infinity2222'</span>, <span class="number">10</span>))</span><br><span class="line"><span class="built_in">console</span>.log(converStringToDeciaml(<span class="string">'22Infinity2222'</span>))</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'parseFloat 结果'</span>, <span class="built_in">parseFloat</span>(<span class="string">'22Infinity2222'</span>, <span class="number">10</span>))</span><br></pre></td></tr></table></figure>

<ul>
<li>测试截图</li>
<li><img src="http://p1.meituan.net/myvideodistribute/f3bc45ab42eea92318ad58711d21a666220332.png" alt="第一部分测试截图"></li>
<li><img src="http://p1.meituan.net/myvideodistribute/2cf7b8c0ae63f2009cbd77d83dec1e2c176792.png" alt="第二部分测试截图"></li>
</ul>
<h2 id="待解决问题"><a href="#待解决问题" class="headerlink" title="待解决问题"></a>待解决问题</h2><ul>
<li>是的 😭 它的浮点数的舍入，我没有想到好的方法，哭唧唧</li>
<li><a href="https://github.com/Ele-Peng/Frontend-01-Template/blob/master/week03/convertStringToNumber.html" target="_blank" rel="noopener">代码地址</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>等我有空把博客评论搞一下，欢迎大家来告诉我的遗留问题该怎么解决，以及你们在参考我的实现时，有测试用例过不去的地方，也可以评论告诉我，我优化代码。</li>
<li>大家等不及的话，可以去我的 <a href="https://blog.csdn.net/Elle_Peng/article/details/105748022" target="_blank" rel="noopener">csdn</a> 评论告诉我，卑微小彭，在线求解</li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序-获取图片主色调</title>
    <url>/2020/04/05/%E5%BE%AE%E4%BF%A1%E5%B0%8F%E7%A8%8B%E5%BA%8F-%E8%8E%B7%E5%8F%96%E5%9B%BE%E7%89%87%E4%B8%BB%E8%89%B2%E8%B0%83/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>是的我要开始做：根据图片的主色调来改变一下页面背景颜色了🙆</li>
<li>记录一下，自己碰到的问题以及思考</li>
<li><a href="https://github.com/Ele-Peng/miniprogram-main-color" target="_blank" rel="noopener">miniprogram-main-color 完整代码 点击一下</a> 欢迎大家去star😘</li>
</ul>
<hr>
<h2 id="开发准备"><a href="#开发准备" class="headerlink" title="开发准备"></a>开发准备</h2><ul>
<li>理一下思路<ol>
<li>将网络图片绘制进canvas</li>
<li>通过canvas的getImageData获取图片的像素数据<ul>
<li><a href="https://blog.csdn.net/Elle_Peng/article/details/105030971" target="_blank" rel="noopener">canvas 2d 与旧版 canvas 将网络图片绘制进canvas的两种方法实践</a></li>
</ul>
</li>
<li>分析目前主要用于获取图片主色调的算法，并实践</li>
<li>得到主要色调，再将rgb转换成hsb，并对b值，进行修改，制作渐变，左侧35，右侧15<a id="more"></a>
<ul>
<li>嗯，祝我成功<h2 id="颜色空间基础知识背景-减色算法"><a href="#颜色空间基础知识背景-减色算法" class="headerlink" title="颜色空间基础知识背景+减色算法"></a>颜色空间基础知识背景+减色算法</h2></li>
<li><a href="http://www.360doc.com/content/17/0417/19/41797635_646363886.shtml" target="_blank" rel="noopener">颜色空间 RGB CMY HSV HSL LAB</a></li>
<li>图片颜色量化算法</li>
</ul>
</li>
</ol>
<ul>
<li>比较常见的应用就是用于提取图片的主色调用于上色配色,当然也可以用于图像分割</li>
<li>主流算法<ul>
<li>两个大方向</li>
<li><strong>在颜色空间合理地选取采样点来构造颜色表，使得减色后的图像和原图尽可能地接近</strong><ul>
<li>直接量化<ul>
<li>对每个颜色通道单独重新采样，将每个通道的色阶从256减少到某个指定的数字。这样得到一个新的小的多的颜色空间，而原图像中的每一个像素将被用在新的颜色空间中的最近邻取代</li>
</ul>
</li>
<li>统计量化<ul>
<li>核心：调整直方图使得累积分布曲线呈线性，从而使图像像素点的亮度值尽可能均匀地分布</li>
<li>利用原图的直方图来引导采样点的选取，使得每个采样点可以大致覆盖相同数量的像素点</li>
<li>对每个颜色通道建立直方图，然后根据这些直方图对各个颜色通道单独采样，在像素值分布多的区域进行密集采样，别的区域稀疏采样，再利用这些采样点来组合成最终的颜色表，原图中的每个像素点用颜色表中最接近的颜色替换掉</li>
</ul>
</li>
<li>颜色空间分割(Median-Cut)<ul>
<li>核心：在颜色空间建立一棵二叉树，通过不断地细化这棵树来近似得到一个颜色三维直方图，然后再根据这棵树来分配采样点</li>
<li>基于图像颜色样本分布的自适应方法，不论图像中颜色样本的分布如何，总是可以生成一个和颜色样本分布匹配良好的颜色表：在颜色样本分布密集的区域内采样点分布也相对密集，其他区域则分配了较少的采样点。且相同数目的颜色样本总是用同样数量的采样点来代表，所以颜色样本分布密集的区域，采样点的数量自然就会多，反之则相应的比较少</li>
<li>最重要、应用最广泛的减色算法之一</li>
</ul>
</li>
<li>k均值聚类(k-Means clustering)<ul>
<li>核心：将像素按颜色的相似程度归类</li>
</ul>
</li>
</ul>
</li>
<li><strong>从一个初始的颜色表出发，通过不断修改颜色表来改善减色效果</strong><ul>
<li>神经网络方法(ANN)<ul>
<li>颜色表通过神经元来编码，通过缓慢的调节神经元的颜色值以保证整个神经网络逐步收敛于最小误差状态（即通过神经网络产生的图像和原图之间误差最小）<h2 id="直接量化实践"><a href="#直接量化实践" class="headerlink" title="直接量化实践"></a>直接量化实践</h2><ul>
<li>首先我们可以来看一看getImageData后的数据</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzljZjVjMjQzMDI0NmE0YjE0YzFlYmMzMjYwZDkwYTgwNTQzMDIucG5n?x-oss-process=image/format,png" alt="getImageData数据"></li>
<li>可以简单看作是外层循环为rgba的打平了二维数组<ul>
<li>如果按满足需求做，只要一个主色调的话，可以把整个getImageData获得的数据，进行各个通道的平均值求值，再拼接，像这样<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">getUniqueColor(imageData) &#123;</span><br><span class="line">   <span class="keyword">let</span> res_r = <span class="number">0</span></span><br><span class="line">   <span class="keyword">let</span> res_g = <span class="number">0</span></span><br><span class="line">   <span class="keyword">let</span> res_b = <span class="number">0</span></span><br><span class="line">   <span class="keyword">let</span> res_a = <span class="number">0</span></span><br><span class="line">   <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; imageData.length; i += <span class="number">1</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (i % <span class="number">4</span> === <span class="number">0</span>) &#123;</span><br><span class="line">       res_r += imageData[i]</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i % <span class="number">4</span> === <span class="number">1</span>) &#123;</span><br><span class="line">       res_g += imageData[i]</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i % <span class="number">4</span> === <span class="number">2</span>) &#123;</span><br><span class="line">       res_b += imageData[i]</span><br><span class="line">     &#125; <span class="keyword">else</span> <span class="keyword">if</span> (i % <span class="number">4</span> === <span class="number">3</span>) &#123;</span><br><span class="line">       res_a += imageData[i]</span><br><span class="line">     &#125; </span><br><span class="line">   &#125;</span><br><span class="line">   res_r = <span class="built_in">Math</span>.round(res_r / (imageData.length / <span class="number">4</span>))</span><br><span class="line">   res_g =  <span class="built_in">Math</span>.round(res_g / (imageData.length / <span class="number">4</span>))</span><br><span class="line">   res_b =  <span class="built_in">Math</span>.round(res_b / (imageData.length / <span class="number">4</span>))</span><br><span class="line">   res_a =  <span class="built_in">Math</span>.round(res_a / (imageData.length / <span class="number">4</span>))</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'res_r'</span>, res_r)</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'res_g'</span>, res_g)</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'res_b'</span>, res_b)</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="string">'res_a'</span>, res_a)</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>运行截图<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzc4NzFiOTVmYzA4NWQ3NGQwNDc4OWY0ZWI5Yzc0YThmNzQ5OTYucG5n?x-oss-process=image/format,png" alt="暴力法求主色调"></li>
<li>无相关点越多，误差越大👎<ul>
<li>我们可以“对每个颜色通道单独重新采样，将每个通道的色阶从256减少到某个指定的数字。这样得到一个新的小的多的颜色空间，而原图像中的每一个像素将被用在新的颜色空间中的最近邻取代”<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> COLOR_SIZE = <span class="number">40</span> <span class="comment">// 单位色块的大小（像素个数，默认40）。以单位色块的平均像素值为作为统计单位</span></span><br><span class="line"><span class="keyword">const</span> LEVEL = <span class="number">32</span> <span class="comment">// 色深，颜色分区参数（0-255），总256，2^8，即8bit，4个通道（rgba），即默认色深4*8bit，32bit</span></span><br><span class="line"><span class="comment">// 分区块，可以拓展性的求主要色板，用来做palette</span></span><br><span class="line">   <span class="keyword">const</span> mapData = that.getLevelData(imageData);</span><br><span class="line">   <span class="keyword">const</span> colors = that.getMostColor(mapData);</span><br><span class="line">   <span class="keyword">if</span> (!colors) &#123;</span><br><span class="line">     <span class="keyword">return</span></span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">const</span> color = that.getAverageColor(colors)</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'color'</span>, color)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>将getImageData数据分成特定大小的区块，分别算出各个区块的averageColor，再利用map特性，将averageColor作key，count各个averageColor个数  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取每段的颜色数据</span></span><br><span class="line"><span class="comment">// 根据像素数据，按单位色块进行切割</span></span><br><span class="line">getLevelData(imageData) &#123;</span><br><span class="line">  <span class="keyword">const</span> len = imageData.length;</span><br><span class="line">  <span class="keyword">const</span> mapData = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i += COLOR_SIZE * <span class="number">4</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> blockColor = <span class="keyword">this</span>.getBlockColor(imageData, i); <span class="comment">// 该区块平均rgba [&#123;r,g,b,a&#125;]数据</span></span><br><span class="line">    <span class="comment">// 获取各个区块的平均rgba数据，将各个通道的颜色进行LEVEL色深降级</span></span><br><span class="line">    <span class="comment">// 根据r_g_b_a 建立map索引</span></span><br><span class="line">    <span class="keyword">const</span> key = <span class="keyword">this</span>.getColorLevel(blockColor);</span><br><span class="line">    !mapData[key] &amp;&amp; (mapData[key] = []);</span><br><span class="line">    mapData[key].push(blockColor);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> mapData;</span><br><span class="line">&#125;,</span><br><span class="line">		</span><br><span class="line"><span class="comment">// 获取单位块的全部色值</span></span><br><span class="line"><span class="comment">// 并根据全部色值，计算平均色值</span></span><br><span class="line"><span class="comment">// 处理最后边界值，小于COLOR_SIZE</span></span><br><span class="line">getBlockColor(imageData, start) &#123;</span><br><span class="line">  <span class="keyword">let</span> data = [],</span><br><span class="line">    count = COLOR_SIZE,</span><br><span class="line">    len = COLOR_SIZE * <span class="number">4</span>;</span><br><span class="line">  imageData.length &lt;= start + len &amp;&amp; (count = <span class="built_in">Math</span>.floor((imageData.length - start - <span class="number">1</span>) / <span class="number">4</span>));</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; count; i += <span class="number">4</span>) &#123;</span><br><span class="line">    data.push(&#123;</span><br><span class="line">      r: imageData[start + i + <span class="number">0</span>],</span><br><span class="line">      g: imageData[start + i + <span class="number">1</span>],</span><br><span class="line">      b: imageData[start + i + <span class="number">2</span>],</span><br><span class="line">      a: imageData[start + i + <span class="number">3</span>]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.getAverageColor(data);</span><br><span class="line">&#125;,</span><br><span class="line">		</span><br><span class="line"><span class="comment">// 取出各个通道的平均值，即为改色块的平均色值</span></span><br><span class="line">getAverageColor(colorArr) &#123;</span><br><span class="line">  <span class="keyword">const</span> len = colorArr.length;</span><br><span class="line">  <span class="keyword">let</span> sr = <span class="number">0</span>, sg = <span class="number">0</span>, sb = <span class="number">0</span>, sa = <span class="number">0</span>;</span><br><span class="line">  colorArr.map(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</span><br><span class="line">    sr += item.r;</span><br><span class="line">    sg += item.g;</span><br><span class="line">    sb += item.b;</span><br><span class="line">    sa += item.a;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    r: <span class="built_in">Math</span>.round(sr / len),</span><br><span class="line">    g: <span class="built_in">Math</span>.round(sg / len),</span><br><span class="line">    b: <span class="built_in">Math</span>.round(sb / len),</span><br><span class="line">    a: <span class="built_in">Math</span>.round(sa / len)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">		</span><br><span class="line">getColorLevel(color) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.getLevel(color.r) + <span class="string">'_'</span> + <span class="keyword">this</span>.getLevel(color.g) + <span class="string">'_'</span> + <span class="keyword">this</span>.getLevel(color.b) + <span class="string">'_'</span> + <span class="keyword">this</span>.getLevel(color.a)</span><br><span class="line">&#125;,</span><br><span class="line">		</span><br><span class="line"><span class="comment">// 色深降级</span></span><br><span class="line">getLevel(value) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.round(value / LEVEL)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li>
<li>把出现次数最多的averageColor区块，作为采样区块，再获取一遍averageColor，即是最终主色调  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 根据色块颜色，获取</span></span><br><span class="line">getMostColor(colorData) &#123;</span><br><span class="line">  <span class="keyword">let</span> rst = <span class="literal">null</span>, len = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> key <span class="keyword">in</span> colorData) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'colorData[key].length'</span>, colorData[key].length)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'colorData[key].length'</span>, colorData[key])</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'colorData[key].length'</span>, key)</span><br><span class="line">    colorData[key].length &gt; len &amp;&amp; (</span><br><span class="line">      rst = colorData[key],</span><br><span class="line">      len = colorData[key].length</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rst;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></li>
<li>运行截图<ul>
<li><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2ViYzI3MmNkNzU2NjNhODUxYmM2MWQ0MDE4OWJjZGI3NzQ5NDUucG5n?x-oss-process=image/format,png" alt="区块获取主色调"></li>
<li>颜色可信度提高了很多<h2 id="拓展实践-医学灰色影像"><a href="#拓展实践-医学灰色影像" class="headerlink" title="拓展实践-医学灰色影像"></a>拓展实践-医学灰色影像</h2><ul>
<li>核心：将<strong>三通道转成单通道</strong>即可<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> greyImageData = that.greyTheImage(imageData)</span><br><span class="line">   wx.canvasPutImageData(&#123;</span><br><span class="line">     canvasId: <span class="string">'myCanvas'</span>,</span><br><span class="line">     x: <span class="number">150</span>,</span><br><span class="line">     y: <span class="number">0</span>,</span><br><span class="line">     width: <span class="number">150</span>,</span><br><span class="line">     height: <span class="number">100</span>,</span><br><span class="line">     data: greyImageData,</span><br><span class="line">     success (res) &#123;</span><br><span class="line">       <span class="built_in">console</span>.log(<span class="string">'canvasPutImageData it worked!'</span>)</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;)</span><br><span class="line"></span><br><span class="line"> greyTheImage(imageData) &#123;</span><br><span class="line">     <span class="comment">// imageData有4个通道rgba</span></span><br><span class="line">     <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; imageData.length; i += <span class="number">4</span>) &#123;</span><br><span class="line">       <span class="keyword">let</span> sum_rgb = <span class="number">0</span></span><br><span class="line">       <span class="comment">// 但我们只需要rgb三通道，a-alpha通道无用</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j += <span class="number">1</span>) &#123;</span><br><span class="line">         sum_rgb = sum_rgb + imageData[i + j]</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">let</span> grey = <span class="built_in">Math</span>.round(sum_rgb / <span class="number">3</span>)</span><br><span class="line">       imageData[i] = grey</span><br><span class="line">       imageData[i + <span class="number">1</span>] = grey</span><br><span class="line">       imageData[i + <span class="number">2</span>] = grey</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">return</span> imageData</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure></li>
<li>运行截图<br><img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlLzhmNWJhNzk2OTJjOWEwOTA2MDNlMzkxMzBlMDRiZTY4MTAwNzcwLnBuZw?x-oss-process=image/format,png" alt="医学灰色影像"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="格式化rgba输出"><a href="#格式化rgba输出" class="headerlink" title="格式化rgba输出"></a>格式化rgba输出</h2><ul>
<li>像这样<img src="https://imgconvert.csdnimg.cn/aHR0cDovL3AwLm1laXR1YW4ubmV0L215dmlkZW9kaXN0cmlidXRlL2YxNDVhYzM4YzQ1MjFkNDgzNGNkZGQ5NTNmNjQ1MWQ3NTI0NTkucG5n?x-oss-process=image/format,png" alt="格式化rgba输出">  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 对最终颜色的字符串格式化</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * result:&#123;</span></span><br><span class="line"><span class="comment"> *   hex:'#ffffff',            十六位值</span></span><br><span class="line"><span class="comment"> *   hexa:'#ffffff00',         十六位值带alpha值</span></span><br><span class="line"><span class="comment"> *   rgb:'rgb(0,0,0)',         RGB值</span></span><br><span class="line"><span class="comment"> *   rgba:'rgba(0,0,0,0)'      RGB值带alpha值</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	</span><br><span class="line">colorStrFormat(color) &#123;</span><br><span class="line">  <span class="keyword">const</span> rgba = <span class="string">'rgba('</span> + color.r + <span class="string">','</span> + color.g + <span class="string">','</span> + color.b + <span class="string">','</span> + (color.a / <span class="number">255</span>).toFixed(<span class="number">4</span>).replace(<span class="regexp">/\.*0+$/</span>, <span class="string">''</span>) + <span class="string">')'</span>;</span><br><span class="line">  <span class="keyword">const</span> rgb = <span class="string">'rgb('</span> + color.r + <span class="string">','</span> + color.g + <span class="string">','</span> + color.b + <span class="string">')'</span>;</span><br><span class="line">  <span class="keyword">const</span> hex = <span class="string">'#'</span> + <span class="keyword">this</span>.Num2Hex(color.r) + <span class="keyword">this</span>.Num2Hex(color.g) + <span class="keyword">this</span>.Num2Hex(color.b);</span><br><span class="line">  <span class="keyword">const</span> hexa = hex + <span class="keyword">this</span>.Num2Hex(color.a);</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    rgba: rgba,</span><br><span class="line">    rgb: rgb,</span><br><span class="line">    hex: hex,</span><br><span class="line">    hexa: hexa</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">	</span><br><span class="line">Num2Hex(num) &#123;</span><br><span class="line">  <span class="keyword">const</span> hex = num.toString(<span class="number">16</span>) + <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">if</span> (hex.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'0'</span> + hex;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> hex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2></li>
<li><a href="https://blog.csdn.net/u012843346/article/details/16839649" target="_blank" rel="noopener">phg1024 JavaScript图像处理(6) - 减色算法(Color Reduction)</a></li>
<li><a href="https://github.com/whoiam2007s/ImgMainColor" target="_blank" rel="noopener">获取图片主色调的插件</a></li>
<li>其实也可以利用 <a href="https://blog.csdn.net/nanhupatar/article/details/82793637" target="_blank" rel="noopener">CSS新特性去改变背景颜色</a>，比如高斯模糊等来达到业务需求<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2></li>
<li>周六听了一天 John Lennon 歌曲【这也是我拖更的原因😶 羡慕他和 Yoko 那段伊甸园般的爱情，他对 Yoko 的痴爱，他和母亲的两次分别感同身受，Beatles在一起做音乐的欢乐，他对 Sean 的宠溺父爱，但他的人生却在一次枪杀后戛然而止，心痛 心痛 🌧</li>
<li>祝大家多多发财</li>
</ul>
<hr>
]]></content>
      <categories>
        <category>微信小程序</category>
      </categories>
      <tags>
        <tag>微信小程序</tag>
      </tags>
  </entry>
  <entry>
    <title>Toy-Browser-DAY2</title>
    <url>/2020/05/15/Toy-Browser-DAY2/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>


<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>implementation of a toy-browser 🙆</li>
<li>DAY1，我们已经完成 HTTP相关解析，现在我们可以写 HTML 的解析啦，开不开心！😝</li>
<li><img src="http://p1.meituan.net/myvideodistribute/6e1d35dcd8c01b557925f8d799583cb1130452.png" alt="HTML 的解析"></li>
</ul>
<a id="more"></a>



<h2 id="实践过程"><a href="#实践过程" class="headerlink" title="实践过程"></a>实践过程</h2><h3 id="第一步：拆分文件"><a href="#第一步：拆分文件" class="headerlink" title="第一步：拆分文件"></a>第一步：拆分文件</h3><ul>
<li>为了方便文件管理，我们把parse单独拆到文件中</li>
<li>parser 接受 HTML 文本作为参数，返回一颗 DOM 树</li>
</ul>
<ul>
<li><p>server.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> server = http.createServer(<span class="function">(<span class="params">req, res</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">  ... some code </span><br><span class="line">  </span><br><span class="line">  res.end(</span><br><span class="line">    <span class="string">`&lt;html maaa=a &gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;</span></span><br><span class="line"><span class="string">        &lt;style&gt;</span></span><br><span class="line"><span class="string">    body div #myid&#123;</span></span><br><span class="line"><span class="string">        width:100px;</span></span><br><span class="line"><span class="string">        background-color: #ff5000;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    body div img&#123;</span></span><br><span class="line"><span class="string">        width:30px;</span></span><br><span class="line"><span class="string">        background-color: #ff1111;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">        &lt;/style&gt;</span></span><br><span class="line"><span class="string">    &lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">        &lt;div&gt;</span></span><br><span class="line"><span class="string">            &lt;img id="myid"/&gt;</span></span><br><span class="line"><span class="string">            &lt;img /&gt;</span></span><br><span class="line"><span class="string">        &lt;/div&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;`</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">8088</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>client.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">... some code</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  ... some code</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">let</span> dom = parser.parseHTML(response.body)</span><br><span class="line">  </span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure>
</li>
<li><p>parseHTML1.js</p>
</li>
</ul>
<pre><code><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 拆分文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.parseHTML = <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(html)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></code></pre><ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/98a64e9c9eb9f97c01b0bb4ccb0141f976175.png" alt="运行结果"></li>
</ul>
</li>
</ul>
<h3 id="第二步：创建状态机"><a href="#第二步：创建状态机" class="headerlink" title="第二步：创建状态机"></a>第二步：创建状态机</h3><ul>
<li>我们用 FSM 来实现 HTML 的分析</li>
<li>在 HTML 标准中，已经规定了 HTML 的状态</li>
<li>Toy-Browser 只挑选其中的一部分状态，完成一个最简版本</li>
</ul>
<ul>
<li><p>parseHTML2.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 初始化 FSM - Finite State Machine</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EOF = <span class="built_in">Symbol</span>(<span class="string">"EOF"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">data</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.parseHTML = <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> state = data</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> html) &#123;</span><br><span class="line">    state = state(c)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = state(EOF)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="第三步：解析标签"><a href="#第三步：解析标签" class="headerlink" title="第三步：解析标签"></a>第三步：解析标签</h3><ul>
<li><p>主要的标签有：开始标签，结束标签和自封闭标签</p>
</li>
<li><p>在这一步我们暂时忽略属性</p>
</li>
<li><p>【未完：状态图分析】</p>
</li>
<li><p>parseHTML3.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 解析标签</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EOF = <span class="built_in">Symbol</span>(<span class="string">"EOF"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">data</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> tagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 开始标签</span></span><br><span class="line"><span class="comment">// 2. 结束标签</span></span><br><span class="line"><span class="comment">// 3. 自封闭标签</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123; <span class="comment">// 结束标签</span></span><br><span class="line">    <span class="keyword">return</span> endTagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123; <span class="comment">// 开始标签</span></span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">endTagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(char == EOF) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selfClosingStartTag</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"EOF"</span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.parseHTML = <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> state = data</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> html) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = state(EOF)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="第四步：创建元素"><a href="#第四步：创建元素" class="headerlink" title="第四步：创建元素"></a>第四步：创建元素</h3><ul>
<li><p>在状态中，除了状态迁移，我们还会要加入业务逻辑</p>
</li>
<li><p>我们在标签结束状态提交标签 token</p>
</li>
<li><p>parseHTML4.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// emitToken 创建元素</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentToken = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emit</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (token.type != <span class="string">"text"</span>) </span><br><span class="line">    <span class="built_in">console</span>.log(token)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EOF = <span class="built_in">Symbol</span>(<span class="string">"EOF"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">data</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> tagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    emit(&#123;</span><br><span class="line">      type: <span class="string">"EOF"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 开始标签</span></span><br><span class="line"><span class="comment">// 2. 结束标签</span></span><br><span class="line"><span class="comment">// 3. 自封闭标签</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123; <span class="comment">// 结束标签</span></span><br><span class="line">    <span class="keyword">return</span> endTagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123; <span class="comment">// 开始标签</span></span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"startTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">endTagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"endTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(char == EOF) &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken.tagName += char.toLowerCase()</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selfClosingStartTag</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&gt;"</span> || char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    currentToken.isSelfClosing = <span class="literal">true</span></span><br><span class="line">    currentToken.type = <span class="string">"selfClosingTag"</span></span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"EOF"</span>) &#123;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.parseHTML = <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> state = data</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> html) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = state(EOF)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/5c4078e02702211bbe87ca75d2044cdb106832.png" alt="第四步运行结果"></li>
</ul>
</li>
</ul>
<h3 id="第五步：处理属性"><a href="#第五步：处理属性" class="headerlink" title="第五步：处理属性"></a>第五步：处理属性</h3><ul>
<li><p>属性分为单引号、双引号、无引号三种写法，因此需要较多状态处理</p>
</li>
<li><p>处理属性的方式跟标签类似</p>
</li>
<li><p>属性结束时，我们把属性加到标签 token 上</p>
</li>
<li><p>parseHTML5.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 处理属性 attribute</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentToken = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> currentAttribute = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emit</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (token.type != <span class="string">"text"</span>) </span><br><span class="line">    <span class="built_in">console</span>.log(token)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EOF = <span class="built_in">Symbol</span>(<span class="string">"EOF"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">data</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> tagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    emit(&#123;</span><br><span class="line">      type: <span class="string">"EOF"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    emit(&#123;</span><br><span class="line">      type: <span class="string">"text"</span>,</span><br><span class="line">      content: char</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 开始标签</span></span><br><span class="line"><span class="comment">// 2. 结束标签</span></span><br><span class="line"><span class="comment">// 3. 自封闭标签</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123; <span class="comment">// 结束标签</span></span><br><span class="line">    <span class="keyword">return</span> endTagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123; <span class="comment">// 开始标签</span></span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"startTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">endTagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"endTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken.tagName += char.toLowerCase()</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span> || char == <span class="string">"/"</span> || char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> afterAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute = &#123;</span><br><span class="line">      name: <span class="string">""</span>,</span><br><span class="line">      value: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attributeName(char)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">afterAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>) || char == <span class="string">"/"</span> || char == <span class="string">"&gt;"</span> || char == EOF) &#123; </span><br><span class="line">    <span class="keyword">return</span> afterAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span> || char == <span class="string">"\'"</span> || char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> attributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.name += char</span><br><span class="line">    <span class="keyword">return</span> attributeName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>) || char == <span class="string">"/"</span> || char == <span class="string">"&gt;"</span> || char == EOF) &#123; </span><br><span class="line">    <span class="keyword">return</span> beforeAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> doubleQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\'"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> singleQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> UnquotedAttributeValue(char)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doubleQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"\""</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="keyword">return</span> afterQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> doubleQuotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">singleQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"\'"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="keyword">return</span> afterQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> singleQuotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">afterQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char ==<span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UnquotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="comment">// emit(currentToken)</span></span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="comment">// emit(currentToken)</span></span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span> || char == <span class="string">"\'"</span> || char == <span class="string">"&lt;"</span> || char == <span class="string">"="</span> || char == <span class="string">"`"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> UnquotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selfClosingStartTag</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&gt;"</span> || char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    currentToken.isSelfClosing = <span class="literal">true</span></span><br><span class="line">    currentToken.type = <span class="string">"selfClosingTag"</span></span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"EOF"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.parseHTML = <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> state = data</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> html) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">    <span class="comment">// console.log(state)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = state(EOF)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/3b45aac402868fe1c62c7d7debbcfd24114412.png" alt="第五步运行结果"></li>
</ul>
</li>
</ul>
<h3 id="第六步：构建-DOM-树"><a href="#第六步：构建-DOM-树" class="headerlink" title="第六步：构建 DOM 树"></a>第六步：构建 DOM 树</h3><ul>
<li><p>从标签创建 DOM 树的基本技巧是使用栈</p>
</li>
<li><p>遇到开始标签时创建元素并入栈，遇到结束标签时出栈</p>
</li>
<li><p>自封闭节点可视为入栈后立刻出栈</p>
</li>
<li><p>任何元素的父元素是它入栈前的栈顶</p>
</li>
<li><p>parseHTML6.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 处理属性 constructTree</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentToken = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> currentAttribute = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> stack = [&#123;<span class="attr">type</span>: <span class="string">"document"</span>, <span class="attr">children</span>: []&#125;]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emit</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (token.type == <span class="string">"text"</span>) </span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> top = stack[stack.length - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (token.type == <span class="string">"startTag"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> element = &#123;</span><br><span class="line">      type: <span class="string">"element"</span>,</span><br><span class="line">      children: [],</span><br><span class="line">      attributes: []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    element.tagName = token.tagName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">in</span> token) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="string">"type"</span> &amp;&amp; p != <span class="string">"tagName"</span>) &#123;</span><br><span class="line">        element.attributes.push(&#123;</span><br><span class="line">          name: p,</span><br><span class="line">          value: token[p]</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    top.children.push(element)</span><br><span class="line">    element.parent = top</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!token.isSelfClosing)</span><br><span class="line">      stack.push(element)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'push'</span>, element)</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.type == <span class="string">"endTag"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (top.tagName != token.tagName) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Tag start end doesn't match"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'pop'</span>, stack.pop())</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EOF = <span class="built_in">Symbol</span>(<span class="string">"EOF"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">data</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> tagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    emit(&#123;</span><br><span class="line">      type: <span class="string">"EOF"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    emit(&#123;</span><br><span class="line">      type: <span class="string">"text"</span>,</span><br><span class="line">      content: char</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 开始标签</span></span><br><span class="line"><span class="comment">// 2. 结束标签</span></span><br><span class="line"><span class="comment">// 3. 自封闭标签</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123; <span class="comment">// 结束标签</span></span><br><span class="line">    <span class="keyword">return</span> endTagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123; <span class="comment">// 开始标签</span></span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"startTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">endTagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"endTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken.tagName += char.toLowerCase()</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span> || char == <span class="string">"/"</span> || char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> afterAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute = &#123;</span><br><span class="line">      name: <span class="string">""</span>,</span><br><span class="line">      value: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attributeName(char)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">afterAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>) || char == <span class="string">"/"</span> || char == <span class="string">"&gt;"</span> || char == EOF) &#123; </span><br><span class="line">    <span class="keyword">return</span> afterAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span> || char == <span class="string">"\'"</span> || char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> attributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.name += char</span><br><span class="line">    <span class="keyword">return</span> attributeName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>) || char == <span class="string">"/"</span> || char == <span class="string">"&gt;"</span> || char == EOF) &#123; </span><br><span class="line">    <span class="keyword">return</span> beforeAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> doubleQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\'"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> singleQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> UnquotedAttributeValue(char)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doubleQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"\""</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="keyword">return</span> afterQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> doubleQuotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">singleQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"\'"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="keyword">return</span> afterQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> singleQuotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">afterQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char ==<span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UnquotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="comment">// emit(currentToken)</span></span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="comment">// emit(currentToken)</span></span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span> || char == <span class="string">"\'"</span> || char == <span class="string">"&lt;"</span> || char == <span class="string">"="</span> || char == <span class="string">"`"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> UnquotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selfClosingStartTag</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&gt;"</span> || char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    currentToken.isSelfClosing = <span class="literal">true</span></span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"EOF"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.parseHTML = <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> state = data</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> html) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">    <span class="comment">// console.log(state)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = state(EOF)</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">console</span>.log(stack)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果：这边我在每次对栈操作时(push/pop)时，添加了 console</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/f83a95f5afec8c5ad34c8df0a34a6ff8116344.png" alt="第六步运行结果"></li>
</ul>
</li>
<li><p>这边推荐使用 <a href="https://code.visualstudio.com/docs/editor/debugging" target="_blank" rel="noopener">vs-code debugger 使用方法</a></p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/7a4cb0d87ac89cb3a5ae4252c3a5d6a7321211.png" alt="第六步运行结果 vscode debugger"></li>
</ul>
</li>
</ul>
<h3 id="第七步：文本节点"><a href="#第七步：文本节点" class="headerlink" title="第七步：文本节点"></a>第七步：文本节点</h3><ul>
<li><p>文本节点与自封闭标签处理类似</p>
</li>
<li><p>多个文本节点需要合并</p>
</li>
<li><p>parseHTML7.js</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 处理文本节点 combineText</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> currentToken = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> currentAttribute = <span class="literal">null</span></span><br><span class="line"><span class="keyword">let</span> currentTextNode = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> stack = [&#123;<span class="attr">type</span>: <span class="string">"document"</span>, <span class="attr">children</span>: []&#125;]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">emit</span>(<span class="params">token</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> top = stack[stack.length - <span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (token.type == <span class="string">"startTag"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> element = &#123;</span><br><span class="line">      type: <span class="string">"element"</span>,</span><br><span class="line">      children: [],</span><br><span class="line">      attributes: []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    element.tagName = token.tagName</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> p <span class="keyword">in</span> token) &#123;</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="string">"type"</span> &amp;&amp; p != <span class="string">"tagName"</span>) &#123;</span><br><span class="line">        element.attributes.push(&#123;</span><br><span class="line">          name: p,</span><br><span class="line">          value: token[p]</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    top.children.push(element)</span><br><span class="line">    element.parent = top</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!token.isSelfClosing)</span><br><span class="line">      stack.push(element)</span><br><span class="line">    </span><br><span class="line">    currentTextNode = <span class="literal">null</span></span><br><span class="line">    <span class="comment">// console.log('push', element)</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.type == <span class="string">"endTag"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (top.tagName != token.tagName) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Tag start end doesn't match"</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// console.log('pop', stack.pop())</span></span><br><span class="line">      stack.pop()</span><br><span class="line">    &#125;</span><br><span class="line">    currentTextNode = <span class="literal">null</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (token.type == <span class="string">"text"</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (currentTextNode == <span class="literal">null</span>) &#123;</span><br><span class="line">      currentTextNode = &#123;</span><br><span class="line">        type: <span class="string">"text"</span>,</span><br><span class="line">        content: <span class="string">""</span></span><br><span class="line">      &#125;</span><br><span class="line">      top.children.push(currentTextNode)</span><br><span class="line">    &#125;</span><br><span class="line">    currentTextNode.content += token.content</span><br><span class="line">    <span class="comment">// console.log(top.children)</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> EOF = <span class="built_in">Symbol</span>(<span class="string">"EOF"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">data</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> tagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    emit(&#123;</span><br><span class="line">      type: <span class="string">"EOF"</span></span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    emit(&#123;</span><br><span class="line">      type: <span class="string">"text"</span>,</span><br><span class="line">      content: char</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 开始标签</span></span><br><span class="line"><span class="comment">// 2. 结束标签</span></span><br><span class="line"><span class="comment">// 3. 自封闭标签</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123; <span class="comment">// 结束标签</span></span><br><span class="line">    <span class="keyword">return</span> endTagOpen</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123; <span class="comment">// 开始标签</span></span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"startTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">endTagOpen</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken = &#123;</span><br><span class="line">      type: <span class="string">"endTag"</span>,</span><br><span class="line">      tagName: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tagName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span>(char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tagName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char.match(<span class="regexp">/^[a-zA-Z]$/</span>)) &#123;</span><br><span class="line">    currentToken.tagName += char.toLowerCase()</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tagName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span> || char == <span class="string">"/"</span> || char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> afterAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute = &#123;</span><br><span class="line">      name: <span class="string">""</span>,</span><br><span class="line">      value: <span class="string">""</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> attributeName(char)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">afterAttributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">attributeName</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>) || char == <span class="string">"/"</span> || char == <span class="string">"&gt;"</span> || char == EOF) &#123; </span><br><span class="line">    <span class="keyword">return</span> afterAttributeName(char)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"="</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span> || char == <span class="string">"\'"</span> || char == <span class="string">"&lt;"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> attributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.name += char</span><br><span class="line">    <span class="keyword">return</span> attributeName</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beforeAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>) || char == <span class="string">"/"</span> || char == <span class="string">"&gt;"</span> || char == EOF) &#123; </span><br><span class="line">    <span class="keyword">return</span> beforeAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> doubleQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\'"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> singleQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> UnquotedAttributeValue(char)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doubleQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"\""</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="keyword">return</span> afterQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> doubleQuotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">singleQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"\'"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="keyword">return</span> afterQuotedAttributeValue</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> singleQuotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">afterQuotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char ==<span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">UnquotedAttributeValue</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char.match(<span class="regexp">/^[\t\n\f ]$/</span>)) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="comment">// emit(currentToken)</span></span><br><span class="line">    <span class="keyword">return</span> beforeAttributeName</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    <span class="comment">// emit(currentToken)</span></span><br><span class="line">    <span class="keyword">return</span> selfClosingStartTag</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"&gt;"</span>) &#123;</span><br><span class="line">    currentToken[currentAttribute.name] = currentAttribute.value</span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\u0000"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"\""</span> || char == <span class="string">"\'"</span> || char == <span class="string">"&lt;"</span> || char == <span class="string">"="</span> || char == <span class="string">"`"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == EOF) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    currentAttribute.value += char</span><br><span class="line">    <span class="keyword">return</span> UnquotedAttributeValue</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selfClosingStartTag</span>(<span class="params">char</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (char == <span class="string">"&gt;"</span> || char == <span class="string">"/"</span>) &#123;</span><br><span class="line">    currentToken.isSelfClosing = <span class="literal">true</span></span><br><span class="line">    emit(currentToken)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (char == <span class="string">"EOF"</span>) &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// return data</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.parseHTML = <span class="function"><span class="keyword">function</span> <span class="title">parseHTML</span>(<span class="params">html</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> state = data</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> char <span class="keyword">of</span> html) &#123;</span><br><span class="line">    state = state(char)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  state = state(EOF)</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/1d00a3a9aa02bd2ff5eb52805c38768b345257.png" alt="第六步运行结果 vscode debugger"></li>
</ul>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://html.spec.whatwg.org/multipage/" target="_blank" rel="noopener">HTML standard docs</a></li>
<li><a href="https://code.visualstudio.com/docs/editor/debugging" target="_blank" rel="noopener">VSCODE debugger</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li><a href="https://github.com/Ele-Peng/toy-browser" target="_blank" rel="noopener">完整代码地址-点击一下</a></li>
<li>学而不思则罔 互勉</li>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>浏览器</category>
      </categories>
      <tags>
        <tag>浏览器</tag>
      </tags>
  </entry>
  <entry>
    <title>【未完】Javascript-运行机制（一）</title>
    <url>/2020/04/30/Javascript-%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><ul>
<li>五一假期，来写一写 Promise 的题吧，嘿嘿嘿 😃</li>
<li>五一倒计时 3 天</li>
</ul>
<a id="more"></a>

<h2 id="实践准备"><a href="#实践准备" class="headerlink" title="实践准备"></a>实践准备</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line">#import &lt;JavaScriptCore&#x2F;JavaScriptCore.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argx, const char * argv[]) &#123;</span><br><span class="line">  @autoreleasepool &#123;</span><br><span class="line">    &#x2F;&#x2F; var context &#x3D; new JSContext</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; define a javascript context</span><br><span class="line">    JSContext* context &#x3D; [[JSContext alloc] init];</span><br><span class="line">    &#x2F;&#x2F; like:var result &#x3D; null;</span><br><span class="line">    JSValue* result;</span><br><span class="line">    </span><br><span class="line">    while(true) &#123;</span><br><span class="line">      char sourcecode[1024];</span><br><span class="line">      </span><br><span class="line">      scanf(&#39;%s&#39;, &amp;sourcecode);</span><br><span class="line">      NSString* code &#x3D; [NSString stringWithUTF8String: sourcecode];</span><br><span class="line">      </span><br><span class="line">      result &#x3D; [context evaluateScript:code];</span><br><span class="line">      </span><br><span class="line">      NSLog(@&quot;%@&quot;, [result toString]);</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>如上实现一个简单的事件循环，用来输出 console</li>
<li><img src="http://p1.meituan.net/myvideodistribute/a99619da1cded49f443ded2fc219b27432778.png" alt="OC 方法"></li>
<li>我们在 Javascript 中讲的微任务队列、宏任务队列，是 Javascript 调用方去使用 Javascript 的一种方式，如果仅是执行一段代码，是不需要事件循环的。通过这段代码，是可以看出来，Javascript 的事件循环，是在 JSContext 之外，事件循环相关知识，既不是 Javascript 引擎的一部分，也不是 Javascript 语言的一部分。</li>
<li>code 的传入方式<ul>
<li>&lt;script&gt;&lt;/script&gt; 普通代码片段</li>
<li>&lt;script type=”module”&gt;&lt;/script&gt;</li>
<li>函数</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line">#import &lt;JavaScriptCore&#x2F;JavaScriptCore.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argx, const char * argv[]) &#123;</span><br><span class="line">  @autoreleasepool &#123;</span><br><span class="line">    &#x2F;&#x2F; var context &#x3D; new JSContext</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; define a javascript context</span><br><span class="line">    JSContext* context &#x3D; [[JSContext alloc] init];</span><br><span class="line">    &#x2F;&#x2F; like:var result &#x3D; null;</span><br><span class="line">    JSValue* result;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; TODO: calculate the square of arg x</span><br><span class="line">    NSString* code &#x3D; @&quot;(function(x)&#123; return x * x; &#125;)&quot;;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; like: result &#x3D; (function(x)&#123; return x * x; &#125;)</span><br><span class="line">    result &#x3D; [context evaluateScript:code];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; passing the number 4 into the function</span><br><span class="line">    JSValue* arg1 &#x3D; [JSValue valueWithInt32:4 inContext:context];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; execute the function with arg of 4</span><br><span class="line">    NSLog(@&quot;%@&quot;, [[result callWithArguments:@[arg1]] toString]);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>上面的 Object-C 代码，可以看出来，我们是将一段一段的代码，传入 evaluateScript 中执行。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line">#import &lt;JavaScriptCore&#x2F;JavaScriptCore.h&gt;</span><br><span class="line"></span><br><span class="line">int main(int argx, const char * argv[]) &#123;</span><br><span class="line">  @autoreleasepool &#123;</span><br><span class="line">    &#x2F;&#x2F; var context &#x3D; new JSContext</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; define a javascript context</span><br><span class="line">    JSContext* context &#x3D; [[JSContext alloc] init];</span><br><span class="line">    &#x2F;&#x2F; like:var result &#x3D; null;</span><br><span class="line">    JSValue* result;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; TODO: calculate the square of arg x</span><br><span class="line">    NSString* code &#x3D; @&quot;new Promise(resolve &#x3D;&gt; resolve()).then(() &#x3D;&gt; this.a &#x3D; 3), function()&#123;return this.a&#125;;&quot;;</span><br><span class="line">        </span><br><span class="line">    result &#x3D; [context evaluateScript:code];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; like: result();</span><br><span class="line">    NSLog(@&quot;%@&quot;, [[result callWithArguments:@[]] toString]);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  return 0;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>evaluateScript 实际上执行两步：</p>
<ol>
<li><p>执行整个方法</p>
<blockquote>
<p>new Promise(resolve =&gt; resolve()).then(() =&gt; this.a = 3), function(){return this.a};</p>
</blockquote>
<ul>
<li>逗号表达式，永远返回后面的值，如果被调用，前面的会被执行</li>
</ul>
</li>
<li><p>执行 Promise 中 then 后面的语句</p>
</li>
</ol>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/81d945c99778450fd86a710f20355cbc269796.png" alt="evaluateScript"></li>
<li>有 then ,可能产生一个宏任务里面有多个微任务的情况， 一切JS 代码都是微任务中执行的</li>
<li>拿浏览器举例：setTimeout、setInterval 这种其实不是 JS 语法本身的 API，是 JS 的宿主浏览器提供的 API， 所以是宏任务。</li>
<li>而 Promise 是 JS 本身自带的 API，这种就是微任务。</li>
</ul>
</li>
<li><p>总结：<strong>宿主提供的方法是宏任务，JS 自带的是微任务</strong></p>
</li>
<li><p><strong>任务列表列里面有很多宏任务，然后每个宏任务里面有一个微任务列表，每个宏任务执行下一个宏任务之前会把自己内部的微任务执行完</strong></p>
</li>
<li><p><strong>宏任务</strong>包括：script 、setTimeout、setInterval 、setImmediate 、I/O 、UI rendering。</p>
</li>
<li><p><strong>微任务</strong>包括：MutationObserver、Promise.then()或catch()、Promise为基础开发的其它技术，比如fetch API、V8的垃圾回收过程、Node独有的process.nextTick。</p>
</li>
</ul>
<h1 id="Javascript-结构化程序设计基础设施"><a href="#Javascript-结构化程序设计基础设施" class="headerlink" title="Javascript 结构化程序设计基础设施"></a>Javascript 结构化程序设计基础设施</h1><ul>
<li></li>
</ul>
<h2 id="实践记录"><a href="#实践记录" class="headerlink" title="实践记录"></a>实践记录</h2><h3 id="基础题"><a href="#基础题" class="headerlink" title="基础题"></a>基础题</h3><p>1.1 题目一</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'1'</span>, promise1);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析：</p>
<ul>
<li><p>从上至下，先执行 new Promise，执行该构造函数中 console.log(‘promise1’)</p>
<blockquote>
<p>console.log(‘1’, promise1);</p>
</blockquote>
</li>
<li><p>再执行同步代码</p>
</li>
<li><p>执行完后， promise1 中并没有 resolved, rejected， 一直处在 pending 的状态</p>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/f45e1dbe45d84e46ab2fd24703cad0c521137.png" alt="题目一执行"></li>
</ul>
</li>
</ul>
<p>1.2 题目二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  resolve(<span class="string">'success'</span>)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promise.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上至下，先执行 new Promise，执行该构造函数中<ul>
<li>console.log(1);</li>
<li>resolve(‘success’) 将 promise 中的状态更改为 resolved，并保存下来</li>
<li>console.log(2);</li>
</ul>
</li>
<li>promise.then 入队微任务队列</li>
<li>再执行当前宏任务中的同步代码<ul>
<li>console.log(4);</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列，且 promise 为resolved，执行 promise.then<ul>
<li>console.log(3);</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/c31fd6e9ba9c9f9ac4062d6b395706f230745.png" alt="题目二执行"></li>
</ul>
</li>
</ul>
<p>1.3 题目三</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promise.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上至下，先执行 new Promise，执行该构造函数中<ul>
<li>console.log(1);</li>
<li>console.log(2);</li>
<li>该 promise 没有 resolved, rejected, 一直处在 pending</li>
</ul>
</li>
<li>promise.then 入队微任务队列</li>
<li>再执行当前宏任务中的同步代码<ul>
<li>console.log(4);</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列，但 promise 为pending，不可能执行 promise.then 中方法</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/b6e827ca293c65c261a83a81f1f5411227105.png" alt="题目三执行"></li>
</ul>
</li>
</ul>
<p>1.4 题目四</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise1'</span>)</span><br><span class="line">  resolve(<span class="string">'resolve1'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> promise2 = promise1.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'1'</span>, promise1);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'2'</span>, promise2);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上至下，先执行 new Promise，执行该构造函数中<ul>
<li>console.log(‘promise1’)</li>
<li>resolve(‘resolve1’) 将 promise 中的状态更改为 resolved，并保存下来</li>
</ul>
</li>
<li>promise1.then 入队微任务队列</li>
<li>promise2 是一个新状态为 pending 的 Promise</li>
<li>执行同步代码<ul>
<li>console.log(‘1’, promise1);<ul>
<li>promise1 中状态在上面已经更改为 resolved</li>
</ul>
</li>
<li>console.log(‘2’, promise2);<ul>
<li>promise2 中状态为pending</li>
</ul>
</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 promise1.then <ul>
<li>console.log(res) <ul>
<li>其中 promise1.then， promise1 的状态为 resolved</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/f31e7f8db309521b5252143252eaed2551272.png" alt="题目四运行结果"></li>
</ul>
</li>
</ul>
<p>1.5 题目五</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> <span class="function">(<span class="params"><span class="keyword">new</span> <span class="built_in">Promise</span>((resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  resolve(<span class="string">'success'</span>)</span><br><span class="line">&#125;))</span><br><span class="line">fn().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上至下，const fn = () =&gt; (Promise Object) 返回一个 promise 对象</li>
<li>fn()，执行 fn 方法<ul>
<li>console.log(1);</li>
<li>resolve(‘success’) 将 promise 中的状态更改为 resolved，并保存下来</li>
</ul>
</li>
<li>Function.then 入队微任务队列</li>
<li>执行同步代码<ul>
<li>console.log(‘start’)</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 Function.then<ul>
<li>console.log(res) 其中 promise 的状态为 resolved</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/955895672615c24a4eb671617d8b739829033.png" alt="题目五运行结果"></li>
</ul>
</li>
</ul>
<p>1.6 题目六</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> fn = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">  <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">    resolve(<span class="string">"success"</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"start"</span>);</span><br><span class="line">fn().then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上至下，const fn = () =&gt; (Promise Object) 返回一个 promise 对象</li>
<li>执行同步代码<ul>
<li>console.log(“start”);</li>
</ul>
</li>
<li>fn(), 执行 fn 方法<ul>
<li>console.log(1);</li>
<li>resolve(“success”); 将 promise 中的状态更改为 resolved，并保存下来</li>
</ul>
</li>
<li>Function.then 入队微任务队列</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 Function.then<ul>
<li>console.log(res); 其中 promise 的状态为 resolved</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/ccd1a9148be91f5aa24847a0d4e23dfb31837.png" alt="题目六运行结果"></li>
</ul>
</li>
</ul>
<h3 id="Promise-结合-setTimeout"><a href="#Promise-结合-setTimeout" class="headerlink" title="Promise 结合 setTimeout"></a>Promise 结合 setTimeout</h3><p>2.1 题目一</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'time'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'resolve'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'end'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上至下，先执行同步代码<ul>
<li>console.log(‘start’)</li>
</ul>
</li>
<li>setTimeout … 入队宏任务队列</li>
<li>Promise.resolve().then … 入队微任务队列</li>
<li>执行同步代码<ul>
<li>console.log(‘end’)</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 Promise.resolve().then<ul>
<li>console.log(‘resolve’)</li>
</ul>
</li>
<li>第一个宏任务执行完了，开始执行下一个宏任务 setTimeout …<ul>
<li>console.log(‘time’)</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/4a9c74ab2a26cc16e55ce53f6fb765d630133.png" alt="题目一运行结果"></li>
</ul>
</li>
</ul>
<p>2.2 题目二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"timerStart"</span>);</span><br><span class="line">    resolve(<span class="string">"success"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"timerEnd"</span>);</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promise.then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上至下，先执行 new Promise，执行该构造函数中<ul>
<li>console.log(1);</li>
<li>setTimeout … 入队宏任务队列</li>
<li>console.log(2);</li>
</ul>
</li>
<li>promise.then … 入队微任务队列</li>
<li>执行同步代码<ul>
<li>console.log(4);</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 其中 promise 中，并没有 resolved、rejected，一直在 pending，不可能执行 promise.then 中方法</li>
<li>第一个宏任务执行完了，开始执行下一个宏任务 setTimeout …</li>
<li>第二个宏任务 setTimeout 代码从上至下执行</li>
<li>执行同步代码<ul>
<li>console.log(“timerStart”);</li>
<li>resolve(“success”); 将 promise 中的状态更改为 resolved，并保存下来</li>
<li>console.log(“timerEnd”);</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/66ea5bbd68d0841ad58cac5ca771625347414.png" alt="题目二运行结果"></li>
</ul>
</li>
</ul>
<p>2.3 题目三</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer1'</span>);</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer3'</span>)</span><br><span class="line">  &#125;, <span class="number">0</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer2'</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>从上执行</li>
<li>setTimeout … 加入宏任务队列</li>
<li>setTimeout … 加入宏任务队列</li>
<li>执行同步代码<ul>
<li>console.log(‘start’)</li>
</ul>
</li>
<li>第一个宏任务执行完了，开始执行下一个宏任务 setTimeout …</li>
<li>执行同步代码 <ul>
<li>console.log(‘timer1’);</li>
</ul>
</li>
<li>setTimeout … 加入宏任务队列</li>
<li>第二个宏任务执行完了，开始执行下一个宏任务</li>
<li>执行同步代码<ul>
<li>console.log(‘timer2’)</li>
</ul>
</li>
<li>第三个宏任务执行完了，开始执行下一个宏任务</li>
<li>执行同步代码<ul>
<li>console.log(‘timer3’)</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/b5ab6578c5ba7d8d727a3bf47ba8879033812.png" alt="题目三运行结果"></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer1'</span>);</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer2'</span>)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>setTimeout … 加入宏任务队列</li>
<li>setTimeout … 加入宏任务队列</li>
<li>执行同步代码<ul>
<li>console.log(‘start’)</li>
</ul>
</li>
<li>第一个宏任务执行完了，开始执行下一个宏任务 setTimeout …</li>
<li>执行同步代码<ul>
<li>console.log(‘timer1’);</li>
<li>Promise.resolve().then … 入队微任务队列</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列<ul>
<li>console.log(‘promise’)</li>
</ul>
</li>
</ul>
</li>
<li>第二个宏任务执行完了，开始执行下一个宏任务 setTimeout …</li>
<li>执行同步代码<ul>
<li>console.log(‘timer2’)</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/f65f2aa65848d2e8aaf5c3918509c6e934427.png" alt="题目三运行结果"></li>
</ul>
</li>
</ul>
<p>2.4 题目四</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise1'</span>);</span><br><span class="line">  <span class="keyword">const</span> timer2 = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer2'</span>)</span><br><span class="line">  &#125;, <span class="number">0</span>)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> timer1 = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'timer1'</span>)</span><br><span class="line">  <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'promise2'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'start'</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>Promise.resolve().then … 入队微任务队列</li>
<li>setTimeout … 入队宏任务队列</li>
<li>执行同步代码</li>
<li>console.log(‘start’);</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列</li>
<li>执行同步代码</li>
<li>console.log(‘promise1’);</li>
<li>setTimeout … 入队宏任务队列</li>
<li>第一个宏任务执行完了，开始执行下一个宏任务 setTimeout …</li>
<li>console.log(‘timer2’)</li>
<li>第二个宏任务执行完了，开始执行下一个宏任务</li>
<li>执行同步代码</li>
<li>console.log(‘timer1’)</li>
<li>Promise.resolve().then … 入队微任务队列</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列</li>
<li>console.log(‘promise2’)</li>
<li>第二个宏任务执行完了，开始执行下一个宏任务</li>
<li>console.log(‘timer2’)</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/60a22379f31bb12de055ed83a31aca0b46969.png" alt="题目四运行结果"></li>
</ul>
</li>
</ul>
<p>2.5 题目五 ** 存在和之前一样的，promise resolved 后，状态上抛至上一个 宏任务队列的问题</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">'success'</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> promise2 = promise1.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error!!!'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'promise1'</span>, promise1)</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'promise2'</span>, promise2)</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise1'</span>, promise1)</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'promise2'</span>, promise2)</span><br><span class="line">&#125;, <span class="number">2000</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>先执行 new Promise，执行该构造函数中</li>
<li>setTimout … 入队宏任务队列</li>
<li>promise1.then … 入队微任务队列</li>
<li>执行同步代码<ul>
<li>console.log(‘promise1’, promise1)<ul>
<li>其中 promise1 没有 resolved、rejected,一直处在 pending 状态</li>
<li>promise1 Promise {&lt;pending&gt;}</li>
</ul>
</li>
<li>console.log(‘promise2’, promise2)<ul>
<li>其中 promise1 一直处在 pending 状态，直接影响到 promise2 也一直处在 pending 状态</li>
<li>promise2 Promise {&lt;pending&gt;}</li>
</ul>
</li>
</ul>
</li>
<li>setTimeout … 入队宏任务队列</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 promise1.then …<ul>
<li>由于 promise1 仍处于 pending 状态，不可能执行 promise1.then …</li>
</ul>
</li>
<li>第一个宏任务执行完了，开始执行下一个宏任务</li>
<li>resolve(‘success’) 将 promise1 中的状态更改为 resolved，并保存下来</li>
<li>第二个宏任务执行完了，开始执行下一个宏任务</li>
<li>执行同步代码<ul>
<li>console.log(‘promise1’, promise1)<ul>
<li>其中 promise1 处在 resolved 状态</li>
<li>promise1 Promise {&lt;resolved&gt;: “success”}</li>
</ul>
</li>
<li>console.log(‘promise2’, promise2)<ul>
<li>promise2 Promise {&lt;rejected&gt;: Error: error!!! at &lt;anonymous&gt;:8:9}</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/3ad654d66c66c648a058adf29154d879107368.png" alt="题目五运行结果"></li>
</ul>
</li>
</ul>
<p>2.6 题目六</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise1 = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    resolve(<span class="string">"success"</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"timer1"</span>);</span><br><span class="line">  &#125;, <span class="number">1000</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"promise1里的内容"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> promise2 = promise1.then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"error!!!"</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"promise1"</span>, promise1);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"promise2"</span>, promise2);</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"timer2"</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"promise1"</span>, promise1);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"promise2"</span>, promise2);</span><br><span class="line">&#125;, <span class="number">2000</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行，先执行 new Promise，执行该构造函数</li>
<li>setTimeout 入队宏任务队列</li>
<li>执行同步代码<ul>
<li>console.log(“promise1里的内容”);</li>
</ul>
</li>
<li>promise1.then … 入队微任务队列</li>
<li>执行同步代码<ul>
<li>console.log(“promise1”, promise1);<ul>
<li>其中 promise1 没有 resolved、rejected 掉，一直处在 pending 状态<ul>
<li>promise1 Promise {&lt;pending&gt;}</li>
</ul>
</li>
</ul>
</li>
<li>console.log(“promise2”, promise2);<ul>
<li>primise1 的 pending 状态，直接影响 promise2 也处在 pending 状态<ul>
<li>promise2 Promise {&lt;pending&gt;}</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>setTimeout … 入队宏任务队列</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 promise1.then …<ul>
<li>由于 promise1 仍处于 pending 状态，不可能执行 promise1.then …</li>
</ul>
</li>
<li>第一个宏任务执行完了，开始执行第二个宏任务</li>
<li>resolve(“success”); 将 promise1 中的状态更改为 resolved，并保存下来</li>
<li>执行同步代码<ul>
<li>console.log(“timer1”);</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 promise1.then …<ul>
<li>throw new Error(“error!!!”);</li>
</ul>
</li>
<li>第二个宏任务执行完了，开始执行下一个宏任务<ul>
<li>执行同步代码<ul>
<li>console.log(“timer2”);</li>
<li>console.log(“promise1”, promise1);<ul>
<li>其中 promise1 的状态已经 resloved</li>
<li>promise1 Promise {&lt;resolved&gt;: “success”}</li>
</ul>
</li>
<li>console.log(“promise2”, promise2);<ul>
<li>promise2 Promise {&lt;rejected&gt;: Error: error!!! at &lt;anonymous&gt;:8:9}</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/88a197ec5863fcca93b072d3baecf6a0113849.png" alt="题目六运行结果"></li>
</ul>
</li>
</ul>
<h3 id="Promise-中的-then、catch、finally"><a href="#Promise-中的-then、catch、finally" class="headerlink" title="Promise 中的 then、catch、finally"></a>Promise 中的 then、catch、finally</h3><p>3.1 题目一</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  resolve(<span class="string">"success1"</span>);</span><br><span class="line">  reject(<span class="string">"error"</span>);</span><br><span class="line">  resolve(<span class="string">"success2"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promise</span><br><span class="line">.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"then: "</span>, res);</span><br><span class="line">  &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"catch: "</span>, err);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行，先执行 new Promise，执行该构造函数<ul>
<li>resolve(“success1”); 将 promise 中的状态更改为 resolved，并保存下来</li>
</ul>
</li>
<li>promise.then … 入队微任务队列</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 promise.then …<ul>
<li>console then:  success1</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/448d9fb1db29ba7e76762f97a9508d1e35386.png" alt="题目一运行结果"></li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><strong>Promise的状态一经改变就不能再改变</strong></li>
<li><strong>构造函数中的 resolve 或 reject 只有第一次执行有效，多次调用没有任何作用</strong>。</li>
</ul>
</li>
</ul>
<p>3.2 题目二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  reject(<span class="string">"error"</span>);</span><br><span class="line">  resolve(<span class="string">"success2"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">promise</span><br><span class="line">.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"then1: "</span>, res);</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"then2: "</span>, res);</span><br><span class="line">  &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"catch: "</span>, err);</span><br><span class="line">  &#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"then3: "</span>, res);</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行，先执行 new Promise，执行该构造函数<ul>
<li>reject(“error”); 将 promise 中的状态更改为 rejected，并保存下来</li>
</ul>
</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 promise.then …</li>
<li>由于 promise 状态为 rejected，因此触发 catch ，不管 catch 连接到哪，都能捕获上层未捕捉过的错误<ul>
<li>console.log(“catch: “, err);</li>
<li>return a new promise</li>
</ul>
</li>
<li>由于 新的 promise 没有返回值，因此返回 undefined</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><strong>catch不管被连接到哪里，都能捕获上层未捕捉过的错误</strong></li>
<li>至于 then3 也会被执行，那是因为*<em>catch()也会返回一个 Promise *</em>，且由于这个 Promise 没有返回值，所以打印出来的是 undefined 。</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/8523408bd03cb268237e720380e1273d47036.png" alt="题目二运行结果"></li>
</ul>
</li>
</ul>
<p>3.3 题目三</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态为 resolved, 因此触发 then<ul>
<li>console.log(res); res –&gt; 1</li>
</ul>
</li>
<li>没有报错，略过 catch</li>
<li>被 then 捕捉<ul>
<li>console.log(2); 返回新的 promise， promise 返回 resolve(2)</li>
</ul>
</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><strong>Promise 可以链式调用</strong>，不过 promise 每次调用 .then 或者 .catch 都会返回一个新的 promise，从而实现了链式调用, 它并不像一般我们任务的链式调用一样 return this。</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/2ca378bb1952c6fbacc3028024b1b89027624.png" alt="题目三运行结果"></li>
</ul>
</li>
</ul>
<p>3.4 题目四</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.reject(<span class="number">1</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">  &#125;)</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态为 rejected，因此触发 catch<ul>
<li>console.log(err); err –&gt; 1</li>
<li>return resolve(3)</li>
</ul>
</li>
<li>被 then 捕捉<ul>
<li>console.log(3) </li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/ed821dfd96ad96250140abdedf581fd930226.png" alt="题目四运行结果"></li>
</ul>
</li>
</ul>
<p>3.5 题目五</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'timer'</span>)</span><br><span class="line">    resolve(<span class="string">'success'</span>)</span><br><span class="line">  &#125;, <span class="number">1000</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> start = <span class="built_in">Date</span>.now();</span><br><span class="line">promise.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res, <span class="built_in">Date</span>.now() - start)</span><br><span class="line">&#125;)</span><br><span class="line">promise.then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(res, <span class="built_in">Date</span>.now() - start)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行，先执行 new Promise，执行该构造函数</li>
<li>setTimeout … 入队宏任务队列</li>
<li>promise.then … 入队微任务队列</li>
<li>promise.then … 入队微任务队列</li>
<li>当前宏任务中的所有同步代码执行完毕，开始执行当前宏任务中的微任务队列 promise.then …</li>
<li>因为 promise 状态并没有 resolved、rejected，一直处在 pending，并不能调用 then 方法</li>
<li>同上</li>
<li>第一个宏任务执行完成，开始执行第二个宏任务 setTimeout …</li>
<li>执行同步代码<ul>
<li>console.log(‘timer’)</li>
<li>promise 状态更改为 resolved，并保存下来<ul>
<li>状态往上抛</li>
<li>console.log(res, Date.now() - start)</li>
<li>console.log(res, Date.now() - start))</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><strong>Promise 的 .then 或者 .catch 可以被调用多次，但这里 Promise 构造函数只执行一次。或者说 promise 内部状态一经改变，并且有了一个值，那么后续每次调用 .then 或者 .catch 都会直接拿到该值。</strong></li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/9ee74ca562f7c913d51c9fd5fe60680543896.png" alt="题目五运行结果"></li>
</ul>
</li>
</ul>
<p>3.6 题目六</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error!!!'</span>)</span><br><span class="line">&#125;).then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"then: "</span>, res)</span><br><span class="line">&#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"catch: "</span>, err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态更改为 resolve，并无返回值</li>
<li>执行 then<ul>
<li>throw new Error(‘error!!!’)</li>
<li>return Promise.reject(new Error(‘error!!!’))</li>
</ul>
</li>
<li>被 catch 捕捉<ul>
<li>console.log(“catch: “, err) err –&gt; error</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/a1cb4e4f5e5ec95e2215d5b7ecc6a32428525.png" alt="题目六运行结果"></li>
</ul>
</li>
</ul>
<p>3.7 题目七</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> promise = <span class="built_in">Promise</span>.resolve().then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;)</span><br><span class="line">promise.catch(<span class="built_in">console</span>.err)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态改变为 resolve ，并无返回值</li>
<li>执行 then<ul>
<li>return Promise.resolve(promise)</li>
<li>Chaining cycle detected for promise</li>
</ul>
</li>
<li>执行同步代码<ul>
<li>promise.catch promise cycle</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/70dbed986bad1d410ad7be3de8fe963d21008.png" alt="题目七运行结果"></li>
</ul>
</li>
</ul>
<p>3.8 题目八</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="number">1</span>)</span><br><span class="line">  .then(<span class="number">2</span>)</span><br><span class="line">  .then(<span class="built_in">Promise</span>.resolve(<span class="number">3</span>))</span><br><span class="line">  .then(<span class="built_in">console</span>.log)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态改变为 resolve， return Promise.resolve(1)</li>
<li>.then 或者 .catch 的参数期望是函数，传入非函数则会发生值透传</li>
<li>第一个then和第二个then中传入的都不是函数，一个是数字类型，一个是对象类型，因此发生了透传，将resolve(1) 的值直接传到最后一个then里</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><strong>.then 或者 .catch 的参数期望是函数，传入非函数则会发生值透传</strong></li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/68c56ed26f2845300ecba0dc6dc7a3e914382.png" alt="题目八运行结果"></li>
</ul>
</li>
</ul>
<p>3.9 题目九</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.reject(<span class="string">'err!!!'</span>)</span><br><span class="line">  .then(<span class="function">(<span class="params">res</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'success'</span>, res)</span><br><span class="line">  &#125;, (err) =&gt; &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'error'</span>, err)</span><br><span class="line">  &#125;).catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'catch'</span>, err)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>我们可以先来看看，如果 catch 住了错误，err 会一直链式传递下去被 catch嘛</p>
</li>
<li><p><img src="http://p1.meituan.net/myvideodistribute/f9859062c1341e2e575f952e320aba4222620.png" alt="是否会被一直catch"></p>
<ul>
<li>一旦 catch 住当前报错，当前报错并不会再往下传递</li>
</ul>
</li>
<li><p><img src="http://p1.meituan.net/myvideodistribute/9846287852a98f322045973bf302c58f24992.png" alt="逐行调用catch是会一直传递下去的"></p>
<ul>
<li>逐行调用 then 是会一直传递下去的</li>
</ul>
</li>
<li><p>那我还可以看看，如果没有错误，res 会一直链式传递 then 执行嘛</p>
</li>
<li><p><img src="http://p1.meituan.net/myvideodistribute/e2e72158c05ceee7da7528ff9a20348426425.png" alt="是否会被一直then"></p>
<ul>
<li>可以看出 then 是会一直往下传递的</li>
</ul>
</li>
<li><p><img src="http://p0.meituan.net/myvideodistribute/abb8ccf3daffdd023ce079c86cafdfd626377.png" alt="逐行调用then 是会一直传递下去的"></p>
<ul>
<li>逐行调用 then 是会一直传递下去的</li>
</ul>
</li>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态改变为 rejected，return ‘err!!!’</li>
<li>执行 then，then 中第二个函数，相当于 catch</li>
<li>因此执行</li>
<li>console.log(‘error’, err) err –&gt; err!!!</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/05e3b86caaf2b9cbf0c6326020e3385327546.png" alt="题目九运行结果"></li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve()</span><br><span class="line">  .then(<span class="function"><span class="keyword">function</span> <span class="title">success</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'error!!!'</span>)</span><br><span class="line">  &#125;, <span class="function"><span class="keyword">function</span> <span class="title">fail1</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fail1'</span>, err)</span><br><span class="line">  &#125;).catch(<span class="function"><span class="keyword">function</span> <span class="title">fail2</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'fail2'</span>, err)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态变为 resolve，</li>
<li>执行 then<ul>
<li>throw new Error(‘error!!!’)</li>
</ul>
</li>
<li>被 catch <ul>
<li>console.log(‘fail2’, err) err –&gt; error!!!</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/c8643d8fb0fd251145befd28d635ed7e33265.png" alt="运行结果"></li>
</ul>
</li>
</ul>
<p>3.10 题目十</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'1'</span>)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(res)</span><br><span class="line">  &#125;)</span><br><span class="line">  .finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finally'</span>)</span><br><span class="line">  &#125;)</span><br><span class="line"><span class="built_in">Promise</span>.resolve(<span class="string">'2'</span>)</span><br><span class="line">  .finally(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finally2'</span>)</span><br><span class="line">  	<span class="keyword">return</span> <span class="string">'我是finally2返回的值'</span></span><br><span class="line">  &#125;)</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'finally2后面的then函数'</span>, res)</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>promise 状态变为 resolve，return 1</li>
<li>执行 then<ul>
<li>console.log(res) res –&gt; return new Promise， resolve(1) 加入微任务队列</li>
</ul>
</li>
<li>promise 状态变为 resolve, return 2<ul>
<li>执行 finally<ul>
<li>console.log(‘finally2’)</li>
<li>return new Promise， resolve(‘我是finally2返回的值’) 加入微任务队列</li>
</ul>
</li>
</ul>
</li>
<li>当前同步代码执行完成，开始还行微任务队列<ul>
<li>console.log(‘finally’)</li>
<li>console.log(‘finally2后面的then函数’, res) res –&gt; 2</li>
</ul>
</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li>.finally()方法不管Promise对象最后的状态如何都会执行</li>
<li>.finally()方法的回调函数不接受任何的参数，也就是说你在.finally()函数中是没法知道Promise最终的状态是resolved还是rejected的</li>
<li>它最终返回的默认会是一个<strong>上一次的Promise对象值</strong>，不过如果抛出的是一个异常则返回异常的Promise对象。</li>
<li><strong>promise 每次调用 .then 或者 .catch 都会返回一个新的 promise，从而实现了链式调用</strong> </li>
</ul>
</li>
</ul>
<ul>
<li>运行结果<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/99d8936b8c5029a6786b464868666f7d47917.png" alt="题目十运行结果"></li>
</ul>
</li>
</ul>
<h3 id="Promise-中的-all-和-race"><a href="#Promise-中的-all-和-race" class="headerlink" title="Promise 中的 all 和 race"></a>Promise 中的 all 和 race</h3><ul>
<li>Promise.all(iterable) 方法返回一个 Promise 实例，此实例在 iterable 参数内所有的 promise 都“完成（resolved）”或参数中不包含 promise 时回调完成（resolve）；如果参数中  promise 有一个失败（rejected），此实例回调失败（reject），失败的原因是第一个失败 promise 的结果。</li>
<li>Promise.race(iterable) 方法返回一个 promise，一旦迭代器中的某个promise解决或拒绝，返回的 promise就会解决或拒绝。</li>
</ul>
<p>4.1 题目一</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runAsync</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> r(x, <span class="built_in">console</span>.log(x)), <span class="number">1000</span>))</span><br><span class="line">    <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Promise</span>.all([runAsync(<span class="number">1</span>), runAsync(<span class="number">2</span>), runAsync(<span class="number">3</span>)])</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>Promise.all 入队微任务队列</li>
<li>当前同步代码执行完成，开始执行微任务队列<ul>
<li>间隔一秒后，控制台会同时打印出1, 2, 3，还有一个数组[1, 2, 3]</li>
</ul>
</li>
</ul>
</li>
<li><p>结论</p>
<ul>
<li><strong>有了all，就可以并行执行多个异步操作，并且在一个回调中处理所有的返回数据</strong></li>
<li>.all()后面的.then()里的回调函数接收的就是所有异步操作的结果。</li>
<li>而且这个结果中数组的顺序和Promise.all()接收到的数组顺序一致</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/d3a6d5f4f158de806b690af124fcec9431029.png" alt="题目一运行结果"></li>
</ul>
</li>
</ul>
<p>4.2 题目二</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runAsync</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> r(x, <span class="built_in">console</span>.log(x)), <span class="number">1000</span>))</span><br><span class="line">  <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runReject</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> rej(<span class="string">`Error: <span class="subst">$&#123;x&#125;</span>`</span>, <span class="built_in">console</span>.log(x)), <span class="number">1000</span> * x))</span><br><span class="line">  <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Promise</span>.all([runAsync(<span class="number">1</span>), runReject(<span class="number">4</span>), runAsync(<span class="number">3</span>), runReject(<span class="number">2</span>)])</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res))</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>Promise.all 入队微任务队列</li>
<li>当前同步代码执行完成，开始执行微任务队列<ul>
<li>间隔一秒后，控制台会同时打印出 1, 3</li>
</ul>
</li>
<li>由于 runReject(4) 比 runReject(2) 晚入微任务队列，且 catch 只执行一次<ul>
<li>再间隔一秒后<ul>
<li>console.log(x) x –&gt; 2</li>
<li>console.log(‘Error: 2’)</li>
</ul>
</li>
<li>再间隔2秒后<ul>
<li>console.log(x) x –&gt; 4</li>
<li>不会再执行 catch</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/e0e25426dc0d49c3af9acee68744760d51135.png" alt="题目二运行结果"></li>
</ul>
</li>
<li><p>等同于</p>
  <figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runAsync</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> r(x, <span class="built_in">console</span>.log(x)), <span class="number">1000</span>))</span><br><span class="line">  <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runReject</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> rej(<span class="string">`Error: <span class="subst">$&#123;x&#125;</span>`</span>, <span class="built_in">console</span>.log(x)), <span class="number">1000</span> * x))</span><br><span class="line">  <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Promise</span>.all([runAsync(<span class="number">1</span>), runReject(<span class="number">4</span>), runAsync(<span class="number">3</span>), runReject(<span class="number">2</span>)])</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(res), </span><br><span class="line">  err =&gt; <span class="built_in">console</span>.log(err);</span><br></pre></td></tr></table></figure></li>
<li><p>结论</p>
<ul>
<li>all 和 race传入的数组中如果有会抛出异常的异步任务，那么只有最先抛出的错误会被捕获，并且是被 then 的第二个参数或者后面的 catch 捕获；但并不会影响数组中其它的异步任务的执行。</li>
</ul>
</li>
</ul>
<p>4.3 题目三</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runAsync</span> (<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span> setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> r(x, <span class="built_in">console</span>.log(x)), <span class="number">1000</span>))</span><br><span class="line">  <span class="keyword">return</span> p</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Promise</span>.race([runAsync(<span class="number">1</span>), runAsync(<span class="number">2</span>), runAsync(<span class="number">3</span>)])</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'result: '</span>, res))</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err))</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>Promise.race 入队微任务队列</li>
<li>当前宏任务中同步任务执行完成，开始执行微任务</li>
<li>在间隔时间都一样的情况下，runAsync1 最先加入队列</li>
<li>因此<ul>
<li>console.log(x) x –&gt; 1</li>
</ul>
</li>
<li>由于 race 的特殊性，只捕捉最先执行完成的那个结果<ul>
<li>console.log(‘result: ‘, res) res –&gt; 1</li>
</ul>
</li>
<li>再<ul>
<li>console.log(x) x –&gt; 2</li>
<li>console.log(x) x –&gt; 3</li>
</ul>
</li>
<li>没有报错，不会被 catch</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p0.meituan.net/myvideodistribute/2eda438cd745e39ba934af362a80521038770.png" alt="题目三运行结果"></li>
</ul>
</li>
</ul>
<p>4.4 题目四</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runAsync</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">r</span> =&gt;</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> r(x, <span class="built_in">console</span>.log(x)), <span class="number">1000</span>)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runReject</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> p = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">res, rej</span>) =&gt;</span></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> rej(<span class="string">`Error: <span class="subst">$&#123;x&#125;</span>`</span>, <span class="built_in">console</span>.log(x)), <span class="number">1000</span> * x)</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Promise</span>.race([runReject(<span class="number">0</span>), runAsync(<span class="number">1</span>), runAsync(<span class="number">2</span>), runAsync(<span class="number">3</span>)])</span><br><span class="line">  .then(<span class="function"><span class="params">res</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"result: "</span>, res))</span><br><span class="line">  .catch(<span class="function"><span class="params">err</span> =&gt;</span> <span class="built_in">console</span>.log(err));</span><br></pre></td></tr></table></figure>

<ul>
<li><p>分析</p>
<ul>
<li>代码从上至下开始执行</li>
<li>Promise.race 入队微任务队列</li>
<li>当前宏任务中同步任务执行完成，开始执行微任务</li>
<li>runReject(0) 最先传入</li>
<li>因此<ul>
<li>console.log(x) x –&gt; 0</li>
<li>console.log(err) err –&gt; Error: 0</li>
</ul>
</li>
<li>间隔小于1秒后</li>
<li>runAsync(1), runAsync(2), runAsync(3)<ul>
<li>依次为</li>
<li>console.log(x) x –&gt; 1</li>
<li>console.log(x) x –&gt; 2</li>
<li>console.log(x) x –&gt; 3</li>
</ul>
</li>
</ul>
</li>
<li><p>运行结果</p>
<ul>
<li><img src="http://p1.meituan.net/myvideodistribute/89acbf32e7218b90c050526171bd1b3d53719.png" alt="题目四"></li>
</ul>
</li>
</ul>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul>
<li><a href="https://juejin.im/post/5e58c618e51d4526ed66b5cf" target="_blank" rel="noopener">题目来源</a></li>
</ul>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><ul>
<li>祝大家多多发财</li>
</ul>
]]></content>
      <categories>
        <category>前端概念</category>
      </categories>
      <tags>
        <tag>前端概念</tag>
      </tags>
  </entry>
</search>
