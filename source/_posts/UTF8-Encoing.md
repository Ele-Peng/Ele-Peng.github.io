---
title: UTF8_Encoing
date: 2020-04-21 21:53:02
tags:
- å‰ç«¯æ¦‚å¿µ
- UTF-8
categories:
- [å‰ç«¯æ¦‚å¿µ]
description:
- è®°å½•ä¸€ä¸‹å°† String å­—ç¬¦ä¸²ï¼Œè½¬æˆå­—èŠ‚æµçš„æ•´ä¸ªå®ç°è¿‡ç¨‹


---



<style  type="text/css">
.lx-entry a {
    color: #191919;
    padding: 2px 0 1px 0;
    text-decoration: none;
    background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
    transition: background-position 120ms ease-in-out, padding 120ms ease-in-out;
    background-size: 100% 200%;
    background-position: 0 0;
    word-break: break-word;
}

.lx-entry a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), rgba(247,65,65,.761) calc(50% - 9px), rgba(247,65,65,.761) 100% );
  background-position: 0 100%;
}

.post-button a:hover {
  background-image: linear-gradient( transparent 0%, transparent calc(50% - 9px), transparent calc(50% - 9px), transparent 100% ) !important;
  background-position: 0 100% !important;
  outline: none !important;
  text-decoration: none !important;
}
</style>

## å†™åœ¨å‰é¢
- å‘¨ä¸€å’Œå°å§å¦¹ Skady å®è´ç»ƒå®Œèˆåï¼Œäº¤æµäº†ä¸€ä¸ªå°æ—¶æŠ€æœ¯ï¼Œæ˜¯çš„ğŸ™†æˆ‘ä»¬æ²¡æœ‰æ‰¯çš®ï¼Œéš¾å¾—äº¤æµæŠ€æœ¯ã€‚ğŸ¤£å¥¹åœ¨ç©â€œåœ¨Cè¯­è¨€ä¸­ç¼–å†™JSä»£ç ï¼Œç„¶åå†ç¼–è¯‘æˆwasmï¼Œå¯ä»¥åœ¨æµè§ˆå™¨é‡Œè·‘â€ï¼Œæˆ‘ä»¬ç®€å•åœ°äº¤æµäº†ä¸€ä¸‹åº•å±‚å®ç°.<span style="color: #bfbfbf">åº”è¯¥æ˜¯åŸºäº ArrayBuffer çš„</span>
- ç„¶åä¸çŸ¥æ€ä¹ˆå°±æƒ³åˆ°äº† 0.1 + 0.2 â‰  0.3ï¼Œè¿™ä¸ªç»å…¸é—®é¢˜
- æƒ³çœ‹çœ‹å®ƒåœ¨å†…å­˜ä¸­çš„è¡¨ç°
- å¹¶è®°å½•ä¸€ä¸‹å°† String å­—ç¬¦ä¸²ï¼Œè½¬æˆå­—èŠ‚æµçš„æ•´ä¸ªå®ç°è¿‡ç¨‹
- å¾€ä¸‹çœ‹å§~ ğŸ¤“

<!-- more -->

## å®è·µè¿‡ç¨‹
#### æ€»ä½“æ€è·¯
- ç»Ÿè®¡å­—ç¬¦ä¸²é•¿åº¦
- å¾ªç¯éå†å­—ç¬¦ä¸²ï¼Œè¿›è¡Œç¼–ç 
- è¾“å‡ºç¼–ç åçš„å­—èŠ‚æµ

```javascript
function UTF8_Encoding(str) {
   let length = str.length,
        strIndex = -1,
        strEnd = length - 1,
        bytes = new Uint8Array(length),
        index = 0;

    while (strIndex++ < strEnd) {
        bytes[index] = str.charCodeAt(strIndex) & 0xFF; // è®¾ç½®ä¸ºä½8ä½å€¼
        index += 1;
    }

    return bytes;
}
```

## å­—èŠ‚æµæ–‡ä»¶è½¬ String
#### æ€»ä½“æ€è·¯
- ç»Ÿè®¡å­—èŠ‚æµé•¿åº¦
- å¾ªç¯éå†å­—èŠ‚æµï¼Œè¿›è¡Œè§£ç 
- è¾“å‡ºè§£ç åçš„å­—èŠ‚æµ

```javascript
function UTF8_Decoding(bytes) {
    let str = "",
        bytesIndex = -1,
        bytesEnd = bytes.length - 1;

    while (bytesIndex ++ < bytesEnd) {
        str += String.fromCharCode(bytes[bytesIndex]);
    }

    return str;
};
```

#### æµ‹è¯•æˆªå›¾
- ![æµ‹è¯•æˆªå›¾](http://p0.meituan.net/myvideodistribute/c1770110908275e40343791324f7dfff154914.png)


## ç±»å‹åŒ–æ•°ç»„
- ç±»å‹åŒ–æ•°ç»„ä¸­çš„å…ƒç´ éƒ½æ˜¯æ•°å­—ã€‚ä½¿ç”¨æ„é€ å‡½æ•°åœ¨åˆ›å»ºç±»å‹åŒ–æ•°ç»„çš„æ—¶å€™å†³å®šäº†æ•°ç»„ä¸­æ•°å­—ï¼ˆæœ‰ç¬¦å·æˆ–è€…æ— ç¬¦å·æ•´æ•°æˆ–è€…æµ®ç‚¹æ•°ï¼‰çš„ç±»å‹å’Œå¤§å°ï¼ˆä»¥ä½ä¸ºå•ä½ï¼‰
- ç±»å‹åŒ–æ•°ç»„æœ‰å›ºå®šçš„é•¿åº¦ã€‚
- åœ¨åˆ›å»ºç±»å‹åŒ–æ•°ç»„çš„æ—¶å€™ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ æ€»æ˜¯é»˜è®¤åˆå§‹åŒ–ä¸º0.
- **ç±»å‹åŒ–æ•°ç»„**
	- **TypedArray** è§†å›¾æ”¯æŒçš„æ•°æ®ç±»å‹ä¸€å…±æœ‰ 9 ç§ï¼ˆ **DataView** è§†å›¾æ”¯æŒé™¤ **Uint8C** ä»¥å¤–çš„å…¶ä»– 8 ç§ï¼‰ã€‚

		| æ•°æ®ç±»å‹ |  å­—èŠ‚é•¿åº¦  |  å«ä¹‰  | å¯¹åº”çš„ C è¯­è¨€ç±»å‹ |
		| --- | --- | --- | --- |
		| Int8 | 1 | 8 ä½å¸¦ç¬¦å·æ•´æ•° | signed char |
		| Uint8 |	1 |	8 ä½ä¸å¸¦ç¬¦å·æ•´æ•° |	unsigned char |
		| Uint8C | 1 | 8 ä½ä¸å¸¦ç¬¦å·æ•´æ•°ï¼ˆè‡ªåŠ¨è¿‡æ»¤æº¢å‡ºï¼‰|unsigned char |
		| Int16 |	2 |	16 ä½å¸¦ç¬¦å·æ•´æ•° |	short |
		| Uint16 | 2 | 16 ä½ä¸å¸¦ç¬¦å·æ•´æ•° | unsigned short |
		| Int32 |	4 | 32 ä½å¸¦ç¬¦å·æ•´æ•° | int |
		| Uint32 | 4 | 32 ä½ä¸å¸¦ç¬¦å·çš„æ•´æ•° | unsigned int |
		| Float32 | 4	 | 32 ä½æµ®ç‚¹æ•° | float |
		| Float64 | 8 |	64 ä½æµ®ç‚¹æ•° | double |
- åœ¨åˆ›å»ºä¸€ä¸ªç±»å‹åŒ–æ•°ç»„çš„æ—¶å€™ï¼Œå¯ä»¥ä¼ é€’æ•°ç»„å¤§å°ç»™æ„é€ å‡½æ•°ï¼Œæˆ–è€…ä¼ é€’ä¸€ä¸ªæ•°ç»„æˆ–è€…ç±»å‹åŒ–æ•°ç»„æ¥ç”¨äºåˆå§‹åŒ–æ•°ç»„å…ƒç´ ã€‚ä¸€æ—¦åˆ›å»ºäº†ç±»å‹åŒ–æ•°ç»„ï¼Œå°±å¯ä»¥åƒæ“ä½œå…¶ä»–ç±»æ•°ç»„å¯¹è±¡é‚£æ ·ï¼Œé€šè¿‡å¸¸è§„çš„ä¸­æ‹¬å·è¡¨ç¤ºæ³•æ¥å¯¹æ•°ç»„å…ƒç´ è¿›è¡Œè¯»/å†™æ“ä½œã€‚

	```javascript
	var bytes = new Uint8Array(1024); // 1kbå­—èŠ‚ 
	for (var i = 0; i < bytes.length; i ++) // å¾ªç¯æ•°ç»„çš„æ¯ä¸ªå…ƒç´ 
	for (var i = 0; i < bytes.length; i ++) // å¾ªç¯æ•°ç»„çš„æ¯ä¸ªå…ƒç´ 
		bytes[i] = i & 0xFF; // è®¾ç½®ä¸ºç´¢å¼•çš„ä½8ä½å€¼
	var copy = new Uint8Array(bytes); // åˆ›å»ºæ•°ç»„çš„å‰¯æœ¬
	var ints = new Int32Array([0, 1, 2, 3]); // åŒ…å«è¿™4ä¸ªintå€¼çš„ç±»å‹åŒ–æ•°ç»„
	```
- ç±»å‹åŒ–æ•°ç»„ï¼šä»–ä»¬éƒ½æ˜¯**åŸºæœ¬å­—èŠ‚å—çš„è§†å›¾**ï¼Œç§°ä¸ºä¸€ä¸ª ArrayBuffer ã€‚ArrayBuffer åªæ˜¯ä¸é€æ˜çš„å­—èŠ‚å—ã€‚å¯ä»¥é€šè¿‡ç±»å‹åŒ–æ•°ç»„è·å–è¿™äº›å­—èŠ‚ï¼Œä½†æ˜¯ ArrayBuffer è‡ªå·±å¹¶ä¸æ˜¯ä¸€ä¸ªç±»å‹åŒ–æ•°ç»„ã€‚å¯ä»¥åƒå¯¹ä»»æ„ Javascript å¯¹è±¡é‚£æ ·ï¼Œä½¿ç”¨æ•°å­—æ•°ç»„ç´¢å¼•æ¥æ“ä½œ ArrayBufferã€‚ä½†æ˜¯ï¼Œè¿™æ ·åšå¹¶**ä¸èƒ½èµ‹äºˆè®¿é—®ç¼“å†²åŒºä¸­å­—èŠ‚çš„æƒé™**
	
	```javascript
	var bytes = new Uint8Array(8); // åˆ†é…8ä¸ªå­—èŠ‚
	bytes[0] = 1 // æŠŠç¬¬ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º1
	bytes.buffer[0] = 255 // é”™è¯¯è·å–ï¼Œç¼“å†²åŒºä¸­æ²¡æœ‰ç´¢å¼•å€¼0
	bytes.buffer[1] = 255 // é”™è¯¯è®¾ç½®ç¼“å†²åŒºå­—èŠ‚
	
	```

### â€œå­—èŠ‚é¡ºåºâ€
- å­—èŠ‚ç»„ç»‡æˆæ›´é•¿çš„å­—çš„é¡ºåº
- ä¸ºäº†é«˜æ•ˆï¼Œç±»å‹åŒ–æ•°ç»„é‡‡ç”¨åº•å±‚ç¡¬ä»¶çš„åŸç”Ÿé¡ºåºã€‚åœ¨ä½ä½ä¼˜å…ˆ(little-endian)ç³»ç»Ÿä¸­ï¼Œ ArrayBuffer ä¸­æ•°å­—çš„å­—èŠ‚æ˜¯æŒ‰ç…§ä»ä½ä½åˆ°é«˜ä½çš„é¡ºåºæ’åˆ—çš„ã€‚åœ¨é«˜ä½ä¼˜å…ˆ(big-endian)ç³»ç»Ÿä¸­ï¼Œå­—èŠ‚æ˜¯æŒ‰ç…§ä»é«˜ä½åˆ°ä½ä½çš„é¡ºåºæ’åˆ—çš„ã€‚
- å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç æ¥æ£€æµ‹ç³»ç»Ÿçš„å­—èŠ‚é¡ºåºï¼š

	```javascript
	// å¦‚æœæ•´æ•° Ox00000001 åœ¨å†…å­˜ä¸­è¡¨ç¤ºæˆï¼š 01 00 00 00
	// åˆ™è¯´æ˜å½“å‰ç³»ç»Ÿæ˜¯ä½ä½ä¼˜å…ˆç³»ç»Ÿ
	// ç›¸åï¼Œåœ¨é«˜ä½ä¼˜å…ˆç³»ç»Ÿä¸­ï¼Œå®ƒä¼šè¡¨ç¤ºæˆï¼š00 00 00 01
	var little_endian = new Int8Array(new Int32Array([1]).buffer)[0] === 1
	```
	
## æ€è€ƒé—®é¢˜ 0.1 + 0.2 â‰  0.3
- æˆ‘ä»¬å¯ä»¥å…ˆæ¥çœ‹çœ‹ åè¿›åˆ¶å°æ•°çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š
	- æ•´æ•°éƒ¨åˆ†ï¼šé™¤ä»¥2ï¼Œå–å‡ºä½™æ•°ï¼Œå•†ç»§ç»­é™¤ä»¥2ï¼Œç›´åˆ°å¾—åˆ°0ä¸ºæ­¢ï¼Œå°†å–å‡ºçš„ä½™æ•°é€†åº
	- å°æ•°éƒ¨åˆ†ï¼šä¹˜ä»¥2ï¼Œç„¶åå–å‡ºæ•´æ•°éƒ¨åˆ†ï¼Œå°†å‰©ä¸‹çš„å°æ•°éƒ¨åˆ†ç»§ç»­ä¹˜ä»¥2ï¼Œç„¶åå†å–æ•´æ•°éƒ¨åˆ†ï¼Œä¸€ç›´å–åˆ°å°æ•°éƒ¨åˆ†ä¸ºé›¶ä¸ºæ­¢ã€‚å¦‚æœæ°¸è¿œä¸ä¸ºé›¶ï¼Œåˆ™æŒ‰è¦æ±‚ä¿ç•™è¶³å¤Ÿä½æ•°çš„å°æ•°ï¼Œæœ€åä¸€ä½åš0èˆ1å…¥ã€‚å°†å–å‡ºçš„æ•´æ•°é¡ºåºæ’åˆ—ã€‚
	- æ‰€ä»¥ 0.1 å¯ä»¥è¡¨ç¤ºä¸º
		- 0.000110011001100110011...
	- 0.2 å¯ä»¥è¡¨ç¤ºä¸º
		- 0.00110011001100110011...

		
```javascript
// 0.1 å’Œ 0.2 éƒ½è½¬åŒ–æˆäºŒè¿›åˆ¶åå†è¿›è¡Œè¿ç®—
0.00011001100110011001100110011001100110011001100110011010 +
0.0011001100110011001100110011001100110011001100110011010 =
0.0100110011001100110011001100110011001100110011001100111

// è½¬æˆåè¿›åˆ¶æ­£å¥½æ˜¯ 0.30000000000000004
```

- äºŒè¿›åˆ¶æ•°è½¬æˆ IEEE 754 æ ‡å‡†

	- ![IEEE 754 æ ‡å‡†](http://p0.meituan.net/myvideodistribute/eefbaacb81e66deb742370e27d9e3bb876872.png)

	- ä½¿ç”¨ 64 ä½å›ºå®šé•¿åº¦æ¥è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯æ ‡å‡†çš„double åŒç²¾åº¦æµ®ç‚¹æ•°ã€‚
	- è¿™æ ·çš„å­˜å‚¨ç»“æ„ä¼˜ç‚¹æ˜¯å¯ä»¥å½’ä¸€åŒ–å¤„ç†æ•´æ•°å’Œå°æ•°ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´ã€‚
	- è¿™64ä¸ªæ¯”ç‰¹åˆå¯åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œå³ï¼š
		- ç¬¬1ä½: æ˜¯ç¬¦å·çš„æ ‡å¿—ä½(S), 0ä»£è¡¨æ­£æ•°ï¼Œ1ä»£è¡¨è´Ÿæ•°
		- ç¬¬1-11ä½: æŒ‡æ•°ä½(E), å­˜å‚¨æŒ‡æ•°ï¼ˆexponentï¼‰ï¼Œç”¨æ¥è¡¨ç¤ºæ¬¡æ–¹æ•°
		- ç¬¬12-63ä½: å°¾æ•°(M), è¿™52 ä½æ˜¯å°¾æ•°ï¼Œè¶…å‡ºçš„éƒ¨åˆ†è‡ªåŠ¨è¿›ä¸€èˆé›¶
	- å®é™…æ•°å­—å°±å¯ä»¥ç”¨ä»¥ä¸‹å…¬å¼æ¥è®¡ç®—ï¼š
		
		- ![IEEE 754æ•°å­¦å…¬å¼](http://p0.meituan.net/myvideodistribute/7b2c9fce00cfe3bf57fcede347257af276632.png)

	- å› æ­¤ 0.1 çš„äºŒè¿›åˆ¶è¡¨ç¤ºï¼š	

		> 0.00011001100110011001100110011001100110011001100110011001100...
	
		- é¦–å…ˆ 0.1 æ˜¯æ­£æ•°ï¼Œæ ‡å¿—ä½ 
		
			> Sign = 0
			
		- å…¶æ¬¡, å°†å°æ•°è½¬åŒ–ä¸ºç§‘å­¦è®¡æ•°æ³•
			
			> 1.100110011001100110011001100110011001100110011001100... * 2^-4
			
			- ç›¸å¯¹äºï¼Œå°æ•°ç‚¹ç§»äº†4ä½ï¼ŒæŒ‡æ•°å‡4
			
				> exponent = -4 + 1023 = 1019
				
				> 01111111011

		- ç”±äºç§‘å­¦è®¡æ•°æ³•, ç¬¬ä¸€ä¸ªæ•°å§‹ç»ˆæ˜¯1, æ‰€ä»¥å¯ä»¥å¿½ç•¥å­˜å‚¨, åªè¦å­˜åé¢çš„52ä½å°±å¯ä»¥äº†
		- **å¦‚æœè¶…è¿‡äº†52ä½, å°±æ˜¯å¯¹ç¬¬53ä½èˆ0è¿›1**ï¼ˆç²¾åº¦è¯¯å·®ï¼‰, ç»“æœä¹Ÿå°±æ˜¯

			> 1001100110011001100110011001100110011001100110011010
		
	- å› æ­¤ 0.1 çš„ IEEE 754 çš„è¡¨ç¤ºï¼š
	
		- ![0.1 çš„IEEE 754](http://p0.meituan.net/myvideodistribute/1ae3cf9f7bda61d8d0849ce05f7657f997288.png)
	- åŒç† 0.2 çš„ IEEE 754 çš„è¡¨ç¤ºï¼š
		
		- ![0.2 çš„ IEEE 754](http://p0.meituan.net/myvideodistribute/0c5d93145800b45b59a3ef23dc2abe4a97936.png)

### æŸ¥çœ‹ 0.1 è¡¨ç¤ºæ–¹å¼

```javascript
let b = new Float64Array([0.1])
console.log(b)
let intArr = new Uint8Array(b.buffer)
for (let i = 7; i >= 0; i --) {
    s = intArr[i].toString(2)
    while(s.length < 8) {
        s = '0' + s
    }
    console.log(s)

}
```	

- ![ä½ä½ä¼˜å…ˆç³»ç»Ÿ](http://p0.meituan.net/myvideodistribute/d996e0a508b796f5a3d4f4866c1bf43064783.png)
- é¦–å…ˆæˆ‘ä»¬çš„ç³»ç»Ÿæ˜¯ä½ä½ä¼˜å…ˆç³»ç»Ÿ(little_endian)
- ![æŸ¥çœ‹ 0.1 è¡¨ç¤ºæ–¹å¼æˆªå›¾](http://p0.meituan.net/myvideodistribute/de79ee3caac77ddad9398cfeaaf3719f227171.png)
	- 0 --> æ ‡å¿—ä½
	- 011111111011 --> æŒ‡æ•°ä½
	- 1001{12}1010 --> å°¾æ•°

	
## å‚è€ƒæ–‡çŒ®
- ã€ŠJavascript æƒå¨æŒ‡å—ã€‹22.5ç«  ç±»å‹åŒ–æ•°ç»„å’Œ ArrayBuffer P678
- [å½»åº•ææ‡‚Javascript æµ®ç‚¹æ•°](https://cloud.tencent.com/developer/article/1592651)
- [äºŒè¿›åˆ¶è½¬æ¢å·¥å…·](http://www.binaryconvert.com/convert_double.html)

## å†™åœ¨åé¢
- ç¥å¤§å®¶å¤šå¤šå‘è´¢
